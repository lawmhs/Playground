
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cython 3.0a0 documentation</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/_static/css/badge_only.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="search" title="Search" href="search.html" /> 
  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="https://cython.readthedocs.io/en/latest/" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'index'
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index.html#document-index">Cython 3.0a0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="welcome-to-cython-s-documentation">
<h1>Welcome to Cython’s Documentation<a class="headerlink" href="#welcome-to-cython-s-documentation" title="Permalink to this headline">¶</a></h1>
<p>Also see the <a class="reference external" href="https://cython.org/">Cython project homepage</a>.</p>
<div class="toctree-wrapper compound">
<span id="document-src/quickstart/index"></span><div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-src/quickstart/overview"></span><div class="section" id="cython-an-overview">
<h3>Cython - an overview<a class="headerlink" href="#cython-an-overview" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="index.html#cython" id="id1">[Cython]</a> is a programming language that makes writing C extensions
for the Python language as easy as Python itself.  It aims to become
a superset of the <a class="reference internal" href="index.html#python" id="id2">[Python]</a> language which gives it high-level,
object-oriented, functional, and dynamic programming.  Its main feature
on top of these is support for optional static type declarations as
part of the language.  The source code gets translated into optimized
C/C++ code and compiled as Python extension modules.  This allows for
both very fast program execution and tight integration with external C
libraries, while keeping up the high programmer productivity for
which the Python language is well known.</p>
<p>The primary Python execution environment is commonly referred to as
CPython, as it is written in C.  Other major implementations use Java
(Jython <a class="reference internal" href="index.html#jython" id="id3">[Jython]</a>), C# (IronPython <a class="reference internal" href="index.html#ironpython" id="id4">[IronPython]</a>) and Python itself
(PyPy <a class="reference internal" href="index.html#pypy" id="id5">[PyPy]</a>).  Written in C, CPython has been conducive to wrapping
many external libraries that interface through the C language.  It
has, however, remained non trivial to write the necessary glue code in
C, especially for programmers who are more fluent in a high-level
language like Python than in a close-to-the-metal language like C.</p>
<p>Originally based on the well-known Pyrex <a class="reference internal" href="index.html#pyrex" id="id6">[Pyrex]</a>, the Cython project
has approached this problem by means of a source code compiler that
translates Python code to equivalent C code.  This code is executed
within the CPython runtime environment, but at the speed of compiled C
and with the ability to call directly into C libraries.
At the same time, it keeps the original interface of the Python
source code, which makes it directly usable from Python code.  These
two-fold characteristics enable Cython’s two major use cases:
extending the CPython interpreter with fast binary modules, and
interfacing Python code with external C libraries.</p>
<p>While Cython can compile (most) regular Python code, the generated C
code usually gains major (and sometime impressive) speed improvements
from optional static type declarations for both Python and C types.
These allow Cython to assign C semantics to parts of the code, and to
translate them into very efficient C code.  Type declarations can
therefore be used for two purposes: for moving code sections from
dynamic Python semantics into static-and-fast C semantics, but also
for directly manipulating types defined in external libraries.  Cython
thus merges the two worlds into a very broadly applicable programming
language.</p>
<table class="docutils citation" frame="void" id="cython" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[Cython]</a></td><td>G. Ewing, R. W. Bradshaw, S. Behnel, D. S. Seljebotn et al.,
The Cython compiler, <a class="reference external" href="https://cython.org/">https://cython.org/</a>.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="ironpython" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[IronPython]</a></td><td>Jim Hugunin et al., <a class="reference external" href="https://archive.codeplex.com/?p=IronPython">https://archive.codeplex.com/?p=IronPython</a>.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="jython" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[Jython]</a></td><td>J. Huginin, B. Warsaw, F. Bock, et al.,
Jython: Python for the Java platform, <a class="reference external" href="http://www.jython.org">http://www.jython.org</a>.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="pypy" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[PyPy]</a></td><td>The PyPy Group, PyPy: a Python implementation written in Python,
<a class="reference external" href="https://pypy.org/">https://pypy.org/</a>.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="pyrex" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[Pyrex]</a></td><td>G. Ewing, Pyrex: C-Extensions for Python,
<a class="reference external" href="https://www.cosc.canterbury.ac.nz/greg.ewing/python/Pyrex/">https://www.cosc.canterbury.ac.nz/greg.ewing/python/Pyrex/</a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="python" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[Python]</a></td><td>G. van Rossum et al., The Python programming language,
<a class="reference external" href="https://www.python.org/">https://www.python.org/</a>.</td></tr>
</tbody>
</table>
</div>
<span id="document-src/quickstart/install"></span><div class="section" id="installing-cython">
<span id="install"></span><h3>Installing Cython<a class="headerlink" href="#installing-cython" title="Permalink to this headline">¶</a></h3>
<p>Many scientific Python distributions, such as Anaconda <a class="reference internal" href="index.html#anaconda" id="id1">[Anaconda]</a>,
Enthought Canopy <a class="reference internal" href="index.html#canopy" id="id2">[Canopy]</a>, and Sage <a class="reference internal" href="index.html#sage" id="id3">[Sage]</a>,
bundle Cython and no setup is needed.  Note however that if your
distribution ships a version of Cython which is too old you can still
use the instructions below to update Cython.  Everything in this
tutorial should work with Cython 0.11.2 and newer, unless a footnote
says otherwise.</p>
<p>Unlike most Python software, Cython requires a C compiler to be
present on the system. The details of getting a C compiler varies
according to the system used:</p>
<blockquote>
<div><ul class="simple">
<li><strong>Linux</strong> The GNU C Compiler (gcc) is usually present, or easily
available through the package system. On Ubuntu or Debian, for
instance, the command <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">build-essential</span></code> will
fetch everything you need.</li>
<li><strong>Mac OS X</strong> To retrieve gcc, one option is to install Apple’s
XCode, which can be retrieved from the Mac OS X’s install DVDs or
from <a class="reference external" href="https://developer.apple.com/">https://developer.apple.com/</a>.</li>
<li><strong>Windows</strong> A popular option is to use the open source MinGW (a
Windows distribution of gcc). See the appendix for instructions for
setting up MinGW manually. Enthought Canopy and Python(x,y) bundle
MinGW, but some of the configuration steps in the appendix might
still be necessary.  Another option is to use Microsoft’s Visual C.
One must then use the same version which the installed Python was
compiled with.</li>
</ul>
</div></blockquote>
<p>The simplest way of installing Cython is by using <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">Cython</span>
</pre></div>
</div>
<p>The newest Cython release can always be downloaded from
<a class="reference external" href="https://cython.org/">https://cython.org/</a>.  Unpack the tarball or zip file, enter the
directory, and then run:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
<p>For one-time builds, e.g. for CI/testing, on platforms that are not covered
by one of the wheel packages provided on PyPI, it is substantially faster
than a full source build to install an uncompiled (slower) version of Cython
with</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">Cython</span> <span class="o">--</span><span class="n">install</span><span class="o">-</span><span class="n">option</span><span class="o">=</span><span class="s">&quot;--no-cython-compile&quot;</span>
</pre></div>
</div>
<table class="docutils citation" frame="void" id="anaconda" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[Anaconda]</a></td><td><a class="reference external" href="https://docs.anaconda.com/anaconda/">https://docs.anaconda.com/anaconda/</a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="canopy" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[Canopy]</a></td><td><a class="reference external" href="https://www.enthought.com/product/canopy/">https://www.enthought.com/product/canopy/</a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="sage" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[Sage]</a></td><td><ol class="first last upperalpha simple" start="23">
<li>Stein et al., Sage Mathematics Software, <a class="reference external" href="https://www.sagemath.org/">https://www.sagemath.org/</a></li>
</ol>
</td></tr>
</tbody>
</table>
</div>
<span id="document-src/quickstart/build"></span><div class="section" id="building-cython-code">
<h3>Building Cython code<a class="headerlink" href="#building-cython-code" title="Permalink to this headline">¶</a></h3>
<p>Cython code must, unlike Python, be compiled. This happens in two stages:</p>
<blockquote>
<div><ul class="simple">
<li>A <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file is compiled by Cython to a <code class="docutils literal notranslate"><span class="pre">.c</span></code> file, containing
the code of a Python extension module.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">.c</span></code> file is compiled by a C compiler to
a <code class="docutils literal notranslate"><span class="pre">.so</span></code> file (or <code class="docutils literal notranslate"><span class="pre">.pyd</span></code> on Windows) which can be
<code class="docutils literal notranslate"><span class="pre">import</span></code>-ed directly into a Python session.
Distutils or setuptools take care of this part.
Although Cython can call them for you in certain cases.</li>
</ul>
</div></blockquote>
<p>To understand fully the Cython + distutils/setuptools build process,
one may want to read more about
<a class="reference external" href="https://docs.python.org/3/distributing/index.html">distributing Python modules</a>.</p>
<p>There are several ways to build Cython code:</p>
<blockquote>
<div><ul class="simple">
<li>Write a distutils/setuptools <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>. This is the normal and recommended way.</li>
<li>Use <a class="reference internal" href="index.html#pyximport"><span class="std std-ref">Pyximport</span></a>, importing Cython <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> files as if they
were <code class="docutils literal notranslate"><span class="pre">.py</span></code> files (using distutils to compile and build in the background).
This method is easier than writing a <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, but is not very flexible.
So you’ll need to write a <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> if, for example, you need certain compilations options.</li>
<li>Run the <code class="docutils literal notranslate"><span class="pre">cython</span></code> command-line utility manually to produce the <code class="docutils literal notranslate"><span class="pre">.c</span></code> file
from the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file, then manually compiling the <code class="docutils literal notranslate"><span class="pre">.c</span></code> file into a shared
object library or DLL suitable for import from Python.
(These manual steps are mostly for debugging and experimentation.)</li>
<li>Use the <a class="reference internal" href="index.html#jupyter" id="id1">[Jupyter]</a> notebook or the <a class="reference internal" href="index.html#sage" id="id2">[Sage]</a> notebook,
both of which allow Cython code inline.
This is the easiest way to get started writing Cython code and running it.</li>
</ul>
</div></blockquote>
<p>Currently, using distutils or setuptools is the most common way Cython files are built and distributed.
The other methods are described in more detail in the <a class="reference internal" href="index.html#compilation"><span class="std std-ref">Source Files and Compilation</span></a> section of the reference manual.</p>
<div class="section" id="building-a-cython-module-using-distutils">
<h4>Building a Cython module using distutils<a class="headerlink" href="#building-a-cython-module-using-distutils" title="Permalink to this headline">¶</a></h4>
<p>Imagine a simple “hello world” script in a file <code class="docutils literal notranslate"><span class="pre">hello.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">say_hello_to</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Hello </span><span class="si">%s</span><span class="s">!&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>The following could be a corresponding <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Hello world app&#39;</span><span class="p">,</span>
      <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;hello.pyx&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>To build, run <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">build_ext</span> <span class="pre">--inplace</span></code>.  Then simply
start a Python session and do <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">hello</span> <span class="pre">import</span> <span class="pre">say_hello_to</span></code> and
use the imported function as you see fit.</p>
<p>One caveat if you use setuptools instead of distutils, the default
action when running <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code> is to create a zipped
<code class="docutils literal notranslate"><span class="pre">egg</span></code> file which will not work with <code class="docutils literal notranslate"><span class="pre">cimport</span></code> for <code class="docutils literal notranslate"><span class="pre">pxd</span></code> files
when you try to use them from a dependent package.
To prevent this, include <code class="docutils literal notranslate"><span class="pre">zip_safe=False</span></code> in the arguments to <code class="docutils literal notranslate"><span class="pre">setup()</span></code>.</p>
</div>
<div class="section" id="using-the-jupyter-notebook">
<span id="jupyter-notebook"></span><h4>Using the Jupyter notebook<a class="headerlink" href="#using-the-jupyter-notebook" title="Permalink to this headline">¶</a></h4>
<p>Cython can be used conveniently and interactively from a web browser
through the Jupyter notebook.  To install Jupyter notebook, e.g. into a virtualenv,
use pip:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>venv<span class="o">)</span>$ pip install jupyter
<span class="o">(</span>venv<span class="o">)</span>$ jupyter notebook
</pre></div>
</div>
<p>To enable support for Cython compilation, install Cython as described in <a class="reference internal" href="index.html#install"><span class="std std-ref">the installation guide</span></a>
and load the <code class="docutils literal notranslate"><span class="pre">Cython</span></code> extension from within the Jupyter notebook:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">load_ext</span> <span class="n">Cython</span>
</pre></div>
</div>
<p>Then, prefix a cell with the <code class="docutils literal notranslate"><span class="pre">%%cython</span></code> marker to compile it:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">cython</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">a</span> <span class="o">=</span> <span class="mf">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">10</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">+=</span> <span class="n">i</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>You can show Cython’s code analysis by passing the <code class="docutils literal notranslate"><span class="pre">--annotate</span></code> option:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">cython</span> <span class="o">--</span><span class="n">annotate</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="figure">
<img alt="_images/jupyter.png" src="_images/jupyter.png" />
</div>
<p>For more information about the arguments of the <code class="docutils literal notranslate"><span class="pre">%%cython</span></code> magic, see
<a class="reference internal" href="index.html#compiling-notebook"><span class="std std-ref">Compiling with a Jupyter Notebook</span></a>.</p>
</div>
<div class="section" id="using-the-sage-notebook">
<h4>Using the Sage notebook<a class="headerlink" href="#using-the-sage-notebook" title="Permalink to this headline">¶</a></h4>
<div class="figure" id="id3">
<img alt="_images/sage.png" src="_images/sage.png" />
<p class="caption"><span class="caption-text">For users of the Sage math distribution, the Sage notebook allows
transparently editing and compiling Cython code simply by typing
<code class="docutils literal notranslate"><span class="pre">%cython</span></code> at the top of a cell and evaluate it.  Variables and
functions defined in a Cython cell imported into the running session.</span></p>
</div>
<table class="docutils citation" frame="void" id="jupyter" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[Jupyter]</a></td><td><a class="reference external" href="https://jupyter.org/">https://jupyter.org/</a></td></tr>
</tbody>
</table>
</div>
</div>
<span id="document-src/quickstart/cythonize"></span><div class="section" id="faster-code-via-static-typing">
<h3>Faster code via static typing<a class="headerlink" href="#faster-code-via-static-typing" title="Permalink to this headline">¶</a></h3>
<p>Cython is a Python compiler.  This means that it can compile normal
Python code without changes (with a few obvious exceptions of some as-yet
unsupported language features, see <a class="reference internal" href="index.html#cython-limitations"><span class="std std-ref">Cython limitations</span></a>).
However, for performance critical code, it is often helpful to add
static type declarations, as they will allow Cython to step out of the
dynamic nature of the Python code and generate simpler and faster C code
- sometimes faster by orders of magnitude.</p>
<p>It must be noted, however, that type declarations can make the source
code more verbose and thus less readable.  It is therefore discouraged
to use them without good reason, such as where benchmarks prove
that they really make the code substantially faster in a performance
critical section. Typically a few types in the right spots go a long way.</p>
<p>All C types are available for type declarations: integer and floating
point types, complex numbers, structs, unions and pointer types.
Cython can automatically and correctly convert between the types on
assignment.  This also includes Python’s arbitrary size integer types,
where value overflows on conversion to a C type will raise a Python
<code class="docutils literal notranslate"><span class="pre">OverflowError</span></code> at runtime.  (It does not, however, check for overflow
when doing arithmetic.) The generated C code will handle the
platform dependent sizes of C types correctly and safely in this case.</p>
<p>Types are declared via the cdef keyword.</p>
<div class="section" id="typing-variables">
<h4>Typing Variables<a class="headerlink" href="#typing-variables" title="Permalink to this headline">¶</a></h4>
<p>Consider the following pure Python code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mf">2</span> <span class="o">-</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">integrate_f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span> <span class="o">*</span> <span class="n">dx</span>
</pre></div>
</div>
<p>Simply compiling this in Cython merely gives a 35% speedup.  This is
better than nothing, but adding some static types can make a much larger
difference.</p>
<p>With additional type declarations, this might look like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mf">2</span> <span class="o">-</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">integrate_f</span><span class="p">(</span><span class="n">double</span> <span class="n">a</span><span class="p">,</span> <span class="n">double</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">s</span><span class="p">,</span> <span class="nf">dx</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span> <span class="o">*</span> <span class="n">dx</span>
</pre></div>
</div>
<p>Since the iterator variable <code class="docutils literal notranslate"><span class="pre">i</span></code> is typed with C semantics, the for-loop will be compiled
to pure C code.  Typing <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">s</span></code> and <code class="docutils literal notranslate"><span class="pre">dx</span></code> is important as they are involved
in arithmetic within the for-loop; typing <code class="docutils literal notranslate"><span class="pre">b</span></code> and <code class="docutils literal notranslate"><span class="pre">N</span></code> makes less of a
difference, but in this case it is not much extra work to be
consistent and type the entire function.</p>
<p>This results in a 4 times speedup over the pure Python version.</p>
</div>
<div class="section" id="typing-functions">
<h4>Typing Functions<a class="headerlink" href="#typing-functions" title="Permalink to this headline">¶</a></h4>
<p>Python function calls can be expensive – in Cython doubly so because
one might need to convert to and from Python objects to do the call.
In our example above, the argument is assumed to be a C double both inside f()
and in the call to it, yet a Python <code class="docutils literal notranslate"><span class="pre">float</span></code> object must be constructed around the
argument in order to pass it.</p>
<p>Therefore Cython provides a syntax for declaring a C-style function,
the cdef keyword:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">f</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">except</span><span class="o">?</span> <span class="o">-</span><span class="mf">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mf">2</span> <span class="o">-</span> <span class="n">x</span>
</pre></div>
</div>
<p>Some form of except-modifier should usually be added, otherwise Cython
will not be able to propagate exceptions raised in the function (or a
function it calls). The <code class="docutils literal notranslate"><span class="pre">except?</span> <span class="pre">-2</span></code> means that an error will be checked
for if <code class="docutils literal notranslate"><span class="pre">-2</span></code> is returned (though the <code class="docutils literal notranslate"><span class="pre">?</span></code> indicates that <code class="docutils literal notranslate"><span class="pre">-2</span></code> may also
be used as a valid return value).
Alternatively, the slower <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">*</span></code> is always
safe. An except clause can be left out if the function returns a Python
object or if it is guaranteed that an exception will not be raised
within the function call.</p>
<p>A side-effect of cdef is that the function is no longer available from
Python-space, as Python wouldn’t know how to call it. It is also no
longer possible to change <code class="xref py py-func docutils literal notranslate"><span class="pre">f()</span></code> at runtime.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> keyword instead of <code class="docutils literal notranslate"><span class="pre">cdef</span></code>, a Python wrapper is also
created, so that the function is available both from Cython (fast, passing
typed values directly) and from Python (wrapping values in Python
objects). In fact, <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> does not just provide a Python wrapper, it also
installs logic to allow the method to be overridden by python methods, even
when called from within cython. This does add a tiny overhead compared to <code class="docutils literal notranslate"><span class="pre">cdef</span></code>
methods.</p>
<p>Speedup: 150 times over pure Python.</p>
</div>
<div class="section" id="determining-where-to-add-types">
<span id="id1"></span><h4>Determining where to add types<a class="headerlink" href="#determining-where-to-add-types" title="Permalink to this headline">¶</a></h4>
<p>Because static typing is often the key to large speed gains, beginners
often have a tendency to type everything in sight. This cuts down on both
readability and flexibility, and can even slow things down (e.g. by adding
unnecessary type checks, conversions, or slow buffer unpacking).
On the other hand, it is easy to kill
performance by forgetting to type a critical loop variable. Two essential
tools to help with this task are profiling and annotation.
Profiling should be the first step of any optimization effort, and can
tell you where you are spending your time. Cython’s annotation can then
tell you why your code is taking time.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">-a</span></code> switch to the <code class="docutils literal notranslate"><span class="pre">cython</span></code> command line program (or
following a link from the Sage notebook) results in an HTML report
of Cython code interleaved with the generated C code.  Lines are
colored according to the level of “typedness” –
white lines translate to pure C,
while lines that require the Python C-API are yellow
(darker as they translate to more C-API interaction).
Lines that translate to C code have a plus (<code class="docutils literal notranslate"><span class="pre">+</span></code>) in front
and can be clicked to show the generated code.</p>
<p>This report is invaluable when optimizing a function for speed,
and for determining when to <a class="reference internal" href="index.html#nogil"><span class="std std-ref">release the GIL</span></a>:
in general, a <code class="docutils literal notranslate"><span class="pre">nogil</span></code> block may contain only “white” code.</p>
<div class="figure">
<img alt="_images/htmlreport.png" src="_images/htmlreport.png" />
</div>
<p>Note that Cython deduces the type of local variables based on their assignments
(including as loop variable targets) which can also cut down on the need to
explicitly specify types everywhere.
For example, declaring <code class="docutils literal notranslate"><span class="pre">dx</span></code> to be of type double above is unnecessary,
as is declaring the type of <code class="docutils literal notranslate"><span class="pre">s</span></code> in the last version (where the return type
of <code class="docutils literal notranslate"><span class="pre">f</span></code> is known to be a C double.)  A notable exception, however, is
<em>integer types used in arithmetic expressions</em>, as Cython is unable to ensure
that an overflow would not occur (and so falls back to <code class="docutils literal notranslate"><span class="pre">object</span></code> in case
Python’s bignums are needed).  To allow inference of C integer types, set the
<code class="docutils literal notranslate"><span class="pre">infer_types</span></code> <a class="reference internal" href="index.html#compiler-directives"><span class="std std-ref">directive</span></a> to <code class="docutils literal notranslate"><span class="pre">True</span></code>. This directive
does a work similar to the <code class="docutils literal notranslate"><span class="pre">auto</span></code> keyword in C++ for the readers who are familiar
with this language feature. It can be of great help to cut down on the need to type
everything, but it also can lead to surprises. Especially if one isn’t familiar with
arithmetic expressions with c types. A quick overview of those
can be found <a class="reference external" href="https://www.eskimo.com/~scs/cclass/int/sx4cb.html">here</a>.</p>
</div>
</div>
</div>
</div>
<span id="document-src/tutorial/index"></span><div class="section" id="tutorials">
<h2>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-src/tutorial/cython_tutorial"></span><div class="section" id="basic-tutorial">
<span id="tutorial"></span><h3>Basic Tutorial<a class="headerlink" href="#basic-tutorial" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-basics-of-cython">
<h4>The Basics of Cython<a class="headerlink" href="#the-basics-of-cython" title="Permalink to this headline">¶</a></h4>
<p>The fundamental nature of Cython can be summed up as follows: Cython is Python
with C data types.</p>
<p>Cython is Python: Almost any piece of Python code is also valid Cython code.
(There are a few <a class="reference internal" href="index.html#cython-limitations"><span class="std std-ref">Limitations</span></a>, but this approximation will
serve for now.) The Cython compiler will convert it into C code which makes
equivalent calls to the Python/C API.</p>
<p>But Cython is much more than that, because parameters and variables can be
declared to have C data types. Code which manipulates Python values and C
values can be freely intermixed, with conversions occurring automatically
wherever possible. Reference count maintenance and error checking of Python
operations is also automatic, and the full power of Python’s exception
handling facilities, including the try-except and try-finally statements, is
available to you – even in the midst of manipulating C data.</p>
</div>
<div class="section" id="cython-hello-world">
<h4>Cython Hello World<a class="headerlink" href="#cython-hello-world" title="Permalink to this headline">¶</a></h4>
<p>As Cython can accept almost any valid python source file, one of the hardest
things in getting started is just figuring out how to compile your extension.</p>
<p>So lets start with the canonical python hello world:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Save this code in a file named <code class="file docutils literal notranslate"><span class="pre">helloworld.pyx</span></code>.  Now we need to create
the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code>, which is like a python Makefile (for more information
see <a class="reference internal" href="index.html#compilation"><span class="std std-ref">Source Files and Compilation</span></a>). Your <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> should look like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;helloworld.pyx&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To use this to build your Cython file use the commandline options:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ python setup.py build_ext --inplace
</pre></div>
</div>
<p>Which will leave a file in your local directory called <code class="file docutils literal notranslate"><span class="pre">helloworld.so</span></code> in unix
or <code class="file docutils literal notranslate"><span class="pre">helloworld.pyd</span></code> in Windows. Now to use this file: start the python
interpreter and simply import it as if it was a regular python module:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">helloworld</span>
<span class="n">Hello</span> <span class="n">World</span>
</pre></div>
</div>
<p>Congratulations! You now know how to build a Cython extension. But so far
this example doesn’t really give a feeling why one would ever want to use Cython, so
lets create a more realistic example.</p>
<div class="section" id="pyximport-cython-compilation-for-developers">
<h5><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyximport</span></code>: Cython Compilation for Developers<a class="headerlink" href="#pyximport-cython-compilation-for-developers" title="Permalink to this headline">¶</a></h5>
<p>If your module doesn’t require any extra C libraries or a special
build setup, then you can use the pyximport module, originally developed
by Paul Prescod, to load .pyx files directly on import, without having
to run your <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> file each time you change your code.
It is shipped and installed with Cython and can be used like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">pyximport</span><span class="p">;</span> <span class="n">pyximport</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">helloworld</span>
<span class="n">Hello</span> <span class="n">World</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="index.html#pyximport"><span class="std std-ref">Pyximport</span></a> module also has experimental
compilation support for normal Python modules.  This allows you to
automatically run Cython on every .pyx and .py module that Python
imports, including the standard library and installed packages.
Cython will still fail to compile a lot of Python modules, in which
case the import mechanism will fall back to loading the Python source
modules instead.  The .py import mechanism is installed like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pyximport</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">pyimport</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that it is not recommended to let <a class="reference internal" href="index.html#pyximport"><span class="std std-ref">Pyximport</span></a> build code
on end user side as it hooks into their import system.  The best way
to cater for end users is to provide pre-built binary packages in the
<a class="reference external" href="https://wheel.readthedocs.io/">wheel</a> packaging format.</p>
</div>
</div>
<div class="section" id="fibonacci-fun">
<h4>Fibonacci Fun<a class="headerlink" href="#fibonacci-fun" title="Permalink to this headline">¶</a></h4>
<p>From the official Python tutorial a simple fibonacci function is defined as:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the Fibonacci series up to n.&quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">1</span>
    <span class="k">while</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

    <span class="k">print</span><span class="p">()</span>
</pre></div>
</div>
<p>Now following the steps for the Hello World example we first rename the file
to have a <cite>.pyx</cite> extension, lets say <code class="file docutils literal notranslate"><span class="pre">fib.pyx</span></code>, then we create the
<code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> file. Using the file created for the Hello World example, all
that you need to change is the name of the Cython filename, and the resulting
module name, doing this we have:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;fib.pyx&quot;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Build the extension with the same command used for the helloworld.pyx:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ python setup.py build_ext --inplace
</pre></div>
</div>
<p>And use the new extension with:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">fib</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">fib</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="mf">2000</span><span class="p">)</span>
<span class="mf">1</span> <span class="mf">1</span> <span class="mf">2</span> <span class="mf">3</span> <span class="mf">5</span> <span class="mf">8</span> <span class="mf">13</span> <span class="mf">21</span> <span class="mf">34</span> <span class="mf">55</span> <span class="mf">89</span> <span class="mf">144</span> <span class="mf">233</span> <span class="mf">377</span> <span class="mf">610</span> <span class="mf">987</span> <span class="mf">1597</span>
</pre></div>
</div>
</div>
<div class="section" id="primes">
<span id="id1"></span><h4>Primes<a class="headerlink" href="#primes" title="Permalink to this headline">¶</a></h4>
<p>Here’s a small example showing some of what can be done. It’s a routine for
finding prime numbers. You tell it how many primes you want, and it returns
them as a Python list.</p>
<p><code class="file docutils literal notranslate"><span class="pre">primes.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">primes</span><span class="p">(</span><span class="nb">int</span> <span class="n">nb_primes</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n</span><span class="p">,</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">len_p</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="kt">p</span>[1000]
    <span class="k">if</span> <span class="n">nb_primes</span> <span class="o">&gt;</span> <span class="mf">1000</span><span class="p">:</span>
        <span class="n">nb_primes</span> <span class="o">=</span> <span class="mf">1000</span>

    <span class="n">len_p</span> <span class="o">=</span> <span class="mf">0</span>  <span class="c"># The current number of elements in p.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mf">2</span>
    <span class="k">while</span> <span class="n">len_p</span> <span class="o">&lt;</span> <span class="n">nb_primes</span><span class="p">:</span>
        <span class="c"># Is n prime?</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[:</span><span class="n">len_p</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c"># If no break occurred in the loop, we have a prime.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">len_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">len_p</span> <span class="o">+=</span> <span class="mf">1</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mf">1</span>

    <span class="c"># Let&#39;s return the result in a python list:</span>
    <span class="n">result_as_list</span>  <span class="o">=</span> <span class="p">[</span><span class="n">prime</span> <span class="k">for</span> <span class="n">prime</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[:</span><span class="n">len_p</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">result_as_list</span>
</pre></div>
</td></tr></table></div>
<p>You’ll see that it starts out just like a normal Python function definition,
except that the parameter <code class="docutils literal notranslate"><span class="pre">nb_primes</span></code> is declared to be of type <code class="docutils literal notranslate"><span class="pre">int</span></code> . This
means that the object passed will be converted to a C integer (or a
<code class="docutils literal notranslate"><span class="pre">TypeError.</span></code> will be raised if it can’t be).</p>
<p>Now, let’s dig into the core of the function:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n</span><span class="p">,</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">len_p</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="kt">p</span>[1000]
</pre></div>
</div>
<p>Lines 2 and 3 use the <code class="docutils literal notranslate"><span class="pre">cdef</span></code> statement to define some local C variables.
The result is stored in the C array <code class="docutils literal notranslate"><span class="pre">p</span></code> during processing,
and will be copied into a Python list at the end (line 22).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You cannot create very large arrays in this manner, because
they are allocated on the C function call stack, which is a
rather precious and scarce resource.
To request larger arrays,
or even arrays with a length only known at runtime,
you can learn how to make efficient use of
<a class="reference internal" href="index.html#memory-allocation"><span class="std std-ref">C memory allocation</span></a>,
<a class="reference internal" href="index.html#array-array"><span class="std std-ref">Python arrays</span></a>
or <a class="reference internal" href="index.html#memoryviews"><span class="std std-ref">NumPy arrays</span></a> with Cython.</p>
</div>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">nb_primes</span> <span class="o">&gt;</span> <span class="mf">1000</span><span class="p">:</span>
    <span class="n">nb_primes</span> <span class="o">=</span> <span class="mf">1000</span>
</pre></div>
</div>
<p>As in C, declaring a static array requires knowing the size at compile time.
We make sure the user doesn’t set a value above 1000 (or we would have a
segmentation fault, just like in C).</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">len_p</span> <span class="o">=</span> <span class="mf">0</span>  <span class="c"># The number of elements in p</span>
<span class="n">n</span> <span class="o">=</span> <span class="mf">2</span>
<span class="k">while</span> <span class="n">len_p</span> <span class="o">&lt;</span> <span class="n">nb_primes</span><span class="p">:</span>
</pre></div>
</div>
<p>Lines 7-9 set up for a loop which will test candidate numbers for primeness
until the required number of primes has been found.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># Is n prime?</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[:</span><span class="n">len_p</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
<p>Lines 11-12, which try dividing a candidate by all the primes found so far,
are of particular interest. Because no Python objects are referred to,
the loop is translated entirely into C code, and thus runs very fast.
You will notice the way we iterate over the <code class="docutils literal notranslate"><span class="pre">p</span></code> C array.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[:</span><span class="n">len_p</span><span class="p">]:</span>
</pre></div>
</div>
<p>The loop gets translated into a fast C loop and works just like iterating
over a Python list or NumPy array.  If you don’t slice the C array with
<code class="docutils literal notranslate"><span class="pre">[:len_p]</span></code>, then Cython will loop over the 1000 elements of the array.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># If no break occurred in the loop</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span><span class="p">[</span><span class="n">len_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">len_p</span> <span class="o">+=</span> <span class="mf">1</span>
<span class="n">n</span> <span class="o">+=</span> <span class="mf">1</span>
</pre></div>
</div>
<p>If no breaks occurred, it means that we found a prime, and the block of code
after the <code class="docutils literal notranslate"><span class="pre">else</span></code> line 16 will be executed. We add the prime found to <code class="docutils literal notranslate"><span class="pre">p</span></code>.
If you find having an <code class="docutils literal notranslate"><span class="pre">else</span></code> after a for-loop strange, just know that it’s a
lesser known features of the Python language, and that Cython executes it at
C speed for you.
If the for-else syntax confuses you, see this excellent
<a class="reference external" href="https://shahriar.svbtle.com/pythons-else-clause-in-loops">blog post</a>.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># Let&#39;s put the result in a python list:</span>
<span class="n">result_as_list</span>  <span class="o">=</span> <span class="p">[</span><span class="n">prime</span> <span class="k">for</span> <span class="n">prime</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[:</span><span class="n">len_p</span><span class="p">]]</span>
<span class="k">return</span> <span class="n">result_as_list</span>
</pre></div>
</div>
<p>In line 22, before returning the result, we need to copy our C array into a
Python list, because Python can’t read C arrays.  Cython can automatically
convert many C types from and to Python types, as described in the
documentation on <a class="reference internal" href="index.html#type-conversion"><span class="std std-ref">type conversion</span></a>, so we can use
a simple list comprehension here to copy the C <code class="docutils literal notranslate"><span class="pre">int</span></code> values into a Python
list of Python <code class="docutils literal notranslate"><span class="pre">int</span></code> objects, which Cython creates automatically along the way.
You could also have iterated manually over the C array and used
<code class="docutils literal notranslate"><span class="pre">result_as_list.append(prime)</span></code>, the result would have been the same.</p>
<p>You’ll notice we declare a Python list exactly the same way it would be in Python.
Because the variable <code class="docutils literal notranslate"><span class="pre">result_as_list</span></code> hasn’t been explicitly declared with a type,
it is assumed to hold a Python object, and from the assignment, Cython also knows
that the exact type is a Python list.</p>
<p>Finally, at line 18, a normal
Python return statement returns the result list.</p>
<p>Compiling primes.pyx with the Cython compiler produces an extension module
which we can try out in the interactive interpreter as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">primes</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">primes</span><span class="o">.</span><span class="n">primes</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
<span class="p">[</span><span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="mf">5</span><span class="p">,</span> <span class="mf">7</span><span class="p">,</span> <span class="mf">11</span><span class="p">,</span> <span class="mf">13</span><span class="p">,</span> <span class="mf">17</span><span class="p">,</span> <span class="mf">19</span><span class="p">,</span> <span class="mf">23</span><span class="p">,</span> <span class="mf">29</span><span class="p">]</span>
</pre></div>
</div>
<p>See, it works! And if you’re curious about how much work Cython has saved you,
take a look at the C code generated for this module.</p>
<p>Cython has a way to visualise where interaction with Python objects and
Python’s C-API is taking place. For this, pass the
<code class="docutils literal notranslate"><span class="pre">annotate=True</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code>. It produces a HTML file. Let’s see:</p>
<div class="figure">
<img alt="_images/htmlreport1.png" src="_images/htmlreport1.png" />
</div>
<p>If a line is white, it means that the code generated doesn’t interact
with Python, so will run as fast as normal C code.  The darker the yellow, the more
Python interaction there is in that line.  Those yellow lines will usually operate
on Python objects, raise exceptions, or do other kinds of higher-level operations
than what can easily be translated into simple and fast C code.
The function declaration and return use the Python interpreter so it makes
sense for those lines to be yellow. Same for the list comprehension because
it involves the creation of a Python object. But the line <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">n</span> <span class="pre">%</span> <span class="pre">i</span> <span class="pre">==</span> <span class="pre">0:</span></code>, why?
We can examine the generated C code to understand:</p>
<div class="figure">
<img alt="_images/python_division.png" src="_images/python_division.png" />
</div>
<p>We can see that some checks happen. Because Cython defaults to the
Python behavior, the language will perform division checks at runtime,
just like Python does. You can deactivate those checks by using the
<a class="reference internal" href="index.html#compiler-directives"><span class="std std-ref">compiler directives</span></a>.</p>
<p>Now let’s see if, even if we have division checks, we obtained a boost in speed.
Let’s write the same program, but Python-style:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">primes_python</span><span class="p">(</span><span class="n">nb_primes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mf">2</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nb_primes</span><span class="p">:</span>
        <span class="c"># Is n prime?</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c"># If no break occurred in the loop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mf">1</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
<p>It is also possible to take a plain <code class="docutils literal notranslate"><span class="pre">.py</span></code> file and to compile it with Cython.
Let’s take <code class="docutils literal notranslate"><span class="pre">primes_python</span></code>, change the function name to <code class="docutils literal notranslate"><span class="pre">primes_python_compiled</span></code> and
compile it with Cython (without changing the code). We will also change the name of the
file to <code class="docutils literal notranslate"><span class="pre">example_py_cy.py</span></code> to differentiate it from the others.
Now the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> looks like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">([</span><span class="s">&#39;example.pyx&#39;</span><span class="p">,</span>        <span class="c"># Cython code file with primes() function</span>
                           <span class="s">&#39;example_py_cy.py&#39;</span><span class="p">],</span>  <span class="c"># Python code file with primes_python_compiled() function</span>
                          <span class="n">annotate</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>        <span class="c"># enables generation of the html annotation file</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Now we can ensure that those two programs output the same values:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">primes_python</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span> <span class="o">==</span> <span class="n">primes</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">primes_python_compiled</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span> <span class="o">==</span> <span class="n">primes</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>
<span class="bp">True</span>
</pre></div>
</div>
<p>It’s possible to compare the speed now:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">timeit</span> <span class="o">-</span><span class="n">s</span> <span class="s">&#39;from example_py import primes_python&#39;</span> <span class="s">&#39;primes_python(1000)&#39;</span>
<span class="mf">10</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mf">3</span><span class="p">:</span> <span class="mf">23</span> <span class="n">msec</span> <span class="n">per</span> <span class="n">loop</span>

<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">timeit</span> <span class="o">-</span><span class="n">s</span> <span class="s">&#39;from example_py_cy import primes_python_compiled&#39;</span> <span class="s">&#39;primes_python_compiled(1000)&#39;</span>
<span class="mf">100</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mf">3</span><span class="p">:</span> <span class="mf">11.9</span> <span class="n">msec</span> <span class="n">per</span> <span class="n">loop</span>

<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">timeit</span> <span class="o">-</span><span class="n">s</span> <span class="s">&#39;from example import primes&#39;</span> <span class="s">&#39;primes(1000)&#39;</span>
<span class="mf">1000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mf">3</span><span class="p">:</span> <span class="mf">1.65</span> <span class="n">msec</span> <span class="n">per</span> <span class="n">loop</span>
</pre></div>
</div>
<p>The cythonize version of <code class="docutils literal notranslate"><span class="pre">primes_python</span></code> is 2 times faster than the Python one,
without changing a single line of code.
The Cython version is 13 times faster than the Python version! What could explain this?</p>
<dl class="docutils">
<dt>Multiple things:</dt>
<dd><ul class="first last simple">
<li>In this program, very little computation happen at each line.
So the overhead of the python interpreter is very important. It would be
very different if you were to do a lot computation at each line. Using NumPy for
example.</li>
<li>Data locality. It’s likely that a lot more can fit in CPU cache when using C than
when using Python. Because everything in python is an object, and every object is
implemented as a dictionary, this is not very cache friendly.</li>
</ul>
</dd>
</dl>
<p>Usually the speedups are between 2x to 1000x. It depends on how much you call
the Python interpreter. As always, remember to profile before adding types
everywhere. Adding types makes your code less readable, so use them with
moderation.</p>
</div>
<div class="section" id="primes-with-c">
<h4>Primes with C++<a class="headerlink" href="#primes-with-c" title="Permalink to this headline">¶</a></h4>
<p>With Cython, it is also possible to take advantage of the C++ language, notably,
part of the C++ standard library is directly importable from Cython code.</p>
<p>Let’s see what our <code class="file docutils literal notranslate"><span class="pre">primes.pyx</span></code> becomes when
using <a class="reference external" href="https://en.cppreference.com/w/cpp/container/vector">vector</a> from the C++
standard library.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Vector in C++ is a data structure which implements a list or stack based
on a resizeable C array. It is similar to the Python <code class="docutils literal notranslate"><span class="pre">array</span></code>
type in the <code class="docutils literal notranslate"><span class="pre">array</span></code> standard library module.
There is a method <cite>reserve</cite> available which will avoid copies if you know in advance
how many elements you are going to put in the vector. For more details
see <a class="reference external" href="https://en.cppreference.com/w/cpp/container/vector">this page from cppreference</a>.</p>
</div>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c"># distutils: language=c++</span>

<span class="k">from</span> <span class="nn">libcpp.vector</span> <span class="k">cimport</span> <span class="n">vector</span>

<span class="k">def</span> <span class="nf">primes</span><span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">nb_primes</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n</span><span class="p">,</span> <span class="nf">i</span>
    <span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>] <span class="nf">p</span>
    <span class="n">p</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">nb_primes</span><span class="p">)</span>  <span class="c"># allocate memory for &#39;nb_primes&#39; elements.</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mf">2</span>
    <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">nb_primes</span><span class="p">:</span>  <span class="c"># size() for vectors is similar to len()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>  <span class="c"># push_back is similar to append()</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mf">1</span>

    <span class="c"># Vectors are automatically converted to Python</span>
    <span class="c"># lists when converted to Python objects.</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>
</td></tr></table></div>
<p>The first line is a compiler directive. It tells Cython to compile your code to C++.
This will enable the use of C++ language features and the C++ standard library.
Note that it isn’t possible to compile Cython code to C++ with <cite>pyximport</cite>. You
should use a <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> or a notebook to run this example.</p>
<p>You can see that the API of a vector is similar to the API of a Python list,
and can sometimes be used as a drop-in replacement in Cython.</p>
<p>For more details about using C++ with Cython, see <a class="reference internal" href="index.html#wrapping-cplusplus"><span class="std std-ref">Using C++ in Cython</span></a>.</p>
</div>
<div class="section" id="language-details">
<h4>Language Details<a class="headerlink" href="#language-details" title="Permalink to this headline">¶</a></h4>
<p>For more about the Cython language, see <a class="reference internal" href="index.html#language-basics"><span class="std std-ref">Language Basics</span></a>.
To dive right in to using Cython in a numerical computation context,
see <a class="reference internal" href="index.html#memoryviews"><span class="std std-ref">Typed Memoryviews</span></a>.</p>
</div>
</div>
<span id="document-src/tutorial/external"></span><div class="section" id="calling-c-functions">
<h3>Calling C functions<a class="headerlink" href="#calling-c-functions" title="Permalink to this headline">¶</a></h3>
<p>This tutorial describes shortly what you need to know in order to call
C library functions from Cython code.  For a longer and more
comprehensive tutorial about using external C libraries, wrapping them
and handling errors, see <a class="reference internal" href="index.html#document-src/tutorial/clibraries"><span class="doc">Using C libraries</span></a>.</p>
<p>For simplicity, let’s start with a function from the standard C
library.  This does not add any dependencies to your code, and it has
the additional advantage that Cython already defines many such
functions for you. So you can just cimport and use them.</p>
<p>For example, let’s say you need a low-level way to parse a number from
a <code class="docutils literal notranslate"><span class="pre">char*</span></code> value.  You could use the <code class="docutils literal notranslate"><span class="pre">atoi()</span></code> function, as defined
by the <code class="docutils literal notranslate"><span class="pre">stdlib.h</span></code> header file.  This can be done as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">atoi</span>

<span class="k">cdef</span> <span class="nf">parse_charptr_to_py_int</span><span class="p">(</span><span class="n">char</span><span class="o">*</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span><span class="p">,</span> <span class="s">&quot;byte string value is NULL&quot;</span>
    <span class="k">return</span> <span class="n">atoi</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c"># note: atoi() has no error detection!</span>
</pre></div>
</div>
<p>You can find a complete list of these standard cimport files in
Cython’s source package
<a class="reference external" href="https://github.com/cython/cython/tree/master/Cython/Includes">Cython/Includes/</a>.
They are stored in <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files, the standard way to provide reusable
Cython declarations that can be shared across modules
(see <a class="reference internal" href="index.html#sharing-declarations"><span class="std std-ref">Sharing Declarations Between Cython Modules</span></a>).</p>
<p>Cython also has a complete set of declarations for CPython’s C-API.
For example, to test at C compilation time which CPython version
your code is being compiled with, you can do this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython.version</span> <span class="k">cimport</span> <span class="n">PY_VERSION_HEX</span>

<span class="c"># Python version &gt;= 3.2 final ?</span>
<span class="k">print</span><span class="p">(</span><span class="n">PY_VERSION_HEX</span> <span class="o">&gt;=</span> <span class="mf">0</span><span class="n">x030200F0</span><span class="p">)</span>
</pre></div>
</div>
<p>Cython also provides declarations for the C math library:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sin</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">f</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="dynamic-linking">
<h4>Dynamic linking<a class="headerlink" href="#dynamic-linking" title="Permalink to this headline">¶</a></h4>
<p>The libc math library is special in that it is not linked by default
on some Unix-like systems, such as Linux. In addition to cimporting the
declarations, you must configure your build system to link against the
shared library <code class="docutils literal notranslate"><span class="pre">m</span></code>.  For distutils, it is enough to add it to the
<code class="docutils literal notranslate"><span class="pre">libraries</span></code> parameter of the <code class="docutils literal notranslate"><span class="pre">Extension()</span></code> setup:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">distutils.extension</span> <span class="k">import</span> <span class="n">Extension</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Extension</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span>
              <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;demo.pyx&quot;</span><span class="p">],</span>
              <span class="n">libraries</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span>  <span class="c"># Unix-like specific</span>
              <span class="p">)</span>
<span class="p">]</span>

<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Demos&quot;</span><span class="p">,</span>
      <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">ext_modules</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="external-declarations">
<h4>External declarations<a class="headerlink" href="#external-declarations" title="Permalink to this headline">¶</a></h4>
<p>If you want to access C code for which Cython does not provide a ready
to use declaration, you must declare them yourself.  For example, the
above <code class="docutils literal notranslate"><span class="pre">sin()</span></code> function is defined as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;math.h&quot;</span><span class="p">:</span>
    <span class="n">double</span> <span class="n">sin</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>This declares the <code class="docutils literal notranslate"><span class="pre">sin()</span></code> function in a way that makes it available
to Cython code and instructs Cython to generate C code that includes
the <code class="docutils literal notranslate"><span class="pre">math.h</span></code> header file.  The C compiler will see the original
declaration in <code class="docutils literal notranslate"><span class="pre">math.h</span></code> at compile time, but Cython does not parse
“math.h” and requires a separate definition.</p>
<p>Just like the <code class="docutils literal notranslate"><span class="pre">sin()</span></code> function from the math library, it is possible
to declare and call into any C library as long as the module that
Cython generates is properly linked against the shared or static
library.</p>
<p>Note that you can easily export an external C function from your Cython
module by declaring it as <code class="docutils literal notranslate"><span class="pre">cpdef</span></code>.  This generates a Python wrapper
for it and adds it to the module dict.  Here is a Cython module that
provides direct access to the C <code class="docutils literal notranslate"><span class="pre">sin()</span></code> function for Python code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&gt;&gt;&gt; sin(0)</span>
<span class="sd">0.0</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;math.h&quot;</span><span class="p">:</span>
    <span class="k">cpdef</span> <span class="kt">double</span> <span class="nf">sin</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>You get the same result when this declaration appears in the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code>
file that belongs to the Cython module (i.e. that has the same name,
see <a class="reference internal" href="index.html#sharing-declarations"><span class="std std-ref">Sharing Declarations Between Cython Modules</span></a>).
This allows the C declaration to be reused in other Cython modules,
while still providing an automatically generated Python wrapper in
this specific module.</p>
</div>
<div class="section" id="naming-parameters">
<h4>Naming parameters<a class="headerlink" href="#naming-parameters" title="Permalink to this headline">¶</a></h4>
<p>Both C and Cython support signature declarations without parameter
names like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;string.h&quot;</span><span class="p">:</span>
    <span class="n">char</span><span class="o">*</span> <span class="n">strstr</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span><span class="o">*</span><span class="p">)</span>
</pre></div>
</div>
<p>However, this prevents Cython code from calling it with keyword
arguments.  It is therefore preferable
to write the declaration like this instead:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;string.h&quot;</span><span class="p">:</span>
    <span class="n">char</span><span class="o">*</span> <span class="n">strstr</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">haystack</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">needle</span><span class="p">)</span>
</pre></div>
</div>
<p>You can now make it clear which of the two arguments does what in
your call, thus avoiding any ambiguities and often making your code
more readable:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;string.h&quot;</span><span class="p">:</span>
    <span class="n">char</span><span class="o">*</span> <span class="n">strstr</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">haystack</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">needle</span><span class="p">)</span>

<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">data</span> <span class="o">=</span> <span class="s">&quot;hfvcakdfagbcffvschvxcdfgccbcfhvgcsnfxjh&quot;</span>

<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">pos</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">needle</span><span class="o">=</span><span class="s">&#39;akd&#39;</span><span class="p">,</span> <span class="n">haystack</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that changing existing parameter names later is a backwards
incompatible API modification, just as for Python code.  Thus, if
you provide your own declarations for external C or C++ functions,
it is usually worth the additional bit of effort to choose the
names of their arguments well.</p>
</div>
</div>
<span id="document-src/tutorial/clibraries"></span><div class="section" id="using-c-libraries">
<span id="id1"></span><h3>Using C libraries<a class="headerlink" href="#using-c-libraries" title="Permalink to this headline">¶</a></h3>
<p>Apart from writing fast code, one of the main use cases of Cython is
to call external C libraries from Python code.  As Cython code
compiles down to C code itself, it is actually trivial to call C
functions directly in the code.  The following gives a complete
example for using (and wrapping) an external C library in Cython code,
including appropriate error handling and considerations about
designing a suitable API for Python and Cython code.</p>
<p>Imagine you need an efficient way to store integer values in a FIFO
queue.  Since memory really matters, and the values are actually
coming from C code, you cannot afford to create and store Python
<code class="docutils literal notranslate"><span class="pre">int</span></code> objects in a list or deque.  So you look out for a queue
implementation in C.</p>
<p>After some web search, you find the C-algorithms library <a class="reference internal" href="index.html#calg" id="id2">[CAlg]</a> and
decide to use its double ended queue implementation.  To make the
handling easier, however, you decide to wrap it in a Python extension
type that can encapsulate all memory management.</p>
<table class="docutils citation" frame="void" id="calg" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[CAlg]</a></td><td>Simon Howard, C Algorithms library, <a class="reference external" href="http://c-algorithms.sourceforge.net/">http://c-algorithms.sourceforge.net/</a></td></tr>
</tbody>
</table>
<div class="section" id="defining-external-declarations">
<h4>Defining external declarations<a class="headerlink" href="#defining-external-declarations" title="Permalink to this headline">¶</a></h4>
<p>You can download CAlg <a class="reference external" href="https://codeload.github.com/fragglet/c-algorithms/zip/master">here</a>.</p>
<p>The C API of the queue implementation, which is defined in the header
file <code class="docutils literal notranslate"><span class="pre">c-algorithms/src/queue.h</span></code>, essentially looks like this:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/* queue.h */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_Queue</span> <span class="n">Queue</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="o">*</span><span class="n">QueueValue</span><span class="p">;</span>

<span class="n">Queue</span> <span class="o">*</span><span class="nf">queue_new</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">queue_free</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">queue_push_head</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="n">QueueValue</span> <span class="n">data</span><span class="p">);</span>
<span class="n">QueueValue</span> <span class="nf">queue_pop_head</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
<span class="n">QueueValue</span> <span class="nf">queue_peek_head</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">queue_push_tail</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="n">QueueValue</span> <span class="n">data</span><span class="p">);</span>
<span class="n">QueueValue</span> <span class="nf">queue_pop_tail</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
<span class="n">QueueValue</span> <span class="nf">queue_peek_tail</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">queue_is_empty</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
</pre></div>
</div>
<p>To get started, the first step is to redefine the C API in a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code>
file, say, <code class="docutils literal notranslate"><span class="pre">cqueue.pxd</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cqueue.pxd</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;c-algorithms/src/queue.h&quot;</span><span class="p">:</span>
    <span class="k">ctypedef</span> <span class="k">struct</span> <span class="nc">Queue</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">ctypedef</span> <span class="n">void</span><span class="o">*</span> <span class="n">QueueValue</span>

    <span class="n">Queue</span><span class="o">*</span> <span class="n">queue_new</span><span class="p">()</span>
    <span class="n">void</span> <span class="n">queue_free</span><span class="p">(</span><span class="n">Queue</span><span class="o">*</span> <span class="n">queue</span><span class="p">)</span>

    <span class="nb">int</span> <span class="n">queue_push_head</span><span class="p">(</span><span class="n">Queue</span><span class="o">*</span> <span class="n">queue</span><span class="p">,</span> <span class="n">QueueValue</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">QueueValue</span>  <span class="n">queue_pop_head</span><span class="p">(</span><span class="n">Queue</span><span class="o">*</span> <span class="n">queue</span><span class="p">)</span>
    <span class="n">QueueValue</span> <span class="n">queue_peek_head</span><span class="p">(</span><span class="n">Queue</span><span class="o">*</span> <span class="n">queue</span><span class="p">)</span>

    <span class="nb">int</span> <span class="n">queue_push_tail</span><span class="p">(</span><span class="n">Queue</span><span class="o">*</span> <span class="n">queue</span><span class="p">,</span> <span class="n">QueueValue</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">QueueValue</span> <span class="n">queue_pop_tail</span><span class="p">(</span><span class="n">Queue</span><span class="o">*</span> <span class="n">queue</span><span class="p">)</span>
    <span class="n">QueueValue</span> <span class="n">queue_peek_tail</span><span class="p">(</span><span class="n">Queue</span><span class="o">*</span> <span class="n">queue</span><span class="p">)</span>

    <span class="n">bint</span> <span class="n">queue_is_empty</span><span class="p">(</span><span class="n">Queue</span><span class="o">*</span> <span class="n">queue</span><span class="p">)</span>
</pre></div>
</div>
<p>Note how these declarations are almost identical to the header file
declarations, so you can often just copy them over.  However, you do
not need to provide <em>all</em> declarations as above, just those that you
use in your code or in other declarations, so that Cython gets to see
a sufficient and consistent subset of them.  Then, consider adapting
them somewhat to make them more comfortable to work with in Cython.</p>
<p>Specifically, you should take care of choosing good argument names
for the C functions, as Cython allows you to pass them as keyword
arguments.  Changing them later on is a backwards incompatible API
modification.  Choosing good names right away will make these
functions more pleasant to work with from Cython code.</p>
<p>One noteworthy difference to the header file that we use above is the
declaration of the <code class="docutils literal notranslate"><span class="pre">Queue</span></code> struct in the first line.  <code class="docutils literal notranslate"><span class="pre">Queue</span></code> is
in this case used as an <em>opaque handle</em>; only the library that is
called knows what is really inside.  Since no Cython code needs to
know the contents of the struct, we do not need to declare its
contents, so we simply provide an empty definition (as we do not want
to declare the <code class="docutils literal notranslate"><span class="pre">_Queue</span></code> type which is referenced in the C header)
<a class="footnote-reference" href="#id4" id="id3">[1]</a>.</p>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>There’s a subtle difference between <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">struct</span> <span class="pre">Queue:</span> <span class="pre">pass</span></code>
and <code class="docutils literal notranslate"><span class="pre">ctypedef</span> <span class="pre">struct</span> <span class="pre">Queue:</span> <span class="pre">pass</span></code>.  The former declares a
type which is referenced in C code as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">Queue</span></code>, while
the latter is referenced in C as <code class="docutils literal notranslate"><span class="pre">Queue</span></code>.  This is a C
language quirk that Cython is not able to hide.  Most modern C
libraries use the <code class="docutils literal notranslate"><span class="pre">ctypedef</span></code> kind of struct.</td></tr>
</tbody>
</table>
<p>Another exception is the last line.  The integer return value of the
<code class="docutils literal notranslate"><span class="pre">queue_is_empty()</span></code> function is actually a C boolean value, i.e. the
only interesting thing about it is whether it is non-zero or zero,
indicating if the queue is empty or not.  This is best expressed by
Cython’s <code class="docutils literal notranslate"><span class="pre">bint</span></code> type, which is a normal <code class="docutils literal notranslate"><span class="pre">int</span></code> type when used in C
but maps to Python’s boolean values <code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">False</span></code> when
converted to a Python object.  This way of tightening declarations in
a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file can often simplify the code that uses them.</p>
<p>It is good practice to define one <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file for each library that
you use, and sometimes even for each header file (or functional group)
if the API is large.  That simplifies their reuse in other projects.
Sometimes, you may need to use C functions from the standard C
library, or want to call C-API functions from CPython directly.  For
common needs like this, Cython ships with a set of standard <code class="docutils literal notranslate"><span class="pre">.pxd</span></code>
files that provide these declarations in a readily usable way that is
adapted to their use in Cython.  The main packages are <code class="docutils literal notranslate"><span class="pre">cpython</span></code>,
<code class="docutils literal notranslate"><span class="pre">libc</span></code> and <code class="docutils literal notranslate"><span class="pre">libcpp</span></code>.  The NumPy library also has a standard
<code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file <code class="docutils literal notranslate"><span class="pre">numpy</span></code>, as it is often used in Cython code.  See
Cython’s <code class="docutils literal notranslate"><span class="pre">Cython/Includes/</span></code> source package for a complete list of
provided <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files.</p>
</div>
<div class="section" id="writing-a-wrapper-class">
<h4>Writing a wrapper class<a class="headerlink" href="#writing-a-wrapper-class" title="Permalink to this headline">¶</a></h4>
<p>After declaring our C library’s API, we can start to design the Queue
class that should wrap the C queue.  It will live in a file called
<code class="docutils literal notranslate"><span class="pre">queue.pyx</span></code>. <a class="footnote-reference" href="#id6" id="id5">[2]</a></p>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[2]</a></td><td>Note that the name of the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file must be different from
the <code class="docutils literal notranslate"><span class="pre">cqueue.pxd</span></code> file with declarations from the C library,
as both do not describe the same code.  A <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file next to
a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file with the same name defines exported
declarations for code in the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file.  As the
<code class="docutils literal notranslate"><span class="pre">cqueue.pxd</span></code> file contains declarations of a regular C
library, there must not be a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file with the same name
that Cython associates with it.</td></tr>
</tbody>
</table>
<p>Here is a first start for the Queue class:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># queue.pyx</span>

<span class="k">cimport</span> <span class="nn">cqueue</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Queue</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cqueue</span>.<span class="kt">Queue</span>* <span class="nf">_c_queue</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="o">=</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_new</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that it says <code class="docutils literal notranslate"><span class="pre">__cinit__</span></code> rather than <code class="docutils literal notranslate"><span class="pre">__init__</span></code>.  While
<code class="docutils literal notranslate"><span class="pre">__init__</span></code> is available as well, it is not guaranteed to be run (for
instance, one could create a subclass and forget to call the
ancestor’s constructor).  Because not initializing C pointers often
leads to hard crashes of the Python interpreter, Cython provides
<code class="docutils literal notranslate"><span class="pre">__cinit__</span></code> which is <em>always</em> called immediately on construction,
before CPython even considers calling <code class="docutils literal notranslate"><span class="pre">__init__</span></code>, and which
therefore is the right place to initialise <code class="docutils literal notranslate"><span class="pre">cdef</span></code> fields of the new
instance.  However, as <code class="docutils literal notranslate"><span class="pre">__cinit__</span></code> is called during object
construction, <code class="docutils literal notranslate"><span class="pre">self</span></code> is not fully constructed yet, and one must
avoid doing anything with <code class="docutils literal notranslate"><span class="pre">self</span></code> but assigning to <code class="docutils literal notranslate"><span class="pre">cdef</span></code> fields.</p>
<p>Note also that the above method takes no parameters, although subtypes
may want to accept some.  A no-arguments <code class="docutils literal notranslate"><span class="pre">__cinit__()</span></code> method is a
special case here that simply does not receive any parameters that
were passed to a constructor, so it does not prevent subclasses from
adding parameters.  If parameters are used in the signature of
<code class="docutils literal notranslate"><span class="pre">__cinit__()</span></code>, they must match those of any declared <code class="docutils literal notranslate"><span class="pre">__init__</span></code>
method of classes in the class hierarchy that are used to instantiate
the type.</p>
</div>
<div class="section" id="memory-management">
<h4>Memory management<a class="headerlink" href="#memory-management" title="Permalink to this headline">¶</a></h4>
<p>Before we continue implementing the other methods, it is important to
understand that the above implementation is not safe.  In case
anything goes wrong in the call to <code class="docutils literal notranslate"><span class="pre">queue_new()</span></code>, this code will
simply swallow the error, so we will likely run into a crash later on.
According to the documentation of the <code class="docutils literal notranslate"><span class="pre">queue_new()</span></code> function, the
only reason why the above can fail is due to insufficient memory.  In
that case, it will return <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, whereas it would normally return a
pointer to the new queue.</p>
<p>The Python way to get out of this is to raise a <code class="docutils literal notranslate"><span class="pre">MemoryError</span></code> <a class="footnote-reference" href="#id8" id="id7">[3]</a>.
We can thus change the init function as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># queue.pyx</span>

<span class="k">cimport</span> <span class="nn">cqueue</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Queue</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cqueue</span>.<span class="kt">Queue</span>* <span class="nf">_c_queue</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="o">=</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_new</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>
</pre></div>
</div>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td>In the specific case of a <code class="docutils literal notranslate"><span class="pre">MemoryError</span></code>, creating a new
exception instance in order to raise it may actually fail because
we are running out of memory.  Luckily, CPython provides a C-API
function <code class="docutils literal notranslate"><span class="pre">PyErr_NoMemory()</span></code> that safely raises the right
exception for us.  Cython automatically
substitutes this C-API call whenever you write <code class="docutils literal notranslate"><span class="pre">raise</span>
<span class="pre">MemoryError</span></code> or <code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">MemoryError()</span></code>.  If you use an older
version, you have to cimport the C-API function from the standard
package <code class="docutils literal notranslate"><span class="pre">cpython.exc</span></code> and call it directly.</td></tr>
</tbody>
</table>
<p>The next thing to do is to clean up when the Queue instance is no
longer used (i.e. all references to it have been deleted).  To this
end, CPython provides a callback that Cython makes available as a
special method <code class="docutils literal notranslate"><span class="pre">__dealloc__()</span></code>.  In our case, all we have to do is
to free the C Queue, but only if we succeeded in initialising it in
the init method:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__dealloc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span><span class="p">:</span>
        <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="compiling-and-linking">
<h4>Compiling and linking<a class="headerlink" href="#compiling-and-linking" title="Permalink to this headline">¶</a></h4>
<p>At this point, we have a working Cython module that we can test.  To
compile it, we need to configure a <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script for distutils.
Here is the most basic script for compiling a Cython module:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">distutils.extension</span> <span class="k">import</span> <span class="n">Extension</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">([</span><span class="n">Extension</span><span class="p">(</span><span class="s">&quot;queue&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;queue.pyx&quot;</span><span class="p">])])</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To build against the external C library, we need to make sure Cython finds the necessary libraries.
There are two ways to archive this. First we can tell distutils where to find
the c-source to compile the <code class="file docutils literal notranslate"><span class="pre">queue.c</span></code> implementation automatically. Alternatively,
we can build and install C-Alg as system library and dynamically link it. The latter is useful
if other applications also use C-Alg.</p>
<div class="section" id="static-linking">
<h5>Static Linking<a class="headerlink" href="#static-linking" title="Permalink to this headline">¶</a></h5>
<p>To build the c-code automatically we need to include compiler directives in <cite>queue.pyx</cite>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: sources = c-algorithms/src/queue.c</span>
<span class="c"># distutils: include_dirs = c-algorithms/src/</span>

<span class="k">cimport</span> <span class="nn">cqueue</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Queue</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cqueue</span>.<span class="kt">Queue</span>* <span class="nf">_c_queue</span>
    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="o">=</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_new</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__dealloc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span><span class="p">:</span>
            <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sources</span></code> compiler directive gives the path of the C
files that distutils is going to compile and
link (statically) into the resulting extension module.
In general all relevant header files should be found in <code class="docutils literal notranslate"><span class="pre">include_dirs</span></code>.
Now we can build the project using:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">build_ext</span> <span class="o">-</span><span class="n">i</span>
</pre></div>
</div>
<p>And test whether our build was successful:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">&#39;import queue; Q = queue.Queue()&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="dynamic-linking">
<h5>Dynamic Linking<a class="headerlink" href="#dynamic-linking" title="Permalink to this headline">¶</a></h5>
<p>Dynamic linking is useful, if the library we are going to wrap is already
installed on the system. To perform dynamic linking we first need to
build and install c-alg.</p>
<p>To build c-algorithms on your system:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cd</span> <span class="n">c</span><span class="o">-</span><span class="n">algorithms</span>
<span class="err">$</span> <span class="n">sh</span> <span class="n">autogen</span><span class="o">.</span><span class="n">sh</span>
<span class="err">$</span> <span class="o">./</span><span class="n">configure</span>
<span class="err">$</span> <span class="n">make</span>
</pre></div>
</div>
<p>to install CAlg run:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">make</span> <span class="n">install</span>
</pre></div>
</div>
<p>Afterwards the file <code class="file docutils literal notranslate"><span class="pre">/usr/local/lib/libcalg.so</span></code> should exist.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This path applies to Linux systems and may be different on other platforms,
so you will need to adapt the rest of the tutorial depending on the path
where <code class="docutils literal notranslate"><span class="pre">libcalg.so</span></code> or <code class="docutils literal notranslate"><span class="pre">libcalg.dll</span></code> is on your system.</p>
</div>
<p>In this approach we need to tell the setup script to link with an external library.
To do so we need to extend the setup script to install change the extension setup from</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">([</span><span class="n">Extension</span><span class="p">(</span><span class="s">&quot;queue&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;queue.pyx&quot;</span><span class="p">])])</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">([</span>
    <span class="n">Extension</span><span class="p">(</span><span class="s">&quot;queue&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;queue.pyx&quot;</span><span class="p">],</span>
              <span class="n">libraries</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;calg&quot;</span><span class="p">])</span>
    <span class="p">])</span>
</pre></div>
</div>
<p>Now we should be able to build the project using:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">build_ext</span> <span class="o">-</span><span class="n">i</span>
</pre></div>
</div>
<p>If the <cite>libcalg</cite> is not installed in a ‘normal’ location, users can provide the
required parameters externally by passing appropriate C compiler
flags, such as:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">CFLAGS</span><span class="o">=</span><span class="s">&quot;-I/usr/local/otherdir/calg/include&quot;</span>  \
<span class="n">LDFLAGS</span><span class="o">=</span><span class="s">&quot;-L/usr/local/otherdir/calg/lib&quot;</span>     \
    <span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">build_ext</span> <span class="o">-</span><span class="n">i</span>
</pre></div>
</div>
<p>Before we run the module, we also need to make sure that <cite>libcalg</cite> is in
the <cite>LD_LIBRARY_PATH</cite> environment variable, e.g. by setting:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">export</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=</span><span class="err">$</span><span class="n">LD_LIBRARY_PATH</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span>
</pre></div>
</div>
<p>Once we have compiled the module for the first time, we can now import
it and instantiate a new Queue:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">export</span> <span class="n">PYTHONPATH</span><span class="o">=.</span>
<span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">&#39;import queue; Q = queue.Queue()&#39;</span>
</pre></div>
</div>
<p>However, this is all our Queue class can do so far, so let’s make it
more usable.</p>
</div>
<div class="section" id="mapping-functionality">
<h5>Mapping functionality<a class="headerlink" href="#mapping-functionality" title="Permalink to this headline">¶</a></h5>
<p>Before implementing the public interface of this class, it is good
practice to look at what interfaces Python offers, e.g. in its
<code class="docutils literal notranslate"><span class="pre">list</span></code> or <code class="docutils literal notranslate"><span class="pre">collections.deque</span></code> classes.  Since we only need a FIFO
queue, it’s enough to provide the methods <code class="docutils literal notranslate"><span class="pre">append()</span></code>, <code class="docutils literal notranslate"><span class="pre">peek()</span></code> and
<code class="docutils literal notranslate"><span class="pre">pop()</span></code>, and additionally an <code class="docutils literal notranslate"><span class="pre">extend()</span></code> method to add multiple
values at once.  Also, since we already know that all values will be
coming from C, it’s best to provide only <code class="docutils literal notranslate"><span class="pre">cdef</span></code> methods for now, and
to give them a straight C interface.</p>
<p>In C, it is common for data structures to store data as a <code class="docutils literal notranslate"><span class="pre">void*</span></code> to
whatever data item type.  Since we only want to store <code class="docutils literal notranslate"><span class="pre">int</span></code> values,
which usually fit into the size of a pointer type, we can avoid
additional memory allocations through a trick: we cast our <code class="docutils literal notranslate"><span class="pre">int</span></code> values
to <code class="docutils literal notranslate"><span class="pre">void*</span></code> and vice versa, and store the value directly as the
pointer value.</p>
<p>Here is a simple implementation for the <code class="docutils literal notranslate"><span class="pre">append()</span></code> method:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_push_tail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, the same error handling considerations as for the
<code class="docutils literal notranslate"><span class="pre">__cinit__()</span></code> method apply, so that we end up with this
implementation instead:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_push_tail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">,</span>
                                  <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span><span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>
</pre></div>
</div>
<p>Adding an <code class="docutils literal notranslate"><span class="pre">extend()</span></code> method should now be straight forward:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">values</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Append all ints to the queue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">value</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[:</span><span class="n">count</span><span class="p">]:</span>  <span class="c"># Slicing pointer to limit the iteration boundaries.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>This becomes handy when reading values from a C array, for example.</p>
<p>So far, we can only add data to the queue.  The next step is to write
the two methods to get the first element: <code class="docutils literal notranslate"><span class="pre">peek()</span></code> and <code class="docutils literal notranslate"><span class="pre">pop()</span></code>,
which provide read-only and destructive read access respectively.
To avoid compiler warnings when casting <code class="docutils literal notranslate"><span class="pre">void*</span></code> to <code class="docutils literal notranslate"><span class="pre">int</span></code> directly,
we use an intermediate data type that is big enough to hold a <code class="docutils literal notranslate"><span class="pre">void*</span></code>.
Here, <code class="docutils literal notranslate"><span class="pre">Py_ssize_t</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="n">Py_ssize_t</span><span class="o">&gt;</span><span class="n">cqueue</span><span class="o">.</span><span class="n">queue_peek_head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="n">Py_ssize_t</span><span class="o">&gt;</span><span class="n">cqueue</span><span class="o">.</span><span class="n">queue_pop_head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>
</pre></div>
</div>
<p>Normally, in C, we risk losing data when we convert a larger integer type
to a smaller integer type without checking the boundaries, and <code class="docutils literal notranslate"><span class="pre">Py_ssize_t</span></code>
may be a larger type than <code class="docutils literal notranslate"><span class="pre">int</span></code>.  But since we control how values are added
to the queue, we already know that all values that are in the queue fit into
an <code class="docutils literal notranslate"><span class="pre">int</span></code>, so the above conversion from <code class="docutils literal notranslate"><span class="pre">void*</span></code> to <code class="docutils literal notranslate"><span class="pre">Py_ssize_t</span></code> to <code class="docutils literal notranslate"><span class="pre">int</span></code>
(the return type) is safe by design.</p>
</div>
<div class="section" id="handling-errors">
<h5>Handling errors<a class="headerlink" href="#handling-errors" title="Permalink to this headline">¶</a></h5>
<p>Now, what happens when the queue is empty?  According to the
documentation, the functions return a <code class="docutils literal notranslate"><span class="pre">NULL</span></code> pointer, which is
typically not a valid value.  But since we are simply casting to and
from ints, we cannot distinguish anymore if the return value was
<code class="docutils literal notranslate"><span class="pre">NULL</span></code> because the queue was empty or because the value stored in
the queue was <code class="docutils literal notranslate"><span class="pre">0</span></code>.  In Cython code, we want the first case to
raise an exception, whereas the second case should simply return
<code class="docutils literal notranslate"><span class="pre">0</span></code>.  To deal with this, we need to special case this value,
and check if the queue really is empty or not:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">except</span><span class="o">?</span> <span class="o">-</span><span class="mf">1</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">value</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Py_ssize_t</span><span class="o">&gt;</span><span class="n">cqueue</span><span class="o">.</span><span class="n">queue_peek_head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
        <span class="c"># this may mean that the queue is empty, or</span>
        <span class="c"># that it happens to contain a 0 value</span>
        <span class="k">if</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&quot;Queue is empty&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
<p>Note how we have effectively created a fast path through the method in
the hopefully common cases that the return value is not <code class="docutils literal notranslate"><span class="pre">0</span></code>.  Only
that specific case needs an additional check if the queue is empty.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">except?</span> <span class="pre">-1</span></code> declaration in the method signature falls into the
same category.  If the function was a Python function returning a
Python object value, CPython would simply return <code class="docutils literal notranslate"><span class="pre">NULL</span></code> internally
instead of a Python object to indicate an exception, which would
immediately be propagated by the surrounding code.  The problem is
that the return type is <code class="docutils literal notranslate"><span class="pre">int</span></code> and any <code class="docutils literal notranslate"><span class="pre">int</span></code> value is a valid queue
item value, so there is no way to explicitly signal an error to the
calling code.  In fact, without such a declaration, there is no
obvious way for Cython to know what to return on exceptions and for
calling code to even know that this method <em>may</em> exit with an
exception.</p>
<p>The only way calling code can deal with this situation is to call
<code class="docutils literal notranslate"><span class="pre">PyErr_Occurred()</span></code> when returning from a function to check if an
exception was raised, and if so, propagate the exception.  This
obviously has a performance penalty.  Cython therefore allows you to
declare which value it should implicitly return in the case of an
exception, so that the surrounding code only needs to check for an
exception when receiving this exact value.</p>
<p>We chose to use <code class="docutils literal notranslate"><span class="pre">-1</span></code> as the exception return value as we expect it
to be an unlikely value to be put into the queue.  The question mark
in the <code class="docutils literal notranslate"><span class="pre">except?</span> <span class="pre">-1</span></code> declaration indicates that the return value is
ambiguous (there <em>may</em> be a <code class="docutils literal notranslate"><span class="pre">-1</span></code> value in the queue, after all) and
that an additional exception check using <code class="docutils literal notranslate"><span class="pre">PyErr_Occurred()</span></code> is
needed in calling code.  Without it, Cython code that calls this
method and receives the exception return value would silently (and
sometimes incorrectly) assume that an exception has been raised.  In
any case, all other return values will be passed through almost
without a penalty, thus again creating a fast path for ‘normal’
values.</p>
<p>Now that the <code class="docutils literal notranslate"><span class="pre">peek()</span></code> method is implemented, the <code class="docutils literal notranslate"><span class="pre">pop()</span></code> method
also needs adaptation.  Since it removes a value from the queue,
however, it is not enough to test if the queue is empty <em>after</em> the
removal.  Instead, we must test it on entry:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">except</span><span class="o">?</span> <span class="o">-</span><span class="mf">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&quot;Queue is empty&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="n">Py_ssize_t</span><span class="o">&gt;</span><span class="n">cqueue</span><span class="o">.</span><span class="n">queue_pop_head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>
</pre></div>
</div>
<p>The return value for exception propagation is declared exactly as for
<code class="docutils literal notranslate"><span class="pre">peek()</span></code>.</p>
<p>Lastly, we can provide the Queue with an emptiness indicator in the
normal Python way by implementing the <code class="docutils literal notranslate"><span class="pre">__bool__()</span></code> special method
(note that Python 2 calls this method <code class="docutils literal notranslate"><span class="pre">__nonzero__</span></code>, whereas Cython
code can use either name):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this method returns either <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> as we
declared the return type of the <code class="docutils literal notranslate"><span class="pre">queue_is_empty()</span></code> function as
<code class="docutils literal notranslate"><span class="pre">bint</span></code> in <code class="docutils literal notranslate"><span class="pre">cqueue.pxd</span></code>.</p>
</div>
<div class="section" id="testing-the-result">
<h5>Testing the result<a class="headerlink" href="#testing-the-result" title="Permalink to this headline">¶</a></h5>
<p>Now that the implementation is complete, you may want to write some
tests for it to make sure it works correctly.  Especially doctests are
very nice for this purpose, as they provide some documentation at the
same time.  To enable doctests, however, you need a Python API that
you can call.  C methods are not visible from Python code, and thus
not callable from doctests.</p>
<p>A quick way to provide a Python API for the class is to change the
methods from <code class="docutils literal notranslate"><span class="pre">cdef</span></code> to <code class="docutils literal notranslate"><span class="pre">cpdef</span></code>.  This will let Cython generate two
entry points, one that is callable from normal Python code using the
Python call semantics and Python objects as arguments, and one that is
callable from C code with fast C semantics and without requiring
intermediate argument conversion from or to Python types. Note that <code class="docutils literal notranslate"><span class="pre">cpdef</span></code>
methods ensure that they can be appropriately overridden by Python
methods even when they are called from Cython. This adds a tiny overhead
compared to <code class="docutils literal notranslate"><span class="pre">cdef</span></code> methods.</p>
<p>Now that we have both a C-interface and a Python interface for our
class, we should make sure that both interfaces are consistent.
Python users would expect an <code class="docutils literal notranslate"><span class="pre">extend()</span></code> method that accepts arbitrary
iterables, whereas C users would like to have one that allows passing
C arrays and C memory.  Both signatures are incompatible.</p>
<p>We will solve this issue by considering that in C, the API could also
want to support other input types, e.g. arrays of <code class="docutils literal notranslate"><span class="pre">long</span></code> or <code class="docutils literal notranslate"><span class="pre">char</span></code>,
which is usually supported with differently named C API functions such as
<code class="docutils literal notranslate"><span class="pre">extend_ints()</span></code>, <code class="docutils literal notranslate"><span class="pre">extend_longs()</span></code>, extend_chars()``, etc.  This allows
us to free the method name <code class="docutils literal notranslate"><span class="pre">extend()</span></code> for the duck typed Python method,
which can accept arbitrary iterables.</p>
<p>The following listing shows the complete implementation that uses
<code class="docutils literal notranslate"><span class="pre">cpdef</span></code> methods where possible:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># queue.pyx</span>

<span class="k">cimport</span> <span class="nn">cqueue</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Queue</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A queue class for C integer values.</span>

<span class="sd">    &gt;&gt;&gt; q = Queue()</span>
<span class="sd">    &gt;&gt;&gt; q.append(5)</span>
<span class="sd">    &gt;&gt;&gt; q.peek()</span>
<span class="sd">    5</span>
<span class="sd">    &gt;&gt;&gt; q.pop()</span>
<span class="sd">    5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">cdef</span> <span class="kt">cqueue</span>.<span class="kt">Queue</span>* <span class="nf">_c_queue</span>
    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="o">=</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_new</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__dealloc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span><span class="p">:</span>
            <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>

    <span class="k">cpdef</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_push_tail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">,</span>
                                      <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span> <span class="o">&lt;</span><span class="n">Py_ssize_t</span><span class="o">&gt;</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>

    <span class="c"># The `cpdef` feature is obviously not available for the original &quot;extend()&quot;</span>
    <span class="c"># method, as the method signature is incompatible with Python argument</span>
    <span class="c"># types (Python does not have pointers).  However, we can rename</span>
    <span class="c"># the C-ish &quot;extend()&quot; method to e.g. &quot;extend_ints()&quot;, and write</span>
    <span class="c"># a new &quot;extend()&quot; method that provides a suitable Python interface by</span>
    <span class="c"># accepting an arbitrary Python iterable.</span>
    <span class="k">cpdef</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">cdef</span> <span class="nf">extend_ints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">values</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">count</span><span class="p">):</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">value</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[:</span><span class="n">count</span><span class="p">]:</span>  <span class="c"># Slicing pointer to limit the iteration boundaries.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">except</span><span class="o">?</span> <span class="o">-</span><span class="mf">1</span><span class="p">:</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">value</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Py_ssize_t</span><span class="o">&gt;</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_peek_head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
            <span class="c"># this may mean that the queue is empty,</span>
            <span class="c"># or that it happens to contain a 0 value</span>
            <span class="k">if</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&quot;Queue is empty&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">except</span><span class="o">?</span> <span class="o">-</span><span class="mf">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&quot;Queue is empty&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">&lt;</span><span class="n">Py_ssize_t</span><span class="o">&gt;</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_pop_head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can test our Queue implementation using a python script,
for example here <code class="file docutils literal notranslate"><span class="pre">test_queue.py</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">import</span> <span class="nn">time</span>

<span class="k">import</span> <span class="nn">queue</span>

<span class="n">Q</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

<span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
<span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">20</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">peek</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
<span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Error message:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>  <span class="c"># Prints &quot;Queue is empty&quot;</span>

<span class="n">i</span> <span class="o">=</span> <span class="mf">10000</span>

<span class="n">values</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">Q</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="k">print</span><span class="p">(</span><span class="s">&quot;Adding {} items took {:1.3f} msecs.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mf">1000</span> <span class="o">*</span> <span class="n">end_time</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">41</span><span class="p">):</span>
    <span class="n">Q</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="n">Q</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;The answer is:&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
</pre></div>
</div>
<p>As a quick test with 10000 numbers on the author’s machine indicates,
using this Queue from Cython code with C <code class="docutils literal notranslate"><span class="pre">int</span></code> values is about five
times as fast as using it from Cython code with Python object values,
almost eight times faster than using it from Python code in a Python
loop, and still more than twice as fast as using Python’s highly
optimised <code class="docutils literal notranslate"><span class="pre">collections.deque</span></code> type from Cython code with Python
integers.</p>
</div>
<div class="section" id="callbacks">
<h5>Callbacks<a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h5>
<p>Let’s say you want to provide a way for users to pop values from the
queue up to a certain user defined event occurs.  To this end, you
want to allow them to pass a predicate function that determines when
to stop, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pop_until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">predicate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peek</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, let us assume for the sake of argument that the C queue
provides such a function that takes a C callback function as
predicate.  The API could look as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">C</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">a</span> <span class="n">predicate</span> <span class="n">function</span> <span class="n">that</span> <span class="n">takes</span> <span class="n">a</span> <span class="n">queue</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">returns</span>
 <span class="o">*</span> <span class="o">-</span><span class="mf">1</span> <span class="k">for</span> <span class="n">errors</span>
 <span class="o">*</span>  <span class="mf">0</span> <span class="k">for</span> <span class="n">reject</span>
 <span class="o">*</span>  <span class="mf">1</span> <span class="k">for</span> <span class="n">accept</span>
 <span class="o">*/</span>
<span class="n">typedef</span> <span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">predicate_func</span><span class="p">)(</span><span class="n">void</span><span class="o">*</span> <span class="n">user_context</span><span class="p">,</span> <span class="n">QueueValue</span> <span class="n">data</span><span class="p">);</span>

<span class="o">/*</span> <span class="n">Pop</span> <span class="n">values</span> <span class="k">as</span> <span class="nb">long</span> <span class="k">as</span> <span class="n">the</span> <span class="n">predicate</span> <span class="n">evaluates</span> <span class="n">to</span> <span class="n">true</span> <span class="k">for</span> <span class="n">them</span><span class="p">,</span>
 <span class="o">*</span> <span class="n">returns</span> <span class="o">-</span><span class="mf">1</span> <span class="k">if</span> <span class="n">the</span> <span class="n">predicate</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">an</span> <span class="n">error</span> <span class="ow">and</span> <span class="mf">0</span> <span class="n">otherwise</span><span class="o">.</span>
 <span class="o">*/</span>
<span class="nb">int</span> <span class="n">queue_pop_head_until</span><span class="p">(</span><span class="n">Queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="n">predicate_func</span> <span class="n">predicate</span><span class="p">,</span>
                         <span class="n">void</span><span class="o">*</span> <span class="n">user_context</span><span class="p">);</span>
</pre></div>
</div>
<p>It is normal for C callback functions to have a generic <code class="xref c c-type docutils literal notranslate"><span class="pre">void*</span></code>
argument that allows passing any kind of context or state through the
C-API into the callback function.  We will use this to pass our Python
predicate function.</p>
<p>First, we have to define a callback function with the expected
signature that we can pass into the C-API function:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">evaluate_predicate</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">context</span><span class="p">,</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">QueueValue</span> <span class="n">value</span><span class="p">):</span>
    <span class="s">&quot;Callback function that can be passed as predicate_func&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># recover Python function object from void* argument</span>
        <span class="n">func</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span><span class="n">context</span>
        <span class="c"># call function, convert result into 0/1 for True/False</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">func</span><span class="p">(&lt;</span><span class="kt">int</span><span class="p">&gt;</span><span class="n">value</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># catch any Python errors and return error indicator</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1</span>
</pre></div>
</div>
<p>The main idea is to pass a pointer (a.k.a. borrowed reference) to the
function object as the user context argument. We will call the C-API
function as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pop_until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">python_predicate_function</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cqueue</span><span class="o">.</span><span class="n">queue_pop_head_until</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c_queue</span><span class="p">,</span> <span class="n">evaluate_predicate</span><span class="p">,</span>
        <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span><span class="n">python_predicate_function</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;an error occurred&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The usual pattern is to first cast the Python object reference into
a <code class="xref c c-type docutils literal notranslate"><span class="pre">void*</span></code> to pass it into the C-API function, and then cast
it back into a Python object in the C predicate callback function.
The cast to <code class="xref c c-type docutils literal notranslate"><span class="pre">void*</span></code> creates a borrowed reference.  On the cast
to <code class="docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code>, Cython increments the reference count of the object
and thus converts the borrowed reference back into an owned reference.
At the end of the predicate function, the owned reference goes out
of scope again and Cython discards it.</p>
<p>The error handling in the code above is a bit simplistic. Specifically,
any exceptions that the predicate function raises will essentially be
discarded and only result in a plain <code class="docutils literal notranslate"><span class="pre">RuntimeError()</span></code> being raised
after the fact.  This can be improved by storing away the exception
in an object passed through the context parameter and re-raising it
after the C-API function has returned <code class="docutils literal notranslate"><span class="pre">-1</span></code> to indicate the error.</p>
</div>
</div>
</div>
<span id="document-src/tutorial/cdef_classes"></span><div class="section" id="extension-types-aka-cdef-classes">
<h3>Extension types (aka. cdef classes)<a class="headerlink" href="#extension-types-aka-cdef-classes" title="Permalink to this headline">¶</a></h3>
<p>To support object-oriented programming, Cython supports writing normal
Python classes exactly as in Python:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MathFunction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">operator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">operator</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">operands</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">(</span><span class="o">*</span><span class="n">operands</span><span class="p">)</span>
</pre></div>
</div>
<p>Based on what Python calls a “built-in type”, however, Cython supports
a second kind of class: <em>extension types</em>, sometimes referred to as
“cdef classes” due to the keywords used for their declaration.  They
are somewhat restricted compared to Python classes, but are generally
more memory efficient and faster than generic Python classes.  The
main difference is that they use a C struct to store their fields and methods
instead of a Python dict.  This allows them to store arbitrary C types
in their fields without requiring a Python wrapper for them, and to
access fields and methods directly at the C level without passing
through a Python dictionary lookup.</p>
<p>Normal Python classes can inherit from cdef classes, but not the other
way around.  Cython requires to know the complete inheritance
hierarchy in order to lay out their C structs, and restricts it to
single inheritance.  Normal Python classes, on the other hand, can
inherit from any number of Python classes and extension types, both in
Cython code and pure Python code.</p>
<p>So far our integration example has not been very useful as it only
integrates a single hard-coded function. In order to remedy this,
with hardly sacrificing speed, we will use a cdef class to represent a
function on floating point numbers:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Function</span><span class="p">:</span>
    <span class="k">cpdef</span> <span class="kt">double</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">except</span> <span class="o">*</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0</span>
</pre></div>
</div>
<p>The directive cpdef makes two versions of the method available; one
fast for use from Cython and one slower for use from Python. Then:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sin</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Function</span><span class="p">:</span>
    <span class="k">cpdef</span> <span class="kt">double</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">except</span> <span class="o">*</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">SinOfSquareFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="k">cpdef</span> <span class="kt">double</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">except</span> <span class="o">*</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mf">2</span><span class="p">)</span>
</pre></div>
</div>
<p>This does slightly more than providing a python wrapper for a cdef
method: unlike a cdef method, a cpdef method is fully overridable by
methods and instance attributes in Python subclasses.  It adds a
little calling overhead compared to a cdef method.</p>
<p>To make the class definitions visible to other modules, and thus allow for
efficient C-level usage and inheritance outside of the module that
implements them, we define them in a <code class="file docutils literal notranslate"><span class="pre">sin_of_square.pxd</span></code> file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Function</span><span class="p">:</span>
    <span class="k">cpdef</span> <span class="kt">double</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">except</span> <span class="o">*</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">SinOfSquareFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="k">cpdef</span> <span class="kt">double</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">except</span> <span class="o">*</span>
</pre></div>
</div>
<p>Using this, we can now change our integration example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">sin_of_square</span> <span class="k">cimport</span> <span class="n">Function</span><span class="p">,</span> <span class="n">SinOfSquareFunction</span>

<span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="n">Function</span> <span class="n">f</span><span class="p">,</span> <span class="n">double</span> <span class="n">a</span><span class="p">,</span> <span class="n">double</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">s</span><span class="p">,</span> <span class="nf">dx</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;f cannot be None&quot;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span> <span class="o">*</span> <span class="n">dx</span>

<span class="k">print</span><span class="p">(</span><span class="n">integrate</span><span class="p">(</span><span class="n">SinOfSquareFunction</span><span class="p">(),</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">10000</span><span class="p">))</span>
</pre></div>
</div>
<p>This is almost as fast as the previous code, however it is much more flexible
as the function to integrate can be changed. We can even pass in a new
function defined in Python-space:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">integrate</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">MyPolynomial</span><span class="p">(</span><span class="n">integrate</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">return</span> <span class="mf">2</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mf">3</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="mf">10</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">integrate</span><span class="p">(</span><span class="n">MyPolynomial</span><span class="p">(),</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">10000</span><span class="p">)</span>
<span class="o">-</span><span class="mf">7.8335833300000077</span>
</pre></div>
</div>
<p>This is about 20 times slower, but still about 10 times faster than
the original Python-only integration code.  This shows how large the
speed-ups can easily be when whole loops are moved from Python code
into a Cython module.</p>
<p>Some notes on our new implementation of <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li>The fast method dispatch here only works because <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> was
declared in <code class="docutils literal notranslate"><span class="pre">Function</span></code>. Had <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> been introduced in
<code class="docutils literal notranslate"><span class="pre">SinOfSquareFunction</span></code>, the code would still work, but Cython
would have used the slower Python method dispatch mechanism
instead.</li>
<li>In the same way, had the argument <code class="docutils literal notranslate"><span class="pre">f</span></code> not been typed, but only
been passed as a Python object, the slower Python dispatch would
be used.</li>
<li>Since the argument is typed, we need to check whether it is
<code class="docutils literal notranslate"><span class="pre">None</span></code>. In Python, this would have resulted in an <code class="docutils literal notranslate"><span class="pre">AttributeError</span></code>
when the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> method was looked up, but Cython would instead
try to access the (incompatible) internal structure of <code class="docutils literal notranslate"><span class="pre">None</span></code> as if
it were a <code class="docutils literal notranslate"><span class="pre">Function</span></code>, leading to a crash or data corruption.</li>
</ul>
</div></blockquote>
<p>There is a <em>compiler directive</em> <code class="docutils literal notranslate"><span class="pre">nonecheck</span></code> which turns on checks
for this, at the cost of decreased speed. Here’s how compiler directives
are used to dynamically switch on or off <code class="docutils literal notranslate"><span class="pre">nonecheck</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: nonecheck=True</span>
<span class="c">#        ^^^ Turns on nonecheck globally</span>

<span class="k">import</span> <span class="nn">cython</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">MyClass</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c"># Turn off nonecheck locally for the function</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">MyClass</span> <span class="nf">obj</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Turn nonecheck on again for a block</span>
        <span class="k">with</span> <span class="n">cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">myfunc</span><span class="p">())</span>  <span class="c"># Raises exception</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">myfunc</span><span class="p">())</span>  <span class="c"># Hope for a crash!</span>
</pre></div>
</div>
<p>Attributes in cdef classes behave differently from attributes in regular classes:</p>
<blockquote>
<div><ul class="simple">
<li>All attributes must be pre-declared at compile-time</li>
<li>Attributes are by default only accessible from Cython (typed access)</li>
<li>Properties can be declared to expose dynamic attributes to Python-space</li>
</ul>
</div></blockquote>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">sin_of_square</span> <span class="k">cimport</span> <span class="n">Function</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">WaveFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>

    <span class="c"># Not available in Python-space:</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">offset</span>

    <span class="c"># Available in Python-space:</span>
    <span class="k">cdef</span> <span class="kr">public</span> <span class="kt">double</span> <span class="nf">freq</span>

    <span class="c"># Available in Python-space, but only for reading:</span>
    <span class="k">cdef</span> <span class="kr">readonly</span> <span class="kt">double</span> <span class="nf">scale</span>

    <span class="c"># Available in Python-space:</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">period</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>

    <span class="nd">@period</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">value</span>
</pre></div>
</div>
</div>
<span id="document-src/tutorial/pxd_files"></span><div class="section" id="pxd-files">
<span id="id1"></span><h3>pxd files<a class="headerlink" href="#pxd-files" title="Permalink to this headline">¶</a></h3>
<p>In addition to the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> source files, Cython uses <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files
which work like C header files – they contain Cython declarations
(and sometimes code sections) which are only meant for inclusion by
Cython modules.  A <code class="docutils literal notranslate"><span class="pre">pxd</span></code> file is imported into a <code class="docutils literal notranslate"><span class="pre">pyx</span></code> module by
using the <code class="docutils literal notranslate"><span class="pre">cimport</span></code> keyword.</p>
<p><code class="docutils literal notranslate"><span class="pre">pxd</span></code> files have many use-cases:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">They can be used for sharing external C declarations.</p>
</li>
<li><p class="first">They can contain functions which are well suited for inlining by
the C compiler. Such functions should be marked <code class="docutils literal notranslate"><span class="pre">inline</span></code>, example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">int_min</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">a</span> <span class="k">else</span> <span class="n">a</span>
</pre></div>
</div>
</li>
<li><p class="first">When accompanying an equally named <code class="docutils literal notranslate"><span class="pre">pyx</span></code> file, they
provide a Cython interface to the Cython module so that other
Cython modules can communicate with it using a more efficient
protocol than the Python one.</p>
</li>
</ol>
</div></blockquote>
<p>In our integration example, we might break it up into <code class="docutils literal notranslate"><span class="pre">pxd</span></code> files like this:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Add a <code class="docutils literal notranslate"><span class="pre">cmath.pxd</span></code> function which defines the C functions available from
the C <code class="docutils literal notranslate"><span class="pre">math.h</span></code> header file, like <code class="docutils literal notranslate"><span class="pre">sin</span></code>. Then one would simply do
<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">cmath</span> <span class="pre">cimport</span> <span class="pre">sin</span></code> in <code class="docutils literal notranslate"><span class="pre">integrate.pyx</span></code>.</p>
</li>
<li><p class="first">Add a <code class="docutils literal notranslate"><span class="pre">integrate.pxd</span></code> so that other modules written in Cython
can define fast custom functions to integrate.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Function</span><span class="p">:</span>
    <span class="k">cpdef</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">double</span> <span class="n">x</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">integrate</span><span class="p">(</span><span class="n">Function</span> <span class="n">f</span><span class="p">,</span> <span class="n">double</span> <span class="n">a</span><span class="p">,</span>
                <span class="n">double</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that if you have a cdef class with attributes, the attributes must
be declared in the class declaration <code class="docutils literal notranslate"><span class="pre">pxd</span></code> file (if you use one), not
the <code class="docutils literal notranslate"><span class="pre">pyx</span></code> file. The compiler will tell you about this.</p>
</li>
</ol>
</div></blockquote>
</div>
<span id="document-src/tutorial/caveats"></span><div class="section" id="caveats">
<h3>Caveats<a class="headerlink" href="#caveats" title="Permalink to this headline">¶</a></h3>
<p>Since Cython mixes C and Python semantics, some things may be a bit
surprising or unintuitive. Work always goes on to make Cython more natural
for Python users, so this list may change in the future.</p>
<blockquote>
<div><ul class="simple">
<li>Given two typed <code class="docutils literal notranslate"><span class="pre">int</span></code> variables <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>, <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">%</span> <span class="pre">b</span></code> has the
same sign as the second argument (following Python semantics) rather than
having the same sign as the first (as in C).  The C behavior can be
obtained, at some speed gain, by enabling the cdivision directive
(versions prior to Cython 0.12 always followed C semantics).</li>
<li>Care is needed with unsigned types. <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">unsigned</span> <span class="pre">n</span> <span class="pre">=</span> <span class="pre">10;</span>
<span class="pre">print(range(-n,</span> <span class="pre">n))</span></code> will print an empty list, since <code class="docutils literal notranslate"><span class="pre">-n</span></code> wraps
around to a large positive integer prior to being passed to the
<code class="docutils literal notranslate"><span class="pre">range</span></code> function.</li>
<li>Python’s <code class="docutils literal notranslate"><span class="pre">float</span></code> type actually wraps C <code class="docutils literal notranslate"><span class="pre">double</span></code> values, and
the <code class="docutils literal notranslate"><span class="pre">int</span></code> type in Python 2.x wraps C <code class="docutils literal notranslate"><span class="pre">long</span></code> values.</li>
</ul>
</div></blockquote>
</div>
<span id="document-src/tutorial/profiling_tutorial"></span><div class="section" id="profiling">
<span id="id1"></span><h3>Profiling<a class="headerlink" href="#profiling" title="Permalink to this headline">¶</a></h3>
<p>This part describes the profiling abilities of Cython. If you are familiar
with profiling pure Python code, you can only read the first section
(<a class="reference internal" href="#profiling-basics"><span class="std std-ref">Cython Profiling Basics</span></a>). If you are not familiar with Python profiling you
should also read the tutorial (<a class="reference internal" href="#profiling-tutorial"><span class="std std-ref">Profiling Tutorial</span></a>) which takes you
through a complete example step by step.</p>
<div class="section" id="cython-profiling-basics">
<span id="profiling-basics"></span><h4>Cython Profiling Basics<a class="headerlink" href="#cython-profiling-basics" title="Permalink to this headline">¶</a></h4>
<p>Profiling in Cython is controlled by a compiler directive.
It can be set either for an entire file or on a per function basis
via a Cython decorator.</p>
<div class="section" id="enabling-profiling-for-a-complete-source-file">
<h5>Enabling profiling for a complete source file<a class="headerlink" href="#enabling-profiling-for-a-complete-source-file" title="Permalink to this headline">¶</a></h5>
<p>Profiling is enabled for a complete source file via a global directive to the
Cython compiler at the top of a file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: profile=True</span>
</pre></div>
</div>
<p>Note that profiling gives a slight overhead to each function call therefore making
your program a little slower (or a lot, if you call some small functions very
often).</p>
<p>Once enabled, your Cython code will behave just like Python code when called
from the cProfile module. This means you can just profile your Cython code
together with your Python code using the same tools as for Python code alone.</p>
</div>
<div class="section" id="disabling-profiling-function-wise">
<h5>Disabling profiling function wise<a class="headerlink" href="#disabling-profiling-function-wise" title="Permalink to this headline">¶</a></h5>
<p>If your profiling is messed up because of the call overhead to some small
functions that you rather do not want to see in your profile - either because
you plan to inline them anyway or because you are sure that you can’t make them
any faster - you can use a special decorator to disable profiling for one
function only (regardless of whether it is globally enabled or not):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">cython</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_often_called_function</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="enabling-line-tracing">
<h5>Enabling line tracing<a class="headerlink" href="#enabling-line-tracing" title="Permalink to this headline">¶</a></h5>
<p>To get more detailed trace information (for tools that can make use of it),
you can enable line tracing:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: linetrace=True</span>
</pre></div>
</div>
<p>This will also enable profiling support, so the above <code class="docutils literal notranslate"><span class="pre">profile=True</span></code> option
is not needed.  Line tracing is needed for coverage analysis, for example.</p>
<p>Note that even if line tracing is enabled via the compiler directive, it is
not used by default.  As the runtime slowdown can be substantial, it must
additionally be compiled in by the C compiler by setting the C macro definition
<code class="docutils literal notranslate"><span class="pre">CYTHON_TRACE=1</span></code>.  To include nogil functions in the trace, set
<code class="docutils literal notranslate"><span class="pre">CYTHON_TRACE_NOGIL=1</span></code> (which implies <code class="docutils literal notranslate"><span class="pre">CYTHON_TRACE=1</span></code>).  C macros can be
defined either in the extension definition of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script or by
setting the respective distutils options in the source file with the following
file header comment (if <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code> is used for compilation):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: define_macros=CYTHON_TRACE_NOGIL=1</span>
</pre></div>
</div>
</div>
<div class="section" id="enabling-coverage-analysis">
<h5>Enabling coverage analysis<a class="headerlink" href="#enabling-coverage-analysis" title="Permalink to this headline">¶</a></h5>
<p>Since Cython 0.23, line tracing (see above) also enables support for coverage
reporting with the <a class="reference external" href="https://coverage.readthedocs.io/">coverage.py</a> tool. To
make the coverage analysis understand Cython modules, you also need to enable
Cython’s coverage plugin in your <code class="docutils literal notranslate"><span class="pre">.coveragerc</span></code> file as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[run]</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">Cython.Coverage</span>
</pre></div>
</div>
<p>With this plugin, your Cython source files should show up normally in the
coverage reports.</p>
<p>To include the coverage report in the Cython annotated HTML file, you need
to first run the coverage.py tool to generate an XML result file.  Pass
this file into the <code class="docutils literal notranslate"><span class="pre">cython</span></code> command as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cython  --annotate-coverage coverage.xml  package/mymodule.pyx
</pre></div>
</div>
<p>This will recompile the Cython module and generate one HTML output
file next to each Cython source file it processes, containing colour
markers for lines that were contained in the coverage report.</p>
</div>
</div>
<div class="section" id="profiling-tutorial">
<span id="id2"></span><h4>Profiling Tutorial<a class="headerlink" href="#profiling-tutorial" title="Permalink to this headline">¶</a></h4>
<p>This will be a complete tutorial, start to finish, of profiling Python code,
turning it into Cython code and keep profiling until it is fast enough.</p>
<p>As a toy example, we would like to evaluate the summation of the reciprocals of
squares up to a certain integer <img class="math" src="_images/math/e11f2701c4a39c7fe543a6c4150b421d50f1c159.svg" alt="n"/> for evaluating <img class="math" src="_images/math/b7793e4f08d00aca47e272dcdfeb70f933dac222.svg" alt="\pi"/>. The
relation we want to use has been proven by Euler in 1735 and is known as the
<a class="reference external" href="https://en.wikipedia.org/wiki/Basel_problem">Basel problem</a>.</p>
<div class="math">
<p><img src="_images/math/8da74203ebed7fcb0313f76657e96f03bc34d8c1.svg" alt="\pi^2 = 6 \sum_{k=1}^{\infty} \frac{1}{k^2} =
6 \lim_{k \to \infty} \big( \frac{1}{1^2} +
      \frac{1}{2^2} + \dots + \frac{1}{k^2}  \big) \approx
6 \big( \frac{1}{1^2} + \frac{1}{2^2} + \dots + \frac{1}{n^2}  \big)"/></p>
</div><p>A simple Python code for evaluating the truncated sum looks like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># calc_pi.py</span>

<span class="k">def</span> <span class="nf">recip_square</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">i</span> <span class="o">**</span> <span class="mf">2</span>

<span class="k">def</span> <span class="nf">approx_pi</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mf">10000000</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">1</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">recip_square</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">6</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="o">**</span> <span class="o">.</span><span class="mf">5</span>
</pre></div>
</div>
<p>On my box, this needs approximately 4 seconds to run the function with the
default n. The higher we choose n, the better will be the approximation for
<img class="math" src="_images/math/b7793e4f08d00aca47e272dcdfeb70f933dac222.svg" alt="\pi"/>. An experienced Python programmer will already see plenty of
places to optimize this code. But remember the golden rule of optimization:
Never optimize without having profiled. Let me repeat this: <strong>Never</strong> optimize
without having profiled your code. Your thoughts about which part of your
code takes too much time are wrong. At least, mine are always wrong. So let’s
write a short script to profile our code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># profile.py</span>

<span class="k">import</span> <span class="nn">pstats</span><span class="o">,</span> <span class="nn">cProfile</span>

<span class="k">import</span> <span class="nn">calc_pi</span>

<span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s">&quot;calc_pi.approx_pi()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="s">&quot;Profile.prof&quot;</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="s">&quot;Profile.prof&quot;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">strip_dirs</span><span class="p">()</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
</pre></div>
</div>
<p>Running this on my box gives the following output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Sat Nov  7 17:40:54 2009    Profile.prof

         10000004 function calls in 6.211 CPU seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    3.243    3.243    6.211    6.211 calc_pi.py:7(approx_pi)
 10000000    2.526    0.000    2.526    0.000 calc_pi.py:4(recip_square)
        1    0.442    0.442    0.442    0.442 {range}
        1    0.000    0.000    6.211    6.211 &lt;string&gt;:1(&lt;module&gt;)
        1    0.000    0.000    0.000    0.000 {method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects}
</pre></div>
</div>
<p>This contains the information that the code runs in 6.2 CPU seconds. Note that
the code got slower by 2 seconds because it ran inside the cProfile module. The
table contains the real valuable information.  You might want to check the
Python <a class="reference external" href="https://docs.python.org/library/profile.html">profiling documentation</a>
for the nitty gritty details. The most important columns here are totime (total
time spent in this function <strong>not</strong> counting functions that were called by this
function) and cumtime (total time spent in this function <strong>also</strong> counting the
functions called by this function). Looking at the tottime column, we see that
approximately half the time is spent in approx_pi and the other half is spent
in recip_square. Also half a second is spent in range … of course we should
have used xrange for such a big iteration. And in fact, just changing range to
xrange makes the code run in 5.8 seconds.</p>
<p>We could optimize a lot in the pure Python version, but since we are interested
in Cython, let’s move forward and bring this module to Cython. We would do this
anyway at some time to get the loop run faster. Here is our first Cython version:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: profile=True</span>

<span class="c"># calc_pi.pyx</span>

<span class="k">def</span> <span class="nf">recip_square</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">i</span> <span class="o">**</span> <span class="mf">2</span>

<span class="k">def</span> <span class="nf">approx_pi</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="o">=</span><span class="mf">10000000</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">val</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">k</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">1</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">recip_square</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">6</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="o">**</span> <span class="o">.</span><span class="mf">5</span>
</pre></div>
</div>
<p>Note the first line: We have to tell Cython that profiling should be enabled.
This makes the Cython code slightly slower, but without this we would not get
meaningful output from the cProfile module. The rest of the code is mostly
unchanged, I only typed some variables which will likely speed things up a bit.</p>
<p>We also need to modify our profiling script to import the Cython module directly.
Here is the complete version adding the import of the <a class="reference internal" href="index.html#pyximport"><span class="std std-ref">Pyximport</span></a> module:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># profile.py</span>

<span class="k">import</span> <span class="nn">pstats</span><span class="o">,</span> <span class="nn">cProfile</span>

<span class="k">import</span> <span class="nn">pyximport</span>
<span class="n">pyximport</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>

<span class="k">import</span> <span class="nn">calc_pi</span>

<span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s">&quot;calc_pi.approx_pi()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="s">&quot;Profile.prof&quot;</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="s">&quot;Profile.prof&quot;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">strip_dirs</span><span class="p">()</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
</pre></div>
</div>
<p>We only added two lines, the rest stays completely the same. Alternatively, we could also
manually compile our code into an extension; we wouldn’t need to change the
profile script then at all. The script now outputs the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Sat Nov  7 18:02:33 2009    Profile.prof

         10000004 function calls in 4.406 CPU seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    3.305    3.305    4.406    4.406 calc_pi.pyx:7(approx_pi)
 10000000    1.101    0.000    1.101    0.000 calc_pi.pyx:4(recip_square)
        1    0.000    0.000    4.406    4.406 {calc_pi.approx_pi}
        1    0.000    0.000    4.406    4.406 &lt;string&gt;:1(&lt;module&gt;)
        1    0.000    0.000    0.000    0.000 {method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects}
</pre></div>
</div>
<p>We gained 1.8 seconds. Not too shabby. Comparing the output to the previous, we
see that recip_square function got faster while the approx_pi function has not
changed a lot. Let’s concentrate on the recip_square function a bit more. First
note, that this function is not to be called from code outside of our module;
so it would be wise to turn it into a cdef to reduce call overhead. We should
also get rid of the power operator: it is turned into a pow(i,2) function call by
Cython, but we could instead just write i*i which could be faster. The
whole function is also a good candidate for inlining.  Let’s look at the
necessary changes for these ideas:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: profile=True</span>

<span class="c"># calc_pi.pyx</span>

<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">double</span> <span class="nf">recip_square</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">approx_pi</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="o">=</span><span class="mf">10000000</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">val</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">k</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">1</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">recip_square</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">6</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="o">**</span> <span class="o">.</span><span class="mf">5</span>
</pre></div>
</div>
<p>Now running the profile script yields:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Sat Nov  7 18:10:11 2009    Profile.prof

         10000004 function calls in 2.622 CPU seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    1.782    1.782    2.622    2.622 calc_pi.pyx:7(approx_pi)
 10000000    0.840    0.000    0.840    0.000 calc_pi.pyx:4(recip_square)
        1    0.000    0.000    2.622    2.622 {calc_pi.approx_pi}
        1    0.000    0.000    2.622    2.622 &lt;string&gt;:1(&lt;module&gt;)
        1    0.000    0.000    0.000    0.000 {method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects}
</pre></div>
</div>
<p>That bought us another 1.8 seconds. Not the dramatic change we could have
expected. And why is recip_square still in this table; it is supposed to be
inlined, isn’t it?  The reason for this is that Cython still generates profiling code
even if the function call is eliminated. Let’s tell it to not
profile recip_square any more; we couldn’t get the function to be much faster anyway:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: profile=True</span>

<span class="c"># calc_pi.pyx</span>

<span class="k">cimport</span> <span class="nn">cython</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">double</span> <span class="nf">recip_square</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">approx_pi</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="o">=</span><span class="mf">10000000</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">val</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">k</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">1</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">recip_square</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">6</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="o">**</span> <span class="o">.</span><span class="mf">5</span>
</pre></div>
</div>
<p>Running this shows an interesting result:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Sat Nov  7 18:15:02 2009    Profile.prof

         4 function calls in 0.089 CPU seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    0.089    0.089    0.089    0.089 calc_pi.pyx:10(approx_pi)
        1    0.000    0.000    0.089    0.089 {calc_pi.approx_pi}
        1    0.000    0.000    0.089    0.089 &lt;string&gt;:1(&lt;module&gt;)
        1    0.000    0.000    0.000    0.000 {method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects}
</pre></div>
</div>
<p>First note the tremendous speed gain: this version only takes 1/50 of the time
of our first Cython version. Also note that recip_square has vanished from the
table like we wanted. But the most peculiar and import change is that
approx_pi also got much faster. This is a problem with all profiling: calling a
function in a profile run adds a certain overhead to the function call. This
overhead is <strong>not</strong> added to the time spent in the called function, but to the
time spent in the <strong>calling</strong> function. In this example, approx_pi didn’t need 2.622
seconds in the last run; but it called recip_square 10000000 times, each time taking a
little to set up profiling for it. This adds up to the massive time loss of
around 2.6 seconds. Having disabled profiling for the often called function now
reveals realistic timings for approx_pi; we could continue optimizing it now if
needed.</p>
<p>This concludes this profiling tutorial. There is still some room for
improvement in this code. We could try to replace the power operator in
approx_pi with a call to sqrt from the C stdlib; but this is not necessarily
faster than calling pow(x,0.5).</p>
<p>Even so, the result we achieved here is quite satisfactory: we came up with a
solution that is much faster then our original Python version while retaining
functionality and readability.</p>
</div>
</div>
<span id="document-src/tutorial/strings"></span><div class="section" id="unicode-and-passing-strings">
<h3>Unicode and passing strings<a class="headerlink" href="#unicode-and-passing-strings" title="Permalink to this headline">¶</a></h3>
<p>Similar to the string semantics in Python 3, Cython strictly separates
byte strings and unicode strings.  Above all, this means that by default
there is no automatic conversion between byte strings and unicode strings
(except for what Python 2 does in string operations).  All encoding and
decoding must pass through an explicit encoding/decoding step.  To ease
conversion between Python and C strings in simple cases, the module-level
<code class="docutils literal notranslate"><span class="pre">c_string_type</span></code> and <code class="docutils literal notranslate"><span class="pre">c_string_encoding</span></code> directives can be used to
implicitly insert these encoding/decoding steps.</p>
<div class="section" id="python-string-types-in-cython-code">
<h4>Python string types in Cython code<a class="headerlink" href="#python-string-types-in-cython-code" title="Permalink to this headline">¶</a></h4>
<p>Cython supports four Python string types: <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>,
<code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">basestring</span></code>.  The <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code> types
are the specific types known from normal Python 2.x (named <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a>
and <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> in Python 3).  Additionally, Cython also supports the
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytearray" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytearray</span></code></a> type which behaves like the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> type, except
that it is mutable.</p>
<p>The <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> type is special in that it is the byte string in Python 2
and the Unicode string in Python 3 (for Cython code compiled with
language level 2, i.e. the default).  Meaning, it always corresponds
exactly with the type that the Python runtime itself calls <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>.
Thus, in Python 2, both <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> and <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> represent the byte string
type, whereas in Python 3, both <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code> represent the
Python Unicode string type.  The switch is made at C compile time, the
Python version that is used to run Cython is not relevant.</p>
<p>When compiling Cython code with language level 3, the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> type is
identified with exactly the Unicode string type at Cython compile time,
i.e. it does not identify with <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> when running in Python 2.</p>
<p>Note that the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> type is not compatible with the <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code>
type in Python 2, i.e. you cannot assign a Unicode string to a variable
or argument that is typed <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>.  The attempt will result in either
a compile time error (if detectable) or a <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#TypeError" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">TypeError</span></code></a> exception at
runtime.  You should therefore be careful when you statically type a
string variable in code that must be compatible with Python 2, as this
Python version allows a mix of byte strings and unicode strings for data
and users normally expect code to be able to work with both.  Code that
only targets Python 3 can safely type variables and arguments as either
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> or <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code>.</p>
<p>The <code class="xref py py-obj docutils literal notranslate"><span class="pre">basestring</span></code> type represents both the types <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code>,
i.e. all Python text string types in Python 2 and Python 3.  This can be
used for typing text variables that normally contain Unicode text (at
least in Python 3) but must additionally accept the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> type in
Python 2 for backwards compatibility reasons.  It is not compatible with
the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> type.  Its usage should be rare in normal Cython code as
the generic <a class="reference external" href="https://docs.python.org/3/library/functions.html#object" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">object</span></code></a> type (i.e. untyped code) will normally be good
enough and has the additional advantage of supporting the assignment of
string subtypes.  Support for the <code class="xref py py-obj docutils literal notranslate"><span class="pre">basestring</span></code> type was added in Cython
0.20.</p>
</div>
<div class="section" id="string-literals">
<h4>String literals<a class="headerlink" href="#string-literals" title="Permalink to this headline">¶</a></h4>
<p>Cython understands all Python string type prefixes:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">b'bytes'</span></code> for byte strings</li>
<li><code class="docutils literal notranslate"><span class="pre">u'text'</span></code> for Unicode strings</li>
<li><code class="docutils literal notranslate"><span class="pre">f'formatted</span> <span class="pre">{value}'</span></code> for formatted Unicode string literals as defined by
<span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0498"><strong>PEP 498</strong></a> (added in Cython 0.24)</li>
</ul>
<p>Unprefixed string literals become <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> objects when compiling
with language level 2 and <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code> objects (i.e. Python 3
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) with language level 3.</p>
</div>
<div class="section" id="general-notes-about-c-strings">
<h4>General notes about C strings<a class="headerlink" href="#general-notes-about-c-strings" title="Permalink to this headline">¶</a></h4>
<p>In many use cases, C strings (a.k.a. character pointers) are slow
and cumbersome.  For one, they usually require manual memory
management in one way or another, which makes it more likely to
introduce bugs into your code.</p>
<p>Then, Python string objects cache their length, so requesting it
(e.g. to validate the bounds of index access or when concatenating
two strings into one) is an efficient constant time operation.
In contrast, calling <code class="xref c c-func docutils literal notranslate"><span class="pre">strlen()</span></code> to get this information
from a C string takes linear time, which makes many operations on
C strings rather costly.</p>
<p>Regarding text processing, Python has built-in support for Unicode,
which C lacks completely.  If you are dealing with Unicode text,
you are usually better off using Python Unicode string objects than
trying to work with encoded data in C strings.  Cython makes this
quite easy and efficient.</p>
<p>Generally speaking: unless you know what you are doing, avoid
using C strings where possible and use Python string objects instead.
The obvious exception to this is when passing them back and forth
from and to external C code.  Also, C++ strings remember their length
as well, so they can provide a suitable alternative to Python bytes
objects in some cases, e.g. when reference counting is not needed
within a well defined context.</p>
</div>
<div class="section" id="passing-byte-strings">
<h4>Passing byte strings<a class="headerlink" href="#passing-byte-strings" title="Permalink to this headline">¶</a></h4>
<p>we have dummy C functions declared in
a file called <code class="file docutils literal notranslate"><span class="pre">c_func.pyx</span></code> that we are going to reuse throughout this tutorial:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">malloc</span>
<span class="k">from</span> <span class="nn">libc.string</span> <span class="k">cimport</span> <span class="n">strcpy</span><span class="p">,</span> <span class="n">strlen</span>

<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">hello_world</span> <span class="o">=</span> <span class="s">&#39;hello world&#39;</span>
<span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">n</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">hello_world</span><span class="p">)</span>


<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_call_returning_a_c_string</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">char</span> <span class="o">*&gt;</span> <span class="n">malloc</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c_string</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">c_string</span><span class="p">,</span> <span class="n">hello_world</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c_string</span>


<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">get_a_c_string</span><span class="p">(</span><span class="n">char</span><span class="o">**</span> <span class="n">c_string_ptr</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="o">*</span><span class="n">length</span><span class="p">):</span>
    <span class="n">c_string_ptr</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">char</span> <span class="o">*&gt;</span> <span class="n">malloc</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c_string_ptr</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>

    <span class="n">strcpy</span><span class="p">(</span><span class="n">c_string_ptr</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">hello_world</span><span class="p">)</span>
    <span class="n">length</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
</pre></div>
</div>
<p>We make a corresponding <code class="file docutils literal notranslate"><span class="pre">c_func.pxd</span></code> to be able to cimport those functions:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_call_returning_a_c_string</span><span class="p">()</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">get_a_c_string</span><span class="p">(</span><span class="n">char</span><span class="o">**</span> <span class="n">c_string</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span>
</pre></div>
</div>
<p>It is very easy to pass byte strings between C code and Python.
When receiving a byte string from a C library, you can let Cython
convert it into a Python byte string by simply assigning it to a
Python variable:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">c_func</span> <span class="k">cimport</span> <span class="n">c_call_returning_a_c_string</span>

<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="n">c_call_returning_a_c_string</span><span class="p">()</span>
<span class="k">cdef</span> <span class="kt">bytes</span> <span class="nf">py_string</span> <span class="o">=</span> <span class="n">c_string</span>
</pre></div>
</div>
<p>A type cast to <a class="reference external" href="https://docs.python.org/3/library/functions.html#object" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">object</span></code></a> or <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> will do the same thing:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">py_string</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">bytes</span><span class="p">&gt;</span> <span class="n">c_string</span>
</pre></div>
</div>
<p>This creates a Python byte string object that holds a copy of the
original C string.  It can be safely passed around in Python code, and
will be garbage collected when the last reference to it goes out of
scope.  It is important to remember that null bytes in the string act
as terminator character, as generally known from C.  The above will
therefore only work correctly for C strings that do not contain null
bytes.</p>
<p>Besides not working for null bytes, the above is also very inefficient
for long strings, since Cython has to call <code class="xref c c-func docutils literal notranslate"><span class="pre">strlen()</span></code> on the
C string first to find out the length by counting the bytes up to the
terminating null byte.  In many cases, the user code will know the
length already, e.g. because a C function returned it.  In this case,
it is much more efficient to tell Cython the exact number of bytes by
slicing the C string. Here is an example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">free</span>
<span class="k">from</span> <span class="nn">c_func</span> <span class="k">cimport</span> <span class="n">get_a_c_string</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="bp">NULL</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">length</span> <span class="o">=</span> <span class="mf">0</span>

    <span class="c"># get pointer and length from a C function</span>
    <span class="n">get_a_c_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">py_bytes_string</span> <span class="o">=</span> <span class="n">c_string</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>  <span class="c"># Performs a copy of the data</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">free</span><span class="p">(</span><span class="n">c_string</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, no additional byte counting is required and <code class="docutils literal notranslate"><span class="pre">length</span></code> bytes from
the <code class="docutils literal notranslate"><span class="pre">c_string</span></code> will be copied into the Python bytes object, including
any null bytes.  Keep in mind that the slice indices are assumed to be
accurate in this case and no bounds checking is done, so incorrect
slice indices will lead to data corruption and crashes.</p>
<p>Note that the creation of the Python bytes string can fail with an
exception, e.g. due to insufficient memory.  If you need to
<code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> the string after the conversion, you should wrap
the assignment in a try-finally construct:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">free</span>
<span class="k">from</span> <span class="nn">c_func</span> <span class="k">cimport</span> <span class="n">c_call_returning_a_c_string</span>

<span class="k">cdef</span> <span class="kt">bytes</span> <span class="nf">py_string</span>
<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="n">c_call_returning_a_c_string</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">py_string</span> <span class="o">=</span> <span class="n">c_string</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">free</span><span class="p">(</span><span class="n">c_string</span><span class="p">)</span>
</pre></div>
</div>
<p>To convert the byte string back into a C <code class="xref c c-type docutils literal notranslate"><span class="pre">char*</span></code>, use the
opposite assignment:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">other_c_string</span> <span class="o">=</span> <span class="n">py_string</span>  <span class="c"># other_c_string is a 0-terminated string.</span>
</pre></div>
</div>
<p>This is a very fast operation after which <code class="docutils literal notranslate"><span class="pre">other_c_string</span></code> points to
the byte string buffer of the Python string itself.  It is tied to the
life time of the Python string.  When the Python string is garbage
collected, the pointer becomes invalid.  It is therefore important to
keep a reference to the Python string as long as the <code class="xref c c-type docutils literal notranslate"><span class="pre">char*</span></code>
is in use.  Often enough, this only spans the call to a C function that
receives the pointer as parameter.  Special care must be taken,
however, when the C function stores the pointer for later use.  Apart
from keeping a Python reference to the string object, no manual memory
management is required.</p>
<p>Starting with Cython 0.20, the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytearray" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytearray</span></code></a> type is supported and
coerces in the same way as the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> type.  However, when using it
in a C context, special care must be taken not to grow or shrink the
object buffer after converting it to a C string pointer.  These
modifications can change the internal buffer address, which will make
the pointer invalid.</p>
</div>
<div class="section" id="accepting-strings-from-python-code">
<h4>Accepting strings from Python code<a class="headerlink" href="#accepting-strings-from-python-code" title="Permalink to this headline">¶</a></h4>
<p>The other side, receiving input from Python code, may appear simple
at first sight, as it only deals with objects.  However, getting this
right without making the API too narrow or too unsafe may not be
entirely obvious.</p>
<p>In the case that the API only deals with byte strings, i.e. binary
data or encoded text, it is best not to type the input argument as
something like <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a>, because that would restrict the allowed
input to exactly that type and exclude both subtypes and other kinds
of byte containers, e.g. <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytearray" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytearray</span></code></a> objects or memory views.</p>
<p>Depending on how (and where) the data is being processed, it may be a
good idea to instead receive a 1-dimensional memory view, e.g.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_byte_data</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span><span class="p">[:]</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">first_byte</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">slice_view</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
    <span class="c"># ...</span>
</pre></div>
</div>
<p>Cython’s memory views are described in more detail in
<a class="reference internal" href="index.html#document-src/userguide/memoryviews"><span class="doc">Typed Memoryviews</span></a>, but the above example already shows
most of the relevant functionality for 1-dimensional byte views.  They
allow for efficient processing of arrays and accept anything that can
unpack itself into a byte buffer, without intermediate copying.  The
processed content can finally be returned in the memory view itself
(or a slice of it), but it is often better to copy the data back into
a flat and simple <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> or <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytearray" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytearray</span></code></a> object, especially
when only a small slice is returned.  Since memoryviews do not copy the
data, they would otherwise keep the entire original buffer alive.  The
general idea here is to be liberal with input by accepting any kind of
byte buffer, but strict with output by returning a simple, well adapted
object.  This can simply be done as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_byte_data</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span><span class="p">[:]</span> <span class="n">data</span><span class="p">):</span>
    <span class="c"># ... process the data, here, dummy processing.</span>
    <span class="k">cdef</span> <span class="kt">bint</span> <span class="nf">return_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">108</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># example for returning a slice</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mf">5</span><span class="p">:</span><span class="mf">7</span><span class="p">])</span>
</pre></div>
</div>
<p>If the byte input is actually encoded text, and the further processing
should happen at the Unicode level, then the right thing to do is to
decode the input straight away.  This is almost only a problem in Python
2.x, where Python code expects that it can pass a byte string (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>)
with encoded text into a text API.  Since this usually happens in more
than one place in the module’s API, a helper function is almost always the
way to go, since it allows for easy adaptation of the input normalisation
process later.</p>
<p>This kind of input normalisation function will commonly look similar to
the following:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># to_unicode.pyx</span>

<span class="k">from</span> <span class="nn">cpython.version</span> <span class="k">cimport</span> <span class="n">PY_MAJOR_VERSION</span>

<span class="k">cdef</span> <span class="kt">unicode</span> <span class="nf">_text</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">unicode</span><span class="p">:</span>
        <span class="c"># Fast path for most common case(s).</span>
        <span class="k">return</span> <span class="p">&lt;</span><span class="kt">unicode</span><span class="p">&gt;</span><span class="n">s</span>

    <span class="k">elif</span> <span class="n">PY_MAJOR_VERSION</span> <span class="o">&lt;</span> <span class="mf">3</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="c"># Only accept byte strings as text input in Python 2.x, not in Py3.</span>
        <span class="k">return</span> <span class="p">(&lt;</span><span class="kt">bytes</span><span class="p">&gt;</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="c"># We know from the fast path above that &#39;s&#39; can only be a subtype here.</span>
        <span class="c"># An evil cast to &lt;unicode&gt; might still work in some(!) cases,</span>
        <span class="c"># depending on what the further processing does.  To be safe,</span>
        <span class="c"># we can always create a copy instead.</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Could not convert to unicode.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>And should then be used like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">to_unicode</span> <span class="k">cimport</span> <span class="n">_text</span>

<span class="k">def</span> <span class="nf">api_func</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">text_input</span> <span class="o">=</span> <span class="n">_text</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c"># ...</span>
</pre></div>
</div>
<p>Similarly, if the further processing happens at the byte level, but Unicode
string input should be accepted, then the following might work, if you are
using memory views:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># define a global name for whatever char type is used in the module</span>
<span class="k">ctypedef</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="n">char_type</span>

<span class="k">cdef</span> <span class="kt">char_type</span>[<span class="p">:]</span> <span class="n">_chars</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="c"># encode to the specific encoding used inside of the module</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(&lt;</span><span class="kt">unicode</span><span class="p">&gt;</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div>
</div>
<p>In this case, you might want to additionally ensure that byte string
input really uses the correct encoding, e.g. if you require pure ASCII
input data, you can run over the buffer in a loop and check the highest
bit of each byte.  This should then also be done in the input normalisation
function.</p>
</div>
<div class="section" id="dealing-with-const">
<h4>Dealing with “const”<a class="headerlink" href="#dealing-with-const" title="Permalink to this headline">¶</a></h4>
<p>Many C libraries use the <code class="docutils literal notranslate"><span class="pre">const</span></code> modifier in their API to declare
that they will not modify a string, or to require that users must
not modify a string they return, for example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">const</span> <span class="n">char</span> <span class="n">specialChar</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">process_string</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">s</span><span class="p">);</span>
<span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">look_up_cached_string</span><span class="p">(</span><span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">key</span><span class="p">);</span>
</pre></div>
</div>
<p>Cython has support for the <code class="docutils literal notranslate"><span class="pre">const</span></code> modifier in
the language, so you can declare the above functions straight away as
follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;someheader.h&quot;</span><span class="p">:</span>
    <span class="k">ctypedef</span> <span class="n">const</span> <span class="n">char</span> <span class="n">specialChar</span>
    <span class="nb">int</span> <span class="n">process_string</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">look_up_cached_string</span><span class="p">(</span><span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="decoding-bytes-to-text">
<h4>Decoding bytes to text<a class="headerlink" href="#decoding-bytes-to-text" title="Permalink to this headline">¶</a></h4>
<p>The initially presented way of passing and receiving C strings is
sufficient if your code only deals with binary data in the strings.
When we deal with encoded text, however, it is best practice to decode
the C byte strings to Python Unicode strings on reception, and to
encode Python Unicode strings to C byte strings on the way out.</p>
<p>With a Python byte string object, you would normally just call the
<code class="docutils literal notranslate"><span class="pre">bytes.decode()</span></code> method to decode it into a Unicode string:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">ustring</span> <span class="o">=</span> <span class="n">byte_string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Cython allows you to do the same for a C string, as long as it
contains no null bytes:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">c_func</span> <span class="k">cimport</span> <span class="n">c_call_returning_a_c_string</span>

<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">some_c_string</span> <span class="o">=</span> <span class="n">c_call_returning_a_c_string</span><span class="p">()</span>
<span class="n">ustring</span> <span class="o">=</span> <span class="n">some_c_string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And, more efficiently, for strings where the length is known:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">c_func</span> <span class="k">cimport</span> <span class="n">get_a_c_string</span>

<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="bp">NULL</span>
<span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">length</span> <span class="o">=</span> <span class="mf">0</span>

<span class="c"># get pointer and length from a C function</span>
<span class="n">get_a_c_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span>

<span class="n">ustring</span> <span class="o">=</span> <span class="n">c_string</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The same should be used when the string contains null bytes, e.g. when
it uses an encoding like UCS-4, where each character is encoded in four
bytes most of which tend to be 0.</p>
<p>Again, no bounds checking is done if slice indices are provided, so
incorrect indices lead to data corruption and crashes.  However, using
negative indices is possible and will inject a call
to <code class="xref c c-func docutils literal notranslate"><span class="pre">strlen()</span></code> in order to determine the string length.
Obviously, this only works for 0-terminated strings without internal
null bytes.  Text encoded in UTF-8 or one of the ISO-8859 encodings is
usually a good candidate.  If in doubt, it’s better to pass indices
that are ‘obviously’ correct than to rely on the data to be as expected.</p>
<p>It is common practice to wrap string conversions (and non-trivial type
conversions in general) in dedicated functions, as this needs to be
done in exactly the same way whenever receiving text from C.  This
could look as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">free</span>

<span class="k">cdef</span> <span class="kt">unicode</span> <span class="nf">tounicode</span><span class="p">(</span><span class="n">char</span><span class="o">*</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s">&#39;strict&#39;</span><span class="p">)</span>

<span class="k">cdef</span> <span class="kt">unicode</span> <span class="nf">tounicode_with_length</span><span class="p">(</span>
        <span class="n">char</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">length</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s">&#39;strict&#39;</span><span class="p">)</span>

<span class="k">cdef</span> <span class="kt">unicode</span> <span class="nf">tounicode_with_length_and_free</span><span class="p">(</span>
        <span class="n">char</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">length</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s">&#39;strict&#39;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">free</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>Most likely, you will prefer shorter function names in your code based
on the kind of string being handled.  Different types of content often
imply different ways of handling them on reception.  To make the code
more readable and to anticipate future changes, it is good practice to
use separate conversion functions for different types of strings.</p>
</div>
<div class="section" id="encoding-text-to-bytes">
<h4>Encoding text to bytes<a class="headerlink" href="#encoding-text-to-bytes" title="Permalink to this headline">¶</a></h4>
<p>The reverse way, converting a Python unicode string to a C
<code class="xref c c-type docutils literal notranslate"><span class="pre">char*</span></code>, is pretty efficient by itself, assuming that what
you actually want is a memory managed byte string:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">py_byte_string</span> <span class="o">=</span> <span class="n">py_unicode_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="n">py_byte_string</span>
</pre></div>
</div>
<p>As noted before, this takes the pointer to the byte buffer of the
Python byte string.  Trying to do the same without keeping a reference
to the Python byte string will fail with a compile error:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># this will not compile !</span>
<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="n">py_unicode_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, the Cython compiler notices that the code takes a pointer to a
temporary string result that will be garbage collected after the
assignment.  Later access to the invalidated pointer will read invalid
memory and likely result in a segfault.  Cython will therefore refuse
to compile this code.</p>
</div>
<div class="section" id="c-strings">
<h4>C++ strings<a class="headerlink" href="#c-strings" title="Permalink to this headline">¶</a></h4>
<p>When wrapping a C++ library, strings will usually come in the form of
the <code class="xref c c-type docutils literal notranslate"><span class="pre">std::string</span></code> class.  As with C strings, Python byte strings
automatically coerce from and to C++ strings:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">libcpp.string</span> <span class="k">cimport</span> <span class="n">string</span>

<span class="k">def</span> <span class="nf">get_bytes</span><span class="p">():</span>
    <span class="n">py_bytes_object</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;hello world&#39;</span>
    <span class="k">cdef</span> <span class="kt">string</span> <span class="nf">s</span> <span class="o">=</span> <span class="n">py_bytes_object</span>

    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
    <span class="n">py_bytes_object</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">py_bytes_object</span>
</pre></div>
</div>
<p>The memory management situation is different than in C because the
creation of a C++ string makes an independent copy of the string
buffer which the string object then owns.  It is therefore possible
to convert temporarily created Python objects directly into C++
strings.  A common way to make use of this is when encoding a Python
unicode string into a C++ string:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">string</span> <span class="nf">cpp_string</span> <span class="o">=</span> <span class="n">py_unicode_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this involves a bit of overhead because it first encodes
the Unicode string into a temporarily created Python bytes object
and then copies its buffer into a new C++ string.</p>
<p>For the other direction, efficient decoding support is available
in Cython 0.17 and later:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">libcpp.string</span> <span class="k">cimport</span> <span class="n">string</span>

<span class="k">def</span> <span class="nf">get_ustrings</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">string</span> <span class="nf">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;abcdefg&#39;</span><span class="p">)</span>

    <span class="n">ustring1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
    <span class="n">ustring2</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mf">2</span><span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ustring1</span><span class="p">,</span> <span class="n">ustring2</span>
</pre></div>
</div>
<p>For C++ strings, decoding slices will always take the proper length
of the string into account and apply Python slicing semantics (e.g.
return empty strings for out-of-bounds indices).</p>
</div>
<div class="section" id="auto-encoding-and-decoding">
<h4>Auto encoding and decoding<a class="headerlink" href="#auto-encoding-and-decoding" title="Permalink to this headline">¶</a></h4>
<p>Cython 0.19 comes with two new directives: <code class="docutils literal notranslate"><span class="pre">c_string_type</span></code> and
<code class="docutils literal notranslate"><span class="pre">c_string_encoding</span></code>.  They can be used to change the Python string
types that C/C++ strings coerce from and to.  By default, they only
coerce from and to the bytes type, and encoding or decoding must
be done explicitly, as described above.</p>
<p>There are two use cases where this is inconvenient.  First, if all
C strings that are being processed (or the large majority) contain
text, automatic encoding and decoding from and to Python unicode
objects can reduce the code overhead a little.  In this case, you
can set the <code class="docutils literal notranslate"><span class="pre">c_string_type</span></code> directive in your module to <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code>
and the <code class="docutils literal notranslate"><span class="pre">c_string_encoding</span></code> to the encoding that your C code uses,
for example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: c_string_type=unicode, c_string_encoding=utf8</span>

<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="s">&#39;abcdefg&#39;</span>

<span class="c"># implicit decoding:</span>
<span class="k">cdef</span> <span class="kt">object</span> <span class="nf">py_unicode_object</span> <span class="o">=</span> <span class="n">c_string</span>

<span class="c"># explicit conversion to Python bytes:</span>
<span class="n">py_bytes_object</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">bytes</span><span class="p">&gt;</span><span class="n">c_string</span>
</pre></div>
</div>
<p>The second use case is when all C strings that are being processed
only contain ASCII encodable characters (e.g. numbers) and you want
your code to use the native legacy string type in Python 2 for them,
instead of always using Unicode. In this case, you can set the
string type to <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: c_string_type=str, c_string_encoding=ascii</span>

<span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="s">&#39;abcdefg&#39;</span>

<span class="c"># implicit decoding in Py3, bytes conversion in Py2:</span>
<span class="k">cdef</span> <span class="kt">object</span> <span class="nf">py_str_object</span> <span class="o">=</span> <span class="n">c_string</span>

<span class="c"># explicit conversion to Python bytes:</span>
<span class="n">py_bytes_object</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">bytes</span><span class="p">&gt;</span><span class="n">c_string</span>

<span class="c"># explicit conversion to Python unicode:</span>
<span class="n">py_bytes_object</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">unicode</span><span class="p">&gt;</span><span class="n">c_string</span>
</pre></div>
</div>
<p>The other direction, i.e. automatic encoding to C strings, is only
supported for ASCII and the “default encoding”, which is usually UTF-8
in Python 3 and usually ASCII in Python 2.  CPython handles the memory
management in this case by keeping an encoded copy of the string alive
together with the original unicode string.  Otherwise, there would be no
way to limit the lifetime of the encoded string in any sensible way,
thus rendering any attempt to extract a C string pointer from it a
dangerous endeavour.  The following safely converts a Unicode string to
ASCII (change <code class="docutils literal notranslate"><span class="pre">c_string_encoding</span></code> to <code class="docutils literal notranslate"><span class="pre">default</span></code> to use the default
encoding instead):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: c_string_type=unicode, c_string_encoding=ascii</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">ustring</span> <span class="o">=</span> <span class="s">u&#39;abc&#39;</span>
    <span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">s</span> <span class="o">=</span> <span class="n">ustring</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>    <span class="c"># returns u&#39;a&#39;</span>
</pre></div>
</div>
<p>(This example uses a function context in order to safely control the
lifetime of the Unicode string.  Global Python variables can be
modified from the outside, which makes it dangerous to rely on the
lifetime of their values.)</p>
</div>
<div class="section" id="source-code-encoding">
<h4>Source code encoding<a class="headerlink" href="#source-code-encoding" title="Permalink to this headline">¶</a></h4>
<p>When string literals appear in the code, the source code encoding is
important.  It determines the byte sequence that Cython will store in
the C code for bytes literals, and the Unicode code points that Cython
builds for unicode literals when parsing the byte encoded source file.
Following <span class="target" id="index-1"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0263"><strong>PEP 263</strong></a>, Cython supports the explicit declaration of
source file encodings.  For example, putting the following comment at
the top of an <code class="docutils literal notranslate"><span class="pre">ISO-8859-15</span></code> (Latin-9) encoded source file (into the
first or second line) is required to enable <code class="docutils literal notranslate"><span class="pre">ISO-8859-15</span></code> decoding
in the parser:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># -*- coding: ISO-8859-15 -*-</span>
</pre></div>
</div>
<p>When no explicit encoding declaration is provided, the source code is
parsed as UTF-8 encoded text, as specified by <span class="target" id="index-2"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-3120"><strong>PEP 3120</strong></a>.  <a class="reference external" href="https://en.wikipedia.org/wiki/UTF-8">UTF-8</a>
is a very common encoding that can represent the entire Unicode set of
characters and is compatible with plain ASCII encoded text that it
encodes efficiently.  This makes it a very good choice for source code
files which usually consist mostly of ASCII characters.</p>
<p>As an example, putting the following line into a UTF-8 encoded source
file will print <code class="docutils literal notranslate"><span class="pre">5</span></code>, as UTF-8 encodes the letter <code class="docutils literal notranslate"><span class="pre">'ö'</span></code> in the two
byte sequence <code class="docutils literal notranslate"><span class="pre">'\xc3\xb6'</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;abcö&#39;</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>whereas the following <code class="docutils literal notranslate"><span class="pre">ISO-8859-15</span></code> encoded source file will print
<code class="docutils literal notranslate"><span class="pre">4</span></code>, as the encoding uses only 1 byte for this letter:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># -*- coding: ISO-8859-15 -*-</span>
<span class="k">print</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;abcö&#39;</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>Note that the unicode literal <code class="docutils literal notranslate"><span class="pre">u'abcö'</span></code> is a correctly decoded four
character Unicode string in both cases, whereas the unprefixed Python
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> literal <code class="docutils literal notranslate"><span class="pre">'abcö'</span></code> will become a byte string in Python 2 (thus
having length 4 or 5 in the examples above), and a 4 character Unicode
string in Python 3.  If you are not familiar with encodings, this may
not appear obvious at first read.  See <a class="reference external" href="https://github.com/cython/cython/wiki/enhancements-stringliterals">CEP 108</a> for details.</p>
<p>As a rule of thumb, it is best to avoid unprefixed non-ASCII <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>
literals and to use unicode string literals for all text.  Cython also
supports the <code class="docutils literal notranslate"><span class="pre">__future__</span></code> import <code class="docutils literal notranslate"><span class="pre">unicode_literals</span></code> that instructs
the parser to read all unprefixed <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> literals in a source file as
unicode string literals, just like Python 3.</p>
</div>
<div class="section" id="single-bytes-and-characters">
<h4>Single bytes and characters<a class="headerlink" href="#single-bytes-and-characters" title="Permalink to this headline">¶</a></h4>
<p>The Python C-API uses the normal C <code class="xref c c-type docutils literal notranslate"><span class="pre">char</span></code> type to represent
a byte value, but it has two special integer types for a Unicode code
point value, i.e. a single Unicode character: <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a>
and <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UCS4" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UCS4</span></code></a>.  Cython supports the
first natively, support for <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UCS4" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UCS4</span></code></a> is new in Cython 0.15.
<a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> is either defined as an unsigned 2-byte or
4-byte integer, or as <code class="xref c c-type docutils literal notranslate"><span class="pre">wchar_t</span></code>, depending on the platform.
The exact type is a compile time option in the build of the CPython
interpreter and extension modules inherit this definition at C
compile time.  The advantage of <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UCS4" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UCS4</span></code></a> is that it is
guaranteed to be large enough for any Unicode code point value,
regardless of the platform.  It is defined as a 32bit unsigned int
or long.</p>
<p>In Cython, the <code class="xref c c-type docutils literal notranslate"><span class="pre">char</span></code> type behaves differently from the
<a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> and <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UCS4" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UCS4</span></code></a> types when coercing
to Python objects.  Similar to the behaviour of the bytes type in
Python 3, the <code class="xref c c-type docutils literal notranslate"><span class="pre">char</span></code> type coerces to a Python integer
value by default, so that the following prints 65 and not <code class="docutils literal notranslate"><span class="pre">A</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># -*- coding: ASCII -*-</span>

<span class="k">cdef</span> <span class="kt">char</span> <span class="nf">char_val</span> <span class="o">=</span> <span class="s">&#39;A&#39;</span>
<span class="k">assert</span> <span class="n">char_val</span> <span class="o">==</span> <span class="mf">65</span>   <span class="c"># ASCII encoded byte value of &#39;A&#39;</span>
<span class="k">print</span><span class="p">(</span> <span class="n">char_val</span> <span class="p">)</span>
</pre></div>
</div>
<p>If you want a Python bytes string instead, you have to request it
explicitly, and the following will print <code class="docutils literal notranslate"><span class="pre">A</span></code> (or <code class="docutils literal notranslate"><span class="pre">b'A'</span></code> in Python
3):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span> <span class="p">&lt;</span><span class="kt">bytes</span><span class="p">&gt;</span><span class="n">char_val</span> <span class="p">)</span>
</pre></div>
</div>
<p>The explicit coercion works for any C integer type.  Values outside of
the range of a <code class="xref c c-type docutils literal notranslate"><span class="pre">char</span></code> or <code class="xref c c-type docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">char</span></code> will raise an
<a class="reference external" href="https://docs.python.org/3/library/exceptions.html#OverflowError" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">OverflowError</span></code></a> at runtime.  Coercion will also happen automatically
when assigning to a typed variable, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">bytes</span> <span class="nf">py_byte_string</span>
<span class="n">py_byte_string</span> <span class="o">=</span> <span class="n">char_val</span>
</pre></div>
</div>
<p>On the other hand, the <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> and <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UCS4" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UCS4</span></code></a>
types are rarely used outside of the context of a Python unicode string,
so their default behaviour is to coerce to a Python unicode object.  The
following will therefore print the character <code class="docutils literal notranslate"><span class="pre">A</span></code>, as would the same
code with the <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> type:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">Py_UCS4</span> <span class="nf">uchar_val</span> <span class="o">=</span> <span class="s">u&#39;A&#39;</span>
<span class="k">assert</span> <span class="n">uchar_val</span> <span class="o">==</span> <span class="mf">65</span> <span class="c"># character point value of u&#39;A&#39;</span>
<span class="k">print</span><span class="p">(</span> <span class="n">uchar_val</span> <span class="p">)</span>
</pre></div>
</div>
<p>Again, explicit casting will allow users to override this behaviour.
The following will print 65:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">Py_UCS4</span> <span class="nf">uchar_val</span> <span class="o">=</span> <span class="s">u&#39;A&#39;</span>
<span class="k">print</span><span class="p">(</span> <span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span><span class="n">uchar_val</span> <span class="p">)</span>
</pre></div>
</div>
<p>Note that casting to a C <code class="xref c c-type docutils literal notranslate"><span class="pre">long</span></code> (or <code class="xref c c-type docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span></code>) will work
just fine, as the maximum code point value that a Unicode character
can have is 1114111 (<code class="docutils literal notranslate"><span class="pre">0x10FFFF</span></code>).  On platforms with 32bit or more,
<code class="xref c c-type docutils literal notranslate"><span class="pre">int</span></code> is just as good.</p>
</div>
<div class="section" id="narrow-unicode-builds">
<h4>Narrow Unicode builds<a class="headerlink" href="#narrow-unicode-builds" title="Permalink to this headline">¶</a></h4>
<p>In narrow Unicode builds of CPython before version 3.3, i.e. builds
where <code class="docutils literal notranslate"><span class="pre">sys.maxunicode</span></code> is 65535 (such as all Windows builds, as
opposed to 1114111 in wide builds), it is still possible to use
Unicode character code points that do not fit into the 16 bit wide
<a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> type.  For example, such a CPython build will
accept the unicode literal <code class="docutils literal notranslate"><span class="pre">u'\U00012345'</span></code>.  However, the
underlying system level encoding leaks into Python space in this
case, so that the length of this literal becomes 2 instead of 1.
This also shows when iterating over it or when indexing into it.
The visible substrings are <code class="docutils literal notranslate"><span class="pre">u'\uD808'</span></code> and <code class="docutils literal notranslate"><span class="pre">u'\uDF45'</span></code> in this
example.  They form a so-called surrogate pair that represents the
above character.</p>
<p>For more information on this topic, it is worth reading the <a class="reference external" href="https://en.wikipedia.org/wiki/UTF-16/UCS-2">Wikipedia
article about the UTF-16 encoding</a>.</p>
<p>The same properties apply to Cython code that gets compiled for a
narrow CPython runtime environment.  In most cases, e.g. when
searching for a substring, this difference can be ignored as both the
text and the substring will contain the surrogates.  So most Unicode
processing code will work correctly also on narrow builds.  Encoding,
decoding and printing will work as expected, so that the above literal
turns into exactly the same byte sequence on both narrow and wide
Unicode platforms.</p>
<p>However, programmers should be aware that a single <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a>
value (or single ‘character’ unicode string in CPython) may not be
enough to represent a complete Unicode character on narrow platforms.
For example, if an independent search for <code class="docutils literal notranslate"><span class="pre">u'\uD808'</span></code> and
<code class="docutils literal notranslate"><span class="pre">u'\uDF45'</span></code> in a unicode string succeeds, this does not necessarily
mean that the character <code class="docutils literal notranslate"><span class="pre">u'\U00012345</span></code> is part of that string.  It
may well be that two different characters are in the string that just
happen to share a code unit with the surrogate pair of the character
in question.  Looking for substrings works correctly because the two
code units in the surrogate pair use distinct value ranges, so the
pair is always identifiable in a sequence of code points.</p>
<p>As of version 0.15, Cython has extended support for surrogate pairs so
that you can safely use an <code class="docutils literal notranslate"><span class="pre">in</span></code> test to search character values from
the full <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UCS4" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UCS4</span></code></a> range even on narrow platforms:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">Py_UCS4</span> <span class="nf">uchar</span> <span class="o">=</span> <span class="mf">0</span><span class="n">x12345</span>
<span class="k">print</span><span class="p">(</span> <span class="n">uchar</span> <span class="ow">in</span> <span class="n">some_unicode_string</span> <span class="p">)</span>
</pre></div>
</div>
<p>Similarly, it can coerce a one character string with a high Unicode
code point value to a Py_UCS4 value on both narrow and wide Unicode
platforms:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">Py_UCS4</span> <span class="nf">uchar</span> <span class="o">=</span> <span class="s">u&#39;</span><span class="se">\U00012345</span><span class="s">&#39;</span>
<span class="k">assert</span> <span class="n">uchar</span> <span class="o">==</span> <span class="mf">0</span><span class="n">x12345</span>
</pre></div>
</div>
<p>In CPython 3.3 and later, the <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> type is an alias
for the system specific <code class="xref c c-type docutils literal notranslate"><span class="pre">wchar_t</span></code> type and is no longer tied
to the internal representation of the Unicode string.  Instead, any
Unicode character can be represented on all platforms without
resorting to surrogate pairs.  This implies that narrow builds no
longer exist from that version on, regardless of the size of
<a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a>.  See <span class="target" id="index-3"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0393"><strong>PEP 393</strong></a> for details.</p>
<p>Cython 0.16 and later handles this change internally and does the right
thing also for single character values as long as either type inference
is applied to untyped variables or the portable <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UCS4" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UCS4</span></code></a> type
is explicitly used in the source code instead of the platform specific
<a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> type.  Optimisations that Cython applies to the
Python unicode type will automatically adapt to <span class="target" id="index-4"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0393"><strong>PEP 393</strong></a> at C compile
time, as usual.</p>
</div>
<div class="section" id="iteration">
<h4>Iteration<a class="headerlink" href="#iteration" title="Permalink to this headline">¶</a></h4>
<p>Cython 0.13 supports efficient iteration over <code class="xref c c-type docutils literal notranslate"><span class="pre">char*</span></code>,
bytes and unicode strings, as long as the loop variable is
appropriately typed. So the following will generate the expected
C code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">c_string</span> <span class="o">=</span> <span class="s">&quot;Hello to A C-string&#39;s world&quot;</span>

<span class="k">cdef</span> <span class="kt">char</span> <span class="nf">c</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">c_string</span><span class="p">[:</span><span class="mf">11</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Found the letter A&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The same applies to bytes objects:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">bytes</span> <span class="nf">bytes_string</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;hello to A bytes&#39; world&quot;</span>

<span class="k">cdef</span> <span class="kt">char</span> <span class="nf">c</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bytes_string</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Found the letter A&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For unicode objects, Cython will automatically infer the type of the
loop variable as <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UCS4" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UCS4</span></code></a>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">unicode</span> <span class="nf">ustring</span> <span class="o">=</span> <span class="s">u&#39;Hello world&#39;</span>

<span class="c"># NOTE: no typing required for &#39;uchar&#39; !</span>
<span class="k">for</span> <span class="n">uchar</span> <span class="ow">in</span> <span class="n">ustring</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">uchar</span> <span class="o">==</span> <span class="s">u&#39;A&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Found the letter A&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The automatic type inference usually leads to much more efficient code
here.  However, note that some unicode operations still require the
value to be a Python object, so Cython may end up generating redundant
conversion code for the loop variable value inside of the loop.  If
this leads to a performance degradation for a specific piece of code,
you can either type the loop variable as a Python object explicitly,
or assign its value to a Python typed variable somewhere inside of the
loop to enforce one-time coercion before running Python operations on
it.</p>
<p>There are also optimisations for <code class="docutils literal notranslate"><span class="pre">in</span></code> tests, so that the following
code will run in plain C code, (actually using a switch statement):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cpdef</span> <span class="kt">void</span> <span class="nf">is_in</span><span class="p">(</span><span class="n">Py_UCS4</span> <span class="n">uchar_val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">uchar_val</span> <span class="ow">in</span> <span class="s">u&#39;abcABCxY&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;The character is in the string.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;The character is not in the string&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Combined with the looping optimisation above, this can result in very
efficient character switching code, e.g. in unicode parsers.</p>
</div>
<div class="section" id="windows-and-wide-character-apis">
<h4>Windows and wide character APIs<a class="headerlink" href="#windows-and-wide-character-apis" title="Permalink to this headline">¶</a></h4>
<p>Windows system APIs natively support Unicode in the form of
zero-terminated UTF-16 encoded <code class="xref c c-type docutils literal notranslate"><span class="pre">wchar_t*</span></code> strings, so called
“wide strings”.</p>
<p>By default, Windows builds of CPython define <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> as
a synonym for <code class="xref c c-type docutils literal notranslate"><span class="pre">wchar_t</span></code>. This makes internal <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code>
representation compatible with UTF-16 and allows for efficient zero-copy
conversions. This also means that Windows builds are always
<a class="reference internal" href="#narrow-unicode-builds">Narrow Unicode builds</a> with all the caveats.</p>
<p>To aid interoperation with Windows APIs, Cython 0.19 supports wide
strings (in the form of <code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE*</span></code>) and implicitly converts
them to and from <code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code> string objects.  These conversions behave the
same way as they do for <code class="xref c c-type docutils literal notranslate"><span class="pre">char*</span></code> and <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> as described in
<a class="reference internal" href="#passing-byte-strings">Passing byte strings</a>.</p>
<p>In addition to automatic conversion, unicode literals that appear
in C context become C-level wide string literals and <a class="reference external" href="https://docs.python.org/3/library/functions.html#len" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">len()</span></code></a>
built-in function is specialized to compute the length of zero-terminated
<code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE*</span></code> string or array.</p>
<p>Here is an example of how one would call a Unicode API on Windows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Windows.h&quot;</span><span class="p">:</span>

    <span class="k">ctypedef</span> <span class="n">Py_UNICODE</span> <span class="n">WCHAR</span>
    <span class="k">ctypedef</span> <span class="n">const</span> <span class="n">WCHAR</span><span class="o">*</span> <span class="n">LPCWSTR</span>
    <span class="k">ctypedef</span> <span class="n">void</span><span class="o">*</span> <span class="n">HWND</span>

    <span class="nb">int</span> <span class="n">MessageBoxW</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> <span class="n">LPCWSTR</span> <span class="n">lpText</span><span class="p">,</span> <span class="n">LPCWSTR</span> <span class="n">lpCaption</span><span class="p">,</span> <span class="nb">int</span> <span class="n">uType</span><span class="p">)</span>

<span class="n">title</span> <span class="o">=</span> <span class="s">u&quot;Windows Interop Demo - Python </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mf">3</span><span class="p">]</span>
<span class="n">MessageBoxW</span><span class="p">(</span><span class="bp">NULL</span><span class="p">,</span> <span class="s">u&quot;Hello Cython </span><span class="se">\u263a</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="mf">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>The use of <code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE*</span></code> strings outside of Windows is
strongly discouraged. <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> is inherently not
portable between different platforms and Python versions.</p>
<p class="last">CPython 3.3 has moved to a flexible internal representation of
unicode strings (<span class="target" id="index-5"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0393"><strong>PEP 393</strong></a>), making all <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.Py_UNICODE" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></a> related
APIs deprecated and inefficient.</p>
</div>
<p>One consequence of CPython 3.3 changes is that <a class="reference external" href="https://docs.python.org/3/library/functions.html#len" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">len()</span></code></a> of
<code class="xref py py-obj docutils literal notranslate"><span class="pre">unicode</span></code> strings is always measured in <em>code points</em> (“characters”),
while Windows API expect the number of UTF-16 <em>code units</em>
(where each surrogate is counted individually). To always get the number
of code units, call <a class="reference external" href="https://docs.python.org/3/c-api/unicode.html#c.PyUnicode_GetSize" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyUnicode_GetSize()</span></code></a> directly.</p>
</div>
</div>
<span id="document-src/tutorial/memory_allocation"></span><div class="section" id="memory-allocation">
<span id="id1"></span><h3>Memory Allocation<a class="headerlink" href="#memory-allocation" title="Permalink to this headline">¶</a></h3>
<p>Dynamic memory allocation is mostly a non-issue in Python.  Everything is an
object, and the reference counting system and garbage collector automatically
return memory to the system when it is no longer being used.</p>
<p>When it comes to more low-level data buffers, Cython has special support for
(multi-dimensional) arrays of simple types via NumPy, memory views or Python’s
stdlib array type.  They are full featured, garbage collected and much easier
to work with than bare pointers in C, while still retaining the speed and static
typing benefits.
See <a class="reference internal" href="index.html#array-array"><span class="std std-ref">Working with Python arrays</span></a> and <a class="reference internal" href="index.html#memoryviews"><span class="std std-ref">Typed Memoryviews</span></a>.</p>
<p>In some situations, however, these objects can still incur an unacceptable
amount of overhead, which can then makes a case for doing manual memory
management in C.</p>
<p>Simple C values and structs (such as a local variable <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">double</span> <span class="pre">x</span></code>) are
usually allocated on the stack and passed by value, but for larger and more
complicated objects (e.g. a dynamically-sized list of doubles), the memory must
be manually requested and released.  C provides the functions <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code>,
<code class="xref c c-func docutils literal notranslate"><span class="pre">realloc()</span></code>, and <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> for this purpose, which can be imported
in cython from <code class="docutils literal notranslate"><span class="pre">clibc.stdlib</span></code>. Their signatures are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="o">*</span> <span class="n">malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">realloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="kt">void</span> <span class="n">free</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
</pre></div>
</div>
<p>A very simple example of malloc usage is the following:</p>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">random</span>
<span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">malloc</span><span class="p">,</span> <span class="n">free</span>

<span class="k">def</span> <span class="nf">random_noise</span><span class="p">(</span><span class="nb">int</span> <span class="n">number</span><span class="o">=</span><span class="mf">1</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
    <span class="c"># allocate number * sizeof(double) bytes of memory</span>
    <span class="k">cdef</span> <span class="kt">double</span> *<span class="nf">my_array</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">double</span> <span class="o">*&gt;</span> <span class="n">malloc</span><span class="p">(</span><span class="n">number</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">double</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">my_array</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ran</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normalvariate</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
            <span class="n">my_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ran</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>

        <span class="c"># ... let&#39;s just assume we do some more heavy C calculations here to make up</span>
        <span class="c"># for the work that it takes to pack the C double values into Python float</span>
        <span class="c"># objects below, right after throwing away the existing objects above.</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">my_array</span><span class="p">[:</span><span class="n">number</span><span class="p">]]</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c"># return the previously allocated memory to the system</span>
        <span class="n">free</span><span class="p">(</span><span class="n">my_array</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Note that the C-API functions for allocating memory on the Python heap
are generally preferred over the low-level C functions above as the
memory they provide is actually accounted for in Python’s internal
memory management system.  They also have special optimisations for
smaller memory blocks, which speeds up their allocation by avoiding
costly operating system calls.</p>
<p>The C-API functions can be found in the <code class="docutils literal notranslate"><span class="pre">cpython.mem</span></code> standard
declarations file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython.mem</span> <span class="k">cimport</span> <span class="n">PyMem_Malloc</span><span class="p">,</span> <span class="n">PyMem_Realloc</span><span class="p">,</span> <span class="n">PyMem_Free</span>
</pre></div>
</div>
<p>Their interface and usage is identical to that of the corresponding
low-level C functions.</p>
<p>One important thing to remember is that blocks of memory obtained with
<code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> or <a class="reference external" href="https://docs.python.org/3/c-api/memory.html#c.PyMem_Malloc" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyMem_Malloc()</span></code></a> <em>must</em> be manually released
with a corresponding call to <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> or <a class="reference external" href="https://docs.python.org/3/c-api/memory.html#c.PyMem_Free" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyMem_Free()</span></code></a>
when they are no longer used (and <em>must</em> always use the matching
type of free function).  Otherwise, they won’t be reclaimed until the
python process exits.  This is called a memory leak.</p>
<p>If a chunk of memory needs a larger lifetime than can be managed by a
<code class="docutils literal notranslate"><span class="pre">try..finally</span></code> block, another helpful idiom is to tie its lifetime
to a Python object to leverage the Python runtime’s memory management,
e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython.mem</span> <span class="k">cimport</span> <span class="n">PyMem_Malloc</span><span class="p">,</span> <span class="n">PyMem_Realloc</span><span class="p">,</span> <span class="n">PyMem_Free</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">SomeMemory</span><span class="p">:</span>

    <span class="k">cdef</span> <span class="kt">double</span>* <span class="nf">data</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">number</span><span class="p">):</span>
        <span class="c"># allocate some memory (uninitialised, may contain arbitrary data)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">double</span><span class="o">*&gt;</span> <span class="n">PyMem_Malloc</span><span class="p">(</span><span class="n">number</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">double</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">new_number</span><span class="p">):</span>
        <span class="c"># Allocates new_number * sizeof(double) bytes,</span>
        <span class="c"># preserving the current content and making a best-effort to</span>
        <span class="c"># re-use the original data location.</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">double</span><span class="o">*&gt;</span> <span class="n">PyMem_Realloc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">new_number</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">double</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mem</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>
        <span class="c"># Only overwrite the pointer if the memory was really reallocated.</span>
        <span class="c"># On error (mem is NULL), the originally memory has not been freed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mem</span>

    <span class="k">def</span> <span class="nf">__dealloc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">PyMem_Free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c"># no-op if self.data is NULL</span>
</pre></div>
</div>
</div>
<span id="document-src/tutorial/pure"></span><div class="section" id="pure-python-mode">
<span id="pure-mode"></span><h3>Pure Python Mode<a class="headerlink" href="#pure-python-mode" title="Permalink to this headline">¶</a></h3>
<p>In some cases, it’s desirable to speed up Python code without losing the
ability to run it with the Python interpreter.  While pure Python scripts
can be compiled with Cython, it usually results only in a speed gain of
about 20%-50%.</p>
<p>To go beyond that, Cython provides language constructs to add static typing
and cythonic functionalities to a Python module to make it run much faster
when compiled, while still allowing it to be interpreted.
This is accomplished via an augmenting <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file, via Python
type annotations (following
<a class="reference external" href="https://www.python.org/dev/peps/pep-0484/">PEP 484</a> and
<a class="reference external" href="https://www.python.org/dev/peps/pep-0526/">PEP 526</a>), and/or
via special functions and decorators available after importing the magic
<code class="docutils literal notranslate"><span class="pre">cython</span></code> module.  All three ways can be combined at need, although
projects would commonly decide on a specific way to keep the static type
information easy to manage.</p>
<p>Although it is not typically recommended over writing straight Cython code
in a <code class="file docutils literal notranslate"><span class="pre">.pyx</span></code> file, there are legitimate reasons to do this - easier
testing and debugging, collaboration with pure Python developers, etc.
In pure mode, you are more or less restricted to code that can be expressed
(or at least emulated) in Python, plus static type declarations. Anything
beyond that can only be done in .pyx files with extended language syntax,
because it depends on features of the Cython compiler.</p>
<div class="section" id="augmenting-pxd">
<h4>Augmenting .pxd<a class="headerlink" href="#augmenting-pxd" title="Permalink to this headline">¶</a></h4>
<p>Using an augmenting <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> allows to let the original <code class="file docutils literal notranslate"><span class="pre">.py</span></code> file
completely untouched.  On the other hand, one needs to maintain both the
<code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> and the <code class="file docutils literal notranslate"><span class="pre">.py</span></code> to keep them in sync.</p>
<p>While declarations in a <code class="file docutils literal notranslate"><span class="pre">.pyx</span></code> file must correspond exactly with those
of a <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> file with the same name (and any contradiction results in
a compile time error, see <a class="reference internal" href="index.html#document-src/tutorial/pxd_files"><span class="doc">pxd files</span></a>), the untyped definitions in a
<code class="file docutils literal notranslate"><span class="pre">.py</span></code> file can be overridden and augmented with static types by the more
specific ones present in a <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code>.</p>
<p>If a <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> file is found with the same name as the <code class="file docutils literal notranslate"><span class="pre">.py</span></code> file
being compiled, it will be searched for <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> classes and
<a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a>/<a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> functions and methods.  The compiler will
then convert the corresponding classes/functions/methods in the <code class="file docutils literal notranslate"><span class="pre">.py</span></code>
file to be of the declared type.  Thus if one has a file <code class="file docutils literal notranslate"><span class="pre">A.py</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myfunction</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">2</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="mf">1</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">_helper</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<p>and adds <code class="file docutils literal notranslate"><span class="pre">A.pxd</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">myfunction</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="o">=*</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">double</span> <span class="n">a</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kr">public</span> <span class="kt">int</span> <span class="nf">a</span><span class="p">,</span> <span class="nf">b</span>
    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">double</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>then Cython will compile the <code class="file docutils literal notranslate"><span class="pre">A.py</span></code> as if it had been written as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">myfunction</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="o">=</span><span class="mf">2</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">double</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="mf">1</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kr">public</span> <span class="kt">int</span> <span class="nf">a</span><span class="p">,</span> <span class="nf">b</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>

    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">double</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">_helper</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<p>Notice how in order to provide the Python wrappers to the definitions
in the <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code>, that is, to be accessible from Python,</p>
<ul>
<li><p class="first">Python visible function signatures must be declared as <cite>cpdef</cite> (with default
arguments replaced by a <cite>*</cite> to avoid repetition):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">myfunction</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="o">=*</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">C function signatures of internal functions can be declared as <cite>cdef</cite>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">double</span> <span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first"><cite>cdef</cite> classes (extension types) are declared as <cite>cdef class</cite>;</p>
</li>
<li><p class="first"><cite>cdef</cite> class attributes must be declared as <cite>cdef public</cite> if read/write
Python access is needed, <cite>cdef readonly</cite> for read-only Python access, or
plain <cite>cdef</cite> for internal C level attributes;</p>
</li>
<li><p class="first"><cite>cdef</cite> class methods must be declared as <cite>cpdef</cite> for Python visible
methods or <cite>cdef</cite> for internal C methods.</p>
</li>
</ul>
<p>In the example above, the type of the local variable <cite>a</cite> in <cite>myfunction()</cite>
is not fixed and will thus be a Python object.  To statically type it, one
can use Cython’s <code class="docutils literal notranslate"><span class="pre">&#64;cython.locals</span></code> decorator (see <a class="reference internal" href="#magic-attributes"><span class="std std-ref">Magic Attributes</span></a>,
and <a class="reference internal" href="#magic-attributes-pxd"><span class="std std-ref">Magic Attributes within the .pxd</span></a>).</p>
<p>Normal Python (<a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#def" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">def</span></code></a>) functions cannot be declared in <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code>
files.  It is therefore currently impossible to override the types of plain
Python functions in <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> files, e.g. to override types of their local
variables.  In most cases, declaring them as <cite>cpdef</cite> will work as expected.</p>
</div>
<div class="section" id="magic-attributes">
<span id="id1"></span><h4>Magic Attributes<a class="headerlink" href="#magic-attributes" title="Permalink to this headline">¶</a></h4>
<p>Special decorators are available from the magic <code class="docutils literal notranslate"><span class="pre">cython</span></code> module that can
be used to add static typing within the Python file, while being ignored
by the interpreter.</p>
<p>This option adds the <code class="docutils literal notranslate"><span class="pre">cython</span></code> module dependency to the original code, but
does not require to maintain a supplementary <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> file.  Cython
provides a fake version of this module as <cite>Cython.Shadow</cite>, which is available
as <cite>cython.py</cite> when Cython is installed, but can be copied to be used by other
modules when Cython is not installed.</p>
<div class="section" id="compiled-switch">
<h5>“Compiled” switch<a class="headerlink" href="#compiled-switch" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">compiled</span></code> is a special variable which is set to <code class="docutils literal notranslate"><span class="pre">True</span></code> when the compiler
runs, and <code class="docutils literal notranslate"><span class="pre">False</span></code> in the interpreter. Thus, the code</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>

<span class="k">if</span> <span class="n">cython</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Yep, I&#39;m compiled.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Just a lowly interpreted script.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>will behave differently depending on whether or not the code is executed as a
compiled extension (<code class="file docutils literal notranslate"><span class="pre">.so</span></code>/<code class="file docutils literal notranslate"><span class="pre">.pyd</span></code>) module or a plain <code class="file docutils literal notranslate"><span class="pre">.py</span></code>
file.</p>
</li>
</ul>
</div>
<div class="section" id="static-typing">
<h5>Static typing<a class="headerlink" href="#static-typing" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">cython.declare</span></code> declares a typed variable in the current scope, which can be
used in place of the <code class="samp docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">type</span> <span class="pre">var</span> <span class="pre">[=</span> <span class="pre">value]</span></code> construct. This has two forms,
the first as an assignment (useful as it creates a declaration in interpreted
mode as well):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>              <span class="c"># cdef int x</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="mf">0.57721</span><span class="p">)</span>  <span class="c"># cdef double y = 0.57721</span>
</pre></div>
</div>
<p>and the second mode as a simple function call:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>

<span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>  <span class="c"># cdef int x; cdef double y</span>
</pre></div>
</div>
<p>It can also be used to define extension type private, readonly and public attributes:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>


<span class="nd">@cython</span><span class="o">.</span><span class="n">cclass</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">visibility</span><span class="o">=</span><span class="s">&#39;public&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>  <span class="c"># private by default.</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">visibility</span><span class="o">=</span><span class="s">&#39;readonly&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">5</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="mf">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">&#64;cython.locals</span></code> is a decorator that is used to specify the types of local
variables in the function body (including the arguments):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">locals</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">longlong</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
    <span class="c"># ...</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">&#64;cython.returns(&lt;type&gt;)</span></code> specifies the function’s return type.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">&#64;cython.exceptval(value=None,</span> <span class="pre">*,</span> <span class="pre">check=False)</span></code> specifies the function’s exception
return value and exception check semantics as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="nd">@exceptval</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span>               <span class="c"># cdef int func() except -1:</span>
<span class="nd">@exceptval</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># cdef int func() except -1:</span>
<span class="nd">@exceptval</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>       <span class="c"># cdef int func() except *:</span>
<span class="nd">@exceptval</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>   <span class="c"># cdef int func() except? -1:</span>
</pre></div>
</div>
</li>
<li><p class="first">Python annotations can be used to declare argument types, as shown in the
following example.  To avoid conflicts with other kinds of annotation
usages, this can be disabled with the directive <code class="docutils literal notranslate"><span class="pre">annotation_typing=False</span></code>.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">bar</span><span class="p">:</span> <span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="n">foo</span><span class="p">[</span><span class="s">&quot;hello world&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3</span> <span class="o">+</span> <span class="n">bar</span>
    <span class="k">return</span> <span class="n">foo</span><span class="p">,</span> <span class="mf">5</span>
</pre></div>
</div>
<p>This can be combined with the <code class="docutils literal notranslate"><span class="pre">&#64;cython.exceptval()</span></code> decorator for non-Python
return types:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">exceptval</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;need integer &gt;= 0&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">1</span>
</pre></div>
</div>
<p>Since version 0.27, Cython also supports the variable annotations defined
in <a class="reference external" href="https://www.python.org/dev/peps/pep-0526/">PEP 526</a>. This allows to
declare types of variables in a Python 3.6 compatible way as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="c"># Cython types are evaluated as for cdef declarations</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">cython</span><span class="o">.</span><span class="n">int</span>               <span class="c"># cdef int x</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">cython</span><span class="o">.</span><span class="n">double</span> <span class="o">=</span> <span class="mf">0.57721</span>  <span class="c"># cdef double y = 0.57721</span>
    <span class="n">z</span><span class="p">:</span> <span class="n">cython</span><span class="o">.</span><span class="n">float</span> <span class="o">=</span> <span class="mf">0.57721</span>   <span class="c"># cdef float z  = 0.57721</span>

    <span class="c"># Python types shadow Cython types for compatibility reasons</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.54321</span>          <span class="c"># cdef double a = 0.54321</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">5</span>                  <span class="c"># cdef object b = 5</span>
    <span class="n">c</span><span class="p">:</span> <span class="nb">long</span> <span class="o">=</span> <span class="mf">6</span>                 <span class="c"># cdef object c = 6</span>
    <span class="k">pass</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">cclass</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">cython</span><span class="o">.</span><span class="n">int</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">cython</span><span class="o">.</span><span class="n">int</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
</pre></div>
</div>
<p>There is currently no way to express the visibility of object attributes.</p>
</li>
</ul>
</div>
<div class="section" id="c-types">
<h5>C types<a class="headerlink" href="#c-types" title="Permalink to this headline">¶</a></h5>
<p>There are numerous types built into the Cython module.  It provides all the
standard C types, namely <code class="docutils literal notranslate"><span class="pre">char</span></code>, <code class="docutils literal notranslate"><span class="pre">short</span></code>, <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">long</span></code>, <code class="docutils literal notranslate"><span class="pre">longlong</span></code>
as well as their unsigned versions <code class="docutils literal notranslate"><span class="pre">uchar</span></code>, <code class="docutils literal notranslate"><span class="pre">ushort</span></code>, <code class="docutils literal notranslate"><span class="pre">uint</span></code>, <code class="docutils literal notranslate"><span class="pre">ulong</span></code>,
<code class="docutils literal notranslate"><span class="pre">ulonglong</span></code>.  The special <code class="docutils literal notranslate"><span class="pre">bint</span></code> type is used for C boolean values and
<code class="docutils literal notranslate"><span class="pre">Py_ssize_t</span></code> for (signed) sizes of Python containers.</p>
<p>For each type, there are pointer types <code class="docutils literal notranslate"><span class="pre">p_int</span></code>, <code class="docutils literal notranslate"><span class="pre">pp_int</span></code>, etc., up to
three levels deep in interpreted mode, and infinitely deep in compiled mode.
Further pointer types can be constructed with <code class="docutils literal notranslate"><span class="pre">cython.pointer(cython.int)</span></code>,
and arrays as <code class="docutils literal notranslate"><span class="pre">cython.int[10]</span></code>. A limited attempt is made to emulate these
more complex types, but only so much can be done from the Python language.</p>
<p>The Python types int, long and bool are interpreted as C <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">long</span></code>
and <code class="docutils literal notranslate"><span class="pre">bint</span></code> respectively. Also, the Python builtin types <code class="docutils literal notranslate"><span class="pre">list</span></code>, <code class="docutils literal notranslate"><span class="pre">dict</span></code>,
<code class="docutils literal notranslate"><span class="pre">tuple</span></code>, etc. may be used, as well as any user defined types.</p>
<p>Typed C-tuples can be declared as a tuple of C types.</p>
</div>
<div class="section" id="extension-types-and-cdef-functions">
<h5>Extension types and cdef functions<a class="headerlink" href="#extension-types-and-cdef-functions" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>The class decorator <code class="docutils literal notranslate"><span class="pre">&#64;cython.cclass</span></code> creates a <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">class</span></code>.</li>
<li>The function/method decorator <code class="docutils literal notranslate"><span class="pre">&#64;cython.cfunc</span></code> creates a <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> function.</li>
<li><code class="docutils literal notranslate"><span class="pre">&#64;cython.ccall</span></code> creates a <a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> function, i.e. one that Cython code
can call at the C level.</li>
<li><code class="docutils literal notranslate"><span class="pre">&#64;cython.locals</span></code> declares local variables (see above). It can also be used to
declare types for arguments, i.e. the local variables that are used in the
signature.</li>
<li><code class="docutils literal notranslate"><span class="pre">&#64;cython.inline</span></code> is the equivalent of the C <code class="docutils literal notranslate"><span class="pre">inline</span></code> modifier.</li>
<li><code class="docutils literal notranslate"><span class="pre">&#64;cython.final</span></code> terminates the inheritance chain by preventing a type from
being used as a base class, or a method from being overridden in subtypes.
This enables certain optimisations such as inlined method calls.</li>
</ul>
<p>Here is an example of a <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> function:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="nd">@cython</span><span class="o">.</span><span class="n">cfunc</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">bint</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">locals</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c_compare</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
</pre></div>
</div>
</div>
<div class="section" id="further-cython-functions-and-declarations">
<h5>Further Cython functions and declarations<a class="headerlink" href="#further-cython-functions-and-declarations" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">address</span></code> is used in place of the <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> operator:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">x_ptr</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">p_int</span><span class="p">)</span>
<span class="n">x_ptr</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">address</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">sizeof</span></code> emulates the <cite>sizeof</cite> operator.  It can take both types and
expressions.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">longlong</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">longlong</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">struct</span></code> can be used to create struct types.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">MyStruct</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">MyStruct</span><span class="p">)</span>
</pre></div>
</div>
<p>is equivalent to the code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">struct</span> <span class="nf">MyStruct</span><span class="p">:</span>
    <span class="nb">int</span> <span class="n">x</span>
    <span class="nb">int</span> <span class="n">y</span>
    <span class="n">double</span> <span class="n">data</span>

<span class="k">cdef</span> <span class="kt">MyStruct</span> <span class="nf">a</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">union</span></code> creates union types with exactly the same syntax as <code class="docutils literal notranslate"><span class="pre">struct</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">typedef</span></code> defines a type under a given name:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">typedef</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">p_int</span><span class="p">)</span>   <span class="c"># ctypedef int* T</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">cast</span></code> will (unsafely) reinterpret an expression type. <code class="docutils literal notranslate"><span class="pre">cython.cast(T,</span> <span class="pre">t)</span></code>
is equivalent to <code class="docutils literal notranslate"><span class="pre">&lt;T&gt;t</span></code>. The first attribute must be a type, the second is
the expression to cast. Specifying the optional keyword argument
<code class="docutils literal notranslate"><span class="pre">typecheck=True</span></code> has the semantics of <code class="docutils literal notranslate"><span class="pre">&lt;T?&gt;t</span></code>.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">typecheck</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="magic-attributes-within-the-pxd">
<span id="magic-attributes-pxd"></span><h5>Magic Attributes within the .pxd<a class="headerlink" href="#magic-attributes-within-the-pxd" title="Permalink to this headline">¶</a></h5>
<p>The special <cite>cython</cite> module can also be imported and used within the augmenting
<code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> file. For example, the following Python file <code class="file docutils literal notranslate"><span class="pre">dostuff.py</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dostuff</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
<p>can be augmented with the following <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> file <code class="file docutils literal notranslate"><span class="pre">dostuff.pxd</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">locals</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">dostuff</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">cython.declare()</span></code> function can be used to specify types for global
variables in the augmenting <code class="file docutils literal notranslate"><span class="pre">.pxd</span></code> file.</p>
</div>
</div>
<div class="section" id="tips-and-tricks">
<h4>Tips and Tricks<a class="headerlink" href="#tips-and-tricks" title="Permalink to this headline">¶</a></h4>
<div class="section" id="calling-c-functions">
<h5>Calling C functions<a class="headerlink" href="#calling-c-functions" title="Permalink to this headline">¶</a></h5>
<p>Normally, it isn’t possible to call C functions in pure Python mode as there
is no general way to support it in normal (uncompiled) Python.  However, in
cases where an equivalent Python function exists, this can be achieved by
combining C function coercion with a conditional import as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># mymodule.pxd</span>

<span class="c"># declare a C function as &quot;cpdef&quot; to export it to the module</span>
<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;math.h&quot;</span><span class="p">:</span>
    <span class="k">cpdef</span> <span class="kt">double</span> <span class="nf">sin</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># mymodule.py</span>

<span class="k">import</span> <span class="nn">cython</span>

<span class="c"># override with Python import if not in compiled code</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">cython</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
    <span class="k">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sin</span>

<span class="c"># calls sin() from math.h when compiled with Cython and math.sin() in Python</span>
<span class="k">print</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">0</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that the “sin” function will show up in the module namespace of “mymodule”
here (i.e. there will be a <code class="docutils literal notranslate"><span class="pre">mymodule.sin()</span></code> function).  You can mark it as an
internal name according to Python conventions by renaming it to “_sin” in the
<code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;math.h&quot;</span><span class="p">:</span>
    <span class="k">cpdef</span> <span class="kt">double</span> <span class="kt">_sin</span> <span class="s">&quot;sin&quot;</span> <span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>You would then also change the Python import to <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">math</span> <span class="pre">import</span> <span class="pre">sin</span> <span class="pre">as</span> <span class="pre">_sin</span></code>
to make the names match again.</p>
</div>
<div class="section" id="using-c-arrays-for-fixed-size-lists">
<h5>Using C arrays for fixed size lists<a class="headerlink" href="#using-c-arrays-for-fixed-size-lists" title="Permalink to this headline">¶</a></h5>
<p>C arrays can automatically coerce to Python lists or tuples.
This can be exploited to replace fixed size Python lists in Python code by C
arrays when compiled.  An example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">cython</span>


<span class="nd">@cython</span><span class="o">.</span><span class="n">locals</span><span class="p">(</span><span class="n">counts</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">[</span><span class="mf">10</span><span class="p">],</span> <span class="n">digit</span><span class="o">=</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">count_digits</span><span class="p">(</span><span class="n">digits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; digits = &#39;01112222333334445667788899&#39;</span>
<span class="sd">    &gt;&gt;&gt; count_digits(map(int, digits))</span>
<span class="sd">    [1, 3, 4, 5, 3, 1, 2, 2, 3, 2]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">10</span>
    <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">:</span>
        <span class="k">assert</span> <span class="mf">0</span> <span class="o">&lt;=</span> <span class="n">digit</span> <span class="o">&lt;=</span> <span class="mf">9</span>
        <span class="n">counts</span><span class="p">[</span><span class="n">digit</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1</span>
    <span class="k">return</span> <span class="n">counts</span>
</pre></div>
</div>
<p>In normal Python, this will use a Python list to collect the counts, whereas
Cython will generate C code that uses a C array of C ints.</p>
</div>
</div>
</div>
<span id="document-src/tutorial/numpy"></span><div class="section" id="working-with-numpy">
<span id="working-numpy"></span><h3>Working with NumPy<a class="headerlink" href="#working-with-numpy" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Cython 0.16 introduced typed memoryviews as a successor to the NumPy
integration described here.  They are easier to use than the buffer syntax
below, have less overhead, and can be passed around without requiring the GIL.
They should be preferred to the syntax presented in this page.
See <a class="reference internal" href="index.html#numpy-tutorial"><span class="std std-ref">Cython for NumPy users</span></a>.</p>
</div>
<p>You can use NumPy from Cython exactly the same as in regular Python, but by
doing so you are losing potentially high speedups because Cython has support
for fast access to NumPy arrays. Let’s see how this works with a simple
example.</p>
<p>The code below does 2D discrete convolution of an image with a filter (and I’m
sure you can do better!, let it serve for demonstration purposes). It is both
valid Python and valid Cython code. I’ll refer to it as both
<code class="file docutils literal notranslate"><span class="pre">convolve_py.py</span></code> for the Python version and <code class="file docutils literal notranslate"><span class="pre">convolve1.pyx</span></code> for
the Cython version – Cython uses “.pyx” as its file suffix.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">naive_convolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
    <span class="c"># f is an image and is indexed by (v, w)</span>
    <span class="c"># g is a filter kernel and is indexed by (s, t),</span>
    <span class="c">#   it needs odd dimensions</span>
    <span class="c"># h is the output image and is indexed by (x, y),</span>
    <span class="c">#   it is not cropped</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">%</span> <span class="mf">2</span> <span class="o">!=</span> <span class="mf">1</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">%</span> <span class="mf">2</span> <span class="o">!=</span> <span class="mf">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Only odd dimensions on filter supported&quot;</span><span class="p">)</span>
    <span class="c"># smid and tmid are number of pixels between the center pixel</span>
    <span class="c"># and the edge, ie for a 5x5 filter they will be 2.</span>
    <span class="c">#</span>
    <span class="c"># The output size is calculated by adding smid, tmid to each</span>
    <span class="c"># side of the dimensions of the input image.</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">wmax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="n">smax</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="n">smid</span> <span class="o">=</span> <span class="n">smax</span> <span class="o">//</span> <span class="mf">2</span>
    <span class="n">tmid</span> <span class="o">=</span> <span class="n">tmax</span> <span class="o">//</span> <span class="mf">2</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">+</span> <span class="mf">2</span> <span class="o">*</span> <span class="n">smid</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">wmax</span> <span class="o">+</span> <span class="mf">2</span> <span class="o">*</span> <span class="n">tmid</span>
    <span class="c"># Allocate result image.</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="c"># Do convolution</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xmax</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ymax</span><span class="p">):</span>
            <span class="c"># Calculate pixel value for h at (x,y). Sum one component</span>
            <span class="c"># for each pixel (s, t) of the filter g.</span>
            <span class="n">s_from</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smid</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">smid</span><span class="p">)</span>
            <span class="n">s_to</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">smid</span><span class="p">,</span> <span class="n">smid</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span>
            <span class="n">t_from</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tmid</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">tmid</span><span class="p">)</span>
            <span class="n">t_to</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">tmid</span><span class="p">,</span> <span class="n">tmid</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mf">0</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_from</span><span class="p">,</span> <span class="n">s_to</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_from</span><span class="p">,</span> <span class="n">t_to</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">smid</span> <span class="o">+</span> <span class="n">s</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">tmid</span> <span class="o">+</span> <span class="n">t</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="n">g</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="n">s</span><span class="p">,</span> <span class="n">tmid</span> <span class="o">-</span> <span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span>
            <span class="n">h</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">h</span>
</pre></div>
</div>
<p>This should be compiled to produce <code class="file docutils literal notranslate"><span class="pre">yourmod.so</span></code> (for Linux systems, on Windows
systems, it will be <code class="file docutils literal notranslate"><span class="pre">yourmod.pyd</span></code>). We
run a Python session to test both the Python version (imported from
<code class="docutils literal notranslate"><span class="pre">.py</span></code>-file) and the compiled Cython module.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="gp">In [2]: </span><span class="kn">import</span> <span class="nn">convolve_py</span>
<span class="gp">In [3]: </span><span class="n">convolve_py</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
<span class="go">...     np.array([[1],[2],[1]], dtype=np.int))</span>
<span class="go">Out [3]:</span>
<span class="go">array([[1, 1, 1],</span>
<span class="go">    [2, 2, 2],</span>
<span class="go">    [1, 1, 1]])</span>
<span class="gp">In [4]: </span><span class="kn">import</span> <span class="nn">convolve1</span>
<span class="gp">In [4]: </span><span class="n">convolve1</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
<span class="go">...     np.array([[1],[2],[1]], dtype=np.int))</span>
<span class="go">Out [4]:</span>
<span class="go">array([[1, 1, 1],</span>
<span class="go">    [2, 2, 2],</span>
<span class="go">    [1, 1, 1]])</span>
<span class="gp">In [11]: </span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="gp">In [12]: </span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
<span class="gp">In [13]: </span><span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">81</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="gp">In [19]: </span><span class="o">%</span><span class="n">timeit</span> <span class="o">-</span><span class="n">n2</span> <span class="o">-</span><span class="n">r3</span> <span class="n">convolve_py</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<span class="go">2 loops, best of 3: 1.86 s per loop</span>
<span class="gp">In [20]: </span><span class="o">%</span><span class="n">timeit</span> <span class="o">-</span><span class="n">n2</span> <span class="o">-</span><span class="n">r3</span> <span class="n">convolve1</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<span class="go">2 loops, best of 3: 1.41 s per loop</span>
</pre></div>
</div>
<p>There’s not such a huge difference yet; because the C code still does exactly
what the Python interpreter does (meaning, for instance, that a new object is
allocated for each number used). Look at the generated html file and see what
is needed for even the simplest statements you get the point quickly. We need
to give Cython more information; we need to add types.</p>
<div class="section" id="adding-types">
<h4>Adding types<a class="headerlink" href="#adding-types" title="Permalink to this headline">¶</a></h4>
<p>To add types we use custom Cython syntax, so we are now breaking Python source
compatibility. Consider this code (<em>read the comments!</em>) :</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># tag: numpy_old</span>
<span class="c"># You can ignore the previous line.</span>
<span class="c"># It&#39;s for internal testing of the cython documentation.</span>

<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c"># &quot;cimport&quot; is used to import special compile-time information</span>
<span class="c"># about the numpy module (this is stored in a file numpy.pxd which is</span>
<span class="c"># currently part of the Cython distribution).</span>
<span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c"># We now need to fix a datatype for our arrays. I&#39;ve used the variable</span>
<span class="c"># DTYPE for this, which is assigned to the usual NumPy runtime</span>
<span class="c"># type info object.</span>
<span class="n">DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span>

<span class="c"># &quot;ctypedef&quot; assigns a corresponding compile-time type to DTYPE_t. For</span>
<span class="c"># every type in the numpy module there&#39;s a corresponding compile-time</span>
<span class="c"># type with a _t-suffix.</span>
<span class="k">ctypedef</span> <span class="n">np</span><span class="o">.</span><span class="n">int_t</span> <span class="n">DTYPE_t</span>

<span class="c"># &quot;def&quot; can type its arguments but not have a return type. The type of the</span>
<span class="c"># arguments for a &quot;def&quot; function is checked at run-time when entering the</span>
<span class="c"># function.</span>
<span class="c">#</span>
<span class="c"># The arrays f, g and h is typed as &quot;np.ndarray&quot; instances. The only effect</span>
<span class="c"># this has is to a) insert checks that the function arguments really are</span>
<span class="c"># NumPy arrays, and b) make some attribute access like f.shape[0] much</span>
<span class="c"># more efficient. (In this example this doesn&#39;t matter though.)</span>
<span class="k">def</span> <span class="nf">naive_convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">g</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">%</span> <span class="mf">2</span> <span class="o">!=</span> <span class="mf">1</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">%</span> <span class="mf">2</span> <span class="o">!=</span> <span class="mf">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Only odd dimensions on filter supported&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DTYPE</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DTYPE</span>

    <span class="c"># The &quot;cdef&quot; keyword is also used within functions to type variables. It</span>
    <span class="c"># can only be used at the top indentation level (there are non-trivial</span>
    <span class="c"># problems with allowing them in other places, though we&#39;d love to see</span>
    <span class="c"># good and thought out proposals for it).</span>
    <span class="c">#</span>
    <span class="c"># For the indices, the &quot;int&quot; type is used. This corresponds to a C int,</span>
    <span class="c"># other C types (like &quot;unsigned int&quot;) could have been used instead.</span>
    <span class="c"># Purists could use &quot;Py_ssize_t&quot; which is the proper Python type for</span>
    <span class="c"># array indices.</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">vmax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">wmax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">smax</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">tmax</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">smid</span> <span class="o">=</span> <span class="n">smax</span> <span class="o">//</span> <span class="mf">2</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">tmid</span> <span class="o">=</span> <span class="n">tmax</span> <span class="o">//</span> <span class="mf">2</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">xmax</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">+</span> <span class="mf">2</span> <span class="o">*</span> <span class="n">smid</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">ymax</span> <span class="o">=</span> <span class="n">wmax</span> <span class="o">+</span> <span class="mf">2</span> <span class="o">*</span> <span class="n">tmid</span>
    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">x</span><span class="p">,</span> <span class="nf">y</span><span class="p">,</span> <span class="nf">s</span><span class="p">,</span> <span class="nf">t</span><span class="p">,</span> <span class="nf">v</span><span class="p">,</span> <span class="nf">w</span>

    <span class="c"># It is very important to type ALL your variables. You do not get any</span>
    <span class="c"># warnings if not, only much slower code (they are implicitly typed as</span>
    <span class="c"># Python objects).</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">s_from</span><span class="p">,</span> <span class="nf">s_to</span><span class="p">,</span> <span class="nf">t_from</span><span class="p">,</span> <span class="nf">t_to</span>

    <span class="c"># For the value variable, we want to use the same data type as is</span>
    <span class="c"># stored in the array, so we use &quot;DTYPE_t&quot; as defined above.</span>
    <span class="c"># NB! An important side-effect of this is that if &quot;value&quot; overflows its</span>
    <span class="c"># datatype size, it will simply wrap around like in C, rather than raise</span>
    <span class="c"># an error like in Python.</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">value</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xmax</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ymax</span><span class="p">):</span>
            <span class="n">s_from</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smid</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">smid</span><span class="p">)</span>
            <span class="n">s_to</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">smid</span><span class="p">,</span> <span class="n">smid</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span>
            <span class="n">t_from</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tmid</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">tmid</span><span class="p">)</span>
            <span class="n">t_to</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">tmid</span><span class="p">,</span> <span class="n">tmid</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mf">0</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_from</span><span class="p">,</span> <span class="n">s_to</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_from</span><span class="p">,</span> <span class="n">t_to</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">smid</span> <span class="o">+</span> <span class="n">s</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">tmid</span> <span class="o">+</span> <span class="n">t</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="n">g</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="n">s</span><span class="p">,</span> <span class="n">tmid</span> <span class="o">-</span> <span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span>
            <span class="n">h</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">h</span>
</pre></div>
</div>
<p>After building this and continuing my (very informal) benchmarks, I get:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [21]: </span><span class="kn">import</span> <span class="nn">convolve2</span>
<span class="gp">In [22]: </span><span class="o">%</span><span class="n">timeit</span> <span class="o">-</span><span class="n">n2</span> <span class="o">-</span><span class="n">r3</span> <span class="n">convolve2</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<span class="go">2 loops, best of 3: 828 ms per loop</span>
</pre></div>
</div>
</div>
<div class="section" id="efficient-indexing">
<h4>Efficient indexing<a class="headerlink" href="#efficient-indexing" title="Permalink to this headline">¶</a></h4>
<p>There’s still a bottleneck killing performance, and that is the array lookups
and assignments. The <code class="docutils literal notranslate"><span class="pre">[]</span></code>-operator still uses full Python operations –
what we would like to do instead is to access the data buffer directly at C
speed.</p>
<p>What we need to do then is to type the contents of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">ndarray</span></code> objects.
We do this with a special “buffer” syntax which must be told the datatype
(first argument) and number of dimensions (“ndim” keyword-only argument, if
not provided then one-dimensional is assumed).</p>
<p>These are the needed changes:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">def</span> <span class="nf">naive_convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">DTYPE_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">DTYPE_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">g</span><span class="p">):</span>
<span class="o">...</span>
<span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span>[<span class="nf">DTYPE_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">h</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>
</div>
<p>Usage:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [18]: </span><span class="kn">import</span> <span class="nn">convolve3</span>
<span class="gp">In [19]: </span><span class="o">%</span><span class="n">timeit</span> <span class="o">-</span><span class="n">n3</span> <span class="o">-</span><span class="n">r100</span> <span class="n">convolve3</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<span class="go">3 loops, best of 100: 11.6 ms per loop</span>
</pre></div>
</div>
<p>Note the importance of this change.</p>
<p><em>Gotcha</em>: This efficient indexing only affects certain index operations,
namely those with exactly <code class="docutils literal notranslate"><span class="pre">ndim</span></code> number of typed integer indices. So if
<code class="docutils literal notranslate"><span class="pre">v</span></code> for instance isn’t typed, then the lookup <code class="docutils literal notranslate"><span class="pre">f[v,</span> <span class="pre">w]</span></code> isn’t
optimized. On the other hand this means that you can continue using Python
objects for sophisticated dynamic slicing etc. just as when the array is not
typed.</p>
</div>
<div class="section" id="tuning-indexing-further">
<h4>Tuning indexing further<a class="headerlink" href="#tuning-indexing-further" title="Permalink to this headline">¶</a></h4>
<p>The array lookups are still slowed down by two factors:</p>
<ol class="arabic">
<li><p class="first">Bounds checking is performed.</p>
</li>
<li><p class="first">Negative indices are checked for and handled correctly.  The code above is
explicitly coded so that it doesn’t use negative indices, and it
(hopefully) always access within bounds. We can add a decorator to disable
bounds checking:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">cimport</span> <span class="nn">cython</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># turn off bounds-checking for entire function</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># turn off negative index wrapping for entire function</span>
<span class="k">def</span> <span class="nf">naive_convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">DTYPE_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">DTYPE_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">g</span><span class="p">):</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
</ol>
<p>Now bounds checking is not performed (and, as a side-effect, if you ‘’do’’
happen to access out of bounds you will in the best case crash your program
and in the worst case corrupt data). It is possible to switch bounds-checking
mode in many ways, see <a class="reference internal" href="index.html#compiler-directives"><span class="std std-ref">Compiler directives</span></a> for more
information.</p>
<p>Also, we’ve disabled the check to wrap negative indices (e.g. g[-1] giving
the last value).  As with disabling bounds checking, bad things will happen
if we try to actually use negative indices with this disabled.</p>
<p>The function call overhead now starts to play a role, so we compare the latter
two examples with larger N:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [11]: </span><span class="o">%</span><span class="n">timeit</span> <span class="o">-</span><span class="n">n3</span> <span class="o">-</span><span class="n">r100</span> <span class="n">convolve4</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<span class="go">3 loops, best of 100: 5.97 ms per loop</span>
<span class="gp">In [12]: </span><span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="gp">In [13]: </span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
<span class="gp">In [14]: </span><span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">81</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="gp">In [17]: </span><span class="o">%</span><span class="n">timeit</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">r10</span> <span class="n">convolve3</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<span class="go">1 loops, best of 10: 1.16 s per loop</span>
<span class="gp">In [18]: </span><span class="o">%</span><span class="n">timeit</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">r10</span> <span class="n">convolve4</span><span class="o">.</span><span class="n">naive_convolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<span class="go">1 loops, best of 10: 597 ms per loop</span>
</pre></div>
</div>
<p>(Also this is a mixed benchmark as the result array is allocated within the
function call.)</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Speed comes with some cost. Especially it can be dangerous to set typed
objects (like <code class="docutils literal notranslate"><span class="pre">f</span></code>, <code class="docutils literal notranslate"><span class="pre">g</span></code> and <code class="docutils literal notranslate"><span class="pre">h</span></code> in our sample code) to
<code class="docutils literal notranslate"><span class="pre">None</span></code>.  Setting such objects to <code class="docutils literal notranslate"><span class="pre">None</span></code> is entirely
legal, but all you can do with them is check whether they are None. All
other use (attribute lookup or indexing) can potentially segfault or
corrupt data (rather than raising exceptions as they would in Python).</p>
<p class="last">The actual rules are a bit more complicated but the main message is clear:
Do not use typed objects without knowing that they are not set to None.</p>
</div>
</div>
<div class="section" id="more-generic-code">
<h4>More generic code<a class="headerlink" href="#more-generic-code" title="Permalink to this headline">¶</a></h4>
<p>It would be possible to do:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">naive_convolve</span><span class="p">(</span><span class="nb">object</span><span class="p">[</span><span class="n">DTYPE_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">f</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
</pre></div>
</div>
<p>i.e. use <a class="reference external" href="https://docs.python.org/3/library/functions.html#object" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">object</span></code></a> rather than <code class="xref py py-obj docutils literal notranslate"><span class="pre">np.ndarray</span></code>. Under Python 3.0 this
can allow your algorithm to work with any libraries supporting the buffer
interface; and support for e.g. the Python Imaging Library may easily be added
if someone is interested also under Python 2.x.</p>
<p>There is some speed penalty to this though (as one makes more assumptions
compile-time if the type is set to <code class="xref py py-obj docutils literal notranslate"><span class="pre">np.ndarray</span></code>, specifically it is
assumed that the data is stored in pure strided mode and not in indirect
mode).</p>
</div>
</div>
<span id="document-src/tutorial/array"></span><div class="section" id="working-with-python-arrays">
<span id="array-array"></span><h3>Working with Python arrays<a class="headerlink" href="#working-with-python-arrays" title="Permalink to this headline">¶</a></h3>
<p>Python has a builtin array module supporting dynamic 1-dimensional arrays of
primitive types. It is possible to access the underlying C array of a Python
array from within Cython. At the same time they are ordinary Python objects
which can be stored in lists and serialized between processes when using
<a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">multiprocessing</span></code></a>.</p>
<p>Compared to the manual approach with <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code>, this
gives the safe and automatic memory management of Python, and compared to a
Numpy array there is no need to install a dependency, as the <a class="reference external" href="https://docs.python.org/3/library/array.html#module-array" title="(in Python v3.7)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">array</span></code></a>
module is built into both Python and Cython.</p>
<div class="section" id="safe-usage-with-memory-views">
<h4>Safe usage with memory views<a class="headerlink" href="#safe-usage-with-memory-views" title="Permalink to this headline">¶</a></h4>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="n">array</span>
<span class="k">import</span> <span class="nn">array</span>
<span class="k">cdef</span> <span class="kt">array</span>.<span class="kt">array</span> <span class="nf">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">])</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">a</span>

<span class="k">print</span><span class="p">(</span><span class="n">ca</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
</pre></div>
</div>
<p>NB: the import brings the regular Python array object into the namespace
while the cimport adds functions accessible from Cython.</p>
<p>A Python array is constructed with a type signature and sequence of
initial values. For the possible type signatures, refer to the Python
documentation for the <a class="reference external" href="https://docs.python.org/library/array.html">array module</a>.</p>
<p>Notice that when a Python array is assigned to a variable typed as
memory view, there will be a slight overhead to construct the memory
view. However, from that point on the variable can be passed to other
functions without overhead, so long as it is typed:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="n">array</span>
<span class="k">import</span> <span class="nn">array</span>

<span class="k">cdef</span> <span class="kt">array</span>.<span class="kt">array</span> <span class="nf">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">])</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">a</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">overhead</span><span class="p">(</span><span class="nb">object</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">ca</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">no_overhead</span><span class="p">(</span><span class="nb">int</span><span class="p">[:]</span> <span class="n">ca</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ca</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="n">overhead</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>  <span class="c"># new memory view will be constructed, overhead</span>
<span class="k">print</span><span class="p">(</span><span class="n">no_overhead</span><span class="p">(</span><span class="n">ca</span><span class="p">))</span>  <span class="c"># ca is already a memory view, so no overhead</span>
</pre></div>
</div>
</div>
<div class="section" id="zero-overhead-unsafe-access-to-raw-c-pointer">
<h4>Zero-overhead, unsafe access to raw C pointer<a class="headerlink" href="#zero-overhead-unsafe-access-to-raw-c-pointer" title="Permalink to this headline">¶</a></h4>
<p>To avoid any overhead and to be able to pass a C pointer to other
functions, it is possible to access the underlying contiguous array as a
pointer. There is no type or bounds checking, so be careful to use the
right type and signedness.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="n">array</span>
<span class="k">import</span> <span class="nn">array</span>

<span class="k">cdef</span> <span class="kt">array</span>.<span class="kt">array</span> <span class="nf">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">])</span>

<span class="c"># access underlying pointer:</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">as_ints</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>

<span class="k">from</span> <span class="nn">libc.string</span> <span class="k">cimport</span> <span class="n">memset</span>

<span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">as_voidptr</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that any length-changing operation on the array object may invalidate the
pointer.</p>
</div>
<div class="section" id="cloning-extending-arrays">
<h4>Cloning, extending arrays<a class="headerlink" href="#cloning-extending-arrays" title="Permalink to this headline">¶</a></h4>
<p>To avoid having to use the array constructor from the Python module,
it is possible to create a new array with the same type as a template,
and preallocate a given number of elements. The array is initialized to
zero when requested.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="n">array</span>
<span class="k">import</span> <span class="nn">array</span>

<span class="k">cdef</span> <span class="kt">array</span>.<span class="kt">array</span> <span class="nf">int_array_template</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="k">cdef</span> <span class="kt">array</span>.<span class="kt">array</span> <span class="nf">newarray</span>

<span class="c"># create an array with 3 elements with same type as template</span>
<span class="n">newarray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">int_array_template</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="n">zero</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>An array can also be extended and resized; this avoids repeated memory
reallocation which would occur if elements would be appended or removed
one by one.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="n">array</span>
<span class="k">import</span> <span class="nn">array</span>

<span class="k">cdef</span> <span class="kt">array</span>.<span class="kt">array</span> <span class="nf">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">])</span>
<span class="k">cdef</span> <span class="kt">array</span>.<span class="kt">array</span> <span class="nf">b</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">4</span><span class="p">,</span> <span class="mf">5</span><span class="p">,</span> <span class="mf">6</span><span class="p">])</span>

<span class="c"># extend a with b, resize as needed</span>
<span class="n">array</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="c"># resize a, leaving just original three elements</span>
<span class="n">array</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="api-reference">
<h4>API reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h4>
<div class="section" id="data-fields">
<h5>Data fields<a class="headerlink" href="#data-fields" title="Permalink to this headline">¶</a></h5>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">as_voidptr</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_chars</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_schars</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_uchars</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_shorts</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_ushorts</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_ints</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_uints</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_longs</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_ulongs</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_longlongs</span>  <span class="c"># requires Python &gt;=3</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_ulonglongs</span>  <span class="c"># requires Python &gt;=3</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_floats</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_doubles</span>
<span class="n">data</span><span class="o">.</span><span class="n">as_pyunicodes</span>
</pre></div>
</div>
<p>Direct access to the underlying contiguous C array, with given type;
e.g., <code class="docutils literal notranslate"><span class="pre">myarray.data.as_ints</span></code>.</p>
</div>
<div class="section" id="functions">
<h5>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h5>
<p>The following functions are available to Cython from the array module:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">resize</span><span class="p">(</span><span class="n">array</span> <span class="bp">self</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">except</span> <span class="o">-</span><span class="mf">1</span>
</pre></div>
</div>
<p>Fast resize / realloc. Not suitable for repeated, small increments; resizes
underlying array to exactly the requested amount.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">resize_smart</span><span class="p">(</span><span class="n">array</span> <span class="bp">self</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">except</span> <span class="o">-</span><span class="mf">1</span>
</pre></div>
</div>
<p>Efficient for small increments; uses growth pattern that delivers
amortized linear-time appends.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">array</span> <span class="nf">clone</span><span class="p">(</span><span class="n">array</span> <span class="n">template</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">length</span><span class="p">,</span> <span class="n">bint</span> <span class="n">zero</span><span class="p">)</span>
</pre></div>
</div>
<p>Fast creation of a new array, given a template array. Type will be same as
<code class="docutils literal notranslate"><span class="pre">template</span></code>. If zero is <code class="docutils literal notranslate"><span class="pre">True</span></code>, new array will be initialized with zeroes.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">array</span> <span class="nf">copy</span><span class="p">(</span><span class="n">array</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Make a copy of an array.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">extend_buffer</span><span class="p">(</span><span class="n">array</span> <span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="o">*</span> <span class="n">stuff</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">except</span> <span class="o">-</span><span class="mf">1</span>
</pre></div>
</div>
<p>Efficient appending of new data of same type (e.g. of same array type)
<code class="docutils literal notranslate"><span class="pre">n</span></code>: number of elements (not number of bytes!)</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">extend</span><span class="p">(</span><span class="n">array</span> <span class="bp">self</span><span class="p">,</span> <span class="n">array</span> <span class="n">other</span><span class="p">)</span> <span class="k">except</span> <span class="o">-</span><span class="mf">1</span>
</pre></div>
</div>
<p>Extend array with data from another array; types must match.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">zero</span><span class="p">(</span><span class="n">array</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Set all elements of array to zero.</p>
</div>
</div>
</div>
<span id="document-src/tutorial/readings"></span><div class="section" id="further-reading">
<h3>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h3>
<p>The main documentation is located at <a class="reference external" href="http://docs.cython.org/">http://docs.cython.org/</a>. Some
recent features might not have documentation written yet, in such
cases some notes can usually be found in the form of a Cython
Enhancement Proposal (CEP) on <a class="reference external" href="https://github.com/cython/cython/wiki/enhancements">https://github.com/cython/cython/wiki/enhancements</a>.</p>
<p><a class="reference internal" href="index.html#seljebotn09" id="id1">[Seljebotn09]</a> contains more information about Cython and NumPy
arrays. If you intend to use Cython code in a multi-threaded setting,
it is essential to read up on Cython’s features for managing the
Global Interpreter Lock (the GIL). The same paper contains an
explanation of the GIL, and the main documentation explains the Cython
features for managing it.</p>
<p>Finally, don’t hesitate to ask questions (or post reports on
successes!) on the Cython users mailing list <a class="reference internal" href="index.html#userlist" id="id2">[UserList]</a>.  The Cython
developer mailing list, <a class="reference internal" href="index.html#devlist" id="id3">[DevList]</a>, is also open to everybody, but
focuses on core development issues.  Feel free to use it to report a
clear bug, to ask for guidance if you have time to spare to develop
Cython, or if you have suggestions for future development.</p>
<table class="docutils citation" frame="void" id="devlist" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[DevList]</a></td><td>Cython developer mailing list: <a class="reference external" href="https://mail.python.org/mailman/listinfo/cython-devel">https://mail.python.org/mailman/listinfo/cython-devel</a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="seljebotn09" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[Seljebotn09]</a></td><td>D. S. Seljebotn, Fast numerical computations with Cython,
Proceedings of the 8th Python in Science Conference, 2009.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="userlist" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[UserList]</a></td><td>Cython users mailing list: <a class="reference external" href="https://groups.google.com/group/cython-users">https://groups.google.com/group/cython-users</a></td></tr>
</tbody>
</table>
</div>
<span id="document-src/tutorial/related_work"></span><div class="section" id="related-work">
<h3>Related work<a class="headerlink" href="#related-work" title="Permalink to this headline">¶</a></h3>
<p>Pyrex <a class="reference internal" href="index.html#pyrex" id="id1">[Pyrex]</a> is the compiler project that Cython was originally
based on.  Many features and the major design decisions of the Cython
language were developed by Greg Ewing as part of that project.  Today,
Cython supersedes the capabilities of Pyrex by providing a
substantially higher compatibility with Python code and Python
semantics, as well as superior optimisations and better integration
with scientific Python extensions like NumPy.</p>
<p>ctypes <a class="reference internal" href="index.html#ctypes" id="id2">[ctypes]</a> is a foreign function interface (FFI) for Python.  It
provides C compatible data types, and allows calling functions in DLLs
or shared libraries.  It can be used to wrap these libraries in pure
Python code.  Compared to Cython, it has the major advantage of being
in the standard library and being usable directly from Python code,
without any additional dependencies.  The major drawback is its
performance, which suffers from the Python call overhead as all
operations must pass through Python code first.  Cython, being a
compiled language, can avoid much of this overhead by moving more
functionality and long-running loops into fast C code.</p>
<p>SWIG <a class="reference internal" href="index.html#swig" id="id3">[SWIG]</a> is a wrapper code generator.  It makes it very easy to
parse large API definitions in C/C++ header files, and to generate
straight forward wrapper code for a large set of programming
languages.  As opposed to Cython, however, it is not a programming
language itself.  Thin wrappers are easy to generate, but the more
functionality a wrapper needs to provide, the harder it gets to
implement it with SWIG.  Cython, on the other hand, makes it very easy
to write very elaborate wrapper code specifically for the Python
language, and to make it as thin or thick as needed at any given
place.  Also, there exists third party code for parsing C header files
and using it to generate Cython definitions and module skeletons.</p>
<p>ShedSkin <a class="reference internal" href="index.html#shedskin" id="id4">[ShedSkin]</a> is an experimental Python-to-C++ compiler. It
uses a very powerful whole-module type inference engine to generate a
C++ program from (restricted) Python source code.  The main drawback
is that it has no support for calling the Python/C API for operations
it does not support natively, and supports very few of the standard
Python modules.</p>
<table class="docutils citation" frame="void" id="ctypes" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[ctypes]</a></td><td><a class="reference external" href="https://docs.python.org/library/ctypes.html">https://docs.python.org/library/ctypes.html</a>.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="shedskin" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[ShedSkin]</a></td><td>M. Dufour, J. Coughlan, ShedSkin,
<a class="reference external" href="https://github.com/shedskin/shedskin">https://github.com/shedskin/shedskin</a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="swig" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[SWIG]</a></td><td>David M. Beazley et al.,
SWIG: An Easy to Use Tool for Integrating Scripting Languages with C and C++,
<a class="reference external" href="http://www.swig.org">http://www.swig.org</a>.</td></tr>
</tbody>
</table>
</div>
<span id="document-src/tutorial/appendix"></span><div class="section" id="appendix-installing-mingw-on-windows">
<h3>Appendix: Installing MinGW on Windows<a class="headerlink" href="#appendix-installing-mingw-on-windows" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Download the MinGW installer from
<a class="reference external" href="http://www.mingw.org/wiki/HOWTO_Install_the_MinGW_GCC_Compiler_Suite">http://www.mingw.org/wiki/HOWTO_Install_the_MinGW_GCC_Compiler_Suite</a>.
(As of this
writing, the download link is a bit difficult to find; it’s under
“About” in the menu on the left-hand side). You want the file
entitled “Automated MinGW Installer” (currently version 5.1.4).</p>
</li>
<li><p class="first">Run it and install MinGW. Only the basic package is strictly
needed for Cython, although you might want to grab at least the
C++ compiler as well.</p>
</li>
<li><p class="first">You need to set up Windows’ “PATH” environment variable so that
includes e.g. “c:\mingw\bin” (if you installed MinGW to
“c:\mingw”). The following web-page describes the procedure
in Windows XP (the Vista procedure is similar):
<a class="reference external" href="https://support.microsoft.com/kb/310519">https://support.microsoft.com/kb/310519</a></p>
</li>
<li><p class="first">Finally, tell Python to use MinGW as the default compiler
(otherwise it will try for Visual C). If Python is installed to
“c:\Python27”, create a file named
“c:\Python27\Lib\distutils\distutils.cfg” containing:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">build</span><span class="p">]</span>
<span class="n">compiler</span> <span class="o">=</span> <span class="n">mingw32</span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
<p>The <a class="reference internal" href="index.html#wininst" id="id1">[WinInst]</a> wiki page contains updated information about this
procedure. Any contributions towards making the Windows install
process smoother is welcomed; it is an unfortunate fact that none of
the regular Cython developers have convenient access to Windows.</p>
<table class="docutils citation" frame="void" id="wininst" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[WinInst]</a></td><td><a class="reference external" href="https://github.com/cython/cython/wiki/CythonExtensionsOnWindows">https://github.com/cython/cython/wiki/CythonExtensionsOnWindows</a></td></tr>
</tbody>
</table>
</div>
</div>
</div>
<span id="document-src/userguide/index"></span><div class="section" id="users-guide">
<h2>Users Guide<a class="headerlink" href="#users-guide" title="Permalink to this headline">¶</a></h2>
<p>Contents:</p>
<div class="toctree-wrapper compound">
<span id="document-src/userguide/language_basics"></span><div class="section" id="ctypedef">
<span id="enum"></span><span id="union"></span><span id="struct"></span><span id="language-basics"></span><span id="id1"></span><h3>Language Basics<a class="headerlink" href="#ctypedef" title="Permalink to this headline">¶</a></h3>
<div class="section" id="declaring-data-types">
<span id="id2"></span><h4>Declaring Data Types<a class="headerlink" href="#declaring-data-types" title="Permalink to this headline">¶</a></h4>
<p>As a dynamic language, Python encourages a programming style of considering
classes and objects in terms of their methods and attributes, more than where
they fit into the class hierarchy.</p>
<p>This can make Python a very relaxed and comfortable language for rapid
development, but with a price - the ‘red tape’ of managing data types is
dumped onto the interpreter. At run time, the interpreter does a lot of work
searching namespaces, fetching attributes and parsing argument and keyword tuples.
This run-time ‘late binding’ is a major cause of Python’s relative slowness
compared to ‘early binding’ languages such as C++.</p>
<p>However with Cython it is possible to gain significant speed-ups through
the use of ‘early binding’ programming techniques.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Typing is not a necessity</p>
<p class="last">Providing static typing to parameters and variables is convenience to
speed up your code, but it is not a necessity. Optimize where and when needed.
In fact, typing can <em>slow down</em> your code in the case where the
typing does not allow optimizations but where Cython still needs to
check that the type of some object matches the declared type.</p>
</div>
</div>
<div class="section" id="c-variable-and-type-definitions">
<span id="id3"></span><h4>C variable and type definitions<a class="headerlink" href="#c-variable-and-type-definitions" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> statement is used to declare C variables, either local or
module-level:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">j</span><span class="p">,</span> <span class="nf">k</span>
<span class="k">cdef</span> <span class="kt">float</span> <span class="nf">f</span><span class="p">,</span> <span class="kt">g</span>[42], *<span class="nf">h</span>
</pre></div>
</div>
<p>and C <a class="reference internal" href="#struct"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">struct</span></code></a>, <a class="reference internal" href="#union"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">union</span></code></a> or <a class="reference internal" href="#enum"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">enum</span></code></a> types:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">struct</span> <span class="nf">Grail</span><span class="p">:</span>
    <span class="nb">int</span> <span class="n">age</span>
    <span class="nb">float</span> <span class="n">volume</span>

<span class="k">cdef</span> <span class="k">union</span> <span class="nf">Food</span><span class="p">:</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">spam</span>
    <span class="nb">float</span> <span class="o">*</span><span class="n">eggs</span>

<span class="k">cdef</span> <span class="k">enum</span> <span class="nf">CheeseType</span><span class="p">:</span>
    <span class="n">cheddar</span><span class="p">,</span> <span class="n">edam</span><span class="p">,</span>
    <span class="n">camembert</span>

<span class="k">cdef</span> <span class="k">enum</span> <span class="nf">CheeseState</span><span class="p">:</span>
    <span class="n">hard</span> <span class="o">=</span> <span class="mf">1</span>
    <span class="n">soft</span> <span class="o">=</span> <span class="mf">2</span>
    <span class="n">runny</span> <span class="o">=</span> <span class="mf">3</span>
</pre></div>
</div>
<p>See also <a class="reference internal" href="index.html#struct-union-enum-styles"><span class="std std-ref">Styles of struct, union and enum declaration</span></a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Structs can be declared as <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">packed</span> <span class="pre">struct</span></code>, which has
the same effect as the C directive <code class="docutils literal notranslate"><span class="pre">#pragma</span> <span class="pre">pack(1)</span></code>.</p>
</div>
<p>Declaring an enum as <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> will create a <span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0435"><strong>PEP 435</strong></a>-style Python wrapper:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cpdef</span> <span class="k">enum</span> <span class="nf">CheeseState</span><span class="p">:</span>
    <span class="n">hard</span> <span class="o">=</span> <span class="mf">1</span>
    <span class="n">soft</span> <span class="o">=</span> <span class="mf">2</span>
    <span class="n">runny</span> <span class="o">=</span> <span class="mf">3</span>
</pre></div>
</div>
<p>There is currently no special syntax for defining a constant, but you can use
an anonymous <a class="reference internal" href="#enum"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">enum</span></code></a> declaration for this purpose, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">enum</span><span class="p">:</span>
    <span class="n">tons_of_spam</span> <span class="o">=</span> <span class="mf">3</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>the words <code class="docutils literal notranslate"><span class="pre">struct</span></code>, <code class="docutils literal notranslate"><span class="pre">union</span></code> and <code class="docutils literal notranslate"><span class="pre">enum</span></code> are used only when
defining a type, not when referring to it. For example, to declare a variable
pointing to a <code class="docutils literal notranslate"><span class="pre">Grail</span></code> you would write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">Grail</span> *<span class="nf">gp</span>
</pre></div>
</div>
<p>and not:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">struct</span> <span class="kt">Grail</span> *<span class="nf">gp</span> <span class="c"># WRONG</span>
</pre></div>
</div>
<p>There is also a <code class="docutils literal notranslate"><span class="pre">ctypedef</span></code> statement for giving names to types, e.g.:</p>
<div class="last highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="n">unsigned</span> <span class="nb">long</span> <span class="n">ULong</span>

<span class="k">ctypedef</span> <span class="nb">int</span><span class="o">*</span> <span class="n">IntPtr</span>
</pre></div>
</div>
</div>
<p>It is also possible to declare functions with <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a>, making them c functions.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">eggs</span><span class="p">(</span><span class="n">unsigned</span> <span class="nb">long</span> <span class="n">l</span><span class="p">,</span> <span class="nb">float</span> <span class="n">f</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>You can read more about them in <a class="reference internal" href="#python-functions-vs-c-functions"><span class="std std-ref">Python functions vs. C functions</span></a>.</p>
<p>You can declare classes with <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a>, making them <a class="reference internal" href="index.html#extension-types"><span class="std std-ref">Extension Types</span></a>. Those will
have a behavior very close to python classes, but are faster because they use a <code class="docutils literal notranslate"><span class="pre">struct</span></code>
internally to store attributes.</p>
<p>Here is a simple example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Shrubbery</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">width</span><span class="p">,</span> <span class="nf">height</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;This shrubbery is&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
              <span class="s">&quot;by&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="s">&quot;cubits.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can read more about them in <a class="reference internal" href="index.html#extension-types"><span class="std std-ref">Extension Types</span></a>.</p>
<div class="section" id="types">
<span id="typing-types"></span><span id="id4"></span><h5>Types<a class="headerlink" href="#types" title="Permalink to this headline">¶</a></h5>
<p>Cython uses the normal C syntax for C types, including pointers.  It provides
all the standard C types, namely <code class="docutils literal notranslate"><span class="pre">char</span></code>, <code class="docutils literal notranslate"><span class="pre">short</span></code>, <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">long</span></code>,
<code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">long</span></code> as well as their <code class="docutils literal notranslate"><span class="pre">unsigned</span></code> versions, e.g. <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span></code>.
The special <code class="docutils literal notranslate"><span class="pre">bint</span></code> type is used for C boolean values (<code class="docutils literal notranslate"><span class="pre">int</span></code> with 0/non-0
values for False/True) and <code class="docutils literal notranslate"><span class="pre">Py_ssize_t</span></code> for (signed) sizes of Python
containers.</p>
<p>Pointer types are constructed as in C, by appending a <code class="docutils literal notranslate"><span class="pre">*</span></code> to the base type
they point to, e.g. <code class="docutils literal notranslate"><span class="pre">int**</span></code> for a pointer to a pointer to a C int.
Arrays use the normal C array syntax, e.g. <code class="docutils literal notranslate"><span class="pre">int[10]</span></code>, and the size must be known
at compile time for stack allocated arrays. Cython doesn’t support variable length arrays from C99.
Note that Cython uses array access for pointer dereferencing, as <code class="docutils literal notranslate"><span class="pre">*x</span></code> is not valid Python syntax,
whereas <code class="docutils literal notranslate"><span class="pre">x[0]</span></code> is.</p>
<p>Also, the Python types <code class="docutils literal notranslate"><span class="pre">list</span></code>, <code class="docutils literal notranslate"><span class="pre">dict</span></code>, <code class="docutils literal notranslate"><span class="pre">tuple</span></code>, etc. may be used for
static typing, as well as any user defined <a class="reference internal" href="index.html#extension-types"><span class="std std-ref">Extension Types</span></a>.
For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">list</span> <span class="nf">foo</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>This requires an <em>exact</em> match of the class, it does not allow
subclasses. This allows Cython to optimize code by accessing
internals of the builtin class.
For this kind of typing, Cython uses internally a C variable of type <code class="docutils literal notranslate"><span class="pre">PyObject*</span></code>.
The Python types int, long, and float are not available for static
typing and instead interpreted as C <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">long</span></code>, and <code class="docutils literal notranslate"><span class="pre">float</span></code>
respectively, as statically typing variables with these Python
types has zero advantages.</p>
<p>Cython provides an accelerated and typed equivalent of a Python tuple, the <code class="docutils literal notranslate"><span class="pre">ctuple</span></code>.
A <code class="docutils literal notranslate"><span class="pre">ctuple</span></code> is assembled from any valid C types. For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> (<span class="nf">double</span><span class="p">,</span> <span class="kt">int</span>) <span class="nf">bar</span>
</pre></div>
</div>
<p>They compile down to C-structures and can be used as efficient alternatives to
Python tuples.</p>
<p>While these C types can be vastly faster, they have C semantics.
Specifically, the integer types overflow
and the C <code class="docutils literal notranslate"><span class="pre">float</span></code> type only has 32 bits of precision
(as opposed to the 64-bit C <code class="docutils literal notranslate"><span class="pre">double</span></code> which Python floats wrap
and is typically what one wants).
If you want to use these numeric Python types simply omit the
type declaration and let them be objects.</p>
<p>It is also possible to declare <a class="reference internal" href="index.html#extension-types"><span class="std std-ref">Extension Types</span></a> (declared with <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">class</span></code>).
This does allow subclasses. This typing is mostly used to access
<code class="docutils literal notranslate"><span class="pre">cdef</span></code> methods and attributes of the extension type.
The C code uses a variable which is a pointer to a structure of the
specific type, something like <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">MyExtensionTypeObject*</span></code>.</p>
</div>
<div class="section" id="grouping-multiple-c-declarations">
<h5>Grouping multiple C declarations<a class="headerlink" href="#grouping-multiple-c-declarations" title="Permalink to this headline">¶</a></h5>
<p>If you have a series of declarations that all begin with <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a>, you
can group them into a <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> block like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="n">cdef</span><span class="p">:</span>
    <span class="k">struct</span> <span class="nc">Spam</span><span class="p">:</span>
        <span class="nb">int</span> <span class="n">tons</span>

    <span class="nb">int</span> <span class="n">i</span>
    <span class="nb">float</span> <span class="n">a</span>
    <span class="n">Spam</span> <span class="o">*</span><span class="n">p</span>

    <span class="n">void</span> <span class="n">f</span><span class="p">(</span><span class="n">Spam</span> <span class="o">*</span><span class="n">s</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">tons</span><span class="p">,</span> <span class="s">&quot;Tons of spam&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="python-functions-vs-c-functions">
<span id="cdef"></span><span id="cpdef"></span><span id="id5"></span><h4>Python functions vs. C functions<a class="headerlink" href="#python-functions-vs-c-functions" title="Permalink to this headline">¶</a></h4>
<p>There are two kinds of function definition in Cython:</p>
<p>Python functions are defined using the def statement, as in Python. They take
Python objects as parameters and return Python objects.</p>
<p>C functions are defined using the new <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> statement. They take
either Python objects or C values as parameters, and can return either Python
objects or C values.</p>
<p>Within a Cython module, Python functions and C functions can call each other
freely, but only Python functions can be called from outside the module by
interpreted Python code. So, any functions that you want to “export” from your
Cython module must be declared as Python functions using def.
There is also a hybrid function, called <a class="reference internal" href="#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a>. A <a class="reference internal" href="#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a>
can be called from anywhere, but uses the faster C calling conventions
when being called from other Cython code. A <a class="reference internal" href="#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> can also be overridden
by a Python method on a subclass or an instance attribute, even when called from Cython.
If this happens, most performance gains are of course lost and even if it does not,
there is a tiny overhead in calling a <a class="reference internal" href="#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> method from Cython compared to
calling a <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> method.</p>
<p>Parameters of either type of function can be declared to have C data types,
using normal C declaration syntax. For example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">spam</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span><span class="n">s</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">eggs</span><span class="p">(</span><span class="n">unsigned</span> <span class="nb">long</span> <span class="n">l</span><span class="p">,</span> <span class="nb">float</span> <span class="n">f</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ctuples</span></code> may also be used:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> (<span class="nf">int</span><span class="p">,</span> <span class="kt">float</span>) <span class="nf">chips</span><span class="p">((</span><span class="nb">long</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="n">double</span><span class="p">)</span> <span class="n">t</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>When a parameter of a Python function is declared to have a C data type, it is
passed in as a Python object and automatically converted to a C value, if
possible. In other words, the definition of <code class="docutils literal notranslate"><span class="pre">spam</span></code> above is equivalent to
writing:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">spam</span><span class="p">(</span><span class="n">python_i</span><span class="p">,</span> <span class="n">python_s</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span> <span class="o">=</span> <span class="n">python_i</span>
    <span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">s</span> <span class="o">=</span> <span class="n">python_s</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Automatic conversion is currently only possible for numeric types,
string types and structs (composed recursively of any of these types);
attempting to use any other type for the parameter of a
Python function will result in a compile-time error.
Care must be taken with strings to ensure a reference if the pointer is to be used
after the call. Structs can be obtained from Python mappings, and again care must be taken
with string attributes if they are to be used after the function returns.</p>
<p>C functions, on the other hand, can have parameters of any type, since they’re
passed in directly using a normal C function call.</p>
<p>Functions declared using <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> with Python object return type, like Python functions, will return a <code class="xref std std-keyword docutils literal notranslate"><span class="pre">None</span></code>
value when execution leaves the function body without an explicit return value. This is in
contrast to C/C++, which leaves the return value undefined.
In the case of non-Python object return types, the equivalent of zero is returned, for example, 0 for <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="xref std std-keyword docutils literal notranslate"><span class="pre">False</span></code> for <code class="docutils literal notranslate"><span class="pre">bint</span></code> and <code class="xref std std-keyword docutils literal notranslate"><span class="pre">NULL</span></code> for pointer types.</p>
<p>A more complete comparison of the pros and cons of these different method
types can be found at <a class="reference internal" href="index.html#early-binding-for-speed"><span class="std std-ref">Early Binding for Speed</span></a>.</p>
<div class="section" id="python-objects-as-parameters-and-return-values">
<h5>Python objects as parameters and return values<a class="headerlink" href="#python-objects-as-parameters-and-return-values" title="Permalink to this headline">¶</a></h5>
<p>If no type is specified for a parameter or return value, it is assumed to be a
Python object. (Note that this is different from the C convention, where it
would default to int.) For example, the following defines a C function that
takes two Python objects as parameters and returns a Python object:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">spamobjs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Reference counting for these objects is performed automatically according to
the standard Python/C API rules (i.e. borrowed references are taken as
parameters and a new reference is returned).</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This only applies to Cython code.  Other Python packages which
are implemented in C like NumPy may not follow these conventions.</p>
</div>
</div></blockquote>
<p>The name object can also be used to explicitly declare something as a Python
object. This can be useful if the name being declared would otherwise be taken
as the name of a type, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">ftang</span><span class="p">(</span><span class="nb">object</span> <span class="nb">int</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>declares a parameter called int which is a Python object. You can also use
object as the explicit return type of a function, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">object</span> <span class="nf">ftang</span><span class="p">(</span><span class="nb">object</span> <span class="nb">int</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>In the interests of clarity, it is probably a good idea to always be explicit
about object parameters in C functions.</p>
</div>
<div class="section" id="optional-arguments">
<span id="id6"></span><h5>Optional Arguments<a class="headerlink" href="#optional-arguments" title="Permalink to this headline">¶</a></h5>
<p>Unlike C, it is possible to use optional arguments in <code class="docutils literal notranslate"><span class="pre">cdef</span></code> and <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> functions.
There are differences though whether you declare them in a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code>
file or the corresponding <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file.</p>
<p>To avoid repetition (and potential future inconsistencies), default argument values are
not visible in the declaration (in <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files) but only in
the implementation (in <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> files).</p>
<p>When in a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file, the signature is the same as it is in Python itself:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">C</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">int</span> <span class="n">k</span><span class="o">=</span><span class="mf">3</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
<p>When in a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file, the signature is different like this example: <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">foo(x=*)</span></code>.
This is because the program calling the function just needs to know what signatures are
possible in C, but doesn’t need to know the value of the default arguments.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=*</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">C</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=*</span><span class="p">,</span> <span class="nb">int</span> <span class="n">k</span><span class="o">=*</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The number of arguments may increase when subclassing,
but the arg types and order must be the same, as shown in the example above.</p>
</div>
<p>There may be a slight performance penalty when the optional arg is overridden
with one that does not have default values.</p>
</div>
<div class="section" id="keyword-only-arguments">
<span id="keyword-only-argument"></span><h5>Keyword-only Arguments<a class="headerlink" href="#keyword-only-arguments" title="Permalink to this headline">¶</a></h5>
<p>As in Python 3, <code class="docutils literal notranslate"><span class="pre">def</span></code> functions can have keyword-only arguments
listed after a <code class="docutils literal notranslate"><span class="pre">&quot;*&quot;</span></code> parameter and before a <code class="docutils literal notranslate"><span class="pre">&quot;**&quot;</span></code> parameter if any:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">42</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="o">...</span>


<span class="c"># We cannot call f with less verbosity than this.</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="mf">4</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">68</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
<p>As shown above, the <code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">d</span></code> and <code class="docutils literal notranslate"><span class="pre">e</span></code> arguments can not be
passed as positional arguments and must be passed as keyword arguments.
Furthermore, <code class="docutils literal notranslate"><span class="pre">c</span></code> and <code class="docutils literal notranslate"><span class="pre">e</span></code> are <strong>required</strong> keyword arguments
since they do not have a default value.</p>
<p>A single <code class="docutils literal notranslate"><span class="pre">&quot;*&quot;</span></code> without argument name can be used to
terminate the list of positional arguments:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c"># We cannot call g with less verbosity than this.</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="s">&quot;something&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">68</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="s">&quot;other&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Shown above, the signature takes exactly two positional
parameters and has two required keyword parameters.</p>
</div>
<div class="section" id="function-pointers">
<h5>Function Pointers<a class="headerlink" href="#function-pointers" title="Permalink to this headline">¶</a></h5>
<p>Functions declared in a <code class="docutils literal notranslate"><span class="pre">struct</span></code> are automatically converted to function pointers.</p>
<p>For using error return values with function pointers, see the note at the bottom
of <a class="reference internal" href="#error-return-values"><span class="std std-ref">Error return values</span></a>.</p>
</div>
<div class="section" id="error-return-values">
<span id="id7"></span><h5>Error return values<a class="headerlink" href="#error-return-values" title="Permalink to this headline">¶</a></h5>
<p>If you don’t do anything special, a function declared with <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> that
does not return a Python object has no way of reporting Python exceptions to
its caller. If an exception is detected in such a function, a warning message
is printed and the exception is ignored.</p>
<p>If you want a C function that does not return a Python object to be able to
propagate exceptions to its caller, you need to declare an exception value for
it. Here is an example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">spam</span><span class="p">()</span> <span class="k">except</span> <span class="o">-</span><span class="mf">1</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>With this declaration, whenever an exception occurs inside spam, it will
immediately return with the value <code class="docutils literal notranslate"><span class="pre">-1</span></code>. Furthermore, whenever a call to spam
returns <code class="docutils literal notranslate"><span class="pre">-1</span></code>, an exception will be assumed to have occurred and will be
propagated.</p>
<p>When you declare an exception value for a function, you should never
explicitly or implicitly return that value. In particular, if the exceptional return value
is a <code class="docutils literal notranslate"><span class="pre">False</span></code> value, then you should ensure the function will never terminate via an implicit
or empty return.</p>
<p>If all possible return values are legal and you
can’t reserve one entirely for signalling errors, you can use an alternative
form of exception value declaration:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">spam</span><span class="p">()</span> <span class="k">except</span><span class="o">?</span> <span class="o">-</span><span class="mf">1</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The “?” indicates that the value <code class="docutils literal notranslate"><span class="pre">-1</span></code> only indicates a possible error. In this
case, Cython generates a call to <a class="reference external" href="https://docs.python.org/3/c-api/exceptions.html#c.PyErr_Occurred" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Occurred()</span></code></a> if the exception value is
returned, to make sure it really is an error.</p>
<p>There is also a third form of exception value declaration:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">spam</span><span class="p">()</span> <span class="k">except</span> <span class="o">*</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This form causes Cython to generate a call to <a class="reference external" href="https://docs.python.org/3/c-api/exceptions.html#c.PyErr_Occurred" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Occurred()</span></code></a> after
every call to spam, regardless of what value it returns. If you have a
function returning void that needs to propagate errors, you will have to use
this form, since there isn’t any return value to test.
Otherwise there is little use for this form.</p>
<p>An external C++ function that may raise an exception can be declared with:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">spam</span><span class="p">()</span> <span class="k">except</span> <span class="o">+</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="index.html#wrapping-cplusplus"><span class="std std-ref">Using C++ in Cython</span></a> for more details.</p>
<p>Some things to note:</p>
<ul>
<li><p class="first">Exception values can only declared for functions returning an integer, enum,
float or pointer type, and the value must be a constant expression.
Void functions can only use the <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">*</span></code> form.</p>
</li>
<li><p class="first">The exception value specification is part of the signature of the function.
If you’re passing a pointer to a function as a parameter or assigning it
to a variable, the declared type of the parameter or variable must have
the same exception value specification (or lack thereof). Here is an
example of a pointer-to-function declaration with an exception
value:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">grail</span><span class="p">)(</span><span class="nb">int</span><span class="p">,</span> <span class="n">char</span><span class="o">*</span><span class="p">)</span> <span class="k">except</span> <span class="o">-</span><span class="mf">1</span>
</pre></div>
</div>
</li>
<li><p class="first">You don’t need to (and shouldn’t) declare exception values for functions
which return Python objects. Remember that a function with no declared
return type implicitly returns a Python object. (Exceptions on such functions
are implicitly propagated by returning NULL.)</p>
</li>
</ul>
</div>
<div class="section" id="checking-return-values-of-non-cython-functions">
<span id="id8"></span><h5>Checking return values of non-Cython functions<a class="headerlink" href="#checking-return-values-of-non-cython-functions" title="Permalink to this headline">¶</a></h5>
<p>It’s important to understand that the except clause does not cause an error to
be raised when the specified value is returned. For example, you can’t write
something like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="kt">FILE</span> *<span class="nf">fopen</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span> <span class="k">except</span> <span class="bp">NULL</span> <span class="c"># WRONG!</span>
</pre></div>
</div>
<p>and expect an exception to be automatically raised if a call to <code class="xref py py-func docutils literal notranslate"><span class="pre">fopen()</span></code>
returns <code class="docutils literal notranslate"><span class="pre">NULL</span></code>. The except clause doesn’t work that way; its only purpose is
for propagating Python exceptions that have already been raised, either by a Cython
function or a C function that calls Python/C API routines. To get an exception
from a non-Python-aware function such as <code class="xref py py-func docutils literal notranslate"><span class="pre">fopen()</span></code>, you will have to check the
return value and raise it yourself, for example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.stdio</span> <span class="k">cimport</span> <span class="n">FILE</span><span class="p">,</span> <span class="n">fopen</span>
<span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">malloc</span><span class="p">,</span> <span class="n">free</span>
<span class="k">from</span> <span class="nn">cpython.exc</span> <span class="k">cimport</span> <span class="n">PyErr_SetFromErrnoWithFilenameObject</span>

<span class="k">def</span> <span class="nf">open_file</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">FILE</span>* <span class="nf">p</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;spam.txt&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span>
        <span class="n">PyErr_SetFromErrnoWithFilenameObject</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="s">&quot;spam.txt&quot;</span><span class="p">)</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">allocating_memory</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="mf">10</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">double</span> *<span class="nf">my_array</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">double</span> <span class="o">*&gt;</span> <span class="n">malloc</span><span class="p">(</span><span class="n">number</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">double</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">my_array</span><span class="p">:</span>  <span class="c"># same as &#39;is NULL&#39; above</span>
        <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="n">free</span><span class="p">(</span><span class="n">my_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="overriding-in-extension-types">
<span id="id9"></span><h5>Overriding in extension types<a class="headerlink" href="#overriding-in-extension-types" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">cpdef</span></code> methods can override <code class="docutils literal notranslate"><span class="pre">cdef</span></code> methods:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">C</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">int</span> <span class="n">k</span><span class="o">=</span><span class="mf">3</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
<p>When subclassing an extension type with a Python class,
<code class="docutils literal notranslate"><span class="pre">def</span></code> methods can override <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> methods but not <code class="docutils literal notranslate"><span class="pre">cdef</span></code>
methods:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>  <span class="c"># NOTE: not cdef class</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">C</span></code> above would be an extension type (<code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">class</span></code>),
this would not work correctly.
The Cython compiler will give a warning in that case.</p>
</div>
</div>
<div class="section" id="automatic-type-conversions">
<span id="type-conversion"></span><h4>Automatic type conversions<a class="headerlink" href="#automatic-type-conversions" title="Permalink to this headline">¶</a></h4>
<p>In most situations, automatic conversions will be performed for the basic
numeric and string types when a Python object is used in a context requiring a
C value, or vice versa. The following table summarises the conversion
possibilities.</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="30%" />
<col width="27%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">C types</th>
<th class="head">From Python types</th>
<th class="head">To Python types</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>[unsigned] char,
[unsigned] short,
int, long</td>
<td>int, long</td>
<td>int</td>
</tr>
<tr class="row-odd"><td>unsigned int,
unsigned long,
[unsigned] long long</td>
<td>int, long</td>
<td>long</td>
</tr>
<tr class="row-even"><td>float, double, long double</td>
<td>int, long, float</td>
<td>float</td>
</tr>
<tr class="row-odd"><td>char*</td>
<td>str/bytes</td>
<td>str/bytes <a class="footnote-reference" href="#id13" id="id10">[3]</a></td>
</tr>
<tr class="row-even"><td>C array</td>
<td>iterable</td>
<td>list <a class="footnote-reference" href="#id15" id="id11">[5]</a></td>
</tr>
<tr class="row-odd"><td>struct,
union</td>
<td>&#160;</td>
<td>dict <a class="footnote-reference" href="#id14" id="id12">[4]</a></td>
</tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[3]</a></td><td>The conversion is to/from str for Python 2.x, and bytes for Python 3.x.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id12">[4]</a></td><td>The conversion from a C union type to a Python dict will add
a value for each of the union fields.  Cython 0.23 and later, however,
will refuse to automatically convert a union with unsafe type
combinations.  An example is a union of an <code class="docutils literal notranslate"><span class="pre">int</span></code> and a <code class="docutils literal notranslate"><span class="pre">char*</span></code>,
in which case the pointer value may or may not be a valid pointer.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[5]</a></td><td>Other than signed/unsigned char[].
The conversion will fail if the length of C array is not known at compile time,
and when using a slice of a C array.</td></tr>
</tbody>
</table>
<div class="section" id="caveats-when-using-a-python-string-in-a-c-context">
<h5>Caveats when using a Python string in a C context<a class="headerlink" href="#caveats-when-using-a-python-string-in-a-c-context" title="Permalink to this headline">¶</a></h5>
<p>You need to be careful when using a Python string in a context expecting a
<code class="docutils literal notranslate"><span class="pre">char*</span></code>. In this situation, a pointer to the contents of the Python string is
used, which is only valid as long as the Python string exists. So you need to
make sure that a reference to the original Python string is held for as long
as the C string is needed. If you can’t guarantee that the Python string will
live long enough, you will need to copy the C string.</p>
<p>Cython detects and prevents some mistakes of this kind. For instance, if you
attempt something like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span> *<span class="nf">s</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">pystring1</span> <span class="o">+</span> <span class="n">pystring2</span>
</pre></div>
</div>
<p>then Cython will produce the error message <code class="docutils literal notranslate"><span class="pre">Obtaining</span> <span class="pre">char*</span> <span class="pre">from</span> <span class="pre">temporary</span>
<span class="pre">Python</span> <span class="pre">value</span></code>. The reason is that concatenating the two Python strings
produces a new Python string object that is referenced only by a temporary
internal variable that Cython generates. As soon as the statement has finished,
the temporary variable will be decrefed and the Python string deallocated,
leaving <code class="docutils literal notranslate"><span class="pre">s</span></code> dangling. Since this code could not possibly work, Cython refuses to
compile it.</p>
<p>The solution is to assign the result of the concatenation to a Python
variable, and then obtain the <code class="docutils literal notranslate"><span class="pre">char*</span></code> from that, i.e.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span> *<span class="nf">s</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pystring1</span> <span class="o">+</span> <span class="n">pystring2</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">p</span>
</pre></div>
</div>
<p>It is then your responsibility to hold the reference p for as long as
necessary.</p>
<p>Keep in mind that the rules used to detect such errors are only heuristics.
Sometimes Cython will complain unnecessarily, and sometimes it will fail to
detect a problem that exists. Ultimately, you need to understand the issue and
be careful what you do.</p>
</div>
<div class="section" id="type-casting">
<span id="id16"></span><h5>Type Casting<a class="headerlink" href="#type-casting" title="Permalink to this headline">¶</a></h5>
<p>Where C uses <code class="docutils literal notranslate"><span class="pre">&quot;(&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;)&quot;</span></code>, Cython uses <code class="docutils literal notranslate"><span class="pre">&quot;&lt;&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;&gt;&quot;</span></code>. For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span> *<span class="nf">p</span>
<span class="k">cdef</span> <span class="kt">float</span> *<span class="nf">q</span>
<span class="n">p</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">char</span><span class="o">*&gt;</span><span class="n">q</span>
</pre></div>
</div>
<p>When casting a C value to a Python object type or vice versa,
Cython will attempt a coercion. Simple examples are casts like <code class="docutils literal notranslate"><span class="pre">&lt;int&gt;pyobj</span></code>,
which converts a Python number to a plain C <code class="docutils literal notranslate"><span class="pre">int</span></code> value, or <code class="docutils literal notranslate"><span class="pre">&lt;bytes&gt;charptr</span></code>,
which copies a C <code class="docutils literal notranslate"><span class="pre">char*</span></code> string into a new Python bytes object.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Cython will not prevent a redundant cast, but emits a warning for it.</p>
</div>
</div></blockquote>
<p>To get the address of some Python object, use a cast to a pointer type
like <code class="docutils literal notranslate"><span class="pre">&lt;void*&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;PyObject*&gt;</span></code>.
You can also cast a C pointer back to a Python object reference
with <code class="docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code>, or a more specific builtin or extension type
(e.g. <code class="docutils literal notranslate"><span class="pre">&lt;MyExtType&gt;ptr</span></code>). This will increase the reference count of
the object by one, i.e. the cast returns an owned reference.
Here is an example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython.ref</span> <span class="k">cimport</span> <span class="n">PyObject</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="o">*</span><span class="p">:</span>
    <span class="k">ctypedef</span> <span class="n">Py_ssize_t</span> <span class="n">Py_intptr_t</span>

<span class="n">python_string</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span>

<span class="k">cdef</span> <span class="kt">void</span>* <span class="nf">ptr</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span><span class="n">python_string</span>
<span class="k">cdef</span> <span class="kt">Py_intptr_t</span> <span class="nf">adress_in_c</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Py_intptr_t</span><span class="o">&gt;</span><span class="n">ptr</span>
<span class="n">address_from_void</span> <span class="o">=</span> <span class="n">adress_in_c</span>        <span class="c"># address_from_void is a python int</span>

<span class="k">cdef</span> <span class="kt">PyObject</span>* <span class="nf">ptr2</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PyObject</span><span class="o">*&gt;</span><span class="n">python_string</span>
<span class="k">cdef</span> <span class="kt">Py_intptr_t</span> <span class="nf">address_in_c2</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Py_intptr_t</span><span class="o">&gt;</span><span class="n">ptr2</span>
<span class="n">address_from_PyObject</span> <span class="o">=</span> <span class="n">address_in_c2</span>  <span class="c"># address_from_PyObject is a python int</span>

<span class="k">assert</span> <span class="n">address_from_void</span> <span class="o">==</span> <span class="n">address_from_PyObject</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">python_string</span><span class="p">)</span>

<span class="k">print</span><span class="p">(&lt;</span><span class="kt">object</span><span class="p">&gt;</span><span class="n">ptr</span><span class="p">)</span>                     <span class="c"># Prints &quot;foo&quot;</span>
<span class="k">print</span><span class="p">(&lt;</span><span class="kt">object</span><span class="p">&gt;</span><span class="n">ptr2</span><span class="p">)</span>                    <span class="c"># prints &quot;foo&quot;</span>
</pre></div>
</div>
<p>The precedence of <code class="docutils literal notranslate"><span class="pre">&lt;...&gt;</span></code> is such that <code class="docutils literal notranslate"><span class="pre">&lt;type&gt;a.b.c</span></code> is interpreted as <code class="docutils literal notranslate"><span class="pre">&lt;type&gt;(a.b.c)</span></code>.</p>
</div>
<div class="section" id="checked-type-casts">
<span id="id17"></span><h5>Checked Type Casts<a class="headerlink" href="#checked-type-casts" title="Permalink to this headline">¶</a></h5>
<p>A cast like <code class="docutils literal notranslate"><span class="pre">&lt;MyExtensionType&gt;x</span></code> will cast x to the class
<code class="docutils literal notranslate"><span class="pre">MyExtensionType</span></code> without any checking at all.</p>
<p>To have a cast checked, use the syntax like: <code class="docutils literal notranslate"><span class="pre">&lt;MyExtensionType?&gt;x</span></code>.
In this case, Cython will apply a runtime check that raises a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code>
if <code class="docutils literal notranslate"><span class="pre">x</span></code> is not an instance of <code class="docutils literal notranslate"><span class="pre">MyExtensionType</span></code>.
This tests for the exact class for builtin types,
but allows subclasses for <a class="reference internal" href="index.html#extension-types"><span class="std std-ref">Extension Types</span></a>.</p>
</div>
</div>
<div class="section" id="statements-and-expressions">
<span id="id18"></span><h4>Statements and expressions<a class="headerlink" href="#statements-and-expressions" title="Permalink to this headline">¶</a></h4>
<p>Control structures and expressions follow Python syntax for the most part.
When applied to Python objects, they have the same semantics as in Python
(unless otherwise noted). Most of the Python operators can also be applied to
C values, with the obvious semantics.</p>
<p>If Python objects and C values are mixed in an expression, conversions are
performed automatically between Python objects and C numeric or string types.</p>
<p>Reference counts are maintained automatically for all Python objects, and all
Python operations are automatically checked for errors, with appropriate
action taken.</p>
<div class="section" id="differences-between-c-and-cython-expressions">
<h5>Differences between C and Cython expressions<a class="headerlink" href="#differences-between-c-and-cython-expressions" title="Permalink to this headline">¶</a></h5>
<p>There are some differences in syntax and semantics between C expressions and
Cython expressions, particularly in the area of C constructs which have no
direct equivalent in Python.</p>
<ul>
<li><p class="first">An integer literal is treated as a C constant, and will
be truncated to whatever size your C compiler thinks appropriate.
To get a Python integer (of arbitrary precision) cast immediately to
an object (e.g. <code class="docutils literal notranslate"><span class="pre">&lt;object&gt;100000000000000000000</span></code>). The <code class="docutils literal notranslate"><span class="pre">L</span></code>, <code class="docutils literal notranslate"><span class="pre">LL</span></code>,
and <code class="docutils literal notranslate"><span class="pre">U</span></code> suffixes have the same meaning as in C.</p>
</li>
<li><p class="first">There is no <code class="docutils literal notranslate"><span class="pre">-&gt;</span></code> operator in Cython. Instead of <code class="docutils literal notranslate"><span class="pre">p-&gt;x</span></code>, use <code class="docutils literal notranslate"><span class="pre">p.x</span></code></p>
</li>
<li><p class="first">There is no unary <code class="docutils literal notranslate"><span class="pre">*</span></code> operator in Cython. Instead of <code class="docutils literal notranslate"><span class="pre">*p</span></code>, use <code class="docutils literal notranslate"><span class="pre">p[0]</span></code></p>
</li>
<li><p class="first">There is an <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> operator, with the same semantics as in C.</p>
</li>
<li><p class="first">The null C pointer is called <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, not <code class="docutils literal notranslate"><span class="pre">0</span></code> (and <code class="docutils literal notranslate"><span class="pre">NULL</span></code> is a reserved word).</p>
</li>
<li><p class="first">Type casts are written <code class="docutils literal notranslate"><span class="pre">&lt;type&gt;value</span></code> , for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">p</span><span class="p">,</span> <span class="kt">float</span>* <span class="nf">q</span>
<span class="n">p</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">char</span><span class="o">*&gt;</span><span class="n">q</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="scope-rules">
<h5>Scope rules<a class="headerlink" href="#scope-rules" title="Permalink to this headline">¶</a></h5>
<p>Cython determines whether a variable belongs to a local scope, the module
scope, or the built-in scope completely statically. As with Python, assigning
to a variable which is not otherwise declared implicitly declares it to be a
variable residing in the scope where it is assigned.  The type of the variable
depends on type inference, except for the global module scope, where it is
always a Python object.</p>
</div>
<div class="section" id="built-in-functions">
<span id="id19"></span><h5>Built-in Functions<a class="headerlink" href="#built-in-functions" title="Permalink to this headline">¶</a></h5>
<p>Cython compiles calls to most built-in functions into direct calls to
the corresponding Python/C API routines, making them particularly fast.</p>
<p>Only direct function calls using these names are optimised. If you do
something else with one of these names that assumes it’s a Python object,
such as assign it to a Python variable, and later call it, the call will
be made as a Python function call.</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="18%" />
<col width="39%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Function and arguments</th>
<th class="head">Return type</th>
<th class="head">Python/C API Equivalent</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>abs(obj)</td>
<td>object,
double, …</td>
<td>PyNumber_Absolute, fabs,
fabsf, …</td>
</tr>
<tr class="row-odd"><td>callable(obj)</td>
<td>bint</td>
<td>PyObject_Callable</td>
</tr>
<tr class="row-even"><td>delattr(obj, name)</td>
<td>None</td>
<td>PyObject_DelAttr</td>
</tr>
<tr class="row-odd"><td>exec(code, [glob, [loc]])</td>
<td>object</td>
<td><ul class="first last simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-even"><td>dir(obj)</td>
<td>list</td>
<td>PyObject_Dir</td>
</tr>
<tr class="row-odd"><td>divmod(a, b)</td>
<td>tuple</td>
<td>PyNumber_Divmod</td>
</tr>
<tr class="row-even"><td>getattr(obj, name, [default])
(Note 1)</td>
<td>object</td>
<td>PyObject_GetAttr</td>
</tr>
<tr class="row-odd"><td>hasattr(obj, name)</td>
<td>bint</td>
<td>PyObject_HasAttr</td>
</tr>
<tr class="row-even"><td>hash(obj)</td>
<td>int / long</td>
<td>PyObject_Hash</td>
</tr>
<tr class="row-odd"><td>intern(obj)</td>
<td>object</td>
<td>Py*_InternFromString</td>
</tr>
<tr class="row-even"><td>isinstance(obj, type)</td>
<td>bint</td>
<td>PyObject_IsInstance</td>
</tr>
<tr class="row-odd"><td>issubclass(obj, type)</td>
<td>bint</td>
<td>PyObject_IsSubclass</td>
</tr>
<tr class="row-even"><td>iter(obj, [sentinel])</td>
<td>object</td>
<td>PyObject_GetIter</td>
</tr>
<tr class="row-odd"><td>len(obj)</td>
<td>Py_ssize_t</td>
<td>PyObject_Length</td>
</tr>
<tr class="row-even"><td>pow(x, y, [z])</td>
<td>object</td>
<td>PyNumber_Power</td>
</tr>
<tr class="row-odd"><td>reload(obj)</td>
<td>object</td>
<td>PyImport_ReloadModule</td>
</tr>
<tr class="row-even"><td>repr(obj)</td>
<td>object</td>
<td>PyObject_Repr</td>
</tr>
<tr class="row-odd"><td>setattr(obj, name)</td>
<td>void</td>
<td>PyObject_SetAttr</td>
</tr>
</tbody>
</table>
<p>Note 1: Pyrex originally provided a function <code class="xref py py-func docutils literal notranslate"><span class="pre">getattr3(obj,</span> <span class="pre">name,</span> <span class="pre">default)()</span></code>
corresponding to the three-argument form of the Python builtin <a class="reference external" href="https://docs.python.org/3/library/functions.html#getattr" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">getattr()</span></code></a>.
Cython still supports this function, but the usage is deprecated in favour of
the normal builtin, which Cython can optimise in both forms.</p>
</div>
<div class="section" id="operator-precedence">
<h5>Operator Precedence<a class="headerlink" href="#operator-precedence" title="Permalink to this headline">¶</a></h5>
<p>Keep in mind that there are some differences in operator precedence between
Python and C, and that Cython uses the Python precedences, not the C ones.</p>
</div>
<div class="section" id="integer-for-loops">
<h5>Integer for-loops<a class="headerlink" href="#integer-for-loops" title="Permalink to this headline">¶</a></h5>
<p>Cython recognises the usual Python for-in-range integer loop pattern:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">i</span></code> is declared as a <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> integer type, it will
optimise this into a pure C loop.  This restriction is required as
otherwise the generated code wouldn’t be correct due to potential
integer overflows on the target architecture.  If you are worried that
the loop is not being converted correctly, use the annotate feature of
the cython commandline (<code class="docutils literal notranslate"><span class="pre">-a</span></code>) to easily see the generated C code.
See <a class="reference internal" href="index.html#automatic-range-conversion"><span class="std std-ref">Automatic range conversion</span></a></p>
<p>For backwards compatibility to Pyrex, Cython also supports a more verbose
form of for-loop which you might find in legacy code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">by</span> <span class="n">s</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">s</span></code> is some integer step size.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This syntax is deprecated and should not be used in new code.
Use the normal Python for-loop instead.</p>
</div>
<p>Some things to note about the for-from loop:</p>
<ul class="simple">
<li>The target expression must be a plain variable name.</li>
<li>The name between the lower and upper bounds must be the same as the target
name.</li>
<li>The direction of iteration is determined by the relations. If they are both
from the set {<code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>} then it is upwards; if they are both from the set
{<code class="docutils literal notranslate"><span class="pre">&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;=</span></code>} then it is downwards. (Any other combination is disallowed.)</li>
</ul>
<p>Like other Python looping statements, break and continue may be used in the
body, and the loop may have an else clause.</p>
</div>
</div>
<div class="section" id="cython-file-types">
<span id="id20"></span><h4>Cython file types<a class="headerlink" href="#cython-file-types" title="Permalink to this headline">¶</a></h4>
<p>There are three file types in Cython:</p>
<ul class="simple">
<li>The implementation files, carrying a <code class="docutils literal notranslate"><span class="pre">.py</span></code> or <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> suffix.</li>
<li>The definition files, carrying a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> suffix.</li>
<li>The include files, carrying a <code class="docutils literal notranslate"><span class="pre">.pxi</span></code> suffix.</li>
</ul>
<div class="section" id="the-implementation-file">
<h5>The implementation file<a class="headerlink" href="#the-implementation-file" title="Permalink to this headline">¶</a></h5>
<p>The implementation file, as the name suggest, contains the implementation
of your functions, classes, extension types, etc. Nearly all the
python syntax is supported in this file. Most of the time, a <code class="docutils literal notranslate"><span class="pre">.py</span></code>
file can be renamed into a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file without changing
any code, and Cython will retain the python behavior.</p>
<p>It is possible for Cython to compile both <code class="docutils literal notranslate"><span class="pre">.py</span></code> and <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> files.
The name of the file isn’t important if one wants to use only the Python syntax,
and Cython won’t change the generated code depending on the suffix used.
Though, if one want to use the Cython syntax, using a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file is necessary.</p>
<p>In addition to the Python syntax, the user can also
leverage Cython syntax (such as <code class="docutils literal notranslate"><span class="pre">cdef</span></code>) to use C variables, can
declare functions as <code class="docutils literal notranslate"><span class="pre">cdef</span></code> or <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> and can import C definitions
with <a class="reference internal" href="index.html#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a>. Many other Cython features usable in implementation files
can be found throughout this page and the rest of the Cython documentation.</p>
<p>There are some restrictions on the implementation part of some <a class="reference internal" href="index.html#extension-types"><span class="std std-ref">Extension Types</span></a>
if the corresponding definition file also defines that type.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file is compiled, Cython first checks to see if a corresponding
<code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file exists and processes it first. It acts like a header file for
a Cython <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file. You can put inside functions that will be used by
other Cython modules. This allows different Cython modules to use functions
and classes from each other without the Python overhead. To read more about
what how to do that, you can see <a class="reference internal" href="index.html#pxd-files"><span class="std std-ref">pxd files</span></a>.</p>
</div>
</div>
<div class="section" id="the-definition-file">
<h5>The definition file<a class="headerlink" href="#the-definition-file" title="Permalink to this headline">¶</a></h5>
<p>A definition file is used to declare various things.</p>
<p>Any C declaration can be made, and it can be also a declaration of a C variable or
function implemented in a C/C++ file. This can be done with <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code>.
Sometimes, <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files are used as a translation of C/C++ header files
into a syntax that Cython can understand. This allows then the C/C++ variable and
functions to be used directly in implementation files with <a class="reference internal" href="index.html#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a>.
You can read more about it in <a class="reference internal" href="index.html#external-c-code"><span class="std std-ref">Interfacing with External C Code</span></a> and <a class="reference internal" href="index.html#wrapping-cplusplus"><span class="std std-ref">Using C++ in Cython</span></a>.</p>
<p>It can also contain the definition part of an extension type and the declarations
of functions for an external library.</p>
<p>It cannot contain the implementations of any C or Python functions, or any
Python class definitions, or any executable statements. It is needed when one
wants to  access <a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> attributes and methods, or to inherit from
<a class="reference internal" href="#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> classes defined in this module.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You don’t need to (and shouldn’t) declare anything in a declaration file
<a class="reference internal" href="index.html#public"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">public</span></code></a> in order to make it available to other Cython modules; its mere
presence in a definition file does that. You only need a public
declaration if you want to make something available to external C code.</p>
</div>
</div>
<div class="section" id="the-include-statement-and-include-files">
<h5>The include statement and include files<a class="headerlink" href="#the-include-statement-and-include-files" title="Permalink to this headline">¶</a></h5>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Historically the <code class="docutils literal notranslate"><span class="pre">include</span></code> statement was used for sharing declarations.
Use <a class="reference internal" href="index.html#sharing-declarations"><span class="std std-ref">Sharing Declarations Between Cython Modules</span></a> instead.</p>
</div>
<p>A Cython source file can include material from other files using the include
statement, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">include</span> <span class="s">&quot;spamstuff.pxi&quot;</span>
</pre></div>
</div>
<p>The contents of the named file are textually included at that point.  The
included file can contain any complete statements or declarations that are
valid in the context where the include statement appears, including other
include statements.  The contents of the included file should begin at an
indentation level of zero, and will be treated as though they were indented to
the level of the include statement that is including the file.  The include
statement cannot, however, be used outside of the module scope, such as inside
of functions or class bodies.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are other mechanisms available for splitting Cython code into
separate parts that may be more appropriate in many cases. See
<a class="reference internal" href="index.html#sharing-declarations"><span class="std std-ref">Sharing Declarations Between Cython Modules</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="conditional-compilation">
<span id="id21"></span><h4>Conditional Compilation<a class="headerlink" href="#conditional-compilation" title="Permalink to this headline">¶</a></h4>
<p>Some features are available for conditional compilation and compile-time
constants within a Cython source file.</p>
<div class="section" id="compile-time-definitions">
<h5>Compile-Time Definitions<a class="headerlink" href="#compile-time-definitions" title="Permalink to this headline">¶</a></h5>
<p>A compile-time constant can be defined using the DEF statement:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="cp">DEF</span> <span class="n">FavouriteFood</span> <span class="o">=</span> <span class="s">u&quot;spam&quot;</span>
<span class="cp">DEF</span> <span class="n">ArraySize</span> <span class="o">=</span> <span class="mf">42</span>
<span class="cp">DEF</span> <span class="n">OtherArraySize</span> <span class="o">=</span> <span class="mf">2</span> <span class="o">*</span> <span class="n">ArraySize</span> <span class="o">+</span> <span class="mf">17</span>
</pre></div>
</div>
<p>The right-hand side of the <code class="docutils literal notranslate"><span class="pre">DEF</span></code> must be a valid compile-time expression.
Such expressions are made up of literal values and names defined using <code class="docutils literal notranslate"><span class="pre">DEF</span></code>
statements, combined using any of the Python expression syntax.</p>
<p>The following compile-time names are predefined, corresponding to the values
returned by <a class="reference external" href="https://docs.python.org/3/library/os.html#os.uname" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">os.uname()</span></code></a>.</p>
<blockquote>
<div>UNAME_SYSNAME, UNAME_NODENAME, UNAME_RELEASE,
UNAME_VERSION, UNAME_MACHINE</div></blockquote>
<p>The following selection of builtin constants and functions are also available:</p>
<blockquote>
<div>None, True, False,
abs, all, any, ascii, bin, bool, bytearray, bytes, chr, cmp, complex, dict,
divmod, enumerate, filter, float, format, frozenset, hash, hex, int, len,
list, long, map, max, min, oct, ord, pow, range, reduce, repr, reversed,
round, set, slice, sorted, str, sum, tuple, xrange, zip</div></blockquote>
<p>Note that some of these builtins may not be available when compiling under
Python 2.x or 3.x, or may behave differently in both.</p>
<p>A name defined using <code class="docutils literal notranslate"><span class="pre">DEF</span></code> can be used anywhere an identifier can appear,
and it is replaced with its compile-time value as though it were written into
the source at that point as a literal. For this to work, the compile-time
expression must evaluate to a Python value of type <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">long</span></code>,
<code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">bytes</span></code> or <code class="docutils literal notranslate"><span class="pre">unicode</span></code> (<code class="docutils literal notranslate"><span class="pre">str</span></code> in Py3).</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="cp">DEF</span> <span class="n">FavouriteFood</span> <span class="o">=</span> <span class="s">u&quot;spam&quot;</span>
<span class="cp">DEF</span> <span class="n">ArraySize</span> <span class="o">=</span> <span class="mf">42</span>
<span class="cp">DEF</span> <span class="n">OtherArraySize</span> <span class="o">=</span> <span class="mf">2</span> <span class="o">*</span> <span class="n">ArraySize</span> <span class="o">+</span> <span class="mf">17</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="kt">a1</span>[<span class="kt">ArraySize</span>]
<span class="k">cdef</span> <span class="kt">int</span> <span class="kt">a2</span>[<span class="kt">OtherArraySize</span>]
<span class="k">print</span><span class="p">(</span><span class="s">&quot;I like&quot;</span><span class="p">,</span> <span class="n">FavouriteFood</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="conditional-statements">
<h5>Conditional Statements<a class="headerlink" href="#conditional-statements" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">IF</span></code> statement can be used to conditionally include or exclude sections
of code at compile time. It works in a similar way to the <code class="docutils literal notranslate"><span class="pre">#if</span></code> preprocessor
directive in C.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="cp">IF</span> <span class="n">UNAME_SYSNAME</span> <span class="o">==</span> <span class="s">&quot;Windows&quot;</span><span class="p">:</span>
    <span class="k">include</span> <span class="s">&quot;icky_definitions.pxi&quot;</span>
<span class="cp">ELIF</span> <span class="n">UNAME_SYSNAME</span> <span class="o">==</span> <span class="s">&quot;Darwin&quot;</span><span class="p">:</span>
    <span class="k">include</span> <span class="s">&quot;nice_definitions.pxi&quot;</span>
<span class="cp">ELIF</span> <span class="n">UNAME_SYSNAME</span> <span class="o">==</span> <span class="s">&quot;Linux&quot;</span><span class="p">:</span>
    <span class="k">include</span> <span class="s">&quot;penguin_definitions.pxi&quot;</span>
<span class="cp">ELSE</span><span class="p">:</span>
    <span class="k">include</span> <span class="s">&quot;other_definitions.pxi&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ELIF</span></code> and <code class="docutils literal notranslate"><span class="pre">ELSE</span></code> clauses are optional. An <code class="docutils literal notranslate"><span class="pre">IF</span></code> statement can appear
anywhere that a normal statement or declaration can appear, and it can contain
any statements or declarations that would be valid in that context, including
<code class="docutils literal notranslate"><span class="pre">DEF</span></code> statements and other <code class="docutils literal notranslate"><span class="pre">IF</span></code> statements.</p>
<p>The expressions in the <code class="docutils literal notranslate"><span class="pre">IF</span></code> and <code class="docutils literal notranslate"><span class="pre">ELIF</span></code> clauses must be valid compile-time
expressions as for the <code class="docutils literal notranslate"><span class="pre">DEF</span></code> statement, although they can evaluate to any
Python value, and the truth of the result is determined in the usual Python
way.</p>
</div>
</div>
</div>
<span id="document-src/userguide/extension_types"></span><div class="section" id="extension-types">
<span id="id1"></span><h3>Extension Types<a class="headerlink" href="#extension-types" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>As well as creating normal user-defined classes with the Python class
statement, Cython also lets you create new built-in Python types, known as
extension types. You define an extension type using the <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> class
statement.  Here’s an example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Shrubbery</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">width</span><span class="p">,</span> <span class="nf">height</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;This shrubbery is&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
              <span class="s">&quot;by&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="s">&quot;cubits.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>As you can see, a Cython extension type definition looks a lot like a Python
class definition. Within it, you use the def statement to define methods that
can be called from Python code. You can even define many of the special
methods such as <code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code> as you would in Python.</p>
<p>The main difference is that you can use the <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> statement to define
attributes. The attributes may be Python objects (either generic or of a
particular extension type), or they may be of any C data type. So you can use
extension types to wrap arbitrary C data structures and provide a Python-like
interface to them.</p>
</div>
<div class="section" id="static-attributes">
<span id="readonly"></span><h4>Static Attributes<a class="headerlink" href="#static-attributes" title="Permalink to this headline">¶</a></h4>
<p>Attributes of an extension type are stored directly in the object’s C struct.
The set of attributes is fixed at compile time; you can’t add attributes to an
extension type instance at run time simply by assigning to them, as you could
with a Python class instance. However, you can explicitly enable support
for dynamically assigned attributes, or subclass the extension type with a normal
Python class, which then supports arbitrary attribute assignments.
See <a class="reference internal" href="#dynamic-attributes"><span class="std std-ref">Dynamic Attributes</span></a>.</p>
<p>There are two ways that attributes of an extension type can be accessed: by
Python attribute lookup, or by direct access to the C struct from Cython code.
Python code is only able to access attributes of an extension type by the
first method, but Cython code can use either method.</p>
<p>By default, extension type attributes are only accessible by direct access,
not Python access, which means that they are not accessible from Python code.
To make them accessible from Python code, you need to declare them as
<a class="reference internal" href="#public"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">public</span></code></a> or <a class="reference internal" href="#readonly"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">readonly</span></code></a>. For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Shrubbery</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kr">public</span> <span class="kt">int</span> <span class="nf">width</span><span class="p">,</span> <span class="nf">height</span>
    <span class="k">cdef</span> <span class="kr">readonly</span> <span class="kt">float</span> <span class="nf">depth</span>
</pre></div>
</div>
<p>makes the width and height attributes readable and writable from Python code,
and the depth attribute readable but not writable.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can only expose simple C types, such as ints, floats, and
strings, for Python access. You can also expose Python-valued attributes.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Also the <a class="reference internal" href="#public"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">public</span></code></a> and <a class="reference internal" href="#readonly"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">readonly</span></code></a> options apply only to
Python access, not direct access. All the attributes of an extension type
are always readable and writable by C-level access.</p>
</div>
</div>
<div class="section" id="dynamic-attributes">
<span id="id2"></span><h4>Dynamic Attributes<a class="headerlink" href="#dynamic-attributes" title="Permalink to this headline">¶</a></h4>
<p>It is not possible to add attributes to an extension type at runtime by default.
You have two ways of avoiding this limitation, both add an overhead when
a method is called from Python code. Especially when calling <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> methods.</p>
<p>The first approach is to create a Python subclass.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Animal</span><span class="p">:</span>

    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">number_of_legs</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">number_of_legs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_legs</span> <span class="o">=</span> <span class="n">number_of_legs</span>


<span class="k">class</span> <span class="nc">ExtendableAnimal</span><span class="p">(</span><span class="n">Animal</span><span class="p">):</span>  <span class="c"># Note that we use class, not cdef class</span>
    <span class="k">pass</span>


<span class="n">dog</span> <span class="o">=</span> <span class="n">ExtendableAnimal</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="n">dog</span><span class="o">.</span><span class="n">has_tail</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Declaring a <code class="docutils literal notranslate"><span class="pre">__dict__</span></code> attribute is the second way of enabling dynamic attributes.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Animal</span><span class="p">:</span>

    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">number_of_legs</span>
    <span class="k">cdef</span> <span class="kt">dict</span> <span class="nf">__dict__</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">number_of_legs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_legs</span> <span class="o">=</span> <span class="n">number_of_legs</span>


<span class="n">dog</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="n">dog</span><span class="o">.</span><span class="n">has_tail</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
<div class="section" id="type-declarations">
<h4>Type declarations<a class="headerlink" href="#type-declarations" title="Permalink to this headline">¶</a></h4>
<p>Before you can directly access the attributes of an extension type, the Cython
compiler must know that you have an instance of that type, and not just a
generic Python object. It knows this already in the case of the <code class="docutils literal notranslate"><span class="pre">self</span></code>
parameter of the methods of that type, but in other cases you will have to use
a type declaration.</p>
<p>For example, in the following function:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">widen_shrubbery</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">):</span> <span class="c"># BAD</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">extra_width</span>
</pre></div>
</div>
<p>because the <code class="docutils literal notranslate"><span class="pre">sh</span></code> parameter hasn’t been given a type, the width attribute
will be accessed by a Python attribute lookup. If the attribute has been
declared <a class="reference internal" href="#public"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">public</span></code></a> or <a class="reference internal" href="#readonly"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">readonly</span></code></a> then this will work, but it
will be very inefficient. If the attribute is private, it will not work at all
– the code will compile, but an attribute error will be raised at run time.</p>
<p>The solution is to declare <code class="docutils literal notranslate"><span class="pre">sh</span></code> as being of type <code class="xref py py-class docutils literal notranslate"><span class="pre">Shrubbery</span></code>, as
follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">my_module</span> <span class="k">cimport</span> <span class="n">Shrubbery</span>

<span class="k">cdef</span> <span class="nf">widen_shrubbery</span><span class="p">(</span><span class="n">Shrubbery</span> <span class="n">sh</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">extra_width</span>
</pre></div>
</div>
<p>Now the Cython compiler knows that <code class="docutils literal notranslate"><span class="pre">sh</span></code> has a C attribute called
<code class="xref py py-attr docutils literal notranslate"><span class="pre">width</span></code> and will generate code to access it directly and efficiently.
The same consideration applies to local variables, for example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">my_module</span> <span class="k">cimport</span> <span class="n">Shrubbery</span>

<span class="k">cdef</span> <span class="kt">Shrubbery</span> <span class="nf">another_shrubbery</span><span class="p">(</span><span class="n">Shrubbery</span> <span class="n">sh1</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Shrubbery</span> <span class="nf">sh2</span>
    <span class="n">sh2</span> <span class="o">=</span> <span class="n">Shrubbery</span><span class="p">()</span>
    <span class="n">sh2</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sh1</span><span class="o">.</span><span class="n">width</span>
    <span class="n">sh2</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">sh1</span><span class="o">.</span><span class="n">height</span>
    <span class="k">return</span> <span class="n">sh2</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We here <code class="docutils literal notranslate"><span class="pre">cimport</span></code> the class <code class="xref py py-class docutils literal notranslate"><span class="pre">Shrubbery</span></code>, and this is necessary
to declare the type at compile time. To be able to <code class="docutils literal notranslate"><span class="pre">cimport</span></code> an extension type,
we split the class definition into two parts, one in a definition file and
the other in the corresponding implementation file. You should read
<a class="reference internal" href="index.html#sharing-extension-types"><span class="std std-ref">Sharing Extension Types</span></a> to learn to do that.</p>
</div>
<div class="section" id="type-testing-and-casting">
<h5>Type Testing and Casting<a class="headerlink" href="#type-testing-and-casting" title="Permalink to this headline">¶</a></h5>
<p>Suppose I have a method <code class="xref py py-meth docutils literal notranslate"><span class="pre">quest()</span></code> which returns an object of type <code class="xref py py-class docutils literal notranslate"><span class="pre">Shrubbery</span></code>.
To access it’s width I could write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">Shrubbery</span> <span class="nf">sh</span> <span class="o">=</span> <span class="n">quest</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
</pre></div>
</div>
<p>which requires the use of a local variable and performs a type test on assignment.
If you <em>know</em> the return value of <code class="xref py py-meth docutils literal notranslate"><span class="pre">quest()</span></code> will be of type <code class="xref py py-class docutils literal notranslate"><span class="pre">Shrubbery</span></code>
you can use a cast to write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span> <span class="p">(&lt;</span><span class="kt">Shrubbery</span><span class="p">&gt;</span><span class="n">quest</span><span class="p">())</span><span class="o">.</span><span class="n">width</span> <span class="p">)</span>
</pre></div>
</div>
<p>This may be dangerous if <code class="xref py py-meth docutils literal notranslate"><span class="pre">quest()</span></code> is not actually a <code class="xref py py-class docutils literal notranslate"><span class="pre">Shrubbery</span></code>, as it
will try to access width as a C struct member which may not exist. At the C level,
rather than raising an <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#AttributeError" title="(in Python v3.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">AttributeError</span></code></a>, either an nonsensical result will be
returned (interpreting whatever data is at that address as an int) or a segfault
may result from trying to access invalid memory. Instead, one can write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span> <span class="p">(&lt;</span><span class="kt">Shrubbery?</span><span class="p">&gt;</span><span class="n">quest</span><span class="p">())</span><span class="o">.</span><span class="n">width</span> <span class="p">)</span>
</pre></div>
</div>
<p>which performs a type check (possibly raising a <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#TypeError" title="(in Python v3.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeError</span></code></a>) before making the
cast and allowing the code to proceed.</p>
<p>To explicitly test the type of an object, use the <code class="xref py py-meth docutils literal notranslate"><span class="pre">isinstance()</span></code> builtin function.
For known builtin or extension types, Cython translates these into a
fast and safe type check that ignores changes to
the object’s <code class="docutils literal notranslate"><span class="pre">__class__</span></code> attribute etc., so that after a successful
<code class="xref py py-meth docutils literal notranslate"><span class="pre">isinstance()</span></code> test, code can rely on the expected C structure of the
extension type and its <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> attributes and methods.</p>
</div>
</div>
<div class="section" id="extension-types-and-none">
<span id="id3"></span><h4>Extension types and None<a class="headerlink" href="#extension-types-and-none" title="Permalink to this headline">¶</a></h4>
<p>When you declare a parameter or C variable as being of an extension type,
Cython will allow it to take on the value <code class="docutils literal notranslate"><span class="pre">None</span></code> as well as values of its
declared type. This is analogous to the way a C pointer can take on the value
<code class="docutils literal notranslate"><span class="pre">NULL</span></code>, and you need to exercise the same caution because of it. There is no
problem as long as you are performing Python operations on it, because full
dynamic type checking will be applied. However, when you access C attributes
of an extension type (as in the widen_shrubbery function above), it’s up to
you to make sure the reference you’re using is not <code class="docutils literal notranslate"><span class="pre">None</span></code> – in the
interests of efficiency, Cython does not check this.</p>
<p>You need to be particularly careful when exposing Python functions which take
extension types as arguments. If we wanted to make <code class="xref py py-func docutils literal notranslate"><span class="pre">widen_shrubbery()</span></code> a
Python function, for example, if we simply wrote:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">widen_shrubbery</span><span class="p">(</span><span class="n">Shrubbery</span> <span class="n">sh</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">):</span> <span class="c"># This is</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">extra_width</span>           <span class="c"># dangerous!</span>
</pre></div>
</div>
<p>then users of our module could crash it by passing <code class="docutils literal notranslate"><span class="pre">None</span></code> for the <code class="docutils literal notranslate"><span class="pre">sh</span></code>
parameter.</p>
<p>One way to fix this would be:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">widen_shrubbery</span><span class="p">(</span><span class="n">Shrubbery</span> <span class="n">sh</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">extra_width</span>
</pre></div>
</div>
<p>but since this is anticipated to be such a frequent requirement, Cython
provides a more convenient way. Parameters of a Python function declared as an
extension type can have a <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">None</span></code> clause:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">widen_shrubbery</span><span class="p">(</span><span class="n">Shrubbery</span> <span class="n">sh</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">extra_width</span>
</pre></div>
</div>
<p>Now the function will automatically check that <code class="docutils literal notranslate"><span class="pre">sh</span></code> is <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">None</span></code> along
with checking that it has the right type.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">None</span></code> clause can only be used in Python functions (defined with
<a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#def" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">def</span></code></a>) and not C functions (defined with <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a>).  If
you need to check whether a parameter to a C function is None, you will
need to do it yourself.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Some more things:</p>
<ul class="last simple">
<li>The self parameter of a method of an extension type is guaranteed never to
be <code class="docutils literal notranslate"><span class="pre">None</span></code>.</li>
<li>When comparing a value with <code class="docutils literal notranslate"><span class="pre">None</span></code>, keep in mind that, if <code class="docutils literal notranslate"><span class="pre">x</span></code> is a Python
object, <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">is</span> <span class="pre">None</span></code> and <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">None</span></code> are very efficient because they
translate directly to C pointer comparisons, whereas <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">==</span> <span class="pre">None</span></code> and
<code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">!=</span> <span class="pre">None</span></code>, or simply using <code class="docutils literal notranslate"><span class="pre">x</span></code> as a boolean value (as in <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">x:</span> <span class="pre">...</span></code>)
will invoke Python operations and therefore be much slower.</li>
</ul>
</div>
</div>
<div class="section" id="special-methods">
<h4>Special methods<a class="headerlink" href="#special-methods" title="Permalink to this headline">¶</a></h4>
<p>Although the principles are similar, there are substantial differences between
many of the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__xxx__()</span></code> special methods of extension types and their Python
counterparts. There is a <a class="reference internal" href="index.html#special-methods"><span class="std std-ref">separate page</span></a> devoted to this subject, and you should
read it carefully before attempting to use any special methods in your
extension types.</p>
</div>
<div class="section" id="properties">
<span id="id4"></span><h4>Properties<a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h4>
<p>You can declare properties in an extension class using the same syntax as in ordinary Python code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Spam</span><span class="p">:</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cheese</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># This is called when the property is read.</span>
        <span class="o">...</span>

    <span class="nd">@cheese</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cheese</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="c"># This is called when the property is written.</span>
            <span class="o">...</span>

    <span class="nd">@cheese</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">cheese</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># This is called when the property is deleted.</span>
</pre></div>
</div>
<p>There is also a special (deprecated) legacy syntax for defining properties in an extension class:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Spam</span><span class="p">:</span>

    <span class="k">property</span> <span class="nf">cheese</span><span class="p">:</span>

        <span class="s">&quot;A doc string can go here.&quot;</span>

        <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># This is called when the property is read.</span>
            <span class="o">...</span>

        <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="c"># This is called when the property is written.</span>
            <span class="o">...</span>

        <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># This is called when the property is deleted.</span>
</pre></div>
</div>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">__get__()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">__set__()</span></code> and <code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code> methods are all
optional; if they are omitted, an exception will be raised when the
corresponding operation is attempted.</p>
<p>Here’s a complete example. It defines a property which adds to a list each
time it is written to, returns the list when it is read, and empties the list
when it is deleted.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cheesy.pyx</span>
<span class="k">cdef</span> <span class="k">class</span> <span class="nf">CheeseShop</span><span class="p">:</span>

    <span class="k">cdef</span> <span class="kt">object</span> <span class="nf">cheeses</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cheeses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cheese</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;We don&#39;t have: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cheeses</span>

    <span class="nd">@cheese</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cheese</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cheeses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@cheese</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">cheese</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cheeses</span><span class="p">[:]</span>

<span class="c"># Test input</span>
<span class="k">from</span> <span class="nn">cheesy</span> <span class="k">import</span> <span class="n">CheeseShop</span>

<span class="n">shop</span> <span class="o">=</span> <span class="n">CheeseShop</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">shop</span><span class="o">.</span><span class="n">cheese</span><span class="p">)</span>

<span class="n">shop</span><span class="o">.</span><span class="n">cheese</span> <span class="o">=</span> <span class="s">&quot;camembert&quot;</span>
<span class="k">print</span><span class="p">(</span><span class="n">shop</span><span class="o">.</span><span class="n">cheese</span><span class="p">)</span>

<span class="n">shop</span><span class="o">.</span><span class="n">cheese</span> <span class="o">=</span> <span class="s">&quot;cheddar&quot;</span>
<span class="k">print</span><span class="p">(</span><span class="n">shop</span><span class="o">.</span><span class="n">cheese</span><span class="p">)</span>

<span class="k">del</span> <span class="n">shop</span><span class="o">.</span><span class="n">cheese</span>
<span class="k">print</span><span class="p">(</span><span class="n">shop</span><span class="o">.</span><span class="n">cheese</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># Test output
We don&#39;t have: []
We don&#39;t have: [&#39;camembert&#39;]
We don&#39;t have: [&#39;camembert&#39;, &#39;cheddar&#39;]
We don&#39;t have: []
</pre></div>
</div>
</div>
<div class="section" id="subclassing">
<span id="id5"></span><h4>Subclassing<a class="headerlink" href="#subclassing" title="Permalink to this headline">¶</a></h4>
<p>An extension type may inherit from a built-in type or another extension type:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Parrot</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Norwegian</span><span class="p">(</span><span class="n">Parrot</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>A complete definition of the base type must be available to Cython, so if the
base type is a built-in type, it must have been previously declared as an
extern extension type. If the base type is defined in another Cython module, it
must either be declared as an extern extension type or imported using the
<a class="reference internal" href="index.html#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> statement.</p>
<p>An extension type can only have one base class (no multiple inheritance).</p>
<p>Cython extension types can also be subclassed in Python. A Python class can
inherit from multiple extension types provided that the usual Python rules for
multiple inheritance are followed (i.e. the C layouts of all the base classes
must be compatible).</p>
<p>There is a way to prevent extension types from
being subtyped in Python.  This is done via the <code class="docutils literal notranslate"><span class="pre">final</span></code> directive,
usually set on an extension type using a decorator:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">cython</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">final</span>
<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Parrot</span><span class="p">:</span>
   <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
</pre></div>
</div>
<p>Trying to create a Python subclass from this type will raise a
<a class="reference external" href="https://docs.python.org/3/library/exceptions.html#TypeError" title="(in Python v3.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeError</span></code></a> at runtime.  Cython will also prevent subtyping a
final type inside of the same module, i.e. creating an extension type
that uses a final type as its base type will fail at compile time.
Note, however, that this restriction does not currently propagate to
other extension modules, so even final extension types can still be
subtyped at the C level by foreign code.</p>
</div>
<div class="section" id="c-methods">
<h4>C methods<a class="headerlink" href="#c-methods" title="Permalink to this headline">¶</a></h4>
<p>Extension types can have C methods as well as Python methods. Like C
functions, C methods are declared using <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> or <a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> instead of
<a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#def" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">def</span></code></a>. C methods are “virtual”, and may be overridden in derived
extension types. In addition, <a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> methods can even be overridden by python
methods when called as C method. This adds a little to their calling overhead
compared to a <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> method:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># pets.pyx</span>
<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Parrot</span><span class="p">:</span>

    <span class="k">cdef</span> <span class="kt">void</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;This parrot is resting.&quot;</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Norwegian</span><span class="p">(</span><span class="n">Parrot</span><span class="p">):</span>

    <span class="k">cdef</span> <span class="kt">void</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Parrot</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Lovely plumage!&quot;</span><span class="p">)</span>


<span class="k">cdef</span> <span class="kt">Parrot</span> <span class="nf">p1</span><span class="p">,</span> <span class="nf">p2</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">Parrot</span><span class="p">()</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">Norwegian</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;p1:&quot;</span><span class="p">)</span>
<span class="n">p1</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;p2:&quot;</span><span class="p">)</span>
<span class="n">p2</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># Output
p1:
This parrot is resting.
p2:
This parrot is resting.
Lovely plumage!
</pre></div>
</div>
<p>The above example also illustrates that a C method can call an inherited C
method using the usual Python technique, i.e.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">Parrot</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p><cite>cdef</cite> methods can be declared static by using the &#64;staticmethod decorator.
This can be especially useful for constructing classes that take non-Python
compatible types.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">OwnedPointer</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">void</span>* <span class="nf">ptr</span>

    <span class="k">def</span> <span class="nf">__dealloc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span><span class="p">:</span>
            <span class="n">free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">cdef</span> <span class="nf">create</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">OwnedPointer</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span>
        <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
</div>
<div class="section" id="forward-declaring-extension-types">
<span id="id6"></span><h4>Forward-declaring extension types<a class="headerlink" href="#forward-declaring-extension-types" title="Permalink to this headline">¶</a></h4>
<p>Extension types can be forward-declared, like <a class="reference internal" href="index.html#struct"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">struct</span></code></a> and
<a class="reference internal" href="index.html#union"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">union</span></code></a> types.  This is usually not necessary and violates the
DRY principle (Don’t Repeat Yourself).</p>
<p>If you are forward-declaring an extension type that has a base class, you must
specify the base class in both the forward declaration and its subsequent
definition, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

<span class="o">...</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="c"># attributes and methods</span>
</pre></div>
</div>
</div>
<div class="section" id="fast-instantiation">
<h4>Fast instantiation<a class="headerlink" href="#fast-instantiation" title="Permalink to this headline">¶</a></h4>
<p>Cython provides two ways to speed up the instantiation of extension types.
The first one is a direct call to the <code class="docutils literal notranslate"><span class="pre">__new__()</span></code> special static method,
as known from Python.  For an extension type <code class="docutils literal notranslate"><span class="pre">Penguin</span></code>, you could use
the following code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Penguin</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">object</span> <span class="nf">food</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">food</span> <span class="o">=</span> <span class="n">food</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;eating!&quot;</span><span class="p">)</span>

<span class="n">normal_penguin</span> <span class="o">=</span> <span class="n">Penguin</span><span class="p">(</span><span class="s">&#39;fish&#39;</span><span class="p">)</span>
<span class="n">fast_penguin</span> <span class="o">=</span> <span class="n">Penguin</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">Penguin</span><span class="p">,</span> <span class="s">&#39;wheat&#39;</span><span class="p">)</span>  <span class="c"># note: not calling __init__() !</span>
</pre></div>
</div>
<p>Note that the path through <code class="docutils literal notranslate"><span class="pre">__new__()</span></code> will <em>not</em> call the type’s
<code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method (again, as known from Python).  Thus, in the example
above, the first instantiation will print <code class="docutils literal notranslate"><span class="pre">eating!</span></code>, but the second will
not.  This is only one of the reasons why the <code class="docutils literal notranslate"><span class="pre">__cinit__()</span></code> method is
safer and preferable over the normal <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method for extension
types.</p>
<p>The second performance improvement applies to types that are often created
and deleted in a row, so that they can benefit from a freelist.  Cython
provides the decorator <code class="docutils literal notranslate"><span class="pre">&#64;cython.freelist(N)</span></code> for this, which creates a
statically sized freelist of <code class="docutils literal notranslate"><span class="pre">N</span></code> instances for a given type.  Example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">cython</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">freelist</span><span class="p">(</span><span class="mf">8</span><span class="p">)</span>
<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Penguin</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">object</span> <span class="nf">food</span>
    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">food</span> <span class="o">=</span> <span class="n">food</span>

<span class="n">penguin</span> <span class="o">=</span> <span class="n">Penguin</span><span class="p">(</span><span class="s">&#39;fish 1&#39;</span><span class="p">)</span>
<span class="n">penguin</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">penguin</span> <span class="o">=</span> <span class="n">Penguin</span><span class="p">(</span><span class="s">&#39;fish 2&#39;</span><span class="p">)</span>  <span class="c"># does not need to allocate memory!</span>
</pre></div>
</div>
</div>
<div class="section" id="instantiation-from-existing-c-c-pointers">
<span id="existing-pointers-instantiation"></span><h4>Instantiation from existing C/C++ pointers<a class="headerlink" href="#instantiation-from-existing-c-c-pointers" title="Permalink to this headline">¶</a></h4>
<p>It is quite common to want to instantiate an extension class from an existing
(pointer to a) data structure, often as returned by external C/C++ functions.</p>
<p>As extension classes can only accept Python objects as arguments in their
constructors, this necessitates the use of factory functions. For example,</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">malloc</span><span class="p">,</span> <span class="n">free</span>

<span class="c"># Example C struct</span>
<span class="k">ctypedef</span> <span class="k">struct</span> <span class="nc">my_c_struct</span><span class="p">:</span>
    <span class="nb">int</span> <span class="n">a</span>
    <span class="nb">int</span> <span class="n">b</span>


<span class="k">cdef</span> <span class="k">class</span> <span class="nf">WrapperClass</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A wrapper class for a C/C++ data structure&quot;&quot;&quot;</span>
    <span class="k">cdef</span> <span class="kt">my_c_struct</span> *<span class="nf">_ptr</span>
    <span class="k">cdef</span> <span class="kt">bint</span> <span class="nf">ptr_owner</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptr_owner</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__dealloc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># De-allocate if not null and flag is set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr_owner</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ptr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ptr</span> <span class="o">=</span> <span class="bp">NULL</span>

    <span class="c"># Extension class properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptr</span><span class="o">.</span><span class="n">a</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptr</span><span class="o">.</span><span class="n">b</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NULL</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">cdef</span> <span class="kt">WrapperClass</span> <span class="nf">from_ptr</span><span class="p">(</span><span class="n">my_c_struct</span> <span class="o">*</span><span class="n">_ptr</span><span class="p">,</span> <span class="n">bint</span> <span class="n">owner</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Factory function to create WrapperClass objects from</span>
<span class="sd">        given my_c_struct pointer.</span>

<span class="sd">        Setting ``owner`` flag to ``True`` causes</span>
<span class="sd">        the extension type to ``free`` the structure pointed to by ``_ptr``</span>
<span class="sd">        when the wrapper object is deallocated.&quot;&quot;&quot;</span>
        <span class="c"># Call to __new__ bypasses __init__ constructor</span>
        <span class="k">cdef</span> <span class="kt">WrapperClass</span> <span class="nf">wrapper</span> <span class="o">=</span> <span class="n">WrapperClass</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">WrapperClass</span><span class="p">)</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_ptr</span> <span class="o">=</span> <span class="n">_ptr</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">ptr_owner</span> <span class="o">=</span> <span class="n">owner</span>
        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="nd">@staticmethod</span>
    <span class="k">cdef</span> <span class="kt">WrapperClass</span> <span class="nf">new_struct</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Factory function to create WrapperClass objects with</span>
<span class="sd">        newly allocated my_c_struct&quot;&quot;&quot;</span>
        <span class="k">cdef</span> <span class="kt">my_c_struct</span> *<span class="nf">_ptr</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">my_c_struct</span> <span class="o">*&gt;</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">my_c_struct</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_ptr</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">MemoryError</span>
        <span class="n">_ptr</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="n">_ptr</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="k">return</span> <span class="n">WrapperClass</span><span class="o">.</span><span class="n">from_ptr</span><span class="p">(</span><span class="n">_ptr</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>To then create a <code class="docutils literal notranslate"><span class="pre">WrapperClass</span></code> object from an existing <code class="docutils literal notranslate"><span class="pre">my_c_struct</span></code>
pointer, <code class="docutils literal notranslate"><span class="pre">WrapperClass.from_ptr(ptr)</span></code> can be used in Cython code. To allocate
a new structure and wrap it at the same time, <code class="docutils literal notranslate"><span class="pre">WrapperClass.new_struct</span></code> can be
used instead.</p>
<p>It is possible to create multiple Python objects all from the same pointer
which point to the same in-memory data, if that is wanted, though care must be
taken when de-allocating as can be seen above.
Additionally, the <code class="docutils literal notranslate"><span class="pre">ptr_owner</span></code> flag can be used to control which
<code class="docutils literal notranslate"><span class="pre">WrapperClass</span></code> object owns the pointer and is responsible for de-allocation -
this is set to <code class="docutils literal notranslate"><span class="pre">False</span></code> by default in the example and can be enabled by calling
<code class="docutils literal notranslate"><span class="pre">from_ptr(ptr,</span> <span class="pre">owner=True)</span></code>.</p>
<p>The GIL must <em>not</em> be released in <code class="docutils literal notranslate"><span class="pre">__dealloc__</span></code> either, or another lock used
if it is, in such cases or race conditions can occur with multiple
de-allocations.</p>
<p>Being a part of the object constructor, the <code class="docutils literal notranslate"><span class="pre">__cinit__</span></code> method has a Python
signature, which makes it unable to accept a <code class="docutils literal notranslate"><span class="pre">my_c_struct</span></code> pointer as an
argument.</p>
<p>Attempts to use pointers in a Python signature will result in errors like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">Cannot</span> <span class="n">convert</span> <span class="s">&#39;my_c_struct *&#39;</span> <span class="n">to</span> <span class="n">Python</span> <span class="nb">object</span>
</pre></div>
</div>
<p>This is because Cython cannot automatically convert a pointer to a Python
object, unlike with native types like <code class="docutils literal notranslate"><span class="pre">int</span></code>.</p>
<p>Note that for native types, Cython will copy the value and create a new Python
object while in the above case, data is not copied and deallocating memory is
a responsibility of the extension class.</p>
</div>
<div class="section" id="making-extension-types-weak-referenceable">
<span id="id7"></span><h4>Making extension types weak-referenceable<a class="headerlink" href="#making-extension-types-weak-referenceable" title="Permalink to this headline">¶</a></h4>
<p>By default, extension types do not support having weak references made to
them. You can enable weak referencing by declaring a C attribute of type
object called <code class="xref py py-attr docutils literal notranslate"><span class="pre">__weakref__</span></code>. For example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">ExplodingAnimal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This animal will self-destruct when it is</span>
<span class="sd">    no longer strongly referenced.&quot;&quot;&quot;</span>

    <span class="k">cdef</span> <span class="kt">object</span> <span class="nf">__weakref__</span>
</pre></div>
</div>
</div>
<div class="section" id="controlling-deallocation-and-garbage-collection-in-cpython">
<h4>Controlling deallocation and garbage collection in CPython<a class="headerlink" href="#controlling-deallocation-and-garbage-collection-in-cpython" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section only applies to the usual CPython implementation
of Python. Other implementations like PyPy work differently.</p>
</div>
<div class="section" id="dealloc-intro">
<span id="id8"></span><h5>Introduction<a class="headerlink" href="#dealloc-intro" title="Permalink to this headline">¶</a></h5>
<p>First of all, it is good to understand that there are two ways to
trigger deallocation of Python objects in CPython:
CPython uses reference counting for all objects and any object with a
reference count of zero is immediately deallocated. This is the most
common way of deallocating an object. For example, consider</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;bar&quot;</span>
</pre></div>
</div>
<p>After executing the second line, the string <code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;</span></code> is no longer referenced,
so it is deallocated. This is done using the <code class="docutils literal notranslate"><span class="pre">tp_dealloc</span></code> slot, which can be
customized in Cython by implementing <code class="docutils literal notranslate"><span class="pre">__dealloc__</span></code>.</p>
<p>The second mechanism is the cyclic garbage collector.
This is meant to resolve cyclic reference cycles such as</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Object</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">pass</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">make_cycle</span><span class="p">():</span>
<span class="o">...</span>     <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">x</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">y</span>
</pre></div>
</div>
<p>When calling <code class="docutils literal notranslate"><span class="pre">make_cycle</span></code>, a reference cycle is created since <code class="docutils literal notranslate"><span class="pre">x</span></code>
references <code class="docutils literal notranslate"><span class="pre">y</span></code> and vice versa. Even though neither <code class="docutils literal notranslate"><span class="pre">x</span></code> or <code class="docutils literal notranslate"><span class="pre">y</span></code>
are accessible after <code class="docutils literal notranslate"><span class="pre">make_cycle</span></code> returns, both have a reference count
of 1, so they are not immediately deallocated. At regular times, the garbage
collector runs, which will notice the reference cycle
(using the <code class="docutils literal notranslate"><span class="pre">tp_traverse</span></code> slot) and break it.
Breaking a reference cycle means taking an object in the cycle
and removing all references from it to other Python objects (we call this
<em>clearing</em> an object). Clearing is almost the same as deallocating, except
that the actual object is not yet freed. For <code class="docutils literal notranslate"><span class="pre">x</span></code> in the example above,
the attributes of <code class="docutils literal notranslate"><span class="pre">x</span></code> would be removed from <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<p>Note that it suffices to clear just one object in the reference cycle,
since there is no longer a cycle after clearing one object. Once the cycle
is broken, the usual refcount-based deallocation will actually remove the
objects from memory. Clearing is implemented in the <code class="docutils literal notranslate"><span class="pre">tp_clear</span></code> slot.
As we just explained, it is sufficient that one object in the cycle
implements <code class="docutils literal notranslate"><span class="pre">tp_clear</span></code>.</p>
</div>
<div class="section" id="enabling-the-deallocation-trashcan">
<h5>Enabling the deallocation trashcan<a class="headerlink" href="#enabling-the-deallocation-trashcan" title="Permalink to this headline">¶</a></h5>
<p>In CPython, it is possible to create deeply recursive objects. For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">L</span> <span class="o">=</span> <span class="bp">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">2</span><span class="o">**</span><span class="mf">20</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">L</span><span class="p">]</span>
</pre></div>
</div>
<p>Now imagine that we delete the final <code class="docutils literal notranslate"><span class="pre">L</span></code>. Then <code class="docutils literal notranslate"><span class="pre">L</span></code> deallocates
<code class="docutils literal notranslate"><span class="pre">L[0]</span></code>, which deallocates <code class="docutils literal notranslate"><span class="pre">L[0][0]</span></code> and so on until we reach a
recursion depth of <code class="docutils literal notranslate"><span class="pre">2**20</span></code>. This deallocation is done in C and such
a deep recursion will likely overflow the C call stack, crashing Python.</p>
<p>CPython invented a mechanism for this called the <em>trashcan</em>. It limits the
recursion depth of deallocations by delaying some deallocations.</p>
<p>By default, Cython extension types do not use the trashcan but it can be
enabled by setting the <code class="docutils literal notranslate"><span class="pre">trashcan</span></code> directive to <code class="docutils literal notranslate"><span class="pre">True</span></code>. For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">cython</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">trashcan</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Object</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">dict</span> <span class="nf">__dict__</span>
</pre></div>
</div>
<p>Trashcan usage is inherited by subclasses
(unless explicitly disabled by <code class="docutils literal notranslate"><span class="pre">&#64;cython.trashcan(False)</span></code>).
Some builtin types like <code class="docutils literal notranslate"><span class="pre">list</span></code> use the trashcan, so subclasses of it
use the trashcan by default.</p>
</div>
<div class="section" id="disabling-cycle-breaking-tp-clear">
<h5>Disabling cycle breaking (<code class="docutils literal notranslate"><span class="pre">tp_clear</span></code>)<a class="headerlink" href="#disabling-cycle-breaking-tp-clear" title="Permalink to this headline">¶</a></h5>
<p>By default, each extension type will support the cyclic garbage collector of
CPython. If any Python objects can be referenced, Cython will automatically
generate the <code class="docutils literal notranslate"><span class="pre">tp_traverse</span></code> and <code class="docutils literal notranslate"><span class="pre">tp_clear</span></code> slots. This is usually what you
want.</p>
<p>There is at least one reason why this might not be what you want: If you need
to cleanup some external resources in the <code class="docutils literal notranslate"><span class="pre">__dealloc__</span></code> special function and
your object happened to be in a reference cycle, the garbage collector may
have triggered a call to <code class="docutils literal notranslate"><span class="pre">tp_clear</span></code> to clear the object
(see <a class="reference internal" href="#dealloc-intro"><span class="std std-ref">Introduction</span></a>).</p>
<p>In that case, any object references have vanished when <code class="docutils literal notranslate"><span class="pre">__dealloc__</span></code>
is called. Now your cleanup code lost access to the objects it has to clean up.
To fix this, you can disable clearing instances of a specific class by using
the <code class="docutils literal notranslate"><span class="pre">no_gc_clear</span></code> directive:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="nd">@cython</span><span class="o">.</span><span class="n">no_gc_clear</span>
<span class="k">cdef</span> <span class="k">class</span> <span class="nf">DBCursor</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DBConnection</span> <span class="nf">conn</span>
    <span class="k">cdef</span> <span class="kt">DBAPI_Cursor</span> *<span class="nf">raw_cursor</span>
    <span class="c"># ...</span>
    <span class="k">def</span> <span class="nf">__dealloc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">DBAPI_close_cursor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">raw_conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_cursor</span><span class="p">)</span>
</pre></div>
</div>
<p>This example tries to close a cursor via a database connection when the Python
object is destroyed. The <code class="docutils literal notranslate"><span class="pre">DBConnection</span></code> object is kept alive by the reference
from <code class="docutils literal notranslate"><span class="pre">DBCursor</span></code>. But if a cursor happens to be in a reference cycle, the
garbage collector may delete the database connection reference,
which makes it impossible to clean up the cursor.</p>
<p>If you use <code class="docutils literal notranslate"><span class="pre">no_gc_clear</span></code>, it is important that any given reference cycle
contains at least one object <em>without</em> <code class="docutils literal notranslate"><span class="pre">no_gc_clear</span></code>. Otherwise, the cycle
cannot be broken, which is a memory leak.</p>
</div>
<div class="section" id="disabling-cyclic-garbage-collection">
<h5>Disabling cyclic garbage collection<a class="headerlink" href="#disabling-cyclic-garbage-collection" title="Permalink to this headline">¶</a></h5>
<p>In rare cases, extension types can be guaranteed not to participate in cycles,
but the compiler won’t be able to prove this. This would be the case if
the class can never reference itself, even indirectly.
In that case, you can manually disable cycle collection by using the
<code class="docutils literal notranslate"><span class="pre">no_gc</span></code> directive, but beware that doing so when in fact the extension type
can participate in cycles could cause memory leaks</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="nd">@cython</span><span class="o">.</span><span class="n">no_gc</span>
<span class="k">cdef</span> <span class="k">class</span> <span class="nf">UserInfo</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">str</span> <span class="nf">name</span>
    <span class="k">cdef</span> <span class="kt">tuple</span> <span class="nf">addresses</span>
</pre></div>
</div>
<p>If you can be sure addresses will contain only references to strings,
the above would be safe, and it may yield a significant speedup, depending on
your usage pattern.</p>
</div>
</div>
<div class="section" id="controlling-pickling">
<h4>Controlling pickling<a class="headerlink" href="#controlling-pickling" title="Permalink to this headline">¶</a></h4>
<p>By default, Cython will generate a <code class="docutils literal notranslate"><span class="pre">__reduce__()</span></code> method to allow pickling
an extension type if and only if each of its members are convertible to Python
and it has no <code class="docutils literal notranslate"><span class="pre">__cinit__</span></code> method.
To require this behavior (i.e. throw an error at compile time if a class
cannot be pickled) decorate the class with <code class="docutils literal notranslate"><span class="pre">&#64;cython.auto_pickle(True)</span></code>.
One can also annotate with <code class="docutils literal notranslate"><span class="pre">&#64;cython.auto_pickle(False)</span></code> to get the old
behavior of not generating a <code class="docutils literal notranslate"><span class="pre">__reduce__</span></code> method in any case.</p>
<p>Manually implementing a <code class="docutils literal notranslate"><span class="pre">__reduce__</span></code> or <cite>__reduce_ex__`</cite> method will also
disable this auto-generation and can be used to support pickling of more
complicated types.</p>
</div>
<div class="section" id="public-and-external-extension-types">
<h4>Public and external extension types<a class="headerlink" href="#public-and-external-extension-types" title="Permalink to this headline">¶</a></h4>
<p>Extension types can be declared extern or public. An extern extension type
declaration makes an extension type defined in external C code available to a
Cython module. A public extension type declaration makes an extension type
defined in a Cython module available to external C code.</p>
<div class="section" id="external-extension-types">
<span id="id9"></span><h5>External extension types<a class="headerlink" href="#external-extension-types" title="Permalink to this headline">¶</a></h5>
<p>An extern extension type allows you to gain access to the internals of Python
objects defined in the Python core or in a non-Cython extension module.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In previous versions of Pyrex, extern extension types were also used to
reference extension types defined in another Pyrex module. While you can still
do that, Cython provides a better mechanism for this. See
<a class="reference internal" href="index.html#sharing-declarations"><span class="std std-ref">Sharing Declarations Between Cython Modules</span></a>.</p>
</div>
<p>Here is an example which will let you get at the C-level members of the
built-in complex object.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;complexobject.h&quot;</span><span class="p">:</span>

    <span class="k">struct</span> <span class="nc">Py_complex</span><span class="p">:</span>
        <span class="n">double</span> <span class="n">real</span>
        <span class="n">double</span> <span class="n">imag</span>

    <span class="k">ctypedef</span> <span class="k">class</span> <span class="nc">__builtin__</span><span class="o">.</span><span class="n">complex</span> <span class="p">[</span><span class="nb">object</span> <span class="n">PyComplexObject</span><span class="p">]:</span>
        <span class="k">cdef</span> <span class="kt">Py_complex</span> <span class="nf">cval</span>

<span class="c"># A function which uses the above type</span>
<span class="k">def</span> <span class="nf">spam</span><span class="p">(</span><span class="nb">complex</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Real:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">cval</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Imag:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">cval</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Some important things:</p>
<ol class="last arabic">
<li><p class="first">In this example, <a class="reference internal" href="index.html#ctypedef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">ctypedef</span></code></a> class has been used. This is
because, in the Python header files, the <code class="docutils literal notranslate"><span class="pre">PyComplexObject</span></code> struct is
declared with:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">PyComplexObject</span><span class="p">;</span>
</pre></div>
</div>
<p>At runtime, a check will be performed when importing the Cython
c-extension module that <code class="docutils literal notranslate"><span class="pre">__builtin__.complex</span></code>’s <code class="docutils literal notranslate"><span class="pre">tp_basicsize</span></code>
matches <code class="docutils literal notranslate"><span class="pre">sizeof(`PyComplexObject)</span></code>. This check can fail if the Cython
c-extension module was compiled with one version of the
<code class="docutils literal notranslate"><span class="pre">complexobject.h</span></code> header but imported into a Python with a changed
header. This check can be tweaked by using <code class="docutils literal notranslate"><span class="pre">check_size</span></code> in the name
specification clause.</p>
</li>
<li><p class="first">As well as the name of the extension type, the module in which its type
object can be found is also specified. See the implicit importing section
below.</p>
</li>
<li><p class="first">When declaring an external extension type, you don’t declare any
methods.  Declaration of methods is not required in order to call them,
because the calls are Python method calls. Also, as with
<a class="reference internal" href="index.html#struct"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">struct</span></code></a> and <a class="reference internal" href="index.html#union"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">union</span></code></a>, if your extension class
declaration is inside a <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> extern from block, you only need to
declare those C members which you wish to access.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="name-specification-clause">
<span id="id10"></span><h5>Name specification clause<a class="headerlink" href="#name-specification-clause" title="Permalink to this headline">¶</a></h5>
<p>The part of the class declaration in square brackets is a special feature only
available for extern or public extension types. The full form of this clause
is:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">object</span> <span class="n">object_struct_name</span><span class="p">,</span> <span class="nb">type</span> <span class="n">type_object_name</span><span class="p">,</span> <span class="n">check_size</span> <span class="n">cs_option</span><span class="p">]</span>
</pre></div>
</div>
<p>Where:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">object_struct_name</span></code> is the name to assume for the type’s C struct.</li>
<li><code class="docutils literal notranslate"><span class="pre">type_object_name</span></code> is the name to assume for the type’s statically
declared type object.</li>
<li><code class="docutils literal notranslate"><span class="pre">cs_option</span></code> is <code class="docutils literal notranslate"><span class="pre">warn</span></code> (the default), <code class="docutils literal notranslate"><span class="pre">error</span></code>, or <code class="docutils literal notranslate"><span class="pre">ignore</span></code> and is only
used for external extension types.  If <code class="docutils literal notranslate"><span class="pre">error</span></code>, the <code class="docutils literal notranslate"><span class="pre">sizeof(object_struct)</span></code>
that was found at compile time must match the type’s runtime <code class="docutils literal notranslate"><span class="pre">tp_basicsize</span></code>
exactly, otherwise the module import will fail with an error.  If <code class="docutils literal notranslate"><span class="pre">warn</span></code>
or <code class="docutils literal notranslate"><span class="pre">ignore</span></code>, the <code class="docutils literal notranslate"><span class="pre">object_struct</span></code> is allowed to be smaller than the type’s
<code class="docutils literal notranslate"><span class="pre">tp_basicsize</span></code>, which indicates the runtime type may be part of an updated
module, and that the external module’s developers extended the object in a
backward-compatible fashion (only adding new fields to the end of the object).
If <code class="docutils literal notranslate"><span class="pre">warn</span></code>, a warning will be emitted in this case.</li>
</ul>
<p>The clauses can be written in any order.</p>
<p>If the extension type declaration is inside a <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> extern from
block, the object clause is required, because Cython must be able to generate
code that is compatible with the declarations in the header file. Otherwise,
for extern extension types, the object clause is optional.</p>
<p>For public extension types, the object and type clauses are both required,
because Cython must be able to generate code that is compatible with external C
code.</p>
</div>
<div class="section" id="attribute-name-matching-and-aliasing">
<h5>Attribute name matching and aliasing<a class="headerlink" href="#attribute-name-matching-and-aliasing" title="Permalink to this headline">¶</a></h5>
<p>Sometimes the type’s C struct as specified in <code class="docutils literal notranslate"><span class="pre">object_struct_name</span></code> may use
different labels for the fields than those in the <code class="docutils literal notranslate"><span class="pre">PyTypeObject</span></code>. This can
easily happen in hand-coded C extensions where the <code class="docutils literal notranslate"><span class="pre">PyTypeObject_Foo</span></code> has a
getter method, but the name does not match the name in the <code class="docutils literal notranslate"><span class="pre">PyFooObject</span></code>. In
NumPy, for instance, python-level <code class="docutils literal notranslate"><span class="pre">dtype.itemsize</span></code> is a getter for the C
struct field <code class="docutils literal notranslate"><span class="pre">elsize</span></code>. Cython supports aliasing field names so that one can
write <code class="docutils literal notranslate"><span class="pre">dtype.itemsize</span></code> in Cython code which will be compiled into direct
access of the C struct field, without going through a C-API equivalent of
<code class="docutils literal notranslate"><span class="pre">dtype.__getattr__('itemsize')</span></code>.</p>
<p>For example we may have an extension
module <code class="docutils literal notranslate"><span class="pre">foo_extension</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Foo</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kr">public</span> <span class="kt">int</span> <span class="nf">field0</span><span class="p">,</span> <span class="nf">field1</span><span class="p">,</span> <span class="kt">field2</span>;

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field0</span> <span class="o">=</span> <span class="n">f0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field1</span> <span class="o">=</span> <span class="n">f1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field2</span> <span class="o">=</span> <span class="n">f2</span>
</pre></div>
</div>
<p>but a C struct in a file <code class="docutils literal notranslate"><span class="pre">foo_nominal.h</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="k">struct</span> <span class="err">{</span>
     <span class="n">PyObject_HEAD</span>
     <span class="nb">int</span> <span class="n">f0</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">f1</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">f2</span><span class="p">;</span>
 <span class="p">}</span> <span class="n">FooStructNominal</span><span class="p">;</span>
</pre></div>
</div>
<p>Note that the struct uses <code class="docutils literal notranslate"><span class="pre">f0</span></code>, <code class="docutils literal notranslate"><span class="pre">f1</span></code>, <code class="docutils literal notranslate"><span class="pre">f2</span></code> but they are <code class="docutils literal notranslate"><span class="pre">field0</span></code>,
<code class="docutils literal notranslate"><span class="pre">field1</span></code>, and <code class="docutils literal notranslate"><span class="pre">field2</span></code> in <code class="docutils literal notranslate"><span class="pre">Foo</span></code>. We are given this situation, including
a header file with that struct, and we wish to write a function to sum the
values. If we write an extension module <code class="docutils literal notranslate"><span class="pre">wrapper</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;foo_nominal.h&quot;</span><span class="p">:</span>

    <span class="k">ctypedef</span> <span class="k">class</span> <span class="nc">foo_extension</span><span class="o">.</span><span class="n">Foo</span> <span class="p">[</span><span class="nb">object</span> <span class="n">FooStructNominal</span><span class="p">]:</span>
        <span class="n">cdef</span><span class="p">:</span>
            <span class="nb">int</span> <span class="n">field0</span>
            <span class="nb">int</span> <span class="n">field1</span>
            <span class="nb">int</span> <span class="n">feild2</span>

<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">Foo</span> <span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">field0</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">field1</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">field2</span>
</pre></div>
</div>
<p>then <code class="docutils literal notranslate"><span class="pre">wrapper.sum(f)</span></code> (where <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">=</span> <span class="pre">foo_extension.Foo(1,</span> <span class="pre">2,</span> <span class="pre">3)</span></code>) will still
use the C-API equivalent of:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="s">&#39;field0&#39;</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">f</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="s">&#39;field1&#39;</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">f</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="s">&#39;field1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>instead of the desired C equivalent of <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">f-&gt;f0</span> <span class="pre">+</span> <span class="pre">f-&gt;f1</span> <span class="pre">+</span> <span class="pre">f-&gt;f2</span></code>. We can
alias the fields by using:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;foo_nominal.h&quot;</span><span class="p">:</span>

    <span class="k">ctypedef</span> <span class="k">class</span> <span class="nc">foo_extension</span><span class="o">.</span><span class="n">Foo</span> <span class="p">[</span><span class="nb">object</span> <span class="n">FooStructNominal</span><span class="p">]:</span>
        <span class="n">cdef</span><span class="p">:</span>
            <span class="nb">int</span> <span class="n">field0</span> <span class="s">&quot;f0&quot;</span>
            <span class="nb">int</span> <span class="n">field1</span> <span class="s">&quot;f1&quot;</span>
            <span class="nb">int</span> <span class="n">field2</span> <span class="s">&quot;f2&quot;</span>

<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">Foo</span> <span class="n">f</span><span class="p">)</span> <span class="k">except</span> <span class="o">-</span><span class="mf">1</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">field0</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">field1</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">field2</span>
</pre></div>
</div>
<p>and now Cython will replace the slow <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> with direct C access to
the FooStructNominal fields. This is useful when directly processing Python
code. No changes to Python need be made to achieve significant speedups, even
though the field names in Python and C are different. Of course, one should
make sure the fields are equivalent.</p>
</div>
<div class="section" id="implicit-importing">
<h5>Implicit importing<a class="headerlink" href="#implicit-importing" title="Permalink to this headline">¶</a></h5>
<p>Cython requires you to include a module name in an extern extension class
declaration, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">class</span> <span class="kt">MyModule</span>.<span class="nf">Spam</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The type object will be implicitly imported from the specified module and
bound to the corresponding name in this module. In other words, in this
example an implicit:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">MyModule</span> <span class="k">import</span> <span class="n">Spam</span>
</pre></div>
</div>
<p>statement will be executed at module load time.</p>
<p>The module name can be a dotted name to refer to a module inside a package
hierarchy, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">class</span> <span class="kt">My</span>.<span class="kt">Nested</span>.<span class="kt">Package</span>.<span class="nf">Spam</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>You can also specify an alternative name under which to import the type using
an as clause, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">class</span> <span class="kt">My</span>.<span class="kt">Nested</span>.<span class="kt">Package</span>.<span class="kt">Spam</span> <span class="k">as</span> <span class="nf">Yummy</span><span class="p">:</span>
   <span class="o">...</span>
</pre></div>
</div>
<p>which corresponds to the implicit import statement:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">My.Nested.Package</span> <span class="k">import</span> <span class="n">Spam</span> <span class="k">as</span> <span class="n">Yummy</span>
</pre></div>
</div>
</div>
<div class="section" id="type-names-vs-constructor-names">
<span id="types-names-vs-constructor-names"></span><h5>Type names vs. constructor names<a class="headerlink" href="#type-names-vs-constructor-names" title="Permalink to this headline">¶</a></h5>
<p>Inside a Cython module, the name of an extension type serves two distinct
purposes. When used in an expression, it refers to a module-level global
variable holding the type’s constructor (i.e. its type-object). However, it
can also be used as a C type name to declare variables, arguments and return
values of that type.</p>
<p>When you declare:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">class</span> <span class="kt">MyModule</span>.<span class="nf">Spam</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>the name Spam serves both these roles. There may be other names by which you
can refer to the constructor, but only Spam can be used as a type name. For
example, if you were to explicitly import MyModule, you could use
<code class="docutils literal notranslate"><span class="pre">MyModule.Spam()</span></code> to create a Spam instance, but you wouldn’t be able to use
<code class="xref py py-class docutils literal notranslate"><span class="pre">MyModule.Spam</span></code> as a type name.</p>
<p>When an as clause is used, the name specified in the as clause also takes over
both roles. So if you declare:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">class</span> <span class="kt">MyModule</span>.<span class="kt">Spam</span> <span class="k">as</span> <span class="nf">Yummy</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>then Yummy becomes both the type name and a name for the constructor. Again,
there are other ways that you could get hold of the constructor, but only
Yummy is usable as a type name.</p>
</div>
</div>
<div class="section" id="public-extension-types">
<span id="public"></span><h4>Public extension types<a class="headerlink" href="#public-extension-types" title="Permalink to this headline">¶</a></h4>
<p>An extension type can be declared public, in which case a <code class="docutils literal notranslate"><span class="pre">.h</span></code> file is
generated containing declarations for its object struct and type object. By
including the <code class="docutils literal notranslate"><span class="pre">.h</span></code> file in external C code that you write, that code can
access the attributes of the extension type.</p>
</div>
</div>
<span id="document-src/userguide/special_methods"></span><div class="section" id="special-methods-of-extension-types">
<span id="special-methods"></span><h3>Special Methods of Extension Types<a class="headerlink" href="#special-methods-of-extension-types" title="Permalink to this headline">¶</a></h3>
<p>This page describes the special methods currently supported by Cython extension
types. A complete list of all the special methods appears in the table at the
bottom. Some of these methods behave differently from their Python
counterparts or have no direct Python counterparts, and require special
mention.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Everything said on this page applies only to extension types, defined
with the <code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">class</span></code> statement. It doesn’t apply to classes defined with the
Python <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#class" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">class</span></code></a> statement, where the normal Python rules apply.</p>
</div>
<div class="section" id="declaration">
<span id="id1"></span><h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this headline">¶</a></h4>
<p>Special methods of extension types must be declared with <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#def" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">def</span></code></a>, not
<a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a>. This does not impact their performance–Python uses different
calling conventions to invoke these special methods.</p>
</div>
<div class="section" id="docstrings">
<span id="id2"></span><h4>Docstrings<a class="headerlink" href="#docstrings" title="Permalink to this headline">¶</a></h4>
<p>Currently, docstrings are not fully supported in some special methods of extension
types. You can place a docstring in the source to serve as a comment, but it
won’t show up in the corresponding <code class="xref py py-attr docutils literal notranslate"><span class="pre">__doc__</span></code> attribute at run time. (This
seems to be is a Python limitation – there’s nowhere in the <cite>PyTypeObject</cite>
data structure to put such docstrings.)</p>
</div>
<div class="section" id="initialisation-methods-cinit-and-init">
<span id="initialisation-methods"></span><h4>Initialisation methods: <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> and <code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code><a class="headerlink" href="#initialisation-methods-cinit-and-init" title="Permalink to this headline">¶</a></h4>
<p>There are two methods concerned with initialising the object.</p>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method is where you should perform basic C-level
initialisation of the object, including allocation of any C data structures
that your object will own. You need to be careful what you do in the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method, because the object may not yet be a fully valid Python
object when it is called. Therefore, you should be careful invoking any Python
operations which might touch the object; in particular, its methods and anything
that could be overridden by subtypes (and thus depend on their subtype state being
initialised already).</p>
<p>By the time your <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method is called, memory has been allocated for the
object and any C attributes it has have been initialised to 0 or null. (Any
Python attributes have also been initialised to None, but you probably
shouldn’t rely on that.) Your <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method is guaranteed to be called
exactly once.</p>
<p>If your extension type has a base type, any existing <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> methods in
the base type hierarchy are automatically called before your <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code>
method.  You cannot explicitly call the inherited <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> methods, and the
base types are free to choose whether they implement <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> at all.
If you need to pass a modified argument list to the base type, you will have to do
the relevant part of the initialisation in the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code> method instead, where
the normal rules for calling inherited methods apply.</p>
<p>Any initialisation which cannot safely be done in the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method should
be done in the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code> method. By the time <code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code> is called, the object is
a fully valid Python object and all operations are safe. Under some
circumstances it is possible for <code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code> to be called more than once or not
to be called at all, so your other methods should be designed to be robust in
such situations.</p>
<p>Any arguments passed to the constructor will be passed to both the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method and the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code> method. If you anticipate
subclassing your extension type in Python, you may find it useful to give the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method <cite>*</cite> and <cite>**</cite> arguments so that it can accept and
ignore extra arguments. Otherwise, any Python subclass which has an
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code> with a different signature will have to override
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__new__()</span></code> <a class="footnote-reference" href="#id4" id="id3">[1]</a> as well as <code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code>, which the writer of a Python
class wouldn’t expect to have to do.  Alternatively, as a convenience, if you declare
your <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__`()</span></code> method to take no arguments (other than self) it
will simply ignore any extra arguments passed to the constructor without
complaining about the signature mismatch.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>All constructor arguments will be passed as Python objects.
This implies that non-convertible C types such as pointers or C++ objects
cannot be passed into the constructor from Cython code.  If this is needed,
use a factory function instead that handles the object initialisation.
It often helps to directly call <code class="docutils literal notranslate"><span class="pre">__new__()</span></code> in this function to bypass the
call to the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> constructor.</p>
<p class="last">See <a class="reference internal" href="index.html#existing-pointers-instantiation"><span class="std std-ref">Instantiation from existing C/C++ pointers</span></a> for an example.</p>
</div>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td><a class="reference external" href="https://docs.python.org/reference/datamodel.html#object.__new__">https://docs.python.org/reference/datamodel.html#object.__new__</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="finalization-method-dealloc">
<span id="finalization-method"></span><h4>Finalization method: <code class="xref py py-meth docutils literal notranslate"><span class="pre">__dealloc__()</span></code><a class="headerlink" href="#finalization-method-dealloc" title="Permalink to this headline">¶</a></h4>
<p>The counterpart to the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method is the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__dealloc__()</span></code>
method, which should perform the inverse of the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method. Any
C data that you explicitly allocated (e.g. via malloc) in your
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__cinit__()</span></code> method should be freed in your <code class="xref py py-meth docutils literal notranslate"><span class="pre">__dealloc__()</span></code> method.</p>
<p>You need to be careful what you do in a <code class="xref py py-meth docutils literal notranslate"><span class="pre">__dealloc__()</span></code> method. By the time your
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__dealloc__()</span></code> method is called, the object may already have been partially
destroyed and may not be in a valid state as far as Python is concerned, so
you should avoid invoking any Python operations which might touch the object.
In particular, don’t call any other methods of the object or do anything which
might cause the object to be resurrected. It’s best if you stick to just
deallocating C data.</p>
<p>You don’t need to worry about deallocating Python attributes of your object,
because that will be done for you by Cython after your <code class="xref py py-meth docutils literal notranslate"><span class="pre">__dealloc__()</span></code> method
returns.</p>
<p>When subclassing extension types, be aware that the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__dealloc__()</span></code> method
of the superclass will always be called, even if it is overridden.  This is in
contrast to typical Python behavior where superclass methods will not be
executed unless they are explicitly called by the subclass.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no <code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code> method for extension types.</p>
</div>
</div>
<div class="section" id="arithmetic-methods">
<span id="id5"></span><h4>Arithmetic methods<a class="headerlink" href="#arithmetic-methods" title="Permalink to this headline">¶</a></h4>
<p>Arithmetic operator methods, such as <code class="xref py py-meth docutils literal notranslate"><span class="pre">__add__()</span></code>, behave differently from their
Python counterparts. There are no separate “reversed” versions of these
methods (<code class="xref py py-meth docutils literal notranslate"><span class="pre">__radd__()</span></code>, etc.) Instead, if the first operand cannot perform the
operation, the same method of the second operand is called, with the operands
in the same order.</p>
<p>This means that you can’t rely on the first parameter of these methods being
“self” or being the right type, and you should test the types of both operands
before deciding what to do. If you can’t handle the combination of types you’ve
been given, you should return <cite>NotImplemented</cite>.</p>
<p>This also applies to the in-place arithmetic method <code class="xref py py-meth docutils literal notranslate"><span class="pre">__ipow__()</span></code>. It doesn’t apply
to any of the other in-place methods (<code class="xref py py-meth docutils literal notranslate"><span class="pre">__iadd__()</span></code>, etc.) which always
take <cite>self</cite> as the first argument.</p>
</div>
<div class="section" id="rich-comparisons">
<span id="righ-comparisons"></span><h4>Rich comparisons<a class="headerlink" href="#rich-comparisons" title="Permalink to this headline">¶</a></h4>
<p>There are two ways to implement comparison methods.
Depending on the application, one way or the other may be better:</p>
<ul>
<li><p class="first">The first way uses the 6 Python
<a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#basic-customization">special methods</a>
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__eq__()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">__lt__()</span></code>, etc.
This is new since Cython 0.27 and works exactly as in plain Python classes.</p>
</li>
<li><p class="first">The second way uses a single special method <code class="xref py py-meth docutils literal notranslate"><span class="pre">__richcmp__()</span></code>.
This implements all rich comparison operations in one method.
The signature is <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">__richcmp__(self,</span> <span class="pre">other,</span> <span class="pre">int</span> <span class="pre">op)</span></code>.
The integer argument <code class="docutils literal notranslate"><span class="pre">op</span></code> indicates which operation is to be performed
as shown in the table below:</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>&lt;</td>
<td>Py_LT</td>
</tr>
<tr class="row-even"><td>==</td>
<td>Py_EQ</td>
</tr>
<tr class="row-odd"><td>&gt;</td>
<td>Py_GT</td>
</tr>
<tr class="row-even"><td>&lt;=</td>
<td>Py_LE</td>
</tr>
<tr class="row-odd"><td>!=</td>
<td>Py_NE</td>
</tr>
<tr class="row-even"><td>&gt;=</td>
<td>Py_GE</td>
</tr>
</tbody>
</table>
<p>These constants can be cimported from the <code class="docutils literal notranslate"><span class="pre">cpython.object</span></code> module.</p>
</li>
</ul>
</div>
<div class="section" id="the-next-method">
<span id="id7"></span><h4>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">__next__()</span></code> method<a class="headerlink" href="#the-next-method" title="Permalink to this headline">¶</a></h4>
<p>Extension types wishing to implement the iterator interface should define a
method called <code class="xref py py-meth docutils literal notranslate"><span class="pre">__next__()</span></code>, not next. The Python system will automatically
supply a next method which calls your <code class="xref py py-meth docutils literal notranslate"><span class="pre">__next__()</span></code>. Do <em>NOT</em> explicitly
give your type a <code class="xref py py-meth docutils literal notranslate"><span class="pre">next()</span></code> method, or bad things could happen.</p>
</div>
<div class="section" id="special-method-table">
<span id="special-methods-table"></span><h4>Special Method Table<a class="headerlink" href="#special-method-table" title="Permalink to this headline">¶</a></h4>
<p>This table lists all of the special methods together with their parameter and
return types. In the table below, a parameter name of self is used to indicate
that the parameter has the type that the method belongs to. Other parameters
with no type specified in the table are generic Python objects.</p>
<p>You don’t have to declare your method as taking these parameter types. If you
declare different types, conversions will be performed as necessary.</p>
<div class="section" id="general">
<h5>General<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#special-method-names">https://docs.python.org/3/reference/datamodel.html#special-method-names</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__cinit__</td>
<td>self, …</td>
<td>&#160;</td>
<td>Basic initialisation (no direct Python equivalent)</td>
</tr>
<tr class="row-odd"><td>__init__</td>
<td>self, …</td>
<td>&#160;</td>
<td>Further initialisation</td>
</tr>
<tr class="row-even"><td>__dealloc__</td>
<td>self</td>
<td>&#160;</td>
<td>Basic deallocation (no direct Python equivalent)</td>
</tr>
<tr class="row-odd"><td>__cmp__</td>
<td>x, y</td>
<td>int</td>
<td>3-way comparison (Python 2 only)</td>
</tr>
<tr class="row-even"><td>__str__</td>
<td>self</td>
<td>object</td>
<td>str(self)</td>
</tr>
<tr class="row-odd"><td>__repr__</td>
<td>self</td>
<td>object</td>
<td>repr(self)</td>
</tr>
<tr class="row-even"><td>__hash__</td>
<td>self</td>
<td>Py_hash_t</td>
<td>Hash function (returns 32/64 bit integer)</td>
</tr>
<tr class="row-odd"><td>__call__</td>
<td>self, …</td>
<td>object</td>
<td>self(…)</td>
</tr>
<tr class="row-even"><td>__iter__</td>
<td>self</td>
<td>object</td>
<td>Return iterator for sequence</td>
</tr>
<tr class="row-odd"><td>__getattr__</td>
<td>self, name</td>
<td>object</td>
<td>Get attribute</td>
</tr>
<tr class="row-even"><td>__getattribute__</td>
<td>self, name</td>
<td>object</td>
<td>Get attribute, unconditionally</td>
</tr>
<tr class="row-odd"><td>__setattr__</td>
<td>self, name, val</td>
<td>&#160;</td>
<td>Set attribute</td>
</tr>
<tr class="row-even"><td>__delattr__</td>
<td>self, name</td>
<td>&#160;</td>
<td>Delete attribute</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="rich-comparison-operators">
<h5>Rich comparison operators<a class="headerlink" href="#rich-comparison-operators" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#basic-customization">https://docs.python.org/3/reference/datamodel.html#basic-customization</a></p>
<p>You can choose to either implement the standard Python special methods
like <code class="xref py py-meth docutils literal notranslate"><span class="pre">__eq__()</span></code> or the single special method <code class="xref py py-meth docutils literal notranslate"><span class="pre">__richcmp__()</span></code>.
Depending on the application, one way or the other may be better.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__eq__</td>
<td>self, y</td>
<td>object</td>
<td>self == y</td>
</tr>
<tr class="row-odd"><td>__ne__</td>
<td>self, y</td>
<td>object</td>
<td>self != y  (falls back to <code class="docutils literal notranslate"><span class="pre">__eq__</span></code> if not available)</td>
</tr>
<tr class="row-even"><td>__lt__</td>
<td>self, y</td>
<td>object</td>
<td>self &lt; y</td>
</tr>
<tr class="row-odd"><td>__gt__</td>
<td>self, y</td>
<td>object</td>
<td>self &gt; y</td>
</tr>
<tr class="row-even"><td>__le__</td>
<td>self, y</td>
<td>object</td>
<td>self &lt;= y</td>
</tr>
<tr class="row-odd"><td>__ge__</td>
<td>self, y</td>
<td>object</td>
<td>self &gt;= y</td>
</tr>
<tr class="row-even"><td>__richcmp__</td>
<td>self, y, int op</td>
<td>object</td>
<td>Joined rich comparison method for all of the above
(no direct Python equivalent)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="arithmetic-operators">
<h5>Arithmetic operators<a class="headerlink" href="#arithmetic-operators" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#emulating-numeric-types">https://docs.python.org/3/reference/datamodel.html#emulating-numeric-types</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__add__</td>
<td>x, y</td>
<td>object</td>
<td>binary <cite>+</cite> operator</td>
</tr>
<tr class="row-odd"><td>__sub__</td>
<td>x, y</td>
<td>object</td>
<td>binary <cite>-</cite> operator</td>
</tr>
<tr class="row-even"><td>__mul__</td>
<td>x, y</td>
<td>object</td>
<td><cite>*</cite> operator</td>
</tr>
<tr class="row-odd"><td>__div__</td>
<td>x, y</td>
<td>object</td>
<td><cite>/</cite>  operator for old-style division</td>
</tr>
<tr class="row-even"><td>__floordiv__</td>
<td>x, y</td>
<td>object</td>
<td><cite>//</cite>  operator</td>
</tr>
<tr class="row-odd"><td>__truediv__</td>
<td>x, y</td>
<td>object</td>
<td><cite>/</cite>  operator for new-style division</td>
</tr>
<tr class="row-even"><td>__mod__</td>
<td>x, y</td>
<td>object</td>
<td><cite>%</cite> operator</td>
</tr>
<tr class="row-odd"><td>__divmod__</td>
<td>x, y</td>
<td>object</td>
<td>combined div and mod</td>
</tr>
<tr class="row-even"><td>__pow__</td>
<td>x, y, z</td>
<td>object</td>
<td><cite>**</cite> operator or pow(x, y, z)</td>
</tr>
<tr class="row-odd"><td>__neg__</td>
<td>self</td>
<td>object</td>
<td>unary <cite>-</cite> operator</td>
</tr>
<tr class="row-even"><td>__pos__</td>
<td>self</td>
<td>object</td>
<td>unary <cite>+</cite> operator</td>
</tr>
<tr class="row-odd"><td>__abs__</td>
<td>self</td>
<td>object</td>
<td>absolute value</td>
</tr>
<tr class="row-even"><td>__nonzero__</td>
<td>self</td>
<td>int</td>
<td>convert to boolean</td>
</tr>
<tr class="row-odd"><td>__invert__</td>
<td>self</td>
<td>object</td>
<td><cite>~</cite> operator</td>
</tr>
<tr class="row-even"><td>__lshift__</td>
<td>x, y</td>
<td>object</td>
<td><cite>&lt;&lt;</cite> operator</td>
</tr>
<tr class="row-odd"><td>__rshift__</td>
<td>x, y</td>
<td>object</td>
<td><cite>&gt;&gt;</cite> operator</td>
</tr>
<tr class="row-even"><td>__and__</td>
<td>x, y</td>
<td>object</td>
<td><cite>&amp;</cite> operator</td>
</tr>
<tr class="row-odd"><td>__or__</td>
<td>x, y</td>
<td>object</td>
<td><cite>|</cite> operator</td>
</tr>
<tr class="row-even"><td>__xor__</td>
<td>x, y</td>
<td>object</td>
<td><cite>^</cite> operator</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="numeric-conversions">
<h5>Numeric conversions<a class="headerlink" href="#numeric-conversions" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#emulating-numeric-types">https://docs.python.org/3/reference/datamodel.html#emulating-numeric-types</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__int__</td>
<td>self</td>
<td>object</td>
<td>Convert to integer</td>
</tr>
<tr class="row-odd"><td>__long__</td>
<td>self</td>
<td>object</td>
<td>Convert to long integer</td>
</tr>
<tr class="row-even"><td>__float__</td>
<td>self</td>
<td>object</td>
<td>Convert to float</td>
</tr>
<tr class="row-odd"><td>__oct__</td>
<td>self</td>
<td>object</td>
<td>Convert to octal</td>
</tr>
<tr class="row-even"><td>__hex__</td>
<td>self</td>
<td>object</td>
<td>Convert to hexadecimal</td>
</tr>
<tr class="row-odd"><td>__index__ (2.5+ only)</td>
<td>self</td>
<td>object</td>
<td>Convert to sequence index</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="in-place-arithmetic-operators">
<h5>In-place arithmetic operators<a class="headerlink" href="#in-place-arithmetic-operators" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#emulating-numeric-types">https://docs.python.org/3/reference/datamodel.html#emulating-numeric-types</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__iadd__</td>
<td>self, x</td>
<td>object</td>
<td><cite>+=</cite> operator</td>
</tr>
<tr class="row-odd"><td>__isub__</td>
<td>self, x</td>
<td>object</td>
<td><cite>-=</cite> operator</td>
</tr>
<tr class="row-even"><td>__imul__</td>
<td>self, x</td>
<td>object</td>
<td><cite>*=</cite> operator</td>
</tr>
<tr class="row-odd"><td>__idiv__</td>
<td>self, x</td>
<td>object</td>
<td><cite>/=</cite> operator for old-style division</td>
</tr>
<tr class="row-even"><td>__ifloordiv__</td>
<td>self, x</td>
<td>object</td>
<td><cite>//=</cite> operator</td>
</tr>
<tr class="row-odd"><td>__itruediv__</td>
<td>self, x</td>
<td>object</td>
<td><cite>/=</cite> operator for new-style division</td>
</tr>
<tr class="row-even"><td>__imod__</td>
<td>self, x</td>
<td>object</td>
<td><cite>%=</cite> operator</td>
</tr>
<tr class="row-odd"><td>__ipow__</td>
<td>x, y, z</td>
<td>object</td>
<td><cite>**=</cite> operator</td>
</tr>
<tr class="row-even"><td>__ilshift__</td>
<td>self, x</td>
<td>object</td>
<td><cite>&lt;&lt;=</cite> operator</td>
</tr>
<tr class="row-odd"><td>__irshift__</td>
<td>self, x</td>
<td>object</td>
<td><cite>&gt;&gt;=</cite> operator</td>
</tr>
<tr class="row-even"><td>__iand__</td>
<td>self, x</td>
<td>object</td>
<td><cite>&amp;=</cite> operator</td>
</tr>
<tr class="row-odd"><td>__ior__</td>
<td>self, x</td>
<td>object</td>
<td><cite>|=</cite> operator</td>
</tr>
<tr class="row-even"><td>__ixor__</td>
<td>self, x</td>
<td>object</td>
<td><cite>^=</cite> operator</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="sequences-and-mappings">
<h5>Sequences and mappings<a class="headerlink" href="#sequences-and-mappings" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#emulating-container-types">https://docs.python.org/3/reference/datamodel.html#emulating-container-types</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__len__</td>
<td>self</td>
<td>Py_ssize_t</td>
<td>len(self)</td>
</tr>
<tr class="row-odd"><td>__getitem__</td>
<td>self, x</td>
<td>object</td>
<td>self[x]</td>
</tr>
<tr class="row-even"><td>__setitem__</td>
<td>self, x, y</td>
<td>&#160;</td>
<td>self[x] = y</td>
</tr>
<tr class="row-odd"><td>__delitem__</td>
<td>self, x</td>
<td>&#160;</td>
<td>del self[x]</td>
</tr>
<tr class="row-even"><td>__getslice__</td>
<td>self, Py_ssize_t i, Py_ssize_t j</td>
<td>object</td>
<td>self[i:j]</td>
</tr>
<tr class="row-odd"><td>__setslice__</td>
<td>self, Py_ssize_t i, Py_ssize_t j, x</td>
<td>&#160;</td>
<td>self[i:j] = x</td>
</tr>
<tr class="row-even"><td>__delslice__</td>
<td>self, Py_ssize_t i, Py_ssize_t j</td>
<td>&#160;</td>
<td>del self[i:j]</td>
</tr>
<tr class="row-odd"><td>__contains__</td>
<td>self, x</td>
<td>int</td>
<td>x in self</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="iterators">
<h5>Iterators<a class="headerlink" href="#iterators" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#emulating-container-types">https://docs.python.org/3/reference/datamodel.html#emulating-container-types</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__next__</td>
<td>self</td>
<td>object</td>
<td>Get next item (called next in Python)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="buffer-interface-pep-3118-no-python-equivalents-see-note-1">
<h5>Buffer interface [<span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-3118"><strong>PEP 3118</strong></a>] (no Python equivalents - see note 1)<a class="headerlink" href="#buffer-interface-pep-3118-no-python-equivalents-see-note-1" title="Permalink to this headline">¶</a></h5>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__getbuffer__</td>
<td>self, Py_buffer <cite>*view</cite>, int flags</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>__releasebuffer__</td>
<td>self, Py_buffer <cite>*view</cite></td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="buffer-interface-legacy-no-python-equivalents-see-note-1">
<h5>Buffer interface [legacy] (no Python equivalents - see note 1)<a class="headerlink" href="#buffer-interface-legacy-no-python-equivalents-see-note-1" title="Permalink to this headline">¶</a></h5>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__getreadbuffer__</td>
<td>self, Py_ssize_t i, void <cite>**p</cite></td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>__getwritebuffer__</td>
<td>self, Py_ssize_t i, void <cite>**p</cite></td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>__getsegcount__</td>
<td>self, Py_ssize_t <cite>*p</cite></td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>__getcharbuffer__</td>
<td>self, Py_ssize_t i, char <cite>**p</cite></td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="descriptor-objects-see-note-2">
<h5>Descriptor objects (see note 2)<a class="headerlink" href="#descriptor-objects-see-note-2" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#emulating-container-types">https://docs.python.org/3/reference/datamodel.html#emulating-container-types</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="30%" />
<col width="10%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Parameters</th>
<th class="head">Return type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>__get__</td>
<td>self, instance, class</td>
<td>object</td>
<td>Get value of attribute</td>
</tr>
<tr class="row-odd"><td>__set__</td>
<td>self, instance, value</td>
<td>&#160;</td>
<td>Set value of attribute</td>
</tr>
<tr class="row-even"><td>__delete__</td>
<td>self, instance</td>
<td>&#160;</td>
<td>Delete attribute</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">(1) The buffer interface was intended for use by C code and is not directly
accessible from Python. It is described in the Python/C API Reference Manual
of Python 2.x under sections 6.6 and 10.6. It was superseded by the new
<span class="target" id="index-1"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-3118"><strong>PEP 3118</strong></a> buffer protocol in Python 2.6 and is no longer available in Python 3.
For a how-to guide to the new API, see <a class="reference internal" href="index.html#buffer"><span class="std std-ref">Implementing the buffer protocol</span></a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">(2) Descriptor objects are part of the support mechanism for new-style
Python classes. See the discussion of descriptors in the Python documentation.
See also <span class="target" id="index-2"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0252"><strong>PEP 252</strong></a>, “Making Types Look More Like Classes”, and <span class="target" id="index-3"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0253"><strong>PEP 253</strong></a>,
“Subtyping Built-In Types”.</p>
</div>
</div>
</div>
</div>
<span id="document-src/userguide/sharing_declarations"></span><div class="section" id="sharing-declarations-between-cython-modules">
<span id="sharing-declarations"></span><h3>Sharing Declarations Between Cython Modules<a class="headerlink" href="#sharing-declarations-between-cython-modules" title="Permalink to this headline">¶</a></h3>
<p>This section describes how to make C declarations, functions and extension
types in one Cython module available for use in another Cython module.
These facilities are closely modeled on the Python import mechanism,
and can be thought of as a compile-time version of it.</p>
<div class="section" id="definition-and-implementation-files">
<h4>Definition and Implementation files<a class="headerlink" href="#definition-and-implementation-files" title="Permalink to this headline">¶</a></h4>
<p>A Cython module can be split into two parts: a definition file with a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code>
suffix, containing C declarations that are to be available to other Cython
modules, and an implementation file with a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> suffix, containing
everything else. When a module wants to use something declared in another
module’s definition file, it imports it using the <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a>
statement.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file that consists solely of extern declarations does not need
to correspond to an actual <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file or Python module. This can make it a
convenient place to put common declarations, for example declarations of
functions from  an <a class="reference internal" href="index.html#external-c-code"><span class="std std-ref">external library</span></a> that one
wants to use in several modules.</p>
</div>
<div class="section" id="what-a-definition-file-contains">
<h4>What a Definition File contains<a class="headerlink" href="#what-a-definition-file-contains" title="Permalink to this headline">¶</a></h4>
<p>A definition file can contain:</p>
<ul class="simple">
<li>Any kind of C type declaration.</li>
<li>extern C function or variable declarations.</li>
<li>Declarations of C functions defined in the module.</li>
<li>The definition part of an extension type (see below).</li>
</ul>
<p>It cannot contain the implementations of any C or Python functions, or any
Python class definitions, or any executable statements. It is needed when one
wants to  access <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> attributes and methods, or to inherit from
<a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> classes defined in this module.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You don’t need to (and shouldn’t) declare anything in a declaration file
public in order to make it available to other Cython modules; its mere
presence in a definition file does that. You only need a public
declaration if you want to make something available to external C code.</p>
</div>
</div>
<div class="section" id="what-an-implementation-file-contains">
<h4>What an Implementation File contains<a class="headerlink" href="#what-an-implementation-file-contains" title="Permalink to this headline">¶</a></h4>
<p>An implementation file can contain any kind of Cython statement, although there
are some restrictions on the implementation part of an extension type if the
corresponding definition file also defines that type (see below).
If one doesn’t need to <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> anything from this module, then this
is the only file one needs.</p>
</div>
<div class="section" id="the-cimport-statement">
<span id="cimport"></span><h4>The cimport statement<a class="headerlink" href="#the-cimport-statement" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> statement is used in a definition or
implementation file to gain access to names declared in another definition
file. Its syntax exactly parallels that of the normal Python import
statement:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">module</span> <span class="p">[,</span> <span class="n">module</span><span class="o">...</span><span class="p">]</span>

<span class="k">from</span> <span class="nn">module</span> <span class="k">cimport</span> <span class="n">name</span> <span class="p">[</span><span class="k">as</span> <span class="n">name</span><span class="p">]</span> <span class="p">[,</span> <span class="n">name</span> <span class="p">[</span><span class="k">as</span> <span class="n">name</span><span class="p">]</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>Here is an example. <code class="file docutils literal notranslate"><span class="pre">dishes.pxd</span></code> is a definition file which exports a
C data type. <code class="file docutils literal notranslate"><span class="pre">restaurant.pyx</span></code> is an implementation file which imports and
uses it.</p>
<p><code class="file docutils literal notranslate"><span class="pre">dishes.pxd</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">enum</span> <span class="nf">otherstuff</span><span class="p">:</span>
    <span class="n">sausage</span><span class="p">,</span> <span class="n">eggs</span><span class="p">,</span> <span class="n">lettuce</span>

<span class="k">cdef</span> <span class="k">struct</span> <span class="nf">spamdish</span><span class="p">:</span>
    <span class="nb">int</span> <span class="n">oz_of_spam</span>
    <span class="n">otherstuff</span> <span class="n">filler</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">restaurant.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="k">cimport</span> <span class="nn">dishes</span>
<span class="k">from</span> <span class="nn">dishes</span> <span class="k">cimport</span> <span class="n">spamdish</span>

<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">spamdish</span> <span class="o">*</span><span class="n">d</span><span class="p">):</span>
    <span class="n">d</span><span class="o">.</span><span class="n">oz_of_spam</span> <span class="o">=</span> <span class="mf">42</span>
    <span class="n">d</span><span class="o">.</span><span class="n">filler</span> <span class="o">=</span> <span class="n">dishes</span><span class="o">.</span><span class="n">sausage</span>

<span class="k">def</span> <span class="nf">serve</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">spamdish</span> <span class="nf">d</span>
    <span class="n">prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;{d.oz_of_spam} oz spam, filler no. {d.filler}&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It is important to understand that the <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> statement can only
be used to import C data types, C functions and variables, and extension
types. It cannot be used to import any Python objects, and (with one
exception) it doesn’t imply any Python import at run time. If you want to
refer to any Python names from a module that you have cimported, you will have
to include a regular import statement for it as well.</p>
<p>The exception is that when you use <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> to import an extension type, its
type object is imported at run time and made available by the name under which
you imported it. Using <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> to import extension types is covered in more
detail below.</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file changes, any modules that <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> from it may need to be
recompiled.  The <code class="docutils literal notranslate"><span class="pre">Cython.Build.cythonize</span></code> utility can take care of this for you.</p>
<div class="section" id="search-paths-for-definition-files">
<h5>Search paths for definition files<a class="headerlink" href="#search-paths-for-definition-files" title="Permalink to this headline">¶</a></h5>
<p>When you <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> a module called <code class="docutils literal notranslate"><span class="pre">modulename</span></code>, the Cython
compiler searches for a file called <code class="file docutils literal notranslate"><span class="pre">modulename.pxd</span></code>.
It searches for this file along the path for include files
(as specified by <code class="docutils literal notranslate"><span class="pre">-I</span></code> command line options or the <code class="docutils literal notranslate"><span class="pre">include_path</span></code>
option to <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code>), as well as <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">package_data</span></code> to install <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files in your <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script
allows other packages to cimport items from your module as a dependency.</p>
<p>Also, whenever you compile a file <code class="file docutils literal notranslate"><span class="pre">modulename.pyx</span></code>, the corresponding
definition file <code class="file docutils literal notranslate"><span class="pre">modulename.pxd</span></code> is first searched for along the
include path (but not <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>), and if found, it is processed before
processing the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file.</p>
</div>
<div class="section" id="using-cimport-to-resolve-naming-conflicts">
<h5>Using cimport to resolve naming conflicts<a class="headerlink" href="#using-cimport-to-resolve-naming-conflicts" title="Permalink to this headline">¶</a></h5>
<p>The <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> mechanism provides a clean and simple way to solve the
problem of wrapping external C functions with Python functions of the same
name. All you need to do is put the extern C declarations into a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file
for an imaginary module, and <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> that module. You can then
refer to the C functions by qualifying them with the name of the module.
Here’s an example:</p>
<p><code class="file docutils literal notranslate"><span class="pre">c_lunch.pxd</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;lunch.h&quot;</span><span class="p">:</span>
    <span class="n">void</span> <span class="n">eject_tomato</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">lunch.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">c_lunch</span>

<span class="k">def</span> <span class="nf">eject_tomato</span><span class="p">(</span><span class="nb">float</span> <span class="n">speed</span><span class="p">):</span>
    <span class="n">c_lunch</span><span class="o">.</span><span class="n">eject_tomato</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
</pre></div>
</div>
<p>You don’t need any <code class="file docutils literal notranslate"><span class="pre">c_lunch.pyx</span></code> file, because the only things defined
in <code class="file docutils literal notranslate"><span class="pre">c_lunch.pxd</span></code> are extern C entities. There won’t be any actual
<code class="docutils literal notranslate"><span class="pre">c_lunch</span></code> module at run time, but that doesn’t matter; the
<code class="file docutils literal notranslate"><span class="pre">c_lunch.pxd</span></code> file has done its job of providing an additional namespace
at compile time.</p>
</div>
</div>
<div class="section" id="sharing-c-functions">
<h4>Sharing C Functions<a class="headerlink" href="#sharing-c-functions" title="Permalink to this headline">¶</a></h4>
<p>C functions defined at the top level of a module can be made available via
<a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> by putting headers for them in the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file, for
example:</p>
<p><code class="file docutils literal notranslate"><span class="pre">volume.pxd</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">float</span> <span class="nf">cube</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">volume.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">float</span> <span class="nf">cube</span><span class="p">(</span><span class="nb">float</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">spammery.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">from</span> <span class="nn">volume</span> <span class="k">cimport</span> <span class="n">cube</span>

<span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="n">cube</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
          <span class="s">&quot;cubic metres of spam&quot;</span><span class="p">)</span>

<span class="n">menu</span><span class="p">(</span><span class="s">&quot;Entree&quot;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
<span class="n">menu</span><span class="p">(</span><span class="s">&quot;Main course&quot;</span><span class="p">,</span> <span class="mf">3</span><span class="p">)</span>
<span class="n">menu</span><span class="p">(</span><span class="s">&quot;Dessert&quot;</span><span class="p">,</span> <span class="mf">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When a module exports a C function in this way, an object appears in the
module dictionary under the function’s name. However, you can’t make use of
this object from Python, nor can you use it from Cython using a normal import
statement; you have to use <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a>.</p>
</div>
</div>
<div class="section" id="sharing-extension-types">
<span id="id1"></span><h4>Sharing Extension Types<a class="headerlink" href="#sharing-extension-types" title="Permalink to this headline">¶</a></h4>
<p>An extension type can be made available via <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> by splitting
its definition into two parts, one in a definition file and the other in the
corresponding implementation file.</p>
<p>The definition part of the extension type can only declare C attributes and C
methods, not Python methods, and it must declare all of that type’s C
attributes and C methods.</p>
<p>The implementation part must implement all of the C methods declared in the
definition part, and may not add any further C attributes. It may also define
Python methods.</p>
<p>Here is an example of a module which defines and exports an extension type,
and another module which uses it:</p>
<p><code class="file docutils literal notranslate"><span class="pre">shrubbing.pxd</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Shrubbery</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">width</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">length</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">shrubbing.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Shrubbery</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">w</span><span class="p">,</span> <span class="nb">int</span> <span class="n">l</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">l</span>

<span class="k">def</span> <span class="nf">standard_shrubbery</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Shrubbery</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span> <span class="mf">7</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">landscaping.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">shrubbing</span>
<span class="k">import</span> <span class="nn">shrubbing</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">shrubbing</span>.<span class="kt">Shrubbery</span> <span class="nf">sh</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">shrubbing</span><span class="o">.</span><span class="n">standard_shrubbery</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Shrubbery size is&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">sh</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
</pre></div>
</div>
<p>One would then need to compile both of these modules, e.g. using</p>
<p><code class="file docutils literal notranslate"><span class="pre">setup.py</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">([</span><span class="s">&quot;landscaping.pyx&quot;</span><span class="p">,</span> <span class="s">&quot;shrubbing.pyx&quot;</span><span class="p">]))</span>
</pre></div>
</div>
<p>Some things to note about this example:</p>
<ul class="simple">
<li>There is a <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> class Shrubbery declaration in both
<code class="file docutils literal notranslate"><span class="pre">Shrubbing.pxd</span></code> and <code class="file docutils literal notranslate"><span class="pre">Shrubbing.pyx</span></code>. When the Shrubbing module
is compiled, these two declarations are combined into one.</li>
<li>In Landscaping.pyx, the <a class="reference internal" href="#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> Shrubbing declaration allows us
to refer to the Shrubbery type as <code class="xref py py-class docutils literal notranslate"><span class="pre">Shrubbing.Shrubbery</span></code>. But it
doesn’t bind the name Shrubbing in Landscaping’s module namespace at run
time, so to access <code class="xref py py-func docutils literal notranslate"><span class="pre">Shrubbing.standard_shrubbery()</span></code> we also need to
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">Shrubbing</span></code>.</li>
<li>One caveat if you use setuptools instead of distutils, the default
action when running <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code> is to create a zipped
<code class="docutils literal notranslate"><span class="pre">egg</span></code> file which will not work with <code class="docutils literal notranslate"><span class="pre">cimport</span></code> for <code class="docutils literal notranslate"><span class="pre">pxd</span></code> files
when you try to use them from a dependent package.
To prevent this, include <code class="docutils literal notranslate"><span class="pre">zip_safe=False</span></code> in the arguments to <code class="docutils literal notranslate"><span class="pre">setup()</span></code>.</li>
</ul>
</div>
</div>
<span id="document-src/userguide/external_C_code"></span><div class="section" id="interfacing-with-external-c-code">
<span id="external-c-code"></span><h3>Interfacing with External C Code<a class="headerlink" href="#interfacing-with-external-c-code" title="Permalink to this headline">¶</a></h3>
<p>One of the main uses of Cython is wrapping existing libraries of C code. This
is achieved by using external declarations to declare the C functions and
variables from the library that you want to use.</p>
<p>You can also use public declarations to make C functions and variables defined
in a Cython module available to external C code. The need for this is expected
to be less frequent, but you might want to do it, for example, if you are
<a class="reference external" href="http://www.freenet.org.nz/python/embeddingpyrex/">embedding Python</a> in another application as a scripting language. Just as a
Cython module can be used as a bridge to allow Python code to call C code, it
can also be used to allow C code to call Python code.</p>
<div class="section" id="external-declarations">
<h4>External declarations<a class="headerlink" href="#external-declarations" title="Permalink to this headline">¶</a></h4>
<p>By default, C functions and variables declared at the module level are local
to the module (i.e. they have the C static storage class). They can also be
declared extern to specify that they are defined elsewhere, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="kt">int</span> <span class="nf">spam_counter</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="kt">void</span> <span class="nf">order_spam</span><span class="p">(</span><span class="nb">int</span> <span class="n">tons</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="referencing-c-header-files">
<h5>Referencing C header files<a class="headerlink" href="#referencing-c-header-files" title="Permalink to this headline">¶</a></h5>
<p>When you use an extern definition on its own as in the examples above, Cython
includes a declaration for it in the generated C file. This can cause problems
if the declaration doesn’t exactly match the declaration that will be seen by
other C code. If you’re wrapping an existing C library, for example, it’s
important that the generated C code is compiled with exactly the same
declarations as the rest of the library.</p>
<p>To achieve this, you can tell Cython that the declarations are to be found in a
C header file, like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;spam.h&quot;</span><span class="p">:</span>

    <span class="nb">int</span> <span class="n">spam_counter</span>

    <span class="n">void</span> <span class="n">order_spam</span><span class="p">(</span><span class="nb">int</span> <span class="n">tons</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span></code> from clause does three things:</p>
<ol class="arabic simple">
<li>It directs Cython to place a <code class="docutils literal notranslate"><span class="pre">#include</span></code> statement for the named header file in
the generated C code.</li>
<li>It prevents Cython from generating any C code
for the declarations found in the associated block.</li>
<li>It treats all declarations within the block as though they started with
<code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span></code>.</li>
</ol>
<p>It’s important to understand that Cython does not itself read the C header
file, so you still need to provide Cython versions of any declarations from it
that you use. However, the Cython declarations don’t always have to exactly
match the C ones, and in some cases they shouldn’t or can’t. In particular:</p>
<ol class="arabic">
<li><p class="first">Leave out any platform-specific extensions to C declarations such as
<code class="docutils literal notranslate"><span class="pre">__declspec()</span></code>.</p>
</li>
<li><p class="first">If the header file declares a big struct and you only want to use a few
members, you only need to declare the members you’re interested in. Leaving
the rest out doesn’t do any harm, because the C compiler will use the full
definition from the header file.</p>
<p>In some cases, you might not need any of the struct’s members, in which
case you can just put pass in the body of the struct declaration, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;foo.h&quot;</span><span class="p">:</span>
    <span class="k">struct</span> <span class="nc">spam</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">you can only do this inside a <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code> block; struct
declarations anywhere else must be non-empty.</p>
</div>
</li>
<li><p class="first">If the header file uses <code class="docutils literal notranslate"><span class="pre">typedef</span></code> names such as <code class="xref c c-type docutils literal notranslate"><span class="pre">word</span></code> to refer
to platform-dependent flavours of numeric types, you will need a
corresponding <a class="reference internal" href="index.html#ctypedef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">ctypedef</span></code></a> statement, but you don’t need to match
the type exactly, just use something of the right general kind (int, float,
etc). For example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="nb">int</span> <span class="n">word</span>
</pre></div>
</div>
<p>will work okay whatever the actual size of a <code class="xref c c-type docutils literal notranslate"><span class="pre">word</span></code> is (provided the header
file defines it correctly). Conversion to and from Python types, if any, will also
be used for this new type.</p>
</li>
<li><p class="first">If the header file uses macros to define constants, translate them into a
normal external variable declaration.  You can also declare them as an
<a class="reference internal" href="index.html#enum"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">enum</span></code></a> if they contain normal <code class="xref c c-type docutils literal notranslate"><span class="pre">int</span></code> values.  Note that
Cython considers <a class="reference internal" href="index.html#enum"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">enum</span></code></a> to be equivalent to <code class="xref c c-type docutils literal notranslate"><span class="pre">int</span></code>, so do
not do this for non-int values.</p>
</li>
<li><p class="first">If the header file defines a function using a macro, declare it as though
it were an ordinary function, with appropriate argument and result types.</p>
</li>
<li><p class="first">For archaic reasons C uses the keyword <code class="docutils literal notranslate"><span class="pre">void</span></code> to declare a function
taking no parameters. In Cython as in Python, simply declare such functions
as <code class="xref py py-meth docutils literal notranslate"><span class="pre">foo()</span></code>.</p>
</li>
</ol>
<p>A few more tricks and tips:</p>
<ul>
<li><p class="first">If you want to include a C header because it’s needed by another header, but
don’t want to use any declarations from it, put pass in the extern-from
block:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;spam.h&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</li>
<li><p class="first">If you want to include a system header, put angle brackets inside the quotes:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;&lt;sysheader.h&gt;&quot;</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p class="first">If you want to include some external declarations, but don’t want to specify
a header file (because it’s included by some other header that you’ve
already included) you can put <code class="docutils literal notranslate"><span class="pre">*</span></code> in place of the header file name:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="o">*</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p class="first">If a <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span> <span class="pre">&quot;inc.h&quot;</span></code> block is not empty and contains only
function or variable declarations (and no type declarations of any kind),
Cython will put the <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&quot;inc.h&quot;</span></code> statement after all
declarations generated by Cython. This means that the included file
has access to the variables, functions, structures, … which are
declared by Cython.</p>
</li>
</ul>
</div>
<div class="section" id="implementing-functions-in-c">
<h5>Implementing functions in C<a class="headerlink" href="#implementing-functions-in-c" title="Permalink to this headline">¶</a></h5>
<p>When you want to call C code from a Cython module, usually that code
will be in some external library that you link your extension against.
However, you can also directly compile C (or C++) code as part of your
Cython module. In the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file, you can put something like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;spam.c&quot;</span><span class="p">:</span>
    <span class="n">void</span> <span class="n">order_spam</span><span class="p">(</span><span class="nb">int</span> <span class="n">tons</span><span class="p">)</span>
</pre></div>
</div>
<p>Cython will assume that the function <code class="docutils literal notranslate"><span class="pre">order_spam()</span></code> is defined in the
file <code class="docutils literal notranslate"><span class="pre">spam.c</span></code>. If you also want to cimport this function from another
module, it must be declared (not extern!) in the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">void</span> <span class="nf">order_spam</span><span class="p">(</span><span class="nb">int</span> <span class="n">tons</span><span class="p">)</span>
</pre></div>
</div>
<p>For this to work, the signature of <code class="docutils literal notranslate"><span class="pre">order_spam()</span></code> in <code class="docutils literal notranslate"><span class="pre">spam.c</span></code> must
match the signature that Cython uses, in particular the function must
be static:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">order_spam</span><span class="p">(</span><span class="kt">int</span> <span class="n">tons</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Ordered %i tons of spam!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tons</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="styles-of-struct-union-and-enum-declaration">
<span id="struct-union-enum-styles"></span><h5>Styles of struct, union and enum declaration<a class="headerlink" href="#styles-of-struct-union-and-enum-declaration" title="Permalink to this headline">¶</a></h5>
<p>There are two main ways that structs, unions and enums can be declared in C
header files: using a tag name, or using a typedef. There are also some
variations based on various combinations of these.</p>
<p>It’s important to make the Cython declarations match the style used in the
header file, so that Cython can emit the right sort of references to the type
in the code it generates. To make this possible, Cython provides two different
syntaxes for declaring a struct, union or enum type. The style introduced
above corresponds to the use of a tag name. To get the other style, you prefix
the declaration with <a class="reference internal" href="index.html#ctypedef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">ctypedef</span></code></a>, as illustrated below.</p>
<p>The following table shows the various possible styles that can be found in a
header file, and the corresponding Cython declaration that you should put in
the <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span></code> from block. Struct declarations are used as an example; the
same applies equally to union and enum declarations.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="32%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">C code</th>
<th class="head">Possibilities for corresponding Cython Code</th>
<th class="head">Comments</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">Foo</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
</td>
<td><div class="first last highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">struct</span> <span class="nf">Foo</span><span class="p">:</span>
  <span class="o">...</span>
</pre></div>
</div>
</td>
<td>Cython will refer to the as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">Foo</span></code> in the generated C code.</td>
</tr>
<tr class="row-odd"><td><div class="first last highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">Foo</span><span class="p">;</span>
</pre></div>
</div>
</td>
<td><div class="first last highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="k">struct</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="o">...</span>
</pre></div>
</div>
</td>
<td>Cython will refer to the type simply as <code class="docutils literal notranslate"><span class="pre">Foo</span></code> in
the generated C code.</td>
</tr>
<tr class="row-even"><td><div class="first last highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">foo</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">Foo</span><span class="p">;</span>
</pre></div>
</div>
</td>
<td><div class="first highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">struct</span> <span class="nf">foo</span><span class="p">:</span>
  <span class="o">...</span>
<span class="k">ctypedef</span> <span class="n">foo</span> <span class="n">Foo</span> <span class="c">#optional</span>
</pre></div>
</div>
<p>or:</p>
<div class="last highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="k">struct</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="o">...</span>
</pre></div>
</div>
</td>
<td>If the C header uses both a tag and a typedef with <em>different</em>
names, you can use either form of declaration in Cython
(although if you need to forward reference the type,
you’ll have to use the first form).</td>
</tr>
<tr class="row-odd"><td><div class="first last highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Foo</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">Foo</span><span class="p">;</span>
</pre></div>
</div>
</td>
<td><div class="first last highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">struct</span> <span class="nf">Foo</span><span class="p">:</span>
  <span class="o">...</span>
</pre></div>
</div>
</td>
<td>If the header uses the <em>same</em> name for the tag and typedef, you
won’t be able to include a <a class="reference internal" href="index.html#ctypedef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">ctypedef</span></code></a> for it – but then,
it’s not necessary.</td>
</tr>
</tbody>
</table>
<p>See also use of <a class="reference internal" href="index.html#external-extension-types"><span class="std std-ref">External extension types</span></a>.
Note that in all the cases below, you refer to the type in Cython code simply
as <code class="xref c c-type docutils literal notranslate"><span class="pre">Foo</span></code>, not <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">Foo</span></code>.</p>
</div>
<div class="section" id="accessing-python-c-api-routines">
<h5>Accessing Python/C API routines<a class="headerlink" href="#accessing-python-c-api-routines" title="Permalink to this headline">¶</a></h5>
<p>One particular use of the <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code> statement is for gaining access to
routines in the Python/C API. For example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Python.h&quot;</span><span class="p">:</span>

    <span class="nb">object</span> <span class="n">PyString_FromStringAndSize</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="nb">len</span><span class="p">)</span>
</pre></div>
</div>
<p>will allow you to create Python strings containing null bytes.</p>
</div>
<div class="section" id="special-types">
<h5>Special Types<a class="headerlink" href="#special-types" title="Permalink to this headline">¶</a></h5>
<p>Cython predefines the name <code class="docutils literal notranslate"><span class="pre">Py_ssize_t</span></code> for use with Python/C API routines. To
make your extensions compatible with 64-bit systems, you should always use
this type where it is specified in the documentation of Python/C API routines.</p>
</div>
<div class="section" id="windows-calling-conventions">
<h5>Windows Calling Conventions<a class="headerlink" href="#windows-calling-conventions" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">__stdcall</span></code> and <code class="docutils literal notranslate"><span class="pre">__cdecl</span></code> calling convention specifiers can be used in
Cython, with the same syntax as used by C compilers on Windows, for example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="kt">int</span> <span class="kt">__stdcall</span> <span class="nf">FrobnicateWindow</span><span class="p">(</span><span class="nb">long</span> <span class="n">handle</span><span class="p">)</span>

<span class="k">cdef</span> <span class="nf">void</span> <span class="p">(</span><span class="n">__stdcall</span> <span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">__stdcall</span></code> is used, the function is only considered compatible with
other <code class="docutils literal notranslate"><span class="pre">__stdcall</span></code> functions of the same signature.</p>
</div>
<div class="section" id="resolving-naming-conflicts-c-name-specifications">
<span id="resolve-conflicts"></span><h5>Resolving naming conflicts - C name specifications<a class="headerlink" href="#resolving-naming-conflicts-c-name-specifications" title="Permalink to this headline">¶</a></h5>
<p>Each Cython module has a single module-level namespace for both Python and C
names.  This can be inconvenient if you want to wrap some external C functions
and provide the Python user with Python functions of the same names.</p>
<p>Cython provides a couple of different ways of solving this problem.  The best
way, especially if you have many C functions to wrap, is to put the extern
C function declarations into a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file and thus a different namespace,
using the facilities described in <a class="reference internal" href="index.html#sharing-declarations"><span class="std std-ref">sharing declarations between Cython
modules</span></a>.  Writing them into a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file allows
their reuse across modules, avoids naming collisions in the normal Python way
and even makes it easy to rename them on cimport.  For example, if your
<code class="docutils literal notranslate"><span class="pre">decl.pxd</span></code> file declared a C function <code class="docutils literal notranslate"><span class="pre">eject_tomato</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;myheader.h&quot;</span><span class="p">:</span>
    <span class="n">void</span> <span class="n">eject_tomato</span><span class="p">(</span><span class="nb">float</span> <span class="n">speed</span><span class="p">)</span>
</pre></div>
</div>
<p>then you can cimport and wrap it in a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">decl</span> <span class="k">cimport</span> <span class="n">eject_tomato</span> <span class="k">as</span> <span class="n">c_eject_tomato</span>

<span class="k">def</span> <span class="nf">eject_tomato</span><span class="p">(</span><span class="n">speed</span><span class="p">):</span>
    <span class="n">c_eject_tomato</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
</pre></div>
</div>
<p>or simply cimport the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file and use it as prefix:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">decl</span>

<span class="k">def</span> <span class="nf">eject_tomato</span><span class="p">(</span><span class="n">speed</span><span class="p">):</span>
    <span class="n">decl</span><span class="o">.</span><span class="n">eject_tomato</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this has no runtime lookup overhead, as it would in Python.
Cython resolves the names in the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file at compile time.</p>
<p>For special cases where namespacing or renaming on import is not enough,
e.g. when a name in C conflicts with a Python keyword, you can use a C name
specification to give different Cython and C names to the C function at
declaration time.  Suppose, for example, that you want to wrap an external
C function called <code class="xref py py-func docutils literal notranslate"><span class="pre">yield()</span></code>.  If you declare it as:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;myheader.h&quot;</span><span class="p">:</span>
    <span class="n">void</span> <span class="n">c_yield</span> <span class="s">&quot;yield&quot;</span> <span class="p">(</span><span class="nb">float</span> <span class="n">speed</span><span class="p">)</span>
</pre></div>
</div>
<p>then its Cython visible name will be <code class="docutils literal notranslate"><span class="pre">c_yield</span></code>, whereas its name in C
will be <code class="docutils literal notranslate"><span class="pre">yield</span></code>.  You can then wrap it with:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">call_yield</span><span class="p">(</span><span class="n">speed</span><span class="p">):</span>
    <span class="n">c_yield</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
</pre></div>
</div>
<p>As for functions, C names can be specified for variables, structs, unions,
enums, struct and union members, and enum values.  For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="kt">int</span> <span class="kt">one</span> <span class="s">&quot;eins&quot;</span><span class="p">,</span> <span class="n">two</span> <span class="s">&quot;zwei&quot;</span>
<span class="k">cdef</span> <span class="kr">extern</span> <span class="kt">float</span> <span class="kt">three</span> <span class="s">&quot;drei&quot;</span>

<span class="k">cdef</span> <span class="k">struct</span> <span class="kt">spam</span> <span class="s">&quot;SPAM&quot;</span><span class="p">:</span>
    <span class="nb">int</span> <span class="n">i</span> <span class="s">&quot;eye&quot;</span>

<span class="k">cdef</span> <span class="k">enum</span> <span class="kt">surprise</span> <span class="s">&quot;inquisition&quot;</span><span class="p">:</span>
    <span class="n">first</span> <span class="s">&quot;alpha&quot;</span>
    <span class="n">second</span> <span class="s">&quot;beta&quot;</span> <span class="o">=</span> <span class="mf">3</span>
</pre></div>
</div>
<p>Note that Cython will not do any validation or name mangling on the string
you provide.  It will inject the bare text into the C code unmodified, so you
are entirely on your own with this feature.  If you want to declare a name
<code class="docutils literal notranslate"><span class="pre">xyz</span></code> and have Cython inject the text “make the C compiler fail here” into
the C file for it, you can do this using a C name declaration.  Consider this
an advanced feature, only for the rare cases where everything else fails.</p>
</div>
<div class="section" id="including-verbatim-c-code">
<h5>Including verbatim C code<a class="headerlink" href="#including-verbatim-c-code" title="Permalink to this headline">¶</a></h5>
<p>For advanced use cases, Cython allows you to directly write C code
as “docstring” of a <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code> block:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="o">*</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    /* This is C code which will be put</span>
<span class="sd">     * in the .c file output by Cython */</span>
<span class="sd">    static long square(long x) {return x * x;}</span>
<span class="sd">    #define assign(x, y) ((x) = (y))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">long</span> <span class="n">square</span><span class="p">(</span><span class="nb">long</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">void</span> <span class="n">assign</span><span class="p">(</span><span class="nb">long</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span> <span class="nb">long</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>The above is essentially equivalent to having the C code in a file
<code class="docutils literal notranslate"><span class="pre">header.h</span></code> and writing</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;header.h&quot;</span><span class="p">:</span>
    <span class="nb">long</span> <span class="n">square</span><span class="p">(</span><span class="nb">long</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">void</span> <span class="n">assign</span><span class="p">(</span><span class="nb">long</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span> <span class="nb">long</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>It is also possible to combine a header file and verbatim C code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;badheader.h&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    /* This macro breaks stuff */</span>
<span class="sd">    #undef int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Stuff from badheader.h</span>
</pre></div>
</div>
<p>In this case, the C code <code class="docutils literal notranslate"><span class="pre">#undef</span> <span class="pre">int</span></code> is put right after
<code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&quot;badheader.h&quot;</span></code> in the C code generated by Cython.</p>
<p>Note that the string is parsed like any other docstring in Python.
If you require character escapes to be passed into the C code file,
use a raw docstring, i.e. <code class="docutils literal notranslate"><span class="pre">r&quot;&quot;&quot;</span> <span class="pre">...</span> <span class="pre">&quot;&quot;&quot;</span></code>.</p>
</div>
</div>
<div class="section" id="using-cython-declarations-from-c">
<h4>Using Cython Declarations from C<a class="headerlink" href="#using-cython-declarations-from-c" title="Permalink to this headline">¶</a></h4>
<p>Cython provides two methods for making C declarations from a Cython module
available for use by external C code—public declarations and C API
declarations.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You do not need to use either of these to make declarations from one
Cython module available to another Cython module – you should use the
<a class="reference internal" href="index.html#cimport"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cimport</span></code></a> statement for that. Sharing Declarations Between Cython Modules.</p>
</div>
<div class="section" id="public-declarations">
<h5>Public Declarations<a class="headerlink" href="#public-declarations" title="Permalink to this headline">¶</a></h5>
<p>You can make C types, variables and functions defined in a Cython module
accessible to C code that is linked together with the Cython-generated C file,
by declaring them with the public keyword:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">public</span> <span class="k">struct</span> <span class="nf">Bunny</span><span class="p">:</span> <span class="c"># public type declaration</span>
    <span class="nb">int</span> <span class="n">vorpalness</span>

<span class="k">cdef</span> <span class="kr">public</span> <span class="kt">int</span> <span class="nf">spam</span> <span class="c"># public variable declaration</span>

<span class="k">cdef</span> <span class="kr">public</span> <span class="kt">void</span> <span class="nf">grail</span><span class="p">(</span><span class="n">Bunny</span> <span class="o">*</span><span class="p">)</span> <span class="c"># public function declaration</span>
</pre></div>
</div>
<p>If there are any public declarations in a Cython module, a header file called
<code class="file docutils literal notranslate"><span class="pre">modulename.h</span></code> file is generated containing equivalent C declarations for
inclusion in other C code.</p>
<p>A typical use case for this is building an extension module from multiple
C sources, one of them being Cython generated (i.e. with something like
<code class="docutils literal notranslate"><span class="pre">Extension(&quot;grail&quot;,</span> <span class="pre">sources=[&quot;grail.pyx&quot;,</span> <span class="pre">&quot;grail_helper.c&quot;])</span></code> in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>.
In this case, the file <code class="docutils literal notranslate"><span class="pre">grail_helper.c</span></code> just needs to add
<code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&quot;grail.h&quot;</span></code> in order to access the public Cython variables.</p>
<p>A more advanced use case is embedding Python in C using Cython.
In this case, make sure to call Py_Initialize() and Py_Finalize().
For example, in the following snippet that includes <code class="file docutils literal notranslate"><span class="pre">grail.h</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;grail.h&quot;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Py_Initialize</span><span class="p">();</span>
    <span class="n">initgrail</span><span class="p">();</span>  <span class="cm">/* Python 2.x only ! */</span>
    <span class="n">Bunny</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">grail</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">Py_Finalize</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This C code can then be built together with the Cython-generated C code
in a single program (or library).</p>
<p>In Python 3.x, calling the module init function directly should be avoided.  Instead,
use the <a class="reference external" href="https://docs.python.org/3/c-api/import.html#c._inittab">inittab mechanism</a>
to link Cython modules into a single shared library or program.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">err</span> <span class="o">=</span> <span class="n">PyImport_AppendInittab</span><span class="p">(</span><span class="s">&quot;grail&quot;</span><span class="p">,</span> <span class="n">PyInit_grail</span><span class="p">);</span>
<span class="n">Py_Initialize</span><span class="p">();</span>
<span class="n">grail_module</span> <span class="o">=</span> <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">&quot;grail&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>If the Cython module resides within a package, then the name of the <code class="docutils literal notranslate"><span class="pre">.h</span></code>
file consists of the full dotted name of the module, e.g. a module called
<code class="xref py py-mod docutils literal notranslate"><span class="pre">foo.spam</span></code> would have a header file called <code class="file docutils literal notranslate"><span class="pre">foo.spam.h</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">On some operating systems like Linux, it is also possible to first
build the Cython extension in the usual way and then link against
the resulting <code class="docutils literal notranslate"><span class="pre">.so</span></code> file like a dynamic library.
Beware that this is not portable, so it should be avoided.</p>
</div>
</div>
<div class="section" id="c-api-declarations">
<span id="api"></span><h5>C API Declarations<a class="headerlink" href="#c-api-declarations" title="Permalink to this headline">¶</a></h5>
<p>The other way of making declarations available to C code is to declare them
with the <a class="reference internal" href="#api"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">api</span></code></a> keyword. You can use this keyword with C functions and
extension types. A header file called <code class="file docutils literal notranslate"><span class="pre">modulename_api.h</span></code> is produced
containing declarations of the functions and extension types, and a function
called <code class="xref py py-func docutils literal notranslate"><span class="pre">import_modulename()</span></code>.</p>
<p>C code wanting to use these functions or extension types needs to include the
header and call the <code class="xref py py-func docutils literal notranslate"><span class="pre">import_modulename()</span></code> function. The other functions
can then be called and the extension types used as usual.</p>
<p>If the C code wanting to use these functions is part of more than one shared
library or executable, then <code class="xref py py-func docutils literal notranslate"><span class="pre">import_modulename()</span></code> function needs to be
called in each of the shared libraries which use these functions. If you
crash with a segmentation fault (SIGSEGV on linux) when calling into one of
these api calls, this is likely an indication that the shared library which
contains the api call which is generating the segmentation fault does not call
the <code class="xref py py-func docutils literal notranslate"><span class="pre">import_modulename()</span></code> function before the api call which crashes.</p>
<p>Any public C type or extension type declarations in the Cython module are also
made available when you include <code class="file docutils literal notranslate"><span class="pre">modulename_api.h</span></code>.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># delorean.pyx</span>

<span class="k">cdef</span> <span class="kr">public</span> <span class="k">struct</span> <span class="nf">Vehicle</span><span class="p">:</span>
    <span class="nb">int</span> <span class="n">speed</span>
    <span class="nb">float</span> <span class="n">power</span>

<span class="k">cdef</span> <span class="kr">api</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">(</span><span class="n">Vehicle</span> <span class="o">*</span><span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="mf">88</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">power</span> <span class="o">&gt;=</span> <span class="mf">1.21</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Time travel achieved&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp"># marty.c</span>
<span class="cp">#include</span> <span class="cpf">&quot;delorean_api.h&quot;</span><span class="cp"></span>

<span class="n">Vehicle</span> <span class="n">car</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
	<span class="n">Py_Initialize</span><span class="p">();</span>
	<span class="n">import_delorean</span><span class="p">();</span>
	<span class="n">car</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">car</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">activate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">car</span><span class="p">);</span>
	<span class="n">Py_Finalize</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Any types defined in the Cython module that are used as argument or
return types of the exported functions will need to be declared public,
otherwise they won’t be included in the generated header file, and you will
get errors when you try to compile a C file that uses the header.</p>
</div>
<p>Using the <a class="reference internal" href="#api"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">api</span></code></a> method does not require the C code using the
declarations to be linked with the extension module in any way, as the Python
import machinery is used to make the connection dynamically. However, only
functions can be accessed this way, not variables. Note also that for the
module import mechanism to be set up correctly, the user must call
Py_Initialize() and Py_Finalize(); if you experience a segmentation fault in
the call to <code class="xref py py-func docutils literal notranslate"><span class="pre">import_modulename()</span></code>, it is likely that this wasn’t done.</p>
<p>You can use both <a class="reference internal" href="index.html#public"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">public</span></code></a> and <a class="reference internal" href="#api"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">api</span></code></a> on the same function to
make it available by both methods, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">public</span> <span class="kr">api</span> <span class="kt">void</span> <span class="nf">belt_and_braces</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>However, note that you should include either <code class="file docutils literal notranslate"><span class="pre">modulename.h</span></code> or
<code class="file docutils literal notranslate"><span class="pre">modulename_api.h</span></code> in a given C file, not both, otherwise you may get
conflicting dual definitions.</p>
<p>If the Cython module resides within a package, then:</p>
<ul class="simple">
<li>The name of the header file contains of the full dotted name of the module.</li>
<li>The name of the importing function contains the full name with dots replaced
by double underscores.</li>
</ul>
<p>E.g. a module called <code class="xref py py-mod docutils literal notranslate"><span class="pre">foo.spam</span></code> would have an API header file called
<code class="file docutils literal notranslate"><span class="pre">foo.spam_api.h</span></code> and an importing function called
<code class="xref py py-func docutils literal notranslate"><span class="pre">import_foo__spam()</span></code>.</p>
</div>
<div class="section" id="multiple-public-and-api-declarations">
<h5>Multiple public and API declarations<a class="headerlink" href="#multiple-public-and-api-declarations" title="Permalink to this headline">¶</a></h5>
<p>You can declare a whole group of items as <a class="reference internal" href="index.html#public"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">public</span></code></a> and/or
<a class="reference internal" href="#api"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">api</span></code></a> all at once by enclosing them in a <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> block, for
example,:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">public</span> <span class="kr">api</span><span class="p">:</span>
    <span class="n">void</span> <span class="n">order_spam</span><span class="p">(</span><span class="nb">int</span> <span class="n">tons</span><span class="p">)</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">get_lunch</span><span class="p">(</span><span class="nb">float</span> <span class="n">tomato_size</span><span class="p">)</span>
</pre></div>
</div>
<p>This can be a useful thing to do in a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file (see
<a class="reference internal" href="index.html#sharing-declarations"><span class="std std-ref">Sharing Declarations Between Cython Modules</span></a>) to make the module’s public interface
available by all three methods.</p>
</div>
<div class="section" id="acquiring-and-releasing-the-gil">
<h5>Acquiring and Releasing the GIL<a class="headerlink" href="#acquiring-and-releasing-the-gil" title="Permalink to this headline">¶</a></h5>
<p>Cython provides facilities for acquiring and releasing the
<a class="reference external" href="https://docs.python.org/dev/glossary.html#term-global-interpreter-lock">Global Interpreter Lock (GIL)</a>.
This may be useful when calling from multi-threaded code into
(external C) code that may block, or when wanting to use Python
from a (native) C thread callback.  Releasing the GIL should
obviously only be done for thread-safe code or for code that
uses other means of protection against race conditions and
concurrency issues.</p>
<p>Note that acquiring the GIL is a blocking thread-synchronising
operation, and therefore potentially costly.  It might not be
worth releasing the GIL for minor calculations.  Usually, I/O
operations and substantial computations in parallel code will
benefit from it.</p>
<div class="section" id="releasing-the-gil">
<span id="nogil"></span><h6>Releasing the GIL<a class="headerlink" href="#releasing-the-gil" title="Permalink to this headline">¶</a></h6>
<p>You can release the GIL around a section of code using the
<code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">nogil</span></code> statement:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">code</span> <span class="n">to</span> <span class="n">be</span> <span class="n">executed</span> <span class="k">with</span> <span class="n">the</span> <span class="n">GIL</span> <span class="n">released</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Code in the body of the with-statement must not raise exceptions or
manipulate Python objects in any way, and must not call anything that
manipulates Python objects without first re-acquiring the GIL.  Cython
validates these operations at compile time, but cannot look into
external C functions, for example.  They must be correctly declared
as requiring or not requiring the GIL (see below) in order to make
Cython’s checks effective.</p>
</div>
<div class="section" id="acquiring-the-gil">
<span id="gil"></span><h6>Acquiring the GIL<a class="headerlink" href="#acquiring-the-gil" title="Permalink to this headline">¶</a></h6>
<p>A C function that is to be used as a callback from C code that is executed
without the GIL needs to acquire the GIL before it can manipulate Python
objects. This can be done by specifying <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil</span></code> in the function
header:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">void</span> <span class="nf">my_callback</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="k">with</span> <span class="k">gil</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>If the callback may be called from another non-Python thread,
care must be taken to initialize the GIL first, through a call to
<a class="reference external" href="https://docs.python.org/dev/c-api/init.html#c.PyEval_InitThreads">PyEval_InitThreads()</a>.
If you’re already using  <a class="reference internal" href="index.html#parallel"><span class="std std-ref">cython.parallel</span></a> in your module, this will already have been taken care of.</p>
<p>The GIL may also be acquired through the <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil</span></code> statement:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="k">gil</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">execute</span> <span class="n">this</span> <span class="n">block</span> <span class="k">with</span> <span class="n">the</span> <span class="n">GIL</span> <span class="n">acquired</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="conditional-acquiring-releasing-the-gil">
<span id="gil-conditional"></span><h6>Conditional Acquiring / Releasing the GIL<a class="headerlink" href="#conditional-acquiring-releasing-the-gil" title="Permalink to this headline">¶</a></h6>
<p>Sometimes it is helpful to use a condition to decide whether to run a
certain piece of code with or without the GIL. This code would run anyway,
the difference is whether the GIL will be held or released.
The condition must be constant (at compile time).</p>
<p>This could be useful for profiling, debugging, performance testing, and
for fused types (see <a class="reference internal" href="index.html#fused-gil-conditional"><span class="std std-ref">Conditional GIL Acquiring / Releasing</span></a>).:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="cp">DEF</span> <span class="n">FREE_GIL</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">with</span> <span class="k">nogil</span><span class="p">(</span><span class="n">FREE_GIL</span><span class="p">):</span>
    <span class="o">&lt;</span><span class="n">code</span> <span class="n">to</span> <span class="n">be</span> <span class="n">executed</span> <span class="k">with</span> <span class="n">the</span> <span class="n">GIL</span> <span class="n">released</span><span class="o">&gt;</span>

    <span class="k">with</span> <span class="k">gil</span><span class="p">(</span><span class="bp">False</span><span class="p">):</span>
       <span class="o">&lt;</span><span class="n">GIL</span> <span class="ow">is</span> <span class="n">still</span> <span class="n">released</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="declaring-a-function-as-callable-without-the-gil">
<h5>Declaring a function as callable without the GIL<a class="headerlink" href="#declaring-a-function-as-callable-without-the-gil" title="Permalink to this headline">¶</a></h5>
<p>You can specify <a class="reference internal" href="#nogil"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">nogil</span></code></a> in a C function header or function type to
declare that it is safe to call without the GIL.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">void</span> <span class="nf">my_gil_free_func</span><span class="p">(</span><span class="nb">int</span> <span class="n">spam</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>When you implement such a function in Cython, it cannot have any Python
arguments or Python object return type.  Furthermore, any operation
that involves Python objects (including calling Python functions) must
explicitly acquire the GIL first, e.g. by using a <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil</span></code> block
or by calling a function that has been defined <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil</span></code>.  These
restrictions are checked by Cython and you will get a compile error
if it finds any Python interaction inside of a <code class="docutils literal notranslate"><span class="pre">nogil</span></code> code section.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">nogil</span></code> function annotation declares that it is safe
to call the function without the GIL.  It is perfectly allowed
to execute it while holding the GIL.  The function does not in
itself release the GIL if it is held by the caller.</p>
</div>
<p>Declaring a function <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil</span></code> (i.e. as acquiring the GIL on entry) also
implicitly makes its signature <a class="reference internal" href="#nogil"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">nogil</span></code></a>.</p>
</div>
</div>
</div>
<span id="document-src/userguide/source_files_and_compilation"></span><div class="section" id="source-files-and-compilation">
<span id="compilation"></span><h3>Source Files and Compilation<a class="headerlink" href="#source-files-and-compilation" title="Permalink to this headline">¶</a></h3>
<p>Cython source file names consist of the name of the module followed by a
<code class="docutils literal notranslate"><span class="pre">.pyx</span></code> extension, for example a module called primes would have a source
file named <code class="file docutils literal notranslate"><span class="pre">primes.pyx</span></code>.</p>
<p>Cython code, unlike Python, must be compiled.  This happens in two stages:</p>
<blockquote>
<div><ul class="simple">
<li>A <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file is compiled by Cython to a <code class="docutils literal notranslate"><span class="pre">.c</span></code> file.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">.c</span></code> file is compiled by a C compiler to a <code class="docutils literal notranslate"><span class="pre">.so</span></code> file (or a
<code class="docutils literal notranslate"><span class="pre">.pyd</span></code> file on Windows)</li>
</ul>
</div></blockquote>
<p>Once you have written your <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file, there are a couple of ways of turning it
into an extension module.</p>
<p>The following sub-sections describe several ways to build your
extension modules, and how to pass directives to the Cython compiler.</p>
<div class="section" id="compiling-from-the-command-line">
<span id="compiling-command-line"></span><h4>Compiling from the command line<a class="headerlink" href="#compiling-from-the-command-line" title="Permalink to this headline">¶</a></h4>
<p>There are two ways of compiling from the command line.</p>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">cython</span></code> command takes a <code class="docutils literal notranslate"><span class="pre">.py</span></code> or <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file and
compiles it into a C/C++ file.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> command takes a <code class="docutils literal notranslate"><span class="pre">.py</span></code> or <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file and
compiles it into a C/C++ file.  It then compiles the C/C++ file into
an extension module which is directly importable from Python.</li>
</ul>
<div class="section" id="compiling-with-the-cython-command">
<h5>Compiling with the <code class="docutils literal notranslate"><span class="pre">cython</span></code> command<a class="headerlink" href="#compiling-with-the-cython-command" title="Permalink to this headline">¶</a></h5>
<p>One way is to compile it manually with the Cython
compiler, e.g.:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ cython primes.pyx
</pre></div>
</div>
<p>This will produce a file called <code class="file docutils literal notranslate"><span class="pre">primes.c</span></code>, which then needs to be
compiled with the C compiler using whatever options are appropriate on your
platform for generating an extension module. For these options look at the
official Python documentation.</p>
<p>The other, and probably better, way is to use the <a class="reference external" href="https://docs.python.org/3/library/distutils.html#module-distutils" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">distutils</span></code></a> extension
provided with Cython. The benefit of this method is that it will give the
platform specific compilation options, acting like a stripped down autotools.</p>
</div>
<div class="section" id="compiling-with-the-cythonize-command">
<h5>Compiling with the <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> command<a class="headerlink" href="#compiling-with-the-cythonize-command" title="Permalink to this headline">¶</a></h5>
<p>Run the <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> compiler command with your options and list of
<code class="docutils literal notranslate"><span class="pre">.pyx</span></code> files to generate an extension module.  For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cythonize</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">i</span> <span class="n">yourmod</span><span class="o">.</span><span class="n">pyx</span>
</pre></div>
</div>
<p>This creates a <code class="docutils literal notranslate"><span class="pre">yourmod.c</span></code> file (or <code class="docutils literal notranslate"><span class="pre">yourmod.cpp</span></code> in C++ mode), compiles it,
and puts the resulting extension module (<code class="docutils literal notranslate"><span class="pre">.so</span></code> or <code class="docutils literal notranslate"><span class="pre">.pyd</span></code>, depending on your
platform) next to the source file for direct import (<code class="docutils literal notranslate"><span class="pre">-i</span></code> builds “in place”).
The <code class="docutils literal notranslate"><span class="pre">-a</span></code> switch additionally produces an annotated html file of the source code.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> command accepts multiple source files and glob patterns like
<code class="docutils literal notranslate"><span class="pre">**/*.pyx</span></code> as argument and also understands the common <code class="docutils literal notranslate"><span class="pre">-j</span></code> option for
running multiple parallel build jobs.  When called without further options, it
will only translate the source files to <code class="docutils literal notranslate"><span class="pre">.c</span></code> or <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> files.  Pass the
<code class="docutils literal notranslate"><span class="pre">-h</span></code> flag for a complete list of supported options.</p>
<p>There simpler command line tool <code class="docutils literal notranslate"><span class="pre">cython</span></code> only invokes the source code translator.</p>
<p>In the case of manual compilation, how to compile your <code class="docutils literal notranslate"><span class="pre">.c</span></code> files will vary
depending on your operating system and compiler.  The Python documentation for
writing extension modules should have some details for your system.  On a Linux
system, for example, it might look similar to this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">shared</span> <span class="o">-</span><span class="n">pthread</span> <span class="o">-</span><span class="n">fPIC</span> <span class="o">-</span><span class="n">fwrapv</span> <span class="o">-</span><span class="n">O2</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">strict</span><span class="o">-</span><span class="n">aliasing</span> \
      <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">include</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mf">5</span> <span class="o">-</span><span class="n">o</span> <span class="n">yourmod</span><span class="o">.</span><span class="n">so</span> <span class="n">yourmod</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
<p>(<code class="docutils literal notranslate"><span class="pre">gcc</span></code> will need to have paths to your included header files and paths
to libraries you want to link with.)</p>
<p>After compilation, a <code class="docutils literal notranslate"><span class="pre">yourmod.so</span></code> (<code class="file docutils literal notranslate"><span class="pre">yourmod.pyd</span></code> for Windows)
file is written into the target directory
and your module, <code class="docutils literal notranslate"><span class="pre">yourmod</span></code>, is available for you to import as with any other
Python module.  Note that if you are not relying on <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> or distutils,
you will not automatically benefit from the platform specific file extension
that CPython generates for disambiguation, such as
<code class="docutils literal notranslate"><span class="pre">yourmod.cpython-35m-x86_64-linux-gnu.so</span></code> on a regular 64bit Linux installation
of CPython 3.5.</p>
</div>
</div>
<div class="section" id="basic-setup-py">
<span id="id1"></span><h4>Basic setup.py<a class="headerlink" href="#basic-setup-py" title="Permalink to this headline">¶</a></h4>
<p>The distutils extension provided with Cython allows you to pass <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> files
directly to the <code class="docutils literal notranslate"><span class="pre">Extension</span></code> constructor in your setup file.</p>
<p>If you have a single Cython file that you want to turn into a compiled
extension, say with filename <code class="file docutils literal notranslate"><span class="pre">example.pyx</span></code> the associated <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code>
would be:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;example.pyx&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To understand the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> more fully look at the official
<a class="reference external" href="https://docs.python.org/3/library/distutils.html#module-distutils" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">distutils</span></code></a> documentation. To compile the extension for use in the
current directory use:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ python setup.py build_ext --inplace
</pre></div>
</div>
<div class="section" id="configuring-the-c-build">
<h5>Configuring the C-Build<a class="headerlink" href="#configuring-the-c-build" title="Permalink to this headline">¶</a></h5>
<p>If you have include files in non-standard places you can pass an
<code class="docutils literal notranslate"><span class="pre">include_path</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">cythonize</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;My hello app&quot;</span><span class="p">,</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;src/*.pyx&quot;</span><span class="p">,</span> <span class="n">include_path</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">]),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Often, Python packages that offer a C-level API provide a way to find
the necessary include files, e.g. for NumPy:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">include_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Using memoryviews or importing NumPy with <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">numpy</span></code> does not mean that
you have to add the path to NumPy include files. You need to add this path only
if you use <code class="docutils literal notranslate"><span class="pre">cimport</span> <span class="pre">numpy</span></code>.</p>
</div>
<p>Despite this, you will still get warnings like the
following from the compiler, because Cython is using a deprecated Numpy API:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">.../</span><span class="k">include</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">npy_1_7_deprecated_api</span><span class="o">.</span><span class="n">h</span><span class="p">:</span><span class="mf">15</span><span class="p">:</span><span class="mf">2</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="c">#warning &quot;Using deprecated NumPy API, disable it by &quot; &quot;#defining NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION&quot; [-Wcpp]</span>
</pre></div>
</div>
<p>For the time being, it is just a warning that you can ignore.</p>
<p>If you need to specify compiler options, libraries to link with or other
linker options you will need to create <code class="docutils literal notranslate"><span class="pre">Extension</span></code> instances manually
(note that glob syntax can still be used to specify multiple extensions
in one line):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">distutils.extension</span> <span class="k">import</span> <span class="n">Extension</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Extension</span><span class="p">(</span><span class="s">&quot;primes&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;primes.pyx&quot;</span><span class="p">],</span>
        <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
        <span class="n">libraries</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
        <span class="n">library_dirs</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">]),</span>
    <span class="c"># Everything but primes.pyx is included here.</span>
    <span class="n">Extension</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;*.pyx&quot;</span><span class="p">],</span>
        <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
        <span class="n">libraries</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
        <span class="n">library_dirs</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">]),</span>
<span class="p">]</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;My hello app&quot;</span><span class="p">,</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that when using setuptools, you should import it before Cython as
setuptools may replace the <code class="docutils literal notranslate"><span class="pre">Extension</span></code> class in distutils.  Otherwise,
both might disagree about the class to use here.</p>
<p>Note also that if you use setuptools instead of distutils, the default
action when running <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code> is to create a zipped
<code class="docutils literal notranslate"><span class="pre">egg</span></code> file which will not work with <code class="docutils literal notranslate"><span class="pre">cimport</span></code> for <code class="docutils literal notranslate"><span class="pre">pxd</span></code> files
when you try to use them from a dependent package.
To prevent this, include <code class="docutils literal notranslate"><span class="pre">zip_safe=False</span></code> in the arguments to <code class="docutils literal notranslate"><span class="pre">setup()</span></code>.</p>
<p>If your options are static (for example you do not need to call a tool like
<code class="docutils literal notranslate"><span class="pre">pkg-config</span></code> to determine them) you can also provide them directly in your
.pyx or .pxd source file using a special comment block at the start of the file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: libraries = spam eggs</span>
<span class="c"># distutils: include_dirs = /opt/food/include</span>
</pre></div>
</div>
<p>If you cimport multiple .pxd files defining libraries, then Cython
merges the list of libraries, so this works as expected (similarly
with other options, like <code class="docutils literal notranslate"><span class="pre">include_dirs</span></code> above).</p>
<p>If you have some C files that have been wrapped with Cython and you want to
compile them into your extension, you can define the distutils <code class="docutils literal notranslate"><span class="pre">sources</span></code>
parameter:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: sources = helper.c, another_helper.c</span>
</pre></div>
</div>
<p>Note that these sources are added to the list of sources of the current
extension module.  Spelling this out in the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> file looks
as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>
<span class="k">from</span> <span class="nn">distutils.extension</span> <span class="k">import</span> <span class="n">Extension</span>

<span class="n">sourcefiles</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;example.pyx&#39;</span><span class="p">,</span> <span class="s">&#39;helper.c&#39;</span><span class="p">,</span> <span class="s">&#39;another_helper.c&#39;</span><span class="p">]</span>

<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="n">sourcefiles</span><span class="p">)]</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code> class takes many options, and a fuller explanation can
be found in the <a class="reference external" href="https://docs.python.org/extending/building.html">distutils documentation</a>. Some useful options to know about
are <code class="docutils literal notranslate"><span class="pre">include_dirs</span></code>, <code class="docutils literal notranslate"><span class="pre">libraries</span></code>, and <code class="docutils literal notranslate"><span class="pre">library_dirs</span></code> which specify where
to find the <code class="docutils literal notranslate"><span class="pre">.h</span></code> and library files when linking to external libraries.</p>
<p>Sometimes this is not enough and you need finer customization of the
distutils <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code>.
To do this, you can provide a custom function <code class="docutils literal notranslate"><span class="pre">create_extension</span></code>
to create the final <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code> object after Cython has processed
the sources, dependencies and <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">distutils</span></code> directives but before the
file is actually Cythonized.
This function takes 2 arguments <code class="docutils literal notranslate"><span class="pre">template</span></code> and <code class="docutils literal notranslate"><span class="pre">kwds</span></code>, where
<code class="docutils literal notranslate"><span class="pre">template</span></code> is the <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code> object given as input to Cython
and <code class="docutils literal notranslate"><span class="pre">kwds</span></code> is a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">dict</span></code></a> with all keywords which should be used
to create the <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code>.
The function <code class="docutils literal notranslate"><span class="pre">create_extension</span></code> must return a 2-tuple
<code class="docutils literal notranslate"><span class="pre">(extension,</span> <span class="pre">metadata)</span></code>, where <code class="docutils literal notranslate"><span class="pre">extension</span></code> is the created
<code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code> and <code class="docutils literal notranslate"><span class="pre">metadata</span></code> is metadata which will be written
as JSON at the top of the generated C files. This metadata is only used
for debugging purposes, so you can put whatever you want in there
(as long as it can be converted to JSON).
The default function (defined in <code class="docutils literal notranslate"><span class="pre">Cython.Build.Dependencies</span></code>) is:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">default_create_extension</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;depends&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
        <span class="n">include_dirs</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;include_dirs&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;.&quot;</span><span class="p">]</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="n">resolve_depends</span><span class="p">(</span><span class="n">kwds</span><span class="p">[</span><span class="s">&#39;depends&#39;</span><span class="p">],</span> <span class="n">include_dirs</span><span class="p">)</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;depends&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">depends</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">depends</span><span class="p">))</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">__class__</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">distutils</span><span class="o">=</span><span class="n">kwds</span><span class="p">,</span> <span class="n">module_name</span><span class="o">=</span><span class="n">kwds</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ext</span><span class="p">,</span> <span class="n">metadata</span>
</pre></div>
</div>
<p>In case that you pass a string instead of an <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code> to
<code class="docutils literal notranslate"><span class="pre">cythonize()</span></code>, the <code class="docutils literal notranslate"><span class="pre">template</span></code> will be an <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code> without
sources. For example, if you do <code class="docutils literal notranslate"><span class="pre">cythonize(&quot;*.pyx&quot;)</span></code>,
the <code class="docutils literal notranslate"><span class="pre">template</span></code> will be <code class="docutils literal notranslate"><span class="pre">Extension(name=&quot;*.pyx&quot;,</span> <span class="pre">sources=[])</span></code>.</p>
<p>Just as an example, this adds <code class="docutils literal notranslate"><span class="pre">mylib</span></code> as library to every extension:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">Cython.Build.Dependencies</span> <span class="k">import</span> <span class="n">default_create_extension</span>

<span class="k">def</span> <span class="nf">my_create_extension</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
    <span class="n">libs</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;libraries&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;mylib&quot;</span><span class="p">]</span>
    <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;libraries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">libs</span>
    <span class="k">return</span> <span class="n">default_create_extension</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>

<span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">create_extension</span><span class="o">=</span><span class="n">my_create_extension</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you Cythonize in parallel (using the <code class="docutils literal notranslate"><span class="pre">nthreads</span></code> argument),
then the argument to <code class="docutils literal notranslate"><span class="pre">create_extension</span></code> must be pickleable.
In particular, it cannot be a lambda function.</p>
</div>
</div>
<div class="section" id="cythonize-arguments">
<span id="id2"></span><h5>Cythonize arguments<a class="headerlink" href="#cythonize-arguments" title="Permalink to this headline">¶</a></h5>
<p>The function <code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code> can take extra arguments which will allow you to
customize your build.</p>
<dl class="function">
<dt id="Cython.Build.cythonize">
<code class="descclassname">Cython.Build.</code><code class="descname">cythonize</code><span class="sig-paren">(</span><em>module_list</em>, <em>exclude=None</em>, <em>nthreads=0</em>, <em>aliases=None</em>, <em>quiet=False</em>, <em>force=False</em>, <em>language=None</em>, <em>exclude_failures=False</em>, <em>**options</em><span class="sig-paren">)</span><a class="headerlink" href="#Cython.Build.cythonize" title="Permalink to this definition">¶</a></dt>
<dd><p>Compile a set of source modules into C/C++ files and return a list of distutils
Extension objects for them.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>module_list</strong> – As module list, pass either a glob pattern, a list of glob
patterns or a list of Extension objects.  The latter
allows you to configure the extensions separately
through the normal distutils options.
You can also pass Extension objects that have
glob patterns as their sources. Then, cythonize
will resolve the pattern and create a
copy of the Extension for every matching file.</li>
<li><strong>exclude</strong> – When passing glob patterns as <code class="docutils literal notranslate"><span class="pre">module_list</span></code>, you can exclude certain
module names explicitly by passing them into the <code class="docutils literal notranslate"><span class="pre">exclude</span></code> option.</li>
<li><strong>nthreads</strong> – The number of concurrent builds for parallel compilation
(requires the <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module).</li>
<li><strong>aliases</strong> – If you want to use compiler directives like <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">distutils:</span> <span class="pre">...</span></code> but
can only know at compile time (when running the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>) which values
to use, you can use aliases and pass a dictionary mapping those aliases
to Python strings when calling <a class="reference internal" href="#Cython.Build.cythonize" title="Cython.Build.cythonize"><code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code></a>. As an example, say you
want to use the compiler
directive <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">distutils:</span> <span class="pre">include_dirs</span> <span class="pre">=</span> <span class="pre">../static_libs/include/</span></code>
but this path isn’t always fixed and you want to find it when running
the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>. You can then do <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">distutils:</span> <span class="pre">include_dirs</span> <span class="pre">=</span> <span class="pre">MY_HEADERS</span></code>,
find the value of <code class="docutils literal notranslate"><span class="pre">MY_HEADERS</span></code> in the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, put it in a python
variable called <code class="docutils literal notranslate"><span class="pre">foo</span></code> as a string, and then call
<code class="docutils literal notranslate"><span class="pre">cythonize(...,</span> <span class="pre">aliases={'MY_HEADERS':</span> <span class="pre">foo})</span></code>.</li>
<li><strong>quiet</strong> – If True, Cython won’t print error and warning messages during the compilation.</li>
<li><strong>force</strong> – Forces the recompilation of the Cython modules, even if the timestamps
don’t indicate that a recompilation is necessary.</li>
<li><strong>language</strong> – To globally enable C++ mode, you can pass <code class="docutils literal notranslate"><span class="pre">language='c++'</span></code>. Otherwise, this
will be determined at a per-file level based on compiler directives.  This
affects only modules found based on file names.  Extension instances passed
into <a class="reference internal" href="#Cython.Build.cythonize" title="Cython.Build.cythonize"><code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code></a> will not be changed. It is recommended to rather
use the compiler directive <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">distutils:</span> <span class="pre">language</span> <span class="pre">=</span> <span class="pre">c++</span></code> than this option.</li>
<li><strong>exclude_failures</strong> – For a broad ‘try to compile’ mode that ignores compilation
failures and simply excludes the failed extensions,
pass <code class="docutils literal notranslate"><span class="pre">exclude_failures=True</span></code>. Note that this only
really makes sense for compiling <code class="docutils literal notranslate"><span class="pre">.py</span></code> files which can also
be used without compilation.</li>
<li><strong>annotate</strong> – If <code class="docutils literal notranslate"><span class="pre">True</span></code>, will produce a HTML file for each of the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> or <code class="docutils literal notranslate"><span class="pre">.py</span></code>
files compiled. The HTML file gives an indication
of how much Python interaction there is in
each of the source code lines, compared to plain C code.
It also allows you to see the C/C++ code
generated for each line of Cython code. This report is invaluable when
optimizing a function for speed,
and for determining when to <a class="reference internal" href="index.html#nogil"><span class="std std-ref">release the GIL</span></a>:
in general, a <code class="docutils literal notranslate"><span class="pre">nogil</span></code> block may contain only “white” code.
See examples in <a class="reference internal" href="index.html#determining-where-to-add-types"><span class="std std-ref">Determining where to add types</span></a> or
<a class="reference internal" href="index.html#primes"><span class="std std-ref">Primes</span></a>.</li>
<li><strong>compiler_directives</strong> – Allow to set compiler directives in the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> like this:
<code class="docutils literal notranslate"><span class="pre">compiler_directives={'embedsignature':</span> <span class="pre">True}</span></code>.
See <a class="reference internal" href="#compiler-directives"><span class="std std-ref">Compiler directives</span></a>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
<div class="section" id="multiple-cython-files-in-a-package">
<h4>Multiple Cython Files in a Package<a class="headerlink" href="#multiple-cython-files-in-a-package" title="Permalink to this headline">¶</a></h4>
<p>To automatically compile multiple Cython files without listing all of them
explicitly, you can use glob patterns:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;package/*.pyx&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can also use glob patterns in <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code> objects if you pass
them through <code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;*.pyx&quot;</span><span class="p">])]</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="distributing-cython-modules">
<span id="id3"></span><h5>Distributing Cython modules<a class="headerlink" href="#distributing-cython-modules" title="Permalink to this headline">¶</a></h5>
<p>It is strongly recommended that you distribute the generated <code class="docutils literal notranslate"><span class="pre">.c</span></code> files as well
as your Cython sources, so that users can install your module without needing
to have Cython available.</p>
<p>It is also recommended that Cython compilation not be enabled by default in the
version you distribute. Even if the user has Cython installed, he/she probably
doesn’t want to use it just to install your module. Also, the installed version
may not be the same one you used, and may not compile your sources correctly.</p>
<p>This simply means that the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> file that you ship with will just
be a normal distutils file on the generated <cite>.c</cite> files, for the basic example
we would have instead:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">distutils.extension</span> <span class="k">import</span> <span class="n">Extension</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;example.c&quot;</span><span class="p">])]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This is easy to combine with <code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code> by changing the file extension
of the extension module sources:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">distutils.extension</span> <span class="k">import</span> <span class="n">Extension</span>

<span class="n">USE_CYTHON</span> <span class="o">=</span> <span class="o">...</span>   <span class="c"># command line option, try-import, ...</span>

<span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;.pyx&#39;</span> <span class="k">if</span> <span class="n">USE_CYTHON</span> <span class="k">else</span> <span class="s">&#39;.c&#39;</span>

<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;example&quot;</span><span class="o">+</span><span class="n">ext</span><span class="p">])]</span>

<span class="k">if</span> <span class="n">USE_CYTHON</span><span class="p">:</span>
    <span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">extensions</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If you have many extensions and want to avoid the additional complexity in the
declarations, you can declare them with their normal Cython sources and then
call the following function instead of <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code> to adapt the sources
list in the Extensions when not using Cython:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">os.path</span>

<span class="k">def</span> <span class="nf">no_cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">,</span> <span class="o">**</span><span class="n">_ignore</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sfile</span> <span class="ow">in</span> <span class="n">extension</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">sfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.pyx&#39;</span><span class="p">,</span> <span class="s">&#39;.py&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">extension</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="s">&#39;c++&#39;</span><span class="p">:</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;.cpp&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;.c&#39;</span>
                <span class="n">sfile</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">ext</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sfile</span><span class="p">)</span>
        <span class="n">extension</span><span class="o">.</span><span class="n">sources</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">sources</span>
    <span class="k">return</span> <span class="n">extensions</span>
</pre></div>
</div>
<p>Another option is to make Cython a setup dependency of your system and use
Cython’s build_ext module which runs <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> as part of the build process:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="n">setup_requires</span><span class="o">=</span><span class="p">[</span>
        <span class="s">&#39;cython&gt;=0.x&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;*.pyx&quot;</span><span class="p">])],</span>
    <span class="n">cmdclass</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;build_ext&#39;</span><span class="p">:</span> <span class="n">Cython</span><span class="o">.</span><span class="n">Build</span><span class="o">.</span><span class="n">build_ext</span><span class="p">},</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If you want to expose the C-level interface of your library for other
libraries to cimport from, use package_data to install the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files,
e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="n">package_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;my_package&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;*.pxd&#39;</span><span class="p">],</span>
        <span class="s">&#39;my_package/sub_package&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;*.pxd&#39;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>These <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files need not have corresponding <code class="docutils literal notranslate"><span class="pre">.pyx</span></code>
modules if they contain purely declarations of external libraries.</p>
<p>Remember that if you use setuptools instead of distutils, the default
action when running <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code> is to create a zipped
<code class="docutils literal notranslate"><span class="pre">egg</span></code> file which will not work with <code class="docutils literal notranslate"><span class="pre">cimport</span></code> for <code class="docutils literal notranslate"><span class="pre">pxd</span></code> files
when you try to use them from a dependent package.
To prevent this, include <code class="docutils literal notranslate"><span class="pre">zip_safe=False</span></code> in the arguments to <code class="docutils literal notranslate"><span class="pre">setup()</span></code>.</p>
</div>
</div>
<div class="section" id="integrating-multiple-modules">
<span id="id4"></span><h4>Integrating multiple modules<a class="headerlink" href="#integrating-multiple-modules" title="Permalink to this headline">¶</a></h4>
<p>In some scenarios, it can be useful to link multiple Cython modules
(or other extension modules) into a single binary, e.g. when embedding
Python in another application.  This can be done through the inittab
import mechanism of CPython.</p>
<p>Create a new C file to integrate the extension modules and add this
macro to it:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c">#if PY_MAJOR_VERSION &lt; 3</span>
<span class="c"># define MODINIT(name)  init ## name</span>
<span class="c">#else</span>
<span class="c"># define MODINIT(name)  PyInit_ ## name</span>
<span class="c">#endif</span>
</pre></div>
</div>
<p>If you are only targeting Python 3.x, just use <code class="docutils literal notranslate"><span class="pre">PyInit_</span></code> as prefix.</p>
<p>Then, for each of the modules, declare its module init function
as follows, replacing <code class="docutils literal notranslate"><span class="pre">some_module_name</span></code> with the name of the module:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>  <span class="n">MODINIT</span><span class="p">(</span><span class="n">some_module_name</span><span class="p">)</span> <span class="p">(</span><span class="n">void</span><span class="p">);</span>
</pre></div>
</div>
<p>In C++, declare them as <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">C</span></code>.</p>
<p>If you are not sure of the name of the module init function, refer
to your generated module source file and look for a function name
starting with <code class="docutils literal notranslate"><span class="pre">PyInit_</span></code>.</p>
<p>Next, before you start the Python runtime from your application code
with <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code>, you need to initialise the modules at runtime
using the <code class="docutils literal notranslate"><span class="pre">PyImport_AppendInittab()</span></code> C-API function, again inserting
the name of each of the modules:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">PyImport_AppendInittab</span><span class="p">(</span><span class="s">&quot;some_module_name&quot;</span><span class="p">,</span> <span class="n">MODINIT</span><span class="p">(</span><span class="n">some_module_name</span><span class="p">));</span>
</pre></div>
</div>
<p>This enables normal imports for the embedded extension modules.</p>
<p>In order to prevent the joined binary from exporting all of the module
init functions as public symbols, Cython 0.28 and later can hide these
symbols if the macro <code class="docutils literal notranslate"><span class="pre">CYTHON_NO_PYINIT_EXPORT</span></code> is defined while
C-compiling the module C files.</p>
<p>Also take a look at the <a class="reference external" href="https://github.com/cython/cython/blob/master/bin/cython_freeze">cython_freeze</a> tool.
It can generate the necessary boilerplate code for linking one or more
modules into a single Python executable.</p>
</div>
<div class="section" id="compiling-with-pyximport">
<span id="pyximport"></span><h4>Compiling with <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyximport</span></code><a class="headerlink" href="#compiling-with-pyximport" title="Permalink to this headline">¶</a></h4>
<p>For building Cython modules during development without explicitly
running <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> after each change, you can use <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyximport</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">pyximport</span><span class="p">;</span> <span class="n">pyximport</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">helloworld</span>
<span class="n">Hello</span> <span class="n">World</span>
</pre></div>
</div>
<p>This allows you to automatically run Cython on every <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> that
Python is trying to import.  You should use this for simple Cython
builds only where no extra C libraries and no special building setup
is needed.</p>
<p>It is also possible to compile new <code class="docutils literal notranslate"><span class="pre">.py</span></code> modules that are being
imported (including the standard library and installed packages).  For
using this feature, just tell that to <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyximport</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pyximport</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">pyimport</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>In the case that Cython fails to compile a Python module, <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyximport</span></code>
will fall back to loading the source modules instead.</p>
<p>Note that it is not recommended to let <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyximport</span></code> build code
on end user side as it hooks into their import system.  The best way
to cater for end users is to provide pre-built binary packages in the
<a class="reference external" href="https://wheel.readthedocs.io/">wheel</a> packaging format.</p>
<div class="section" id="arguments">
<h5>Arguments<a class="headerlink" href="#arguments" title="Permalink to this headline">¶</a></h5>
<p>The function <code class="docutils literal notranslate"><span class="pre">pyximport.install()</span></code> can take several arguments to
influence the compilation of Cython or Python files.</p>
<dl class="function">
<dt id="pyximport.install">
<code class="descclassname">pyximport.</code><code class="descname">install</code><span class="sig-paren">(</span><em>pyximport=True</em>, <em>pyimport=False</em>, <em>build_dir=None</em>, <em>build_in_temp=True</em>, <em>setup_args=None</em>, <em>reload_support=False</em>, <em>load_py_module_on_import_failure=False</em>, <em>inplace=False</em>, <em>language_level=None</em><span class="sig-paren">)</span><a class="headerlink" href="#pyximport.install" title="Permalink to this definition">¶</a></dt>
<dd><p>Main entry point for pyxinstall.</p>
<p>Call this to install the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> import hook in
your meta-path for a single Python process.  If you want it to be
installed whenever you use Python, add it to your <code class="docutils literal notranslate"><span class="pre">sitecustomize</span></code>
(as described above).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>pyximport</strong> – If set to False, does not try to import <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> files.</li>
<li><strong>pyimport</strong> – You can pass <code class="docutils literal notranslate"><span class="pre">pyimport=True</span></code> to also
install the <code class="docutils literal notranslate"><span class="pre">.py</span></code> import hook
in your meta-path.  Note, however, that it is rather experimental,
will not work at all for some <code class="docutils literal notranslate"><span class="pre">.py</span></code> files and packages, and will
heavily slow down your imports due to search and compilation.
Use at your own risk.</li>
<li><strong>build_dir</strong> – By default, compiled modules will end up in a <code class="docutils literal notranslate"><span class="pre">.pyxbld</span></code>
directory in the user’s home directory.  Passing a different path
as <code class="docutils literal notranslate"><span class="pre">build_dir</span></code> will override this.</li>
<li><strong>build_in_temp</strong> – If <code class="docutils literal notranslate"><span class="pre">False</span></code>, will produce the C files locally. Working
with complex dependencies and debugging becomes more easy. This
can principally interfere with existing files of the same name.</li>
<li><strong>setup_args</strong> – Dict of arguments for Distribution.
See <code class="docutils literal notranslate"><span class="pre">distutils.core.setup()</span></code>.</li>
<li><strong>reload_support</strong> – Enables support for dynamic
<code class="docutils literal notranslate"><span class="pre">reload(my_module)</span></code>, e.g. after a change in the Cython code.
Additional files <code class="docutils literal notranslate"><span class="pre">&lt;so_path&gt;.reloadNN</span></code> may arise on that account, when
the previously loaded module file cannot be overwritten.</li>
<li><strong>load_py_module_on_import_failure</strong> – If the compilation of a <code class="docutils literal notranslate"><span class="pre">.py</span></code>
file succeeds, but the subsequent import fails for some reason,
retry the import with the normal <code class="docutils literal notranslate"><span class="pre">.py</span></code> module instead of the
compiled module.  Note that this may lead to unpredictable results
for modules that change the system state during their import, as
the second import will rerun these modifications in whatever state
the system was left after the import of the compiled module
failed.</li>
<li><strong>inplace</strong> – Install the compiled module
(<code class="docutils literal notranslate"><span class="pre">.so</span></code> for Linux and Mac / <code class="docutils literal notranslate"><span class="pre">.pyd</span></code> for Windows)
next to the source file.</li>
<li><strong>language_level</strong> – The source language level to use: 2 or 3.
The default is to use the language level of the current Python
runtime for .py files and Py2 for <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> files.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="dependency-handling">
<h5>Dependency Handling<a class="headerlink" href="#dependency-handling" title="Permalink to this headline">¶</a></h5>
<p>Since <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyximport</span></code> does not use <code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code> internally, it currently
requires a different setup for dependencies.  It is possible to declare that
your module depends on multiple files, (likely <code class="docutils literal notranslate"><span class="pre">.h</span></code> and <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files).
If your Cython module is named <code class="docutils literal notranslate"><span class="pre">foo</span></code> and thus has the filename
<code class="file docutils literal notranslate"><span class="pre">foo.pyx</span></code> then you should create another file in the same directory
called <code class="file docutils literal notranslate"><span class="pre">foo.pyxdep</span></code>.  The <code class="file docutils literal notranslate"><span class="pre">modname.pyxdep</span></code> file can be a list of
filenames or “globs” (like <code class="docutils literal notranslate"><span class="pre">*.pxd</span></code> or <code class="docutils literal notranslate"><span class="pre">include/*.h</span></code>).  Each filename or
glob must be on a separate line.  Pyximport will check the file date for each
of those files before deciding whether to rebuild the module.  In order to
keep track of the fact that the dependency has been handled, Pyximport updates
the modification time of your “.pyx” source file.  Future versions may do
something more sophisticated like informing distutils of the dependencies
directly.</p>
</div>
<div class="section" id="limitations">
<h5>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h5>
<p><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyximport</span></code> does not use <code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code>. Thus it is not
possible to do things like using compiler directives at
the top of Cython files or compiling Cython code to C++.</p>
<p>Pyximport does not give you any control over how your Cython file is
compiled.  Usually the defaults are fine.  You might run into problems if
you wanted to write your program in half-C, half-Cython and build them
into a single library.</p>
<p>Pyximport does not hide the Distutils/GCC warnings and errors generated
by the import process.  Arguably this will give you better feedback if
something went wrong and why.  And if nothing went wrong it will give you
the warm fuzzy feeling that pyximport really did rebuild your module as it
was supposed to.</p>
<p>Basic module reloading support is available with the option <code class="docutils literal notranslate"><span class="pre">reload_support=True</span></code>.
Note that this will generate a new module filename for each build and thus
end up loading multiple shared libraries into memory over time. CPython has limited
support for reloading shared libraries as such,
see <a class="reference external" href="https://www.python.org/dev/peps/pep-0489/">PEP 489</a>.</p>
<p>Pyximport puts both your <code class="docutils literal notranslate"><span class="pre">.c</span></code> file and the platform-specific binary into
a separate build directory, usually <code class="docutils literal notranslate"><span class="pre">$HOME/.pyxblx/</span></code>.  To copy it back
into the package hierarchy (usually next to the source file) for manual
reuse, you can pass the option <code class="docutils literal notranslate"><span class="pre">inplace=True</span></code>.</p>
</div>
</div>
<div class="section" id="compiling-with-cython-inline">
<span id="id5"></span><h4>Compiling with <code class="docutils literal notranslate"><span class="pre">cython.inline</span></code><a class="headerlink" href="#compiling-with-cython-inline" title="Permalink to this headline">¶</a></h4>
<p>One can also compile Cython in a fashion similar to SciPy’s <code class="docutils literal notranslate"><span class="pre">weave.inline</span></code>.
For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">cython</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">ret</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">inline</span><span class="p">(</span><span class="s">&quot;return a+b&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">3</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Unbound variables are automatically pulled from the surrounding local
and global scopes, and the result of the compilation is cached for
efficient re-use.</p>
</div>
<div class="section" id="compiling-with-sage">
<span id="id6"></span><h4>Compiling with Sage<a class="headerlink" href="#compiling-with-sage" title="Permalink to this headline">¶</a></h4>
<p>The Sage notebook allows transparently editing and compiling Cython
code simply by typing <code class="docutils literal notranslate"><span class="pre">%cython</span></code> at the top of a cell and evaluate
it. Variables and functions defined in a Cython cell are imported into the
running session.  Please check <a class="reference external" href="https://www.sagemath.org/doc/">Sage documentation</a> for details.</p>
<p>You can tailor the behavior of the Cython compiler by specifying the
directives below.</p>
</div>
<div class="section" id="compiling-with-a-jupyter-notebook">
<span id="compiling-notebook"></span><h4>Compiling with a Jupyter Notebook<a class="headerlink" href="#compiling-with-a-jupyter-notebook" title="Permalink to this headline">¶</a></h4>
<p>It’s possible to compile code in a notebook cell with Cython.
For this you need to load the Cython magic:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">load_ext</span> <span class="n">cython</span>
</pre></div>
</div>
<p>Then you can define a Cython cell by writing <code class="docutils literal notranslate"><span class="pre">%%cython</span></code> on top of it.
Like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">cython</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">a</span> <span class="o">=</span> <span class="mf">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">10</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">+=</span> <span class="n">i</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that each cell will be compiled into a separate extension module. So if you use a package in a Cython
cell, you will have to import this package in the same cell. It’s not enough to
have imported the package in a previous cell. Cython will tell you that there are
“undefined global names” at compilation time if you don’t comply.</p>
<p>The global names (top level functions, classes, variables and modules) of the
cell are then loaded into the global namespace of the notebook. So in the
end, it behaves as if you executed a Python cell.</p>
<p>Additional allowable arguments to the Cython magic are listed below.
You can see them also by typing <code class="docutils literal notranslate"><span class="pre">`%%cython?</span></code> in IPython or a Jupyter notebook.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-a, –annotate</td>
<td>Produce a colorized HTML version of the source.</td>
</tr>
<tr class="row-even"><td>–annotate-fullc</td>
<td>Produce a colorized HTML version of the source which includes entire generated C/C++-code.</td>
</tr>
<tr class="row-odd"><td>-+, –cplus</td>
<td>Output a C++ rather than C file.</td>
</tr>
<tr class="row-even"><td>-f, –force</td>
<td>Force the compilation of a new module, even if the source has been previously compiled.</td>
</tr>
<tr class="row-odd"><td>-3</td>
<td>Select Python 3 syntax</td>
</tr>
<tr class="row-even"><td>-2</td>
<td>Select Python 2 syntax</td>
</tr>
<tr class="row-odd"><td>-c=COMPILE_ARGS, –compile-args=COMPILE_ARGS</td>
<td>Extra flags to pass to compiler via the extra_compile_args.</td>
</tr>
<tr class="row-even"><td>–link-args LINK_ARGS</td>
<td>Extra flags to pass to linker via the extra_link_args.</td>
</tr>
<tr class="row-odd"><td>-l LIB, –lib LIB</td>
<td>Add a library to link the extension against (can be specified multiple times).</td>
</tr>
<tr class="row-even"><td>-L dir</td>
<td>Add a path to the list of library directories (can be specified multiple times).</td>
</tr>
<tr class="row-odd"><td>-I INCLUDE, –include INCLUDE</td>
<td>Add a path to the list of include directories (can be specified multiple times).</td>
</tr>
<tr class="row-even"><td>-S, –src</td>
<td>Add a path to the list of src files (can be specified multiple times).</td>
</tr>
<tr class="row-odd"><td>-n NAME, –name NAME</td>
<td>Specify a name for the Cython module.</td>
</tr>
<tr class="row-even"><td>–pgo</td>
<td>Enable profile guided optimisation in the C compiler. Compiles the cell twice and executes it in between to generate a runtime profile.</td>
</tr>
<tr class="row-odd"><td>–verbose</td>
<td>Print debug information like generated .c/.cpp file location and exact gcc/g++ command invoked.</td>
</tr>
</tbody>
</table>
<div class="section" id="compiler-options">
<span id="id7"></span><h5>Compiler options<a class="headerlink" href="#compiler-options" title="Permalink to this headline">¶</a></h5>
<p>Compiler options can be set in the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code>, before calling <code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code>,
like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>

<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>
<span class="k">from</span> <span class="nn">Cython.Compiler</span> <span class="k">import</span> <span class="n">Options</span>

<span class="n">Options</span><span class="o">.</span><span class="n">docstrings</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hello&quot;</span><span class="p">,</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;lib.pyx&quot;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here are the options that are available:</p>
<dl class="data">
<dt id="Cython.Compiler.Options.docstrings">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">docstrings</code><em class="property"> = True</em><a class="headerlink" href="#Cython.Compiler.Options.docstrings" title="Permalink to this definition">¶</a></dt>
<dd><p>Whether or not to include docstring in the Python extension. If False, the binary size
will be smaller, but the <code class="docutils literal notranslate"><span class="pre">__doc__</span></code> attribute of any class or function will be an
empty string.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.embed_pos_in_docstring">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">embed_pos_in_docstring</code><em class="property"> = False</em><a class="headerlink" href="#Cython.Compiler.Options.embed_pos_in_docstring" title="Permalink to this definition">¶</a></dt>
<dd><p>Embed the source code position in the docstrings of functions and classes.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.emit_code_comments">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">emit_code_comments</code><em class="property"> = True</em><a class="headerlink" href="#Cython.Compiler.Options.emit_code_comments" title="Permalink to this definition">¶</a></dt>
<dd><p>Copy the original source code line by line into C code comments
in the generated code file to help with understanding the output.
This is also required for coverage analysis.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.generate_cleanup_code">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">generate_cleanup_code</code><em class="property"> = False</em><a class="headerlink" href="#Cython.Compiler.Options.generate_cleanup_code" title="Permalink to this definition">¶</a></dt>
<dd><p>Decref global variables in each module on exit for garbage collection.
0: None, 1+: interned objects, 2+: cdef globals, 3+: types objects
Mostly for reducing noise in Valgrind, only executes at process exit
(when all memory will be reclaimed anyways).</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.clear_to_none">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">clear_to_none</code><em class="property"> = True</em><a class="headerlink" href="#Cython.Compiler.Options.clear_to_none" title="Permalink to this definition">¶</a></dt>
<dd><p>Should tp_clear() set object fields to None instead of clearing them to NULL?</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.annotate">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">annotate</code><em class="property"> = False</em><a class="headerlink" href="#Cython.Compiler.Options.annotate" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate an annotated HTML version of the input source files for debugging and optimisation purposes.
This has the same effect as the <code class="docutils literal notranslate"><span class="pre">annotate</span></code> argument in <code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code>.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.fast_fail">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">fast_fail</code><em class="property"> = False</em><a class="headerlink" href="#Cython.Compiler.Options.fast_fail" title="Permalink to this definition">¶</a></dt>
<dd><p>This will abort the compilation on the first error occurred rather than trying
to keep going and printing further error messages.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.warning_errors">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">warning_errors</code><em class="property"> = False</em><a class="headerlink" href="#Cython.Compiler.Options.warning_errors" title="Permalink to this definition">¶</a></dt>
<dd><p>Turn all warnings into errors.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.error_on_unknown_names">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">error_on_unknown_names</code><em class="property"> = True</em><a class="headerlink" href="#Cython.Compiler.Options.error_on_unknown_names" title="Permalink to this definition">¶</a></dt>
<dd><p>Make unknown names an error.  Python raises a NameError when
encountering unknown names at runtime, whereas this option makes
them a compile time error.  If you want full Python compatibility,
you should disable this option and also ‘cache_builtins’.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.error_on_uninitialized">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">error_on_uninitialized</code><em class="property"> = True</em><a class="headerlink" href="#Cython.Compiler.Options.error_on_uninitialized" title="Permalink to this definition">¶</a></dt>
<dd><p>Make uninitialized local variable reference a compile time error.
Python raises UnboundLocalError at runtime, whereas this option makes
them a compile time error. Note that this option affects only variables
of “python object” type.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.convert_range">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">convert_range</code><em class="property"> = True</em><a class="headerlink" href="#Cython.Compiler.Options.convert_range" title="Permalink to this definition">¶</a></dt>
<dd><p>This will convert statements of the form <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">range(...)</span></code>
to <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">from</span> <span class="pre">...</span></code> when <code class="docutils literal notranslate"><span class="pre">i</span></code> is a C integer type, and the direction
(i.e. sign of step) can be determined.
WARNING: This may change the semantics if the range causes assignment to
i to overflow. Specifically, if this option is set, an error will be
raised before the loop is entered, whereas without this option the loop
will execute until an overflowing value is encountered.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.cache_builtins">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">cache_builtins</code><em class="property"> = True</em><a class="headerlink" href="#Cython.Compiler.Options.cache_builtins" title="Permalink to this definition">¶</a></dt>
<dd><p>Perform lookups on builtin names only once, at module initialisation
time.  This will prevent the module from getting imported if a
builtin name that it uses cannot be found during initialisation.
Default is True.
Note that some legacy builtins are automatically remapped
from their Python 2 names to their Python 3 names by Cython
when building in Python 3.x,
so that they do not get in the way even if this option is enabled.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.gcc_branch_hints">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">gcc_branch_hints</code><em class="property"> = True</em><a class="headerlink" href="#Cython.Compiler.Options.gcc_branch_hints" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate branch prediction hints to speed up error handling etc.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.lookup_module_cpdef">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">lookup_module_cpdef</code><em class="property"> = False</em><a class="headerlink" href="#Cython.Compiler.Options.lookup_module_cpdef" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable this to allow one to write <code class="docutils literal notranslate"><span class="pre">your_module.foo</span> <span class="pre">=</span> <span class="pre">...</span></code> to overwrite the
definition if the cpdef function foo, at the cost of an extra dictionary
lookup on every call.
If this is false it generates only the Python wrapper and no override check.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.embed">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">embed</code><em class="property"> = None</em><a class="headerlink" href="#Cython.Compiler.Options.embed" title="Permalink to this definition">¶</a></dt>
<dd><p>Whether or not to embed the Python interpreter, for use in making a
standalone executable or calling from external libraries.
This will provide a C function which initialises the interpreter and
executes the body of this module.
See <a class="reference external" href="https://github.com/cython/cython/tree/master/Demos/embed">this demo</a>
for a concrete example.
If true, the initialisation function is the C main() function, but
this option can also be set to a non-empty string to provide a function name explicitly.
Default is False.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.cimport_from_pyx">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">cimport_from_pyx</code><em class="property"> = False</em><a class="headerlink" href="#Cython.Compiler.Options.cimport_from_pyx" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows cimporting from a pyx file without a pxd file.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.buffer_max_dims">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">buffer_max_dims</code><em class="property"> = 8</em><a class="headerlink" href="#Cython.Compiler.Options.buffer_max_dims" title="Permalink to this definition">¶</a></dt>
<dd><p>Maximum number of dimensions for buffers – set lower than number of
dimensions in numpy, as
slices are passed by value and involve a lot of copying.</p>
</dd></dl>

<dl class="data">
<dt id="Cython.Compiler.Options.closure_freelist_size">
<code class="descclassname">Cython.Compiler.Options.</code><code class="descname">closure_freelist_size</code><em class="property"> = 8</em><a class="headerlink" href="#Cython.Compiler.Options.closure_freelist_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Number of function closure instances to keep in a freelist (0: no freelists)</p>
</dd></dl>

</div>
</div>
<div class="section" id="compiler-directives">
<span id="id8"></span><h4>Compiler directives<a class="headerlink" href="#compiler-directives" title="Permalink to this headline">¶</a></h4>
<p>Compiler directives are instructions which affect the behavior of
Cython code.  Here is the list of currently supported directives:</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">binding</span></code> (True / False)</dt>
<dd>Controls whether free functions behave more like Python’s CFunctions
(e.g. <a class="reference external" href="https://docs.python.org/3/library/functions.html#len" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">len()</span></code></a>) or, when set to True, more like Python’s functions.
When enabled, functions will bind to an instance when looked up as a
class attribute (hence the name) and will emulate the attributes
of Python functions, including introspections like argument names and
annotations.
Default is False.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">boundscheck</span></code>  (True / False)</dt>
<dd>If set to False, Cython is free to assume that indexing operations
([]-operator) in the code will not cause any IndexErrors to be
raised. Lists, tuples, and strings are affected only if the index
can be determined to be non-negative (or if <code class="docutils literal notranslate"><span class="pre">wraparound</span></code> is False).
Conditions which would normally trigger an IndexError may instead cause
segfaults or data corruption if this is set to False.
Default is True.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">wraparound</span></code>  (True / False)</dt>
<dd>In Python, arrays and sequences can be indexed relative to the end.
For example, A[-1] indexes the last value of a list.
In C, negative indexing is not supported.
If set to False, Cython is allowed to neither check for nor correctly
handle negative indices, possibly causing segfaults or data corruption.
If bounds checks are enabled (the default, see <code class="docutils literal notranslate"><span class="pre">boundschecks</span></code> above),
negative indexing will usually raise an <code class="docutils literal notranslate"><span class="pre">IndexError</span></code> for indices that
Cython evaluates itself.
However, these cases can be difficult to recognise in user code to
distinguish them from indexing or slicing that is evaluated by the
underlying Python array or sequence object and thus continues to support
wrap-around indices.
It is therefore safest to apply this option only to code that does not
process negative indices at all.
Default is True.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">initializedcheck</span></code> (True / False)</dt>
<dd>If set to True, Cython checks that a memoryview is initialized
whenever its elements are accessed or assigned to. Setting this
to False disables these checks.
Default is True.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">nonecheck</span></code>  (True / False)</dt>
<dd>If set to False, Cython is free to assume that native field
accesses on variables typed as an extension type, or buffer
accesses on a buffer variable, never occurs when the variable is
set to <code class="docutils literal notranslate"><span class="pre">None</span></code>. Otherwise a check is inserted and the
appropriate exception is raised. This is off by default for
performance reasons.  Default is False.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">overflowcheck</span></code> (True / False)</dt>
<dd>If set to True, raise errors on overflowing C integer arithmetic
operations.  Incurs a modest runtime penalty, but is much faster than
using Python ints.  Default is False.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">overflowcheck.fold</span></code> (True / False)</dt>
<dd>If set to True, and overflowcheck is True, check the overflow bit for
nested, side-effect-free arithmetic expressions once rather than at every
step.  Depending on the compiler, architecture, and optimization settings,
this may help or hurt performance.  A simple suite of benchmarks can be
found in <code class="docutils literal notranslate"><span class="pre">Demos/overflow_perf.pyx</span></code>.  Default is True.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">embedsignature</span></code> (True / False)</dt>
<dd>If set to True, Cython will embed a textual copy of the call
signature in the docstring of all Python visible functions and
classes. Tools like IPython and epydoc can thus display the
signature, which cannot otherwise be retrieved after
compilation.  Default is False.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cdivision</span></code> (True / False)</dt>
<dd>If set to False, Cython will adjust the remainder and quotient
operators C types to match those of Python ints (which differ when
the operands have opposite signs) and raise a
<code class="docutils literal notranslate"><span class="pre">ZeroDivisionError</span></code> when the right operand is 0. This has up to
a 35% speed penalty. If set to True, no checks are performed.  See
<a class="reference external" href="https://github.com/cython/cython/wiki/enhancements-division">CEP 516</a>.  Default
is False.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cdivision_warnings</span></code> (True / False)</dt>
<dd>If set to True, Cython will emit a runtime warning whenever
division is performed with negative operands.  See <a class="reference external" href="https://github.com/cython/cython/wiki/enhancements-division">CEP 516</a>.  Default is
False.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">always_allow_keywords</span></code> (True / False)</dt>
<dd>Avoid the <code class="docutils literal notranslate"><span class="pre">METH_NOARGS</span></code> and <code class="docutils literal notranslate"><span class="pre">METH_O</span></code> when constructing
functions/methods which take zero or one arguments. Has no effect
on special methods and functions with more than one argument. The
<code class="docutils literal notranslate"><span class="pre">METH_NOARGS</span></code> and <code class="docutils literal notranslate"><span class="pre">METH_O</span></code> signatures provide faster
calling conventions but disallow the use of keywords.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">profile</span></code> (True / False)</dt>
<dd>Write hooks for Python profilers into the compiled C code.  Default
is False.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">linetrace</span></code> (True / False)</dt>
<dd>Write line tracing hooks for Python profilers or coverage reporting
into the compiled C code.  This also enables profiling.  Default is
False.  Note that the generated module will not actually use line
tracing, unless you additionally pass the C macro definition
<code class="docutils literal notranslate"><span class="pre">CYTHON_TRACE=1</span></code> to the C compiler (e.g. using the distutils option
<code class="docutils literal notranslate"><span class="pre">define_macros</span></code>).  Define <code class="docutils literal notranslate"><span class="pre">CYTHON_TRACE_NOGIL=1</span></code> to also include
<code class="docutils literal notranslate"><span class="pre">nogil</span></code> functions and sections.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">infer_types</span></code> (True / False)</dt>
<dd>Infer types of untyped variables in function bodies. Default is
None, indicating that only safe (semantically-unchanging) inferences
are allowed.
In particular, inferring <em>integral</em> types for variables <em>used in arithmetic
expressions</em> is considered unsafe (due to possible overflow) and must be
explicitly requested.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">language_level</span></code> (2/3/3str)</dt>
<dd>Globally set the Python language level to be used for module
compilation.  Default is compatibility with Python 2.  To enable
Python 3 source code semantics, set this to 3 (or 3str) at the start
of a module or pass the “-3” or “–3str” command line options to the
compiler.  The <code class="docutils literal notranslate"><span class="pre">3str</span></code> option enables Python 3 semantics but does
not change the <code class="docutils literal notranslate"><span class="pre">str</span></code> type and unprefixed string literals to
<code class="docutils literal notranslate"><span class="pre">unicode</span></code> when the compiled code runs in Python 2.x.
Note that cimported files inherit this setting from the module
being compiled, unless they explicitly set their own language level.
Included source files always inherit this setting.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">c_string_type</span></code> (bytes / str / unicode)</dt>
<dd>Globally set the type of an implicit coercion from char* or std::string.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">c_string_encoding</span></code> (ascii, default, utf-8, etc.)</dt>
<dd>Globally set the encoding to use when implicitly coercing char* or std:string
to a unicode object.  Coercion from a unicode object to C type is only allowed
when set to <code class="docutils literal notranslate"><span class="pre">ascii</span></code> or <code class="docutils literal notranslate"><span class="pre">default</span></code>, the latter being utf-8 in Python 3 and
nearly-always ascii in Python 2.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">type_version_tag</span></code> (True / False)</dt>
<dd>Enables the attribute cache for extension types in CPython by setting the
type flag <code class="docutils literal notranslate"><span class="pre">Py_TPFLAGS_HAVE_VERSION_TAG</span></code>.  Default is True, meaning that
the cache is enabled for Cython implemented types.  To disable it
explicitly in the rare cases where a type needs to juggle with its <code class="docutils literal notranslate"><span class="pre">tp_dict</span></code>
internally without paying attention to cache consistency, this option can
be set to False.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unraisable_tracebacks</span></code> (True / False)</dt>
<dd>Whether to print tracebacks when suppressing unraisable exceptions.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">iterable_coroutine</span></code> (True / False)</dt>
<dd><a class="reference external" href="https://www.python.org/dev/peps/pep-0492/">PEP 492</a> specifies that async-def
coroutines must not be iterable, in order to prevent accidental misuse in
non-async contexts.  However, this makes it difficult and inefficient to write
backwards compatible code that uses async-def coroutines in Cython but needs to
interact with async Python code that uses the older yield-from syntax, such as
asyncio before Python 3.5.  This directive can be applied in modules or
selectively as decorator on an async-def coroutine to make the affected
coroutine(s) iterable and thus directly interoperable with yield-from.</dd>
</dl>
<div class="section" id="configurable-optimisations">
<span id="id10"></span><h5>Configurable optimisations<a class="headerlink" href="#configurable-optimisations" title="Permalink to this headline">¶</a></h5>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">optimize.use_switch</span></code> (True / False)</dt>
<dd>Whether to expand chained if-else statements (including statements like
<code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">x</span> <span class="pre">==</span> <span class="pre">1</span> <span class="pre">or</span> <span class="pre">x</span> <span class="pre">==</span> <span class="pre">2:</span></code>) into C switch statements.  This can have performance
benefits if there are lots of values but cause compiler errors if there are any
duplicate values (which may not be detectable at Cython compile time for all
C constants).  Default is True.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">optimize.unpack_method_calls</span></code> (True / False)</dt>
<dd>Cython can generate code that optimistically checks for Python method objects
at call time and unpacks the underlying function to call it directly.  This
can substantially speed up method calls, especially for builtins, but may also
have a slight negative performance impact in some cases where the guess goes
completely wrong.
Disabling this option can also reduce the code size.  Default is True.</dd>
</dl>
</div>
<div class="section" id="warnings">
<span id="id11"></span><h5>Warnings<a class="headerlink" href="#warnings" title="Permalink to this headline">¶</a></h5>
<p>All warning directives take True / False as options
to turn the warning on / off.</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">warn.undeclared</span></code> (default False)</dt>
<dd>Warns about any variables that are implicitly declared without a <code class="docutils literal notranslate"><span class="pre">cdef</span></code> declaration</dd>
<dt><code class="docutils literal notranslate"><span class="pre">warn.unreachable</span></code> (default True)</dt>
<dd>Warns about code paths that are statically determined to be unreachable, e.g.
returning twice unconditionally.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">warn.maybe_uninitialized</span></code> (default False)</dt>
<dd>Warns about use of variables that are conditionally uninitialized.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">warn.unused</span></code> (default False)</dt>
<dd>Warns about unused variables and declarations</dd>
<dt><code class="docutils literal notranslate"><span class="pre">warn.unused_arg</span></code> (default False)</dt>
<dd>Warns about unused function arguments</dd>
<dt><code class="docutils literal notranslate"><span class="pre">warn.unused_result</span></code> (default False)</dt>
<dd>Warns about unused assignment to the same name, such as
<code class="docutils literal notranslate"><span class="pre">r</span> <span class="pre">=</span> <span class="pre">2;</span> <span class="pre">r</span> <span class="pre">=</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">2</span></code></dd>
<dt><code class="docutils literal notranslate"><span class="pre">warn.multiple_declarators</span></code> (default True)</dt>
<dd>Warns about multiple variables declared on the same line with at least one pointer type.
For example <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">double*</span> <span class="pre">a,</span> <span class="pre">b</span></code> - which, as in C, declares <code class="docutils literal notranslate"><span class="pre">a</span></code> as a pointer, <code class="docutils literal notranslate"><span class="pre">b</span></code> as
a value type, but could be mininterpreted as declaring two pointers.</dd>
</dl>
</div>
<div class="section" id="how-to-set-directives">
<span id="id12"></span><h5>How to set directives<a class="headerlink" href="#how-to-set-directives" title="Permalink to this headline">¶</a></h5>
<div class="section" id="globally">
<h6>Globally<a class="headerlink" href="#globally" title="Permalink to this headline">¶</a></h6>
<p>One can set compiler directives through a special header comment near the top of the file, like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: language_level=3, boundscheck=False</span>
</pre></div>
</div>
<p>The comment must appear before any code (but can appear after other
comments or whitespace).</p>
<p>One can also pass a directive on the command line by using the -X switch:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cython</span> <span class="o">-</span><span class="n">X</span> <span class="n">boundscheck</span><span class="o">=</span><span class="bp">True</span> <span class="o">...</span>
</pre></div>
</div>
<p>Directives passed on the command line will override directives set in
header comments.</p>
</div>
<div class="section" id="locally">
<h6>Locally<a class="headerlink" href="#locally" title="Permalink to this headline">¶</a></h6>
<p>For local blocks, you need to cimport the special builtin <code class="docutils literal notranslate"><span class="pre">cython</span></code>
module:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c">#!python</span>
<span class="k">cimport</span> <span class="nn">cython</span>
</pre></div>
</div>
<p>Then you can use the directives either as decorators or in a with
statement, like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c">#!python</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># turn off boundscheck for this function</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="c"># turn it temporarily on again for this block</span>
    <span class="k">with</span> <span class="n">cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">These two methods of setting directives are <strong>not</strong>
affected by overriding the directive on the command-line using the
-X option.</p>
</div>
</div>
<div class="section" id="in-setup-py">
<h6>In <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code><a class="headerlink" href="#in-setup-py" title="Permalink to this headline">¶</a></h6>
<p>Compiler directives can also be set in the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> file by passing a keyword
argument to <code class="docutils literal notranslate"><span class="pre">cythonize</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;My hello app&quot;</span><span class="p">,</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="s">&#39;hello.pyx&#39;</span><span class="p">,</span> <span class="n">compiler_directives</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;embedsignature&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This will override the default directives as specified in the <code class="docutils literal notranslate"><span class="pre">compiler_directives</span></code> dictionary.
Note that explicit per-file or local directives as explained above take precedence over the
values passed to <code class="docutils literal notranslate"><span class="pre">cythonize</span></code>.</p>
</div>
</div>
</div>
</div>
<span id="document-src/userguide/early_binding_for_speed"></span><div class="section" id="early-binding-for-speed">
<span id="id1"></span><h3>Early Binding for Speed<a class="headerlink" href="#early-binding-for-speed" title="Permalink to this headline">¶</a></h3>
<p>As a dynamic language, Python encourages a programming style of considering
classes and objects in terms of their methods and attributes, more than where
they fit into the class hierarchy.</p>
<p>This can make Python a very relaxed and comfortable language for rapid
development, but with a price - the ‘red tape’ of managing data types is
dumped onto the interpreter. At run time, the interpreter does a lot of work
searching namespaces, fetching attributes and parsing argument and keyword
tuples. This run-time ‘late binding’ is a major cause of Python’s relative
slowness compared to ‘early binding’ languages such as C++.</p>
<p>However with Cython it is possible to gain significant speed-ups through the
use of ‘early binding’ programming techniques.</p>
<p>For example, consider the following (silly) code example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Rectangle</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">x0</span><span class="p">,</span> <span class="nf">y0</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">x1</span><span class="p">,</span> <span class="nf">y1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span>

    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="mf">0</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">=</span> <span class="o">-</span><span class="n">area</span>
        <span class="k">return</span> <span class="n">area</span>

<span class="k">def</span> <span class="nf">rectArea</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">):</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rect</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
</pre></div>
</div>
<p>In the <code class="xref py py-func docutils literal notranslate"><span class="pre">rectArea()</span></code> method, the call to <code class="xref py py-meth docutils literal notranslate"><span class="pre">rect.area()</span></code> and the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">area()</span></code> method contain a lot of Python overhead.</p>
<p>However, in Cython, it is possible to eliminate a lot of this overhead in cases
where calls occur within Cython code. For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Rectangle</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">x0</span><span class="p">,</span> <span class="nf">y0</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">x1</span><span class="p">,</span> <span class="nf">y1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span>

    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="mf">0</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">=</span> <span class="o">-</span><span class="n">area</span>
        <span class="k">return</span> <span class="n">area</span>

    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_area</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">rectArea</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Rectangle</span> <span class="nf">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rect</span><span class="o">.</span><span class="n">_area</span><span class="p">()</span>
</pre></div>
</div>
<p>Here, in the Rectangle extension class, we have defined two different area
calculation methods, the efficient <code class="xref py py-meth docutils literal notranslate"><span class="pre">_area()</span></code> C method, and the
Python-callable <code class="xref py py-meth docutils literal notranslate"><span class="pre">area()</span></code> method which serves as a thin wrapper around
<code class="xref py py-meth docutils literal notranslate"><span class="pre">_area()</span></code>. Note also in the function <code class="xref py py-func docutils literal notranslate"><span class="pre">rectArea()</span></code> how we ‘early bind’
by declaring the local variable <code class="docutils literal notranslate"><span class="pre">rect</span></code> which is explicitly given the type
Rectangle. By using this declaration, instead of just dynamically assigning to
<code class="docutils literal notranslate"><span class="pre">rect</span></code>, we gain the ability to access the much more efficient C-callable
<code class="xref py py-meth docutils literal notranslate"><span class="pre">_area()</span></code> method.</p>
<p>But Cython offers us more simplicity again, by allowing us to declare
dual-access methods - methods that can be efficiently called at C level, but
can also be accessed from pure Python code at the cost of the Python access
overheads. Consider this code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Rectangle</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">x0</span><span class="p">,</span> <span class="nf">y0</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">x1</span><span class="p">,</span> <span class="nf">y1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span>

    <span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="mf">0</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">=</span> <span class="o">-</span><span class="n">area</span>
        <span class="k">return</span> <span class="n">area</span>

<span class="k">def</span> <span class="nf">rectArea</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Rectangle</span> <span class="nf">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rect</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
</pre></div>
</div>
<p>Here, we just have a single area method, declared as <a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> to make it
efficiently callable as a C function, but still accessible from pure Python
(or late-binding Cython) code.</p>
<p>If within Cython code, we have a variable already ‘early-bound’ (ie, declared
explicitly as type Rectangle, (or cast to type Rectangle), then invoking its
area method will use the efficient C code path and skip the Python overhead.
But if in Cython or regular Python code we have a regular object variable
storing a Rectangle object, then invoking the area method will require:</p>
<ul class="simple">
<li>an attribute lookup for the area method</li>
<li>packing a tuple for arguments and a dict for keywords (both empty in this case)</li>
<li>using the Python API to call the method</li>
</ul>
<p>and within the area method itself:</p>
<ul class="simple">
<li>parsing the tuple and keywords</li>
<li>executing the calculation code</li>
<li>converting the result to a python object and returning it</li>
</ul>
<p>So within Cython, it is possible to achieve massive optimisations by
using strong typing in declaration and casting of variables. For tight loops
which use method calls, and where these methods are pure C, the difference can
be huge.</p>
</div>
<span id="document-src/userguide/wrapping_CPlusPlus"></span><div class="section" id="using-c-in-cython">
<span id="wrapping-cplusplus"></span><h3>Using C++ in Cython<a class="headerlink" href="#using-c-in-cython" title="Permalink to this headline">¶</a></h3>
<div class="section" id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h4>
<p>Cython has native support for most of the C++ language.  Specifically:</p>
<ul class="simple">
<li>C++ objects can be dynamically allocated with <code class="docutils literal notranslate"><span class="pre">new</span></code> and <code class="docutils literal notranslate"><span class="pre">del</span></code> keywords.</li>
<li>C++ objects can be stack-allocated.</li>
<li>C++ classes can be declared with the new keyword <code class="docutils literal notranslate"><span class="pre">cppclass</span></code>.</li>
<li>Templated classes and functions are supported.</li>
<li>Overloaded functions are supported.</li>
<li>Overloading of C++ operators (such as operator+, operator[],…) is supported.</li>
</ul>
<div class="section" id="procedure-overview">
<h5>Procedure Overview<a class="headerlink" href="#procedure-overview" title="Permalink to this headline">¶</a></h5>
<p>The general procedure for wrapping a C++ file can now be described as follows:</p>
<ul class="simple">
<li>Specify C++ language in a <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> script or locally in a source file.</li>
<li>Create one or more <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files with <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code> blocks and
(if existing) the C++ namespace name. In these blocks:<ul>
<li>declare classes as <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">cppclass</span></code> blocks</li>
<li>declare public names (variables, methods and constructors)</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">cimport</span></code> them in one or more extension modules (<code class="docutils literal notranslate"><span class="pre">.pyx</span></code> files).</li>
</ul>
</div>
</div>
<div class="section" id="a-simple-tutorial">
<h4>A simple Tutorial<a class="headerlink" href="#a-simple-tutorial" title="Permalink to this headline">¶</a></h4>
<div class="section" id="an-example-c-api">
<h5>An example C++ API<a class="headerlink" href="#an-example-c-api" title="Permalink to this headline">¶</a></h5>
<p>Here is a tiny C++ API which we will use as an example throughout this
document. Let’s assume it will be in a header file called
<code class="file docutils literal notranslate"><span class="pre">Rectangle.h</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef RECTANGLE_H</span>
<span class="cp">#define RECTANGLE_H</span>

<span class="k">namespace</span> <span class="n">shapes</span> <span class="p">{</span>
    <span class="k">class</span> <span class="nc">Rectangle</span> <span class="p">{</span>
        <span class="k">public</span><span class="o">:</span>
            <span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">;</span>
            <span class="n">Rectangle</span><span class="p">();</span>
            <span class="n">Rectangle</span><span class="p">(</span><span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y1</span><span class="p">);</span>
            <span class="o">~</span><span class="n">Rectangle</span><span class="p">();</span>
            <span class="kt">int</span> <span class="nf">getArea</span><span class="p">();</span>
            <span class="kt">void</span> <span class="nf">getSize</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">height</span><span class="p">);</span>
            <span class="kt">void</span> <span class="nf">move</span><span class="p">(</span><span class="kt">int</span> <span class="n">dx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dy</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p>and the implementation in the file called <code class="file docutils literal notranslate"><span class="pre">Rectangle.cpp</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;Rectangle.h&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">shapes</span> <span class="p">{</span>

    <span class="c1">// Default constructor</span>
    <span class="n">Rectangle</span><span class="o">::</span><span class="n">Rectangle</span> <span class="p">()</span> <span class="p">{}</span>

    <span class="c1">// Overloaded constructor</span>
    <span class="n">Rectangle</span><span class="o">::</span><span class="n">Rectangle</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Destructor</span>
    <span class="n">Rectangle</span><span class="o">::~</span><span class="n">Rectangle</span> <span class="p">()</span> <span class="p">{}</span>

    <span class="c1">// Return the area of the rectangle</span>
    <span class="kt">int</span> <span class="n">Rectangle</span><span class="o">::</span><span class="n">getArea</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">-</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">-</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Get the size of the rectangle.</span>
    <span class="c1">// Put the size in the pointer args</span>
    <span class="kt">void</span> <span class="n">Rectangle</span><span class="o">::</span><span class="n">getSize</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="o">*</span><span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span><span class="n">height</span><span class="p">)</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Move the rectangle by dx dy</span>
    <span class="kt">void</span> <span class="n">Rectangle</span><span class="o">::</span><span class="n">move</span> <span class="p">(</span><span class="kt">int</span> <span class="n">dx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dy</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">x0</span> <span class="o">+=</span> <span class="n">dx</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">y0</span> <span class="o">+=</span> <span class="n">dy</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">+=</span> <span class="n">dx</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">+=</span> <span class="n">dy</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is pretty dumb, but should suffice to demonstrate the steps involved.</p>
</div>
<div class="section" id="declaring-a-c-class-interface">
<h5>Declaring a C++ class interface<a class="headerlink" href="#declaring-a-c-class-interface" title="Permalink to this headline">¶</a></h5>
<p>The procedure for wrapping a C++ class is quite similar to that for wrapping
normal C structs, with a couple of additions. Let’s start here by creating the
basic <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code> block:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Rectangle.h&quot;</span> <span class="n">namespace</span> <span class="s">&quot;shapes&quot;</span><span class="p">:</span>
</pre></div>
</div>
<p>This will make the C++ class def for Rectangle available. Note the namespace declaration.
Namespaces are simply used to make the fully qualified name of the object,
and can be nested (e.g. <code class="docutils literal notranslate"><span class="pre">&quot;outer::inner&quot;</span></code>) or even refer to
classes (e.g. <code class="docutils literal notranslate"><span class="pre">&quot;namespace::MyClass</span></code> to declare static members on MyClass).</p>
<div class="section" id="declare-class-with-cdef-cppclass">
<h6>Declare class with cdef cppclass<a class="headerlink" href="#declare-class-with-cdef-cppclass" title="Permalink to this headline">¶</a></h6>
<p>Now, let’s add the Rectangle class to this extern from block - just copy the
class name from Rectangle.h and adjust for Cython syntax, so now it becomes:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Rectangle.h&quot;</span> <span class="n">namespace</span> <span class="s">&quot;shapes&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cppclass</span> <span class="nf">Rectangle</span><span class="p">:</span>
</pre></div>
</div>
</div>
<div class="section" id="add-public-attributes">
<h6>Add public attributes<a class="headerlink" href="#add-public-attributes" title="Permalink to this headline">¶</a></h6>
<p>We now need to declare the attributes and methods for use on Cython. We put those declarations
in a file called <code class="file docutils literal notranslate"><span class="pre">Rectangle.pxd</span></code>. You can see it as a header file
which is readable by Cython:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Rectangle.cpp&quot;</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c"># Declare the class with cdef</span>
<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Rectangle.h&quot;</span> <span class="n">namespace</span> <span class="s">&quot;shapes&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cppclass</span> <span class="nf">Rectangle</span><span class="p">:</span>
        <span class="n">Rectangle</span><span class="p">()</span> <span class="k">except</span> <span class="o">+</span>
        <span class="n">Rectangle</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">except</span> <span class="o">+</span>
        <span class="nb">int</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span>
        <span class="nb">int</span> <span class="n">getArea</span><span class="p">()</span>
        <span class="n">void</span> <span class="n">getSize</span><span class="p">(</span><span class="nb">int</span><span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">void</span> <span class="n">move</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the constructor is declared as “except +”. If the C++ code or
the initial memory allocation raises an exception due to a failure, this
will let Cython safely raise an appropriate Python exception instead
(see below).  Without this declaration, C++ exceptions originating from
the constructor will not be handled by Cython.</p>
<p>We use the lines:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Rectangle.cpp&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>to include the C++ code from <code class="file docutils literal notranslate"><span class="pre">Rectangle.cpp</span></code>. It is also possible to specify to
distutils that <code class="file docutils literal notranslate"><span class="pre">Rectangle.cpp</span></code> is a source. To do that, you can add this directive at the
top of the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> (not <code class="docutils literal notranslate"><span class="pre">.pxd</span></code>) file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: sources = Rectangle.cpp</span>
</pre></div>
</div>
<p>Note that when you use <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code>, the path that you specify is relative to the current
file, but if you use the distutils directive, the path is relative to the
<code class="file docutils literal notranslate"><span class="pre">setup.py</span></code>. If you want to discover the path of the sources when
running the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code>, you can use the <code class="docutils literal notranslate"><span class="pre">aliases</span></code> argument
of the <code class="xref py py-func docutils literal notranslate"><span class="pre">cythonize()</span></code> function.</p>
</div>
<div class="section" id="declare-a-var-with-the-wrapped-c-class">
<h6>Declare a var with the wrapped C++ class<a class="headerlink" href="#declare-a-var-with-the-wrapped-c-class" title="Permalink to this headline">¶</a></h6>
<p>We’ll create a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file named <code class="docutils literal notranslate"><span class="pre">rect.pyx</span></code> to build our wrapper. We’re
using a name other than <code class="docutils literal notranslate"><span class="pre">Rectangle</span></code>, but if you prefer giving the same name
to the wrapper as the C++ class, see the section on
<a class="reference internal" href="index.html#resolve-conflicts"><span class="std std-ref">resolving naming conflicts</span></a>.</p>
<p>Within, we use cdef to declare a var of the class with the C++ <code class="docutils literal notranslate"><span class="pre">new</span></code> statement:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">Rectangle</span> <span class="k">cimport</span> <span class="n">Rectangle</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">rec_ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Rectangle</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="mf">4</span><span class="p">)</span>  <span class="c"># Instantiate a Rectangle object on the heap</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rec_area</span> <span class="o">=</span> <span class="n">rec_ptr</span><span class="o">.</span><span class="n">getArea</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">rec_ptr</span>  <span class="c"># delete heap allocated object</span>

    <span class="k">cdef</span> <span class="kt">Rectangle</span> <span class="nf">rec_stack</span>  <span class="c"># Instantiate a Rectangle object on the stack</span>
</pre></div>
</div>
<p>The line:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>
</pre></div>
</div>
<p>is to indicate to Cython that this <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file has to be compiled to C++.</p>
<p>It’s also possible to declare a stack allocated object, as long as it has
a “default” constructor:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Foo.h&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cppclass</span> <span class="nf">Foo</span><span class="p">:</span>
        <span class="n">Foo</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">Foo</span> <span class="nf">foo</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Note that, like C++, if the class has only one constructor and it
is a nullary one, it’s not necessary to declare it.</p>
</div>
</div>
<div class="section" id="create-cython-wrapper-class">
<h5>Create Cython wrapper class<a class="headerlink" href="#create-cython-wrapper-class" title="Permalink to this headline">¶</a></h5>
<p>At this point, we have exposed into our pyx file’s namespace the interface
of the C++ Rectangle type.  Now, we need to make this accessible from
external Python code (which is our whole point).</p>
<p>Common programming practice is to create a Cython extension type which
holds a C++ instance as an attribute and create a bunch of
forwarding methods. So we can implement the Python extension type as:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">Rectangle</span> <span class="k">cimport</span> <span class="n">Rectangle</span>

<span class="c"># Create a Cython extension type which holds a C++ instance</span>
<span class="c"># as an attribute and create a bunch of forwarding methods</span>
<span class="c"># Python extension type.</span>
<span class="k">cdef</span> <span class="k">class</span> <span class="nf">PyRectangle</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">Rectangle</span> <span class="nf">c_rect</span>  <span class="c"># Hold a C++ instance which we&#39;re wrapping</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">getArea</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">width</span><span class="p">,</span> <span class="nf">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">getSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
</pre></div>
</div>
<p>And there we have it. From a Python perspective, this extension type will look
and feel just like a natively defined Rectangle class.
It should be noted that if you want to give
attribute access, you could just implement some properties:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">Rectangle</span> <span class="k">cimport</span> <span class="n">Rectangle</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">PyRectangle</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">Rectangle</span> <span class="nf">c_rect</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">getArea</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">width</span><span class="p">,</span> <span class="nf">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">getSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>

    <span class="c"># Attribute access</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">x0</span>
    <span class="nd">@x0</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">x0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>

    <span class="c"># Attribute access</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">x1</span>
    <span class="nd">@x1</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">x1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span>

    <span class="c"># Attribute access</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">y0</span>
    <span class="nd">@y0</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">y0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>

    <span class="c"># Attribute access</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">y1</span>
    <span class="nd">@y1</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">y1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span>
</pre></div>
</div>
<p>Cython initializes C++ class attributes of a cdef class using the nullary constructor.
If the class you’re wrapping does not have a nullary constructor, you must store a pointer
to the wrapped class and manually allocate and deallocate it.
A convenient and safe place to do so is in the <cite>__cinit__</cite> and <cite>__dealloc__</cite> methods
which are guaranteed to be called exactly once upon creation and deletion of the Python
instance.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">Rectangle</span> <span class="k">cimport</span> <span class="n">Rectangle</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">PyRectangle</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">Rectangle</span>*<span class="nf">c_rect</span>  <span class="c"># hold a pointer to the C++ instance which we&#39;re wrapping</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dealloc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_rect</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="compilation-and-importing">
<h4>Compilation and Importing<a class="headerlink" href="#compilation-and-importing" title="Permalink to this headline">¶</a></h4>
<p>To compile a Cython module, it is necessary to have a <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>

<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;rect.pyx&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>Run <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">build_ext</span> <span class="pre">--inplace</span></code></p>
<p>To test it, open the Python interpreter:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">rect</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="mf">4</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">rect_obj</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">PyRectangle</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">rect_obj</span><span class="p">))</span>
<span class="p">[</span><span class="s">&#39;__class__&#39;</span><span class="p">,</span> <span class="s">&#39;__delattr__&#39;</span><span class="p">,</span> <span class="s">&#39;__dir__&#39;</span><span class="p">,</span> <span class="s">&#39;__doc__&#39;</span><span class="p">,</span> <span class="s">&#39;__eq__&#39;</span><span class="p">,</span> <span class="s">&#39;__format__&#39;</span><span class="p">,</span> <span class="s">&#39;__ge__&#39;</span><span class="p">,</span>
 <span class="s">&#39;__getattribute__&#39;</span><span class="p">,</span> <span class="s">&#39;__gt__&#39;</span><span class="p">,</span> <span class="s">&#39;__hash__&#39;</span><span class="p">,</span> <span class="s">&#39;__init__&#39;</span><span class="p">,</span> <span class="s">&#39;__init_subclass__&#39;</span><span class="p">,</span> <span class="s">&#39;__le__&#39;</span><span class="p">,</span>
 <span class="s">&#39;__lt__&#39;</span><span class="p">,</span> <span class="s">&#39;__ne__&#39;</span><span class="p">,</span> <span class="s">&#39;__new__&#39;</span><span class="p">,</span> <span class="s">&#39;__reduce__&#39;</span><span class="p">,</span> <span class="s">&#39;__reduce_ex__&#39;</span><span class="p">,</span> <span class="s">&#39;__repr__&#39;</span><span class="p">,</span> <span class="s">&#39;__setattr__&#39;</span><span class="p">,</span>
 <span class="s">&#39;__setstate__&#39;</span><span class="p">,</span> <span class="s">&#39;__sizeof__&#39;</span><span class="p">,</span> <span class="s">&#39;__str__&#39;</span><span class="p">,</span> <span class="s">&#39;__subclasshook__&#39;</span><span class="p">,</span> <span class="s">&#39;get_area&#39;</span><span class="p">,</span> <span class="s">&#39;get_size&#39;</span><span class="p">,</span> <span class="s">&#39;move&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="advanced-c-features">
<h4>Advanced C++ features<a class="headerlink" href="#advanced-c-features" title="Permalink to this headline">¶</a></h4>
<p>We describe here all the C++ features that were not discussed in the above tutorial.</p>
<div class="section" id="overloading">
<h5>Overloading<a class="headerlink" href="#overloading" title="Permalink to this headline">¶</a></h5>
<p>Overloading is very simple. Just declare the method with different parameters
and use any of them:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Foo.h&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cppclass</span> <span class="nf">Foo</span><span class="p">:</span>
        <span class="n">Foo</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Foo</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">Foo</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">Foo</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="overloading-operators">
<h5>Overloading operators<a class="headerlink" href="#overloading-operators" title="Permalink to this headline">¶</a></h5>
<p>Cython uses C++ naming for overloading operators:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;foo.h&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cppclass</span> <span class="nf">Foo</span><span class="p">:</span>
        <span class="n">Foo</span><span class="p">()</span>
        <span class="n">Foo</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
        <span class="n">Foo</span> <span class="n">operator</span><span class="o">-</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
        <span class="nb">int</span> <span class="n">operator</span><span class="o">*</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
        <span class="nb">int</span> <span class="n">operator</span><span class="o">/</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="nb">int</span> <span class="n">operator</span><span class="o">*</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Foo</span><span class="p">)</span> <span class="c"># allows 1*Foo()</span>
    <span class="c"># nonmember operators can also be specified outside the class</span>
    <span class="n">double</span> <span class="n">operator</span><span class="o">/</span><span class="p">(</span><span class="n">double</span><span class="p">,</span> <span class="n">Foo</span><span class="p">)</span>


<span class="k">cdef</span> <span class="kt">Foo</span> <span class="nf">foo</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Foo</span><span class="p">()</span>

<span class="n">foo2</span> <span class="o">=</span> <span class="n">foo</span> <span class="o">+</span> <span class="n">foo</span>
<span class="n">foo2</span> <span class="o">=</span> <span class="n">foo</span> <span class="o">-</span> <span class="n">foo</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">foo</span> <span class="o">*</span> <span class="n">foo2</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">foo</span> <span class="o">/</span> <span class="mf">1</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">foo</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">foo2</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">foo</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1</span>
<span class="n">x</span> <span class="o">=</span> <span class="mf">1</span><span class="o">*</span><span class="n">foo</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">y</span>
<span class="n">y</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">foo</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that if one has <em>pointers</em> to C++ objects, dereferencing must be done
to avoid doing pointer arithmetic rather than arithmetic on the objects
themselves:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">Foo</span>* <span class="nf">foo_ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Foo</span><span class="p">()</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">foo_ptr</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">foo_ptr</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">foo_ptr</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2</span>

<span class="k">del</span> <span class="n">foo_ptr</span>
</pre></div>
</div>
</div>
<div class="section" id="nested-class-declarations">
<h5>Nested class declarations<a class="headerlink" href="#nested-class-declarations" title="Permalink to this headline">¶</a></h5>
<p>C++ allows nested class declaration. Class declarations can also be
nested in Cython:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;&lt;vector&gt;&quot;</span> <span class="n">namespace</span> <span class="s">&quot;std&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cppclass</span> <span class="kt">vector</span>[<span class="kt">T</span>]<span class="p">:</span>
        <span class="n">cppclass</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">T</span> <span class="n">operator</span><span class="o">*</span><span class="p">()</span>
            <span class="n">iterator</span> <span class="n">operator</span><span class="o">++</span><span class="p">()</span>
            <span class="n">bint</span> <span class="n">operator</span><span class="o">==</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="n">bint</span> <span class="n">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">()</span>
        <span class="n">void</span> <span class="n">push_back</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="p">)</span>
        <span class="n">T</span><span class="o">&amp;</span> <span class="n">operator</span><span class="p">[](</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">T</span><span class="o">&amp;</span> <span class="n">at</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">iterator</span> <span class="n">begin</span><span class="p">()</span>
        <span class="n">iterator</span> <span class="n">end</span><span class="p">()</span>

<span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>].<span class="kt">iterator</span> <span class="nf">iter</span>  <span class="c">#iter is declared as being of type vector&lt;int&gt;::iterator</span>
</pre></div>
</div>
<p>Note that the nested class is declared with a <code class="docutils literal notranslate"><span class="pre">cppclass</span></code> but without a <code class="docutils literal notranslate"><span class="pre">cdef</span></code>,
as it is already part of a <code class="docutils literal notranslate"><span class="pre">cdef</span></code> declaration section.</p>
</div>
<div class="section" id="c-operators-not-compatible-with-python-syntax">
<h5>C++ operators not compatible with Python syntax<a class="headerlink" href="#c-operators-not-compatible-with-python-syntax" title="Permalink to this headline">¶</a></h5>
<p>Cython tries to keep its syntax as close as possible to standard Python.
Because of this, certain C++ operators, like the preincrement <code class="docutils literal notranslate"><span class="pre">++foo</span></code>
or the dereferencing operator <code class="docutils literal notranslate"><span class="pre">*foo</span></code> cannot be used with the same
syntax as C++. Cython provides functions replacing these operators in
a special module <code class="docutils literal notranslate"><span class="pre">cython.operator</span></code>. The functions provided are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">cython.operator.dereference</span></code> for dereferencing. <code class="docutils literal notranslate"><span class="pre">dereference(foo)</span></code>
will produce the C++ code <code class="docutils literal notranslate"><span class="pre">*(foo)</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">cython.operator.preincrement</span></code> for pre-incrementation. <code class="docutils literal notranslate"><span class="pre">preincrement(foo)</span></code>
will produce the C++ code <code class="docutils literal notranslate"><span class="pre">++(foo)</span></code>.
Similarly for <code class="docutils literal notranslate"><span class="pre">predecrement</span></code>, <code class="docutils literal notranslate"><span class="pre">postincrement</span></code> and <code class="docutils literal notranslate"><span class="pre">postdecrement</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">cython.operator.comma</span></code> for the comma operator. <code class="docutils literal notranslate"><span class="pre">comma(a,</span> <span class="pre">b)</span></code>
will produce the C++ code <code class="docutils literal notranslate"><span class="pre">((a),</span> <span class="pre">(b))</span></code>.</li>
</ul>
<p>These functions need to be cimported. Of course, one can use a
<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">...</span> <span class="pre">cimport</span> <span class="pre">...</span> <span class="pre">as</span></code> to have shorter and more readable functions.
For example: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">cython.operator</span> <span class="pre">cimport</span> <span class="pre">dereference</span> <span class="pre">as</span> <span class="pre">deref</span></code>.</p>
<p>For completeness, it’s also worth mentioning <code class="docutils literal notranslate"><span class="pre">cython.operator.address</span></code>
which can also be written <code class="docutils literal notranslate"><span class="pre">&amp;foo</span></code>.</p>
</div>
<div class="section" id="templates">
<h5>Templates<a class="headerlink" href="#templates" title="Permalink to this headline">¶</a></h5>
<p>Cython uses a bracket syntax for templating. A simple example for wrapping C++ vector:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="c"># import dereference and increment operators</span>
<span class="k">from</span> <span class="nn">cython.operator</span> <span class="k">cimport</span> <span class="n">dereference</span> <span class="k">as</span> <span class="n">deref</span><span class="p">,</span> <span class="n">preincrement</span> <span class="k">as</span> <span class="n">inc</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;&lt;vector&gt;&quot;</span> <span class="n">namespace</span> <span class="s">&quot;std&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cppclass</span> <span class="kt">vector</span>[<span class="kt">T</span>]<span class="p">:</span>
        <span class="n">cppclass</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">T</span> <span class="n">operator</span><span class="o">*</span><span class="p">()</span>
            <span class="n">iterator</span> <span class="n">operator</span><span class="o">++</span><span class="p">()</span>
            <span class="n">bint</span> <span class="n">operator</span><span class="o">==</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="n">bint</span> <span class="n">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">()</span>
        <span class="n">void</span> <span class="n">push_back</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="p">)</span>
        <span class="n">T</span><span class="o">&amp;</span> <span class="n">operator</span><span class="p">[](</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">T</span><span class="o">&amp;</span> <span class="n">at</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">iterator</span> <span class="n">begin</span><span class="p">()</span>
        <span class="n">iterator</span> <span class="n">end</span><span class="p">()</span>

<span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>] *<span class="nf">v</span> <span class="o">=</span> <span class="n">new</span> <span class="n">vector</span><span class="p">[</span><span class="nb">int</span><span class="p">]()</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">10</span><span class="p">):</span>
    <span class="n">v</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>].<span class="kt">iterator</span> <span class="nf">it</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="k">while</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">v</span><span class="o">.</span><span class="n">end</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">deref</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
    <span class="n">inc</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>

<span class="k">del</span> <span class="n">v</span>
</pre></div>
</div>
<p>Multiple template parameters can be defined as a list, such as <code class="docutils literal notranslate"><span class="pre">[T,</span> <span class="pre">U,</span> <span class="pre">V]</span></code>
or <code class="docutils literal notranslate"><span class="pre">[int,</span> <span class="pre">bool,</span> <span class="pre">char]</span></code>.  Optional template parameters can be indicated
by writing <code class="docutils literal notranslate"><span class="pre">[T,</span> <span class="pre">U,</span> <span class="pre">V=*]</span></code>.  In the event that Cython needs to explicitly
reference the type of a default template parameter for an incomplete template
instantiation, it will write <code class="docutils literal notranslate"><span class="pre">MyClass&lt;T,</span> <span class="pre">U&gt;::V</span></code>, so if the class provides
a typedef for its template parameters it is preferable to use that name here.</p>
<p>Template functions are defined similarly to class templates, with
the template parameter list following the function name:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;&lt;algorithm&gt;&quot;</span> <span class="n">namespace</span> <span class="s">&quot;std&quot;</span><span class="p">:</span>
    <span class="n">T</span> <span class="nb">max</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">T</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="n">b</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="nb">max</span><span class="p">[</span><span class="nb">long</span><span class="p">](</span><span class="mf">3</span><span class="p">,</span> <span class="mf">4</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>  <span class="c"># simple template argument deduction</span>
</pre></div>
</div>
</div>
<div class="section" id="standard-library">
<h5>Standard library<a class="headerlink" href="#standard-library" title="Permalink to this headline">¶</a></h5>
<p>Most of the containers of the C++ Standard Library have been declared
in pxd files located
in <a class="reference external" href="https://github.com/cython/cython/tree/master/Cython/Includes/libcpp">/Cython/Includes/libcpp</a>.
These containers are: deque, list, map,  pair,  queue,  set,  stack,  vector.</p>
<p>For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">libcpp.vector</span> <span class="k">cimport</span> <span class="n">vector</span>

<span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>] <span class="nf">vect</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">x</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">10</span><span class="p">):</span>
    <span class="n">vect</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">10</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">vect</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vect</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>The pxd files
in <a class="reference external" href="https://github.com/cython/cython/tree/master/Cython/Includes/libcpp">/Cython/Includes/libcpp</a>
also work as good examples on how to declare C++ classes.</p>
<p>The STL containers coerce from and to the
corresponding Python builtin types.  The conversion is triggered
either by an assignment to a typed variable (including typed function
arguments) or by an explicit cast, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">libcpp.string</span> <span class="k">cimport</span> <span class="n">string</span>
<span class="k">from</span> <span class="nn">libcpp.vector</span> <span class="k">cimport</span> <span class="n">vector</span>

<span class="n">py_bytes_object</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;The knights who say ni&#39;</span>
<span class="n">py_unicode_object</span> <span class="o">=</span> <span class="s">u&#39;Those who hear them seldom live to tell the tale.&#39;</span>

<span class="k">cdef</span> <span class="kt">string</span> <span class="nf">s</span> <span class="o">=</span> <span class="n">py_bytes_object</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c"># b&#39;The knights who say ni&#39;</span>

<span class="k">cdef</span> <span class="kt">string</span> <span class="nf">cpp_string</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">py_unicode_object</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">cpp_string</span><span class="p">)</span>  <span class="c"># b&#39;Those who hear them seldom live to tell the tale.&#39;</span>

<span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>] <span class="nf">vect</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="mf">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">vect</span><span class="p">)</span>  <span class="c"># [1, 3, 5, 7, 9]</span>

<span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">string</span>] <span class="nf">cpp_strings</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;It is a good shrubbery&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">cpp_strings</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span>   <span class="c"># b&#39;is&#39;</span>
</pre></div>
</div>
<p>The following coercions are available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="31%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Python type =&gt;</th>
<th class="head"><em>C++ type</em></th>
<th class="head">=&gt; Python type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>bytes</td>
<td>std::string</td>
<td>bytes</td>
</tr>
<tr class="row-odd"><td>iterable</td>
<td>std::vector</td>
<td>list</td>
</tr>
<tr class="row-even"><td>iterable</td>
<td>std::list</td>
<td>list</td>
</tr>
<tr class="row-odd"><td>iterable</td>
<td>std::set</td>
<td>set</td>
</tr>
<tr class="row-even"><td>iterable (len 2)</td>
<td>std::pair</td>
<td>tuple (len 2)</td>
</tr>
</tbody>
</table>
<p>All conversions create a new container and copy the data into it.
The items in the containers are converted to a corresponding type
automatically, which includes recursively converting containers
inside of containers, e.g. a C++ vector of maps of strings.</p>
<p>Iteration over stl containers (or indeed any class with <code class="docutils literal notranslate"><span class="pre">begin()</span></code> and
<code class="docutils literal notranslate"><span class="pre">end()</span></code> methods returning an object supporting incrementing, dereferencing,
and comparison) is supported via the <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">..</span> <span class="pre">in</span></code> syntax (including in list
comprehensions).  For example, one can write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">libcpp.vector</span> <span class="k">cimport</span> <span class="n">vector</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>] <span class="nf">v</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4</span><span class="p">,</span> <span class="mf">6</span><span class="p">,</span> <span class="mf">5</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="mf">3</span><span class="p">]</span>

    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">value</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mf">2</span> <span class="o">==</span> <span class="mf">0</span><span class="p">]</span>
</pre></div>
</div>
<p>If the loop target variable is unspecified, an assignment from type
<code class="docutils literal notranslate"><span class="pre">*container.begin()</span></code> is used for <a class="reference internal" href="index.html#compiler-directives"><span class="std std-ref">type inference</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Slicing stl containers is supported,
you can do <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">x</span> <span class="pre">in</span> <span class="pre">my_vector[:5]:</span> <span class="pre">...</span></code> but unlike pointers slices,
it will create a temporary Python object and iterate over it. Thus
making the iteration very slow. You might want to avoid slicing
C++ containers for performance reasons.</p>
</div>
</div>
<div class="section" id="simplified-wrapping-with-default-constructor">
<h5>Simplified wrapping with default constructor<a class="headerlink" href="#simplified-wrapping-with-default-constructor" title="Permalink to this headline">¶</a></h5>
<p>If your extension type instantiates a wrapped C++ class using the default
constructor (not passing any arguments), you may be able to simplify the
lifecycle handling by tying it directly to the lifetime of the Python wrapper
object.  Instead of a pointer attribute, you can declare an instance:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">libcpp.vector</span> <span class="k">cimport</span> <span class="n">vector</span>


<span class="k">cdef</span> <span class="k">class</span> <span class="nf">VectorStack</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>] <span class="nf">v</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">pop_back</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>Cython will automatically generate code that instantiates the C++ object
instance when the Python object is created and deletes it when the Python
object is garbage collected.</p>
</div>
<div class="section" id="exceptions">
<h5>Exceptions<a class="headerlink" href="#exceptions" title="Permalink to this headline">¶</a></h5>
<p>Cython cannot throw C++ exceptions, or catch them with a try-except statement,
but it is possible to declare a function as potentially raising an C++
exception and converting it into a Python exception. For example,</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;some_file.h&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">foo</span><span class="p">()</span> <span class="k">except</span> <span class="o">+</span>
</pre></div>
</div>
<p>This will translate try and the C++ error into an appropriate Python exception.
The translation is performed according to the following table
(the <code class="docutils literal notranslate"><span class="pre">std::</span></code> prefix is omitted from the C++ identifiers):</p>
<table border="1" class="docutils">
<colgroup>
<col width="52%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">C++</th>
<th class="head">Python</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">bad_alloc</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">MemoryError</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">bad_cast</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">TypeError</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">bad_typeid</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">TypeError</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">domain_error</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">ValueError</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">invalid_argument</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">ValueError</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">ios_base::failure</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">IOError</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">out_of_range</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">IndexError</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">overflow_error</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">OverflowError</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">range_error</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">ArithmeticError</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">underflow_error</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">ArithmeticError</span></code></td>
</tr>
<tr class="row-even"><td>(all others)</td>
<td><code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">what()</span></code> message, if any, is preserved. Note that a C++
<code class="docutils literal notranslate"><span class="pre">ios_base_failure</span></code> can denote EOF, but does not carry enough information
for Cython to discern that, so watch out with exception masks on IO streams.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">bar</span><span class="p">()</span> <span class="k">except</span> <span class="o">+</span><span class="ne">MemoryError</span>
</pre></div>
</div>
<p>This will catch any C++ error and raise a Python MemoryError in its place.
(Any Python exception is valid here.)</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">raise_py_error</span><span class="p">()</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">something_dangerous</span><span class="p">()</span> <span class="k">except</span> <span class="o">+</span><span class="n">raise_py_error</span>
</pre></div>
</div>
<p>If something_dangerous raises a C++ exception then raise_py_error will be
called, which allows one to do custom C++ to Python error “translations.” If
raise_py_error does not actually raise an exception a RuntimeError will be
raised.</p>
<p>There is also the special form:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">raise_py_or_cpp</span><span class="p">()</span> <span class="k">except</span> <span class="o">+*</span>
</pre></div>
</div>
<p>for those functions that may raise either a Python or a C++ exception.</p>
</div>
<div class="section" id="static-member-method">
<h5>Static member method<a class="headerlink" href="#static-member-method" title="Permalink to this headline">¶</a></h5>
<p>If the Rectangle class has a static member:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="n">shapes</span> <span class="p">{</span>
    <span class="k">class</span> <span class="nc">Rectangle</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="k">static</span> <span class="kt">void</span> <span class="n">do_something</span><span class="p">();</span>

    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>you can declare it using the Python &#64;staticmethod decorator, i.e.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;Rectangle.h&quot;</span> <span class="n">namespace</span> <span class="s">&quot;shapes&quot;</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">cppclass</span> <span class="nf">Rectangle</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="nd">@staticmethod</span>
        <span class="n">void</span> <span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="declaring-using-references">
<h5>Declaring/Using References<a class="headerlink" href="#declaring-using-references" title="Permalink to this headline">¶</a></h5>
<p>Cython supports declaring lvalue references using the standard <code class="docutils literal notranslate"><span class="pre">Type&amp;</span></code> syntax.
Note, however, that it is unnecessary to declare the arguments of extern
functions as references (const or otherwise) as it has no impact on the
caller’s syntax.</p>
</div>
<div class="section" id="auto-keyword">
<h5><code class="docutils literal notranslate"><span class="pre">auto</span></code> Keyword<a class="headerlink" href="#auto-keyword" title="Permalink to this headline">¶</a></h5>
<p>Though Cython does not have an <code class="docutils literal notranslate"><span class="pre">auto</span></code> keyword, Cython local variables
not explicitly typed with <code class="docutils literal notranslate"><span class="pre">cdef</span></code> are deduced from the types of the right hand
side of <em>all</em> their assignments (see the <code class="docutils literal notranslate"><span class="pre">infer_types</span></code>
<a class="reference internal" href="index.html#compiler-directives"><span class="std std-ref">compiler directive</span></a>).  This is particularly handy
when dealing with functions that return complicated, nested, templated types,
e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">int</span>] <span class="nf">v</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">it</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
</pre></div>
</div>
<p>(Though of course the <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">..</span> <span class="pre">in</span></code> syntax is preferred for objects supporting
the iteration protocol.)</p>
</div>
</div>
<div class="section" id="rtti-and-typeid">
<h4>RTTI and typeid()<a class="headerlink" href="#rtti-and-typeid" title="Permalink to this headline">¶</a></h4>
<p>Cython has support for the <code class="docutils literal notranslate"><span class="pre">typeid(...)</span></code> operator.</p>
<blockquote>
<div>from cython.operator cimport typeid</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">typeid(...)</span></code> operator returns an object of the type <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">type_info</span> <span class="pre">&amp;</span></code>.</p>
<p>If you want to store a type_info value in a C variable, you will need to store it
as a pointer rather than a reference:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">libcpp.typeinfo</span> <span class="k">cimport</span> <span class="n">type_info</span>
<span class="k">cdef</span> <span class="kt">const</span> <span class="kt">type_info</span>* <span class="nf">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">typeid</span><span class="p">(</span><span class="n">MyClass</span><span class="p">)</span>
</pre></div>
</div>
<p>If an invalid type is passed to <code class="docutils literal notranslate"><span class="pre">typeid</span></code>, it will throw an <code class="docutils literal notranslate"><span class="pre">std::bad_typeid</span></code>
exception which is converted into a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> exception in Python.</p>
<p>An additional C++11-only RTTI-related class, <code class="docutils literal notranslate"><span class="pre">std::type_index</span></code>, is available
in <code class="docutils literal notranslate"><span class="pre">libcpp.typeindex</span></code>.</p>
</div>
<div class="section" id="specify-c-language-in-setup-py">
<h4>Specify C++ language in setup.py<a class="headerlink" href="#specify-c-language-in-setup-py" title="Permalink to this headline">¶</a></h4>
<p>Instead of specifying the language and the sources in the source files, it is
possible to declare them in the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span>
           <span class="s">&quot;rect.pyx&quot;</span><span class="p">,</span>                 <span class="c"># our Cython source</span>
           <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;Rectangle.cpp&quot;</span><span class="p">],</span>  <span class="c"># additional source file(s)</span>
           <span class="n">language</span><span class="o">=</span><span class="s">&quot;c++&quot;</span><span class="p">,</span>             <span class="c"># generate C++ code</span>
      <span class="p">))</span>
</pre></div>
</div>
<p>Cython will generate and compile the <code class="file docutils literal notranslate"><span class="pre">rect.cpp</span></code> file (from
<code class="file docutils literal notranslate"><span class="pre">rect.pyx</span></code>), then it will compile <code class="file docutils literal notranslate"><span class="pre">Rectangle.cpp</span></code>
(implementation of the <code class="docutils literal notranslate"><span class="pre">Rectangle</span></code> class) and link both object files
together into <code class="file docutils literal notranslate"><span class="pre">rect.so</span></code> on Linux, or <code class="file docutils literal notranslate"><span class="pre">rect.pyd</span></code> on windows,
which you can then import in Python using
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">rect</span></code> (if you forget to link the <code class="file docutils literal notranslate"><span class="pre">Rectangle.o</span></code>, you will
get missing symbols while importing the library in Python).</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">language</span></code> option has no effect on user provided Extension
objects that are passed into <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code>.  It is only used for modules
found by file name (as in the example above).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code> function in Cython versions up to 0.21 does not
recognize the <code class="docutils literal notranslate"><span class="pre">language</span></code> option and it needs to be specified as an
option to an <code class="xref py py-class docutils literal notranslate"><span class="pre">Extension</span></code> that describes your extension and that
is then handled by <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code> as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="n">Extension</span><span class="p">(</span>
           <span class="s">&quot;rect&quot;</span><span class="p">,</span>                                <span class="c"># the extension name</span>
           <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;rect.pyx&quot;</span><span class="p">,</span> <span class="s">&quot;Rectangle.cpp&quot;</span><span class="p">],</span> <span class="c"># the Cython source and</span>
                                                  <span class="c"># additional C++ source files</span>
           <span class="n">language</span><span class="o">=</span><span class="s">&quot;c++&quot;</span><span class="p">,</span>                        <span class="c"># generate and compile C++ code</span>
      <span class="p">)))</span>
</pre></div>
</div>
<p>The options can also be passed directly from the source file, which is
often preferable (and overrides any global option).  Starting with
version 0.17, Cython also allows passing external source files into the
<code class="docutils literal notranslate"><span class="pre">cythonize()</span></code> command this way.  Here is a simplified setup.py file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rectangleapp&quot;</span><span class="p">,</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="s">&#39;*.pyx&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>And in the .pyx source file, write this into the first comment block, before
any source code, to compile it in C++ mode and link it statically against the
<code class="file docutils literal notranslate"><span class="pre">Rectangle.cpp</span></code> code file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>
<span class="c"># distutils: sources = Rectangle.cpp</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When using distutils directives, the paths are relative to the working
directory of the distutils run (which is usually the
project root where the <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> resides).</p>
</div>
<p>To compile manually (e.g. using <code class="docutils literal notranslate"><span class="pre">make</span></code>), the <code class="docutils literal notranslate"><span class="pre">cython</span></code> command-line
utility can be used to generate a C++ <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> file, and then compile it
into a python extension.  C++ mode for the <code class="docutils literal notranslate"><span class="pre">cython</span></code> command is turned
on with the <code class="docutils literal notranslate"><span class="pre">--cplus</span></code> option.</p>
</div>
<div class="section" id="caveats-and-limitations">
<h4>Caveats and Limitations<a class="headerlink" href="#caveats-and-limitations" title="Permalink to this headline">¶</a></h4>
<div class="section" id="access-to-c-only-functions">
<h5>Access to C-only functions<a class="headerlink" href="#access-to-c-only-functions" title="Permalink to this headline">¶</a></h5>
<p>Whenever generating C++ code, Cython generates declarations of and calls
to functions assuming these functions are C++ (ie, not declared as <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span>
<span class="pre">{...}</span></code>. This is ok if the C functions have C++ entry points, but if they’re C
only, you will hit a roadblock. If you have a C++ Cython module needing
to make calls to pure-C functions, you will need to write a small C++ shim
module which:</p>
<ul class="simple">
<li>includes the needed C headers in an extern “C” block</li>
<li>contains minimal forwarding functions in C++, each of which calls the
respective pure-C function</li>
</ul>
</div>
<div class="section" id="c-left-values">
<h5>C++ left-values<a class="headerlink" href="#c-left-values" title="Permalink to this headline">¶</a></h5>
<p>C++ allows functions returning a reference to be left-values.  This is currently
not supported in Cython. <code class="docutils literal notranslate"><span class="pre">cython.operator.dereference(foo)</span></code> is also not
considered a left-value.</p>
</div>
</div>
</div>
<span id="document-src/userguide/fusedtypes"></span><div class="section" id="fused-types-templates">
<span id="fusedtypes"></span><h3>Fused Types (Templates)<a class="headerlink" href="#fused-types-templates" title="Permalink to this headline">¶</a></h3>
<p>Fused types allow you to have one type definition that can refer to multiple
types.  This allows you to write a single static-typed cython algorithm that can
operate on values of multiple types. Thus fused types allow <a class="reference external" href="https://en.wikipedia.org/wiki/Generic_programming">generic
programming</a> and are akin to templates in C++ or generics in languages like
Java / C#.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Fused types are not currently supported as attributes of extension
types.  Only variables and function/method arguments can be declared
with fused types.</p>
</div>
<div class="section" id="quickstart">
<h4>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h4>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">char_or_float</span><span class="p">:</span>
    <span class="n">char</span>
    <span class="nb">float</span>


<span class="k">cpdef</span> <span class="kt">char_or_float</span> <span class="nf">plus_one</span><span class="p">(</span><span class="n">char_or_float</span> <span class="n">var</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">var</span> <span class="o">+</span> <span class="mf">1</span>


<span class="k">def</span> <span class="nf">show_me</span><span class="p">():</span>
    <span class="n">cdef</span><span class="p">:</span>
        <span class="n">char</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">127</span>
        <span class="nb">float</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">127</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;char&#39;</span><span class="p">,</span> <span class="n">plus_one</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="n">plus_one</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
<p>This gives:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">show_me</span><span class="p">()</span>
<span class="n">char</span> <span class="o">-</span><span class="mf">128</span>
<span class="nb">float</span> <span class="mf">128.0</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">plus_one(a)</span></code> “specializes” the fused type <code class="docutils literal notranslate"><span class="pre">char_or_float</span></code> as a <code class="docutils literal notranslate"><span class="pre">char</span></code>,
whereas <code class="docutils literal notranslate"><span class="pre">plus_one(b)</span></code> specializes <code class="docutils literal notranslate"><span class="pre">char_or_float</span></code> as a <code class="docutils literal notranslate"><span class="pre">float</span></code>.</p>
</div>
<div class="section" id="declaring-fused-types">
<h4>Declaring Fused Types<a class="headerlink" href="#declaring-fused-types" title="Permalink to this headline">¶</a></h4>
<p>Fused types may be declared as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">cython</span>

<span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">my_fused_type</span><span class="p">:</span>
    <span class="n">cython</span><span class="o">.</span><span class="n">int</span>
    <span class="n">cython</span><span class="o">.</span><span class="n">double</span>
</pre></div>
</div>
<p>This declares a new type called <code class="docutils literal notranslate"><span class="pre">my_fused_type</span></code> which can be <em>either</em> an
<code class="docutils literal notranslate"><span class="pre">int</span></code> <em>or</em> a <code class="docutils literal notranslate"><span class="pre">double</span></code>.  Alternatively, the declaration may be written as:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">my_fused_type</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">fused_type</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">cython</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
</pre></div>
</div>
<p>Only names may be used for the constituent types, but they may be any
(non-fused) type, including a typedef.  i.e. one may write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="n">double</span> <span class="n">my_double</span>
<span class="n">my_fused_type</span> <span class="o">=</span> <span class="n">cython</span><span class="o">.</span><span class="n">fused_type</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">my_double</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="using-fused-types">
<h4>Using Fused Types<a class="headerlink" href="#using-fused-types" title="Permalink to this headline">¶</a></h4>
<p>Fused types can be used to declare parameters of functions or methods:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">cfunc</span><span class="p">(</span><span class="n">my_fused_type</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">arg</span> <span class="o">+</span> <span class="mf">1</span>
</pre></div>
</div>
<p>If the you use the same fused type more than once in an argument list, then each
specialization of the fused type must be the same:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">cfunc</span><span class="p">(</span><span class="n">my_fused_type</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">my_fused_type</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cython</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="o">==</span> <span class="n">cython</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, the type of both parameters is either an int, or a double
(according to the previous examples). However, because these arguments use the
same fused type <code class="docutils literal notranslate"><span class="pre">my_fused_type</span></code>, both <code class="docutils literal notranslate"><span class="pre">arg1</span></code> and <code class="docutils literal notranslate"><span class="pre">arg2</span></code> are
specialized to the same type.  Therefore this function returns True for every
possible valid invocation. You are allowed to mix fused types however:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">A</span> <span class="n">x</span><span class="p">,</span> <span class="n">B</span> <span class="n">y</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> are different fused types.  This will result in
specialized code paths for all combinations of types contained in <code class="docutils literal notranslate"><span class="pre">A</span></code>
and <code class="docutils literal notranslate"><span class="pre">B</span></code>.</p>
<div class="section" id="fused-types-and-arrays">
<h5>Fused types and arrays<a class="headerlink" href="#fused-types-and-arrays" title="Permalink to this headline">¶</a></h5>
<p>Note that specializations of only numeric types may not be very useful, as one
can usually rely on promotion of types.  This is not true for arrays, pointers
and typed views of memory however.  Indeed, one may write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myfunc</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">x</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c"># and</span>

<span class="k">cdef</span> <span class="nf">otherfunc</span><span class="p">(</span><span class="n">A</span> <span class="o">*</span><span class="n">x</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Note that in Cython 0.20.x and earlier, the compiler generated the full cross
product of all type combinations when a fused type was used by more than one
memory view in a type signature, e.g.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myfunc</span><span class="p">(</span><span class="n">A</span><span class="p">[:]</span> <span class="n">a</span><span class="p">,</span> <span class="n">A</span><span class="p">[:]</span> <span class="n">b</span><span class="p">):</span>
    <span class="c"># a and b had independent item types in Cython 0.20.x and earlier.</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This was unexpected for most users, unlikely to be desired, and also inconsistent
with other structured type declarations like C arrays of fused types, which were
considered the same type.  It was thus changed in Cython 0.21 to use the same
type for all memory views of a fused type.  In order to get the original
behaviour, it suffices to declare the same fused type under different names, and
then use these in the declarations:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">A</span><span class="p">:</span>
    <span class="nb">int</span>
    <span class="nb">long</span>

<span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">B</span><span class="p">:</span>
    <span class="nb">int</span>
    <span class="nb">long</span>

<span class="k">def</span> <span class="nf">myfunc</span><span class="p">(</span><span class="n">A</span><span class="p">[:]</span> <span class="n">a</span><span class="p">,</span> <span class="n">B</span><span class="p">[:]</span> <span class="n">b</span><span class="p">):</span>
    <span class="c"># a and b are independent types here and may have different item types</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>To get only identical types also in older Cython versions (pre-0.21), a <code class="docutils literal notranslate"><span class="pre">ctypedef</span></code>
can be used:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="n">A</span><span class="p">[:]</span> <span class="n">A_1d</span>

<span class="k">def</span> <span class="nf">myfunc</span><span class="p">(</span><span class="n">A_1d</span> <span class="n">a</span><span class="p">,</span> <span class="n">A_1d</span> <span class="n">b</span><span class="p">):</span>
    <span class="c"># a and b have identical item types here, also in older Cython versions</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="selecting-specializations">
<h4>Selecting Specializations<a class="headerlink" href="#selecting-specializations" title="Permalink to this headline">¶</a></h4>
<p>You can select a specialization (an instance of the function with specific or
specialized (i.e., non-fused) argument types) in two ways: either by indexing or
by calling.</p>
<div class="section" id="indexing">
<h5>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h5>
<p>You can index functions with types to get certain specializations, i.e.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">cfunc</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">p_double</span><span class="p">](</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

<span class="c"># From Cython space</span>
<span class="n">func</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">double</span><span class="p">](</span><span class="n">myfloat</span><span class="p">,</span> <span class="n">mydouble</span><span class="p">)</span>

<span class="c"># From Python space</span>
<span class="n">func</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">](</span><span class="n">myfloat</span><span class="p">,</span> <span class="n">mydouble</span><span class="p">)</span>
</pre></div>
</div>
<p>If a fused type is used as a base type, this will mean that the base type is the
fused type, so the base type is what needs to be specialized:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">myfunc</span><span class="p">(</span><span class="n">A</span> <span class="o">*</span><span class="n">x</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c"># Specialize using int, not int *</span>
<span class="n">myfunc</span><span class="p">[</span><span class="nb">int</span><span class="p">](</span><span class="n">myint</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="calling">
<h5>Calling<a class="headerlink" href="#calling" title="Permalink to this headline">¶</a></h5>
<p>A fused function can also be called with arguments, where the dispatch is
figured out automatically:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">cfunc</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
<span class="n">func</span><span class="p">(</span><span class="n">myfloat</span><span class="p">,</span> <span class="n">mydouble</span><span class="p">)</span>
</pre></div>
</div>
<p>For a <code class="docutils literal notranslate"><span class="pre">cdef</span></code> or <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> function called from Cython this means that the
specialization is figured out at compile time. For <code class="docutils literal notranslate"><span class="pre">def</span></code> functions the
arguments are typechecked at runtime, and a best-effort approach is performed to
figure out which specialization is needed. This means that this may result in a
runtime <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> if no specialization was found. A <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> function is
treated the same way as a <code class="docutils literal notranslate"><span class="pre">def</span></code> function if the type of the function is
unknown (e.g. if it is external and there is no cimport for it).</p>
<p>The automatic dispatching rules are typically as follows, in order of
preference:</p>
<ul class="simple">
<li>try to find an exact match</li>
<li>choose the biggest corresponding numerical type (biggest float, biggest
complex, biggest int)</li>
</ul>
</div>
</div>
<div class="section" id="built-in-fused-types">
<h4>Built-in Fused Types<a class="headerlink" href="#built-in-fused-types" title="Permalink to this headline">¶</a></h4>
<p>There are some built-in fused types available for convenience, these are:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">cython</span><span class="o">.</span><span class="n">integral</span> <span class="c"># short, int, long</span>
<span class="n">cython</span><span class="o">.</span><span class="n">floating</span> <span class="c"># float, double</span>
<span class="n">cython</span><span class="o">.</span><span class="n">numeric</span>  <span class="c"># short, int, long, float, double, float complex, double complex</span>
</pre></div>
</div>
</div>
<div class="section" id="casting-fused-functions">
<h4>Casting Fused Functions<a class="headerlink" href="#casting-fused-functions" title="Permalink to this headline">¶</a></h4>
<p>Fused <code class="docutils literal notranslate"><span class="pre">cdef</span></code> and <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> functions may be cast or assigned to C function pointers as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="nf">myfunc</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">floating</span><span class="p">,</span> <span class="n">cython</span><span class="o">.</span><span class="n">integral</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c"># assign directly</span>
<span class="k">cdef</span> <span class="nf">object</span> <span class="p">(</span><span class="o">*</span><span class="n">funcp</span><span class="p">)(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="n">funcp</span> <span class="o">=</span> <span class="n">myfunc</span>
<span class="n">funcp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

<span class="c"># alternatively, cast it</span>
<span class="p">(</span><span class="o">&lt;</span><span class="nb">object</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">myfunc</span><span class="p">)(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

<span class="c"># This is also valid</span>
<span class="n">funcp</span> <span class="o">=</span> <span class="n">myfunc</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="n">funcp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="type-checking-specializations">
<h4>Type Checking Specializations<a class="headerlink" href="#type-checking-specializations" title="Permalink to this headline">¶</a></h4>
<p>Decisions can be made based on the specializations of the fused parameters.
False conditions are pruned to avoid invalid code. One may check with <code class="docutils literal notranslate"><span class="pre">is</span></code>,
<code class="docutils literal notranslate"><span class="pre">is</span> <span class="pre">not</span></code> and <code class="docutils literal notranslate"><span class="pre">==</span></code> and <code class="docutils literal notranslate"><span class="pre">!=</span></code> to see if a fused type is equal to a certain
other non-fused type (to check the specialization), or use <code class="docutils literal notranslate"><span class="pre">in</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">in</span></code>
to figure out whether a specialization is part of another set of types
(specified as a fused type). In example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">bunch_of_types</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">string_t</span><span class="p">:</span>
    <span class="n">cython</span><span class="o">.</span><span class="n">p_char</span>
    <span class="nb">bytes</span>
    <span class="nb">unicode</span>

<span class="k">cdef</span> <span class="kt">cython</span>.<span class="kt">integral</span> <span class="nf">myfunc</span><span class="p">(</span><span class="n">cython</span><span class="o">.</span><span class="n">integral</span> <span class="n">i</span><span class="p">,</span> <span class="n">bunch_of_types</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> *<span class="nf">int_pointer</span>
    <span class="k">cdef</span> <span class="kt">long</span> *<span class="nf">long_pointer</span>

    <span class="c"># Only one of these branches will be compiled for each specialization!</span>
    <span class="k">if</span> <span class="n">cython</span><span class="o">.</span><span class="n">integral</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">int_pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">long_pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i</span>

    <span class="k">if</span> <span class="n">bunch_of_types</span> <span class="ow">in</span> <span class="n">string_t</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;s is a string!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="conditional-gil-acquiring-releasing">
<span id="fused-gil-conditional"></span><h4>Conditional GIL Acquiring / Releasing<a class="headerlink" href="#conditional-gil-acquiring-releasing" title="Permalink to this headline">¶</a></h4>
<p>Acquiring and releasing the GIL can be controlled by a condition
which is known at compile time (see <a class="reference internal" href="index.html#gil-conditional"><span class="std std-ref">Conditional Acquiring / Releasing the GIL</span></a>).</p>
<p>This is most useful when combined with fused types.
A fused type function may have to handle both cython native types
(e.g. cython.int or cython.double) and python types (e.g. object or bytes).
Conditional Acquiring / Releasing the GIL provides a method for running
the same piece of code either with the GIL released (for cython native types)
and with the GIL held (for python types).:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">cython</span>

<span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">double_or_object</span><span class="p">:</span>
    <span class="n">cython</span><span class="o">.</span><span class="n">double</span>
    <span class="nb">object</span>

<span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">double_or_object</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">with</span> <span class="k">nogil</span><span class="p">(</span><span class="n">double_or_object</span> <span class="ow">is</span> <span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">):</span>
        <span class="c"># Same code handles both cython.double (GIL is released)</span>
        <span class="c"># and python object (GIL is not released).</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">1</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="section" id="signatures">
<h4>__signatures__<a class="headerlink" href="#signatures" title="Permalink to this headline">¶</a></h4>
<p>Finally, function objects from <code class="docutils literal notranslate"><span class="pre">def</span></code> or <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> functions have an attribute
__signatures__, which maps the signature strings to the actual specialized
functions. This may be useful for inspection.  Listed signature strings may also
be used as indices to the fused function, but the index format may change between
Cython versions:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">specialized_function</span> <span class="o">=</span> <span class="n">fused_function</span><span class="p">[</span><span class="s">&quot;MyExtensionClass|int|float&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>It would usually be preferred to index like this, however:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">specialized_function</span> <span class="o">=</span> <span class="n">fused_function</span><span class="p">[</span><span class="n">MyExtensionClass</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</pre></div>
</div>
<p>Although the latter will select the biggest types for <code class="docutils literal notranslate"><span class="pre">int</span></code> and <code class="docutils literal notranslate"><span class="pre">float</span></code> from
Python space, as they are not type identifiers but builtin types there. Passing
<code class="docutils literal notranslate"><span class="pre">cython.int</span></code> and <code class="docutils literal notranslate"><span class="pre">cython.float</span></code> would resolve that, however.</p>
<p>For memoryview indexing from python space we can do the following:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">my_fused_type</span><span class="p">:</span>
    <span class="nb">int</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span>
    <span class="nb">float</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">my_fused_type</span> <span class="n">array</span><span class="p">):</span>
    <span class="o">...</span>

<span class="n">my_fused_type</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">int</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]](</span><span class="n">myarray</span><span class="p">)</span>
</pre></div>
</div>
<p>The same goes for when using e.g. <code class="docutils literal notranslate"><span class="pre">cython.numeric[:,</span> <span class="pre">:]</span></code>.</p>
</div>
</div>
<span id="document-src/userguide/pypy"></span><div class="section" id="porting-cython-code-to-pypy">
<h3>Porting Cython code to PyPy<a class="headerlink" href="#porting-cython-code-to-pypy" title="Permalink to this headline">¶</a></h3>
<p>Cython has basic support for cpyext, the layer in
<a class="reference external" href="https://pypy.org/">PyPy</a> that emulates CPython’s C-API.  This is
achieved by making the generated C code adapt at C compile time, so
the generated code will compile in both CPython and PyPy unchanged.</p>
<p>However, beyond what Cython can cover and adapt internally, the cpyext
C-API emulation involves some differences to the real C-API in CPython
that have a visible impact on user code.  This page lists major
differences and ways to deal with them in order to write Cython code
that works in both CPython and PyPy.</p>
<div class="section" id="reference-counts">
<h4>Reference counts<a class="headerlink" href="#reference-counts" title="Permalink to this headline">¶</a></h4>
<p>A general design difference in PyPy is that the runtime does not use
reference counting internally but always a garbage collector.  Reference
counting is only emulated at the cpyext layer by counting references
being held in C space.  This implies that the reference count in PyPy
is generally different from that in CPython because it does not count
any references held in Python space.</p>
</div>
<div class="section" id="object-lifetime">
<h4>Object lifetime<a class="headerlink" href="#object-lifetime" title="Permalink to this headline">¶</a></h4>
<p>As a direct consequence of the different garbage collection characteristics,
objects may see the end of their lifetime at other points than in
CPython.  Special care therefore has to be taken when objects are expected
to have died in CPython but may not in PyPy.  Specifically, a deallocator
method of an extension type (<code class="docutils literal notranslate"><span class="pre">__dealloc__()</span></code>) may get called at a much
later point than in CPython, triggered rather by memory getting tighter
than by objects dying.</p>
<p>If the point in the code is known when an object is supposed to die (e.g.
when it is tied to another object or to the execution time of a function),
it is worth considering if it can be invalidated and cleaned up manually at
that point, rather than relying on a deallocator.</p>
<p>As a side effect, this can sometimes even lead to a better code design,
e.g. when context managers can be used together with the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement.</p>
</div>
<div class="section" id="borrowed-references-and-data-pointers">
<h4>Borrowed references and data pointers<a class="headerlink" href="#borrowed-references-and-data-pointers" title="Permalink to this headline">¶</a></h4>
<p>The memory management in PyPy is allowed to move objects around in memory.
The C-API layer is only an indirect view on PyPy objects and often replicates
data or state into C space that is then tied to the lifetime of a C-API
object rather then the underlying PyPy object.  It is important to understand
that these two objects are separate things in cpyext.</p>
<p>The effect can be that when data pointers or borrowed references are used,
and the owning object is no longer directly referenced from C space, the
reference or data pointer may become invalid at some point, even if the
object itself is still alive.  As opposed to CPython, it is not enough to
keep the reference to the object alive in a list (or other Python container),
because the contents of those is only managed in Python space and thus only
references the PyPy object.  A reference in a Python container will not keep
the C-API view on it alive.  Entries in a Python class dict will obviously
not work either.</p>
<p>One of the more visible places where this may happen is when accessing the
<code class="xref c c-type docutils literal notranslate"><span class="pre">char*</span></code> buffer of a byte string.  In PyPy, this will only work as
long as the Cython code holds a direct reference to the byte string object
itself.</p>
<p>Another point is when CPython C-API functions are used directly that return
borrowed references, e.g. <a class="reference external" href="https://docs.python.org/3/c-api/tuple.html#c.PyTuple_GET_ITEM" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyTuple_GET_ITEM()</span></code></a> and similar functions,
but also some functions that return borrowed references to built-in modules or
low-level objects of the runtime environment.  The GIL in PyPy only guarantees
that the borrowed reference stays valid up to the next call into PyPy (or
its C-API), but not necessarily longer.</p>
<p>When accessing the internals of Python objects or using borrowed references
longer than up to the next call into PyPy, including reference counting or
anything that frees the GIL, it is therefore required to additionally keep
direct owned references to these objects alive in C space, e.g. in local
variables in a function or in the attributes of an extension type.</p>
<p>When in doubt, avoid using C-API functions that return borrowed references,
or surround the usage of a borrowed reference explicitly by a pair of calls
to <a class="reference external" href="https://docs.python.org/3/c-api/refcounting.html#c.Py_INCREF" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> when getting the reference and <a class="reference external" href="https://docs.python.org/3/c-api/refcounting.html#c.Py_DECREF" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a>
when done with it to convert it into an owned reference.</p>
</div>
<div class="section" id="builtin-types-slots-and-fields">
<h4>Builtin types, slots and fields<a class="headerlink" href="#builtin-types-slots-and-fields" title="Permalink to this headline">¶</a></h4>
<p>The following builtin types are not currently available in cpyext in
form of their C level representation: <a class="reference external" href="https://docs.python.org/3/c-api/complex.html#c.PyComplexObject" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyComplexObject</span></code></a>,
<a class="reference external" href="https://docs.python.org/3/c-api/float.html#c.PyFloatObject" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyFloatObject</span></code></a> and <code class="xref c c-type docutils literal notranslate"><span class="pre">PyBoolObject</span></code>.</p>
<p>Many of the type slot functions of builtin types are not initialised
in cpyext and can therefore not be used directly.</p>
<p>Similarly, almost none of the (implementation) specific struct fields of
builtin types is exposed at the C level, such as the <code class="docutils literal notranslate"><span class="pre">ob_digit</span></code> field
of <a class="reference external" href="https://docs.python.org/3/c-api/long.html#c.PyLongObject" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyLongObject</span></code></a> or the <code class="docutils literal notranslate"><span class="pre">allocated</span></code> field of the
<a class="reference external" href="https://docs.python.org/3/c-api/list.html#c.PyListObject" title="(in Python v3.7)"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyListObject</span></code></a> struct etc.  Although the <code class="docutils literal notranslate"><span class="pre">ob_size</span></code> field of
containers (used by the <code class="xref c c-func docutils literal notranslate"><span class="pre">Py_SIZE()</span></code> macro) is available, it is
not guaranteed to be accurate.</p>
<p>It is best not to access any of these struct fields and slots and to
use the normal Python types instead as well as the normal Python
protocols for object operations.  Cython will map them to an appropriate
usage of the C-API in both CPython and cpyext.</p>
</div>
<div class="section" id="gil-handling">
<h4>GIL handling<a class="headerlink" href="#gil-handling" title="Permalink to this headline">¶</a></h4>
<p>Currently, the GIL handling function <a class="reference external" href="https://docs.python.org/3/c-api/init.html#c.PyGILState_Ensure" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyGILState_Ensure()</span></code></a> is not
re-entrant in PyPy and deadlocks when called twice.  This means that
code that tries to acquire the GIL “just in case”, because it might be
called with or without the GIL, will not work as expected in PyPy.
See <a class="reference external" href="https://bitbucket.org/pypy/pypy/issues/1778">PyGILState_Ensure should not deadlock if GIL already held</a>.</p>
</div>
<div class="section" id="efficiency">
<h4>Efficiency<a class="headerlink" href="#efficiency" title="Permalink to this headline">¶</a></h4>
<p>Simple functions and especially macros that are used for speed in CPython
may exhibit substantially different performance characteristics in cpyext.</p>
<p>Functions returning borrowed references were already mentioned as requiring
special care, but they also induce substantially more runtime overhead because
they often create weak references in PyPy where they only return a plain
pointer in CPython.  A visible example is <a class="reference external" href="https://docs.python.org/3/c-api/tuple.html#c.PyTuple_GET_ITEM" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyTuple_GET_ITEM()</span></code></a>.</p>
<p>Some more high-level functions may also show entirely different performance
characteristics, e.g. <a class="reference external" href="https://docs.python.org/3/c-api/dict.html#c.PyDict_Next" title="(in Python v3.7)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyDict_Next()</span></code></a> for dict iteration.  While
being the fastest way to iterate over a dict in CPython, having linear time
complexity and a low overhead, it currently has quadratic runtime in PyPy
because it maps to normal dict iteration, which cannot keep track of the
current position between two calls and thus needs to restart the iteration
on each call.</p>
<p>The general advice applies here even more than in CPython, that it is always
best to rely on Cython generating appropriately adapted C-API handling code
for you than to use the C-API directly - unless you really know what you are
doing.  And if you find a better way of doing something in PyPy and cpyext
than Cython currently does, it’s best to fix Cython for everyone’s benefit.</p>
</div>
<div class="section" id="known-problems">
<h4>Known problems<a class="headerlink" href="#known-problems" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>As of PyPy 1.9, subtyping builtin types can result in infinite recursion
on method calls in some rare cases.</li>
<li>Docstrings of special methods are not propagated to Python space.</li>
<li>The Python 3.x adaptations in pypy3 only slowly start to include the
C-API, so more incompatibilities can be expected there.</li>
</ul>
</div>
<div class="section" id="bugs-and-crashes">
<h4>Bugs and crashes<a class="headerlink" href="#bugs-and-crashes" title="Permalink to this headline">¶</a></h4>
<p>The cpyext implementation in PyPy is much younger and substantially less
mature than the well tested C-API and its underlying native implementation
in CPython.  This should be remembered when running into crashes, as the
problem may not always be in your code or in Cython.  Also, PyPy and its
cpyext implementation are less easy to debug at the C level than CPython
and Cython, simply because they were not designed for it.</p>
</div>
</div>
<span id="document-src/userguide/limitations"></span><div class="section" id="limitations">
<span id="cython-limitations"></span><h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h3>
<p>This page used to list bugs in Cython that made the semantics of
compiled code differ from that in Python.  Most of the missing
features have been fixed in Cython 0.15.  A future version of
Cython is planned to provide full Python language compatibility.
For now, the issue tracker can provide an overview of deviations
that we are aware of and would like to see fixed.</p>
<p><a class="reference external" href="https://github.com/cython/cython/labels/Python%20Semantics">https://github.com/cython/cython/labels/Python%20Semantics</a></p>
<p>Below is a list of differences that we will probably not be addressing.
Most of these things that fall more into the implementation details rather
than semantics, and we may decide not to fix (or require a –pedantic flag to get).</p>
<div class="section" id="nested-tuple-argument-unpacking">
<h4>Nested tuple argument unpacking<a class="headerlink" href="#nested-tuple-argument-unpacking" title="Permalink to this headline">¶</a></h4>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>This was removed in Python 3.</p>
</div>
<div class="section" id="inspect-support">
<h4>Inspect support<a class="headerlink" href="#inspect-support" title="Permalink to this headline">¶</a></h4>
<p>While it is quite possible to emulate the interface of functions in
Cython’s own function type, and recent Cython releases have seen several
improvements here, the “inspect” module does not consider a Cython
implemented function a “function”, because it tests the object type
explicitly instead of comparing an abstract interface or an abstract
base class. This has a negative impact on code that uses inspect to
inspect function objects, but would require a change to Python itself.</p>
</div>
<div class="section" id="stack-frames">
<h4>Stack frames<a class="headerlink" href="#stack-frames" title="Permalink to this headline">¶</a></h4>
<p>Currently we generate fake tracebacks as part of exception propagation,
but don’t fill in locals and can’t fill in co_code.
To be fully compatible, we would have to generate these stack frame objects at
function call time (with a potential performance penalty).  We may have an
option to enable this for debugging.</p>
</div>
<div class="section" id="identity-vs-equality-for-inferred-literals">
<h4>Identity vs. equality for inferred literals<a class="headerlink" href="#identity-vs-equality-for-inferred-literals" title="Permalink to this headline">¶</a></h4>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span>          <span class="c"># a inferred to be C type &#39;double&#39;</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">None</span>     <span class="c"># b and c inferred to be type &#39;object&#39;</span>
<span class="k">if</span> <span class="n">some_runtime_expression</span><span class="p">:</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>        <span class="c"># creates a new Python float object</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span>        <span class="c"># creates a new Python float object</span>
<span class="k">print</span><span class="p">(</span><span class="n">b</span> <span class="ow">is</span> <span class="n">c</span><span class="p">)</span>     <span class="c"># most likely not the same object</span>
</pre></div>
</div>
</div>
</div>
<span id="document-src/userguide/pyrex_differences"></span><div class="section" id="differences-between-cython-and-pyrex">
<span id="pyrex-differences"></span><h3>Differences between Cython and Pyrex<a class="headerlink" href="#differences-between-cython-and-pyrex" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Both Cython and Pyrex are moving targets. It has come to the point
that an explicit list of all the differences between the two
projects would be laborious to list and track, but hopefully
this high-level list gives an idea of the differences that
are present. It should be noted that both projects make an effort
at mutual compatibility, but Cython’s goal is to be as close to
and complete as Python as reasonable.</p>
</div>
<div class="section" id="python-3-support">
<h4>Python 3 Support<a class="headerlink" href="#python-3-support" title="Permalink to this headline">¶</a></h4>
<p>Cython creates <code class="docutils literal notranslate"><span class="pre">.c</span></code> files that can be built and used with both
Python 2.x and Python 3.x. In fact, compiling your module with
Cython may very well be an easy way to port code to Python 3.</p>
<p>Cython also supports various syntax additions that came with
Python 3.0 and later major Python releases.  If they do not conflict
with existing Python 2.x syntax or semantics, they are usually just
accepted by the compiler.  Everything else depends on the
compiler directive <code class="docutils literal notranslate"><span class="pre">language_level=3</span></code>
(see <a class="reference internal" href="index.html#compiler-directives"><span class="std std-ref">compiler directives</span></a>).</p>
<div class="section" id="list-set-dict-comprehensions">
<h5>List/Set/Dict Comprehensions<a class="headerlink" href="#list-set-dict-comprehensions" title="Permalink to this headline">¶</a></h5>
<p>Cython supports the different comprehensions defined by Python 3 for
lists, sets and dicts:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">expr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>             <span class="c"># list</span>
<span class="p">{</span><span class="n">expr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">A</span><span class="p">}</span>             <span class="c"># set</span>
<span class="p">{</span><span class="n">key</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">:</span> <span class="n">value</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">A</span><span class="p">}</span>   <span class="c"># dict</span>
</pre></div>
</div>
<p>Looping is optimized if <code class="docutils literal notranslate"><span class="pre">A</span></code> is a list, tuple or dict.  You can use
the <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#for" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">for</span></code></a> … <a class="reference external" href="https://docs.python.org/3/reference/simple_stmts.html#from" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">from</span></code></a> syntax, too, but it is
generally preferred to use the usual <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#for" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">for</span></code></a> … <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#in" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">in</span></code></a>
<code class="docutils literal notranslate"><span class="pre">range(...)</span></code> syntax with a C run variable (e.g. <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">int</span> <span class="pre">i</span></code>).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">see <a class="reference internal" href="#automatic-range-conversion"><span class="std std-ref">Automatic range conversion</span></a></p>
</div>
<p>Note that Cython also supports set literals starting from Python 2.4.</p>
</div>
<div class="section" id="keyword-only-arguments">
<h5>Keyword-only arguments<a class="headerlink" href="#keyword-only-arguments" title="Permalink to this headline">¶</a></h5>
<p>Python functions can have keyword-only arguments listed after the <code class="docutils literal notranslate"><span class="pre">*</span></code>
parameter and before the <code class="docutils literal notranslate"><span class="pre">**</span></code> parameter if any, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">42</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">d</span></code> and <code class="docutils literal notranslate"><span class="pre">e</span></code> cannot be passed as position arguments and must be
passed as keyword arguments. Furthermore, <code class="docutils literal notranslate"><span class="pre">c</span></code> and <code class="docutils literal notranslate"><span class="pre">e</span></code> are required keyword
arguments, since they do not have a default value.</p>
<p>If the parameter name after the <code class="docutils literal notranslate"><span class="pre">*</span></code> is omitted, the function will not accept any
extra positional arguments, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>takes exactly two positional parameters and has two required keyword parameters.</p>
</div>
</div>
<div class="section" id="conditional-expressions-x-if-b-else-y">
<h4>Conditional expressions “x if b else y”<a class="headerlink" href="#conditional-expressions-x-if-b-else-y" title="Permalink to this headline">¶</a></h4>
<p>Conditional expressions as described in
<a class="reference external" href="https://www.python.org/dev/peps/pep-0308/">https://www.python.org/dev/peps/pep-0308/</a>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="k">if</span> <span class="n">C</span> <span class="k">else</span> <span class="n">Y</span>
</pre></div>
</div>
<p>Only one of <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">Y</span></code> is evaluated (depending on the value of C).</p>
</div>
<div class="section" id="cdef-inline">
<span id="inline"></span><h4>cdef inline<a class="headerlink" href="#cdef-inline" title="Permalink to this headline">¶</a></h4>
<p>Module level functions can now be declared inline, with the <a class="reference internal" href="#inline"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">inline</span></code></a>
keyword passed on to the C compiler. These can be as fast as macros.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">something_fast</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
<p>Note that class-level <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> functions are handled via a virtual
function table, so the compiler won’t be able to inline them in almost all
cases.</p>
</div>
<div class="section" id="assignment-on-declaration-e-g-cdef-int-spam-5">
<h4>Assignment on declaration (e.g. “cdef int spam = 5”)<a class="headerlink" href="#assignment-on-declaration-e-g-cdef-int-spam-5" title="Permalink to this headline">¶</a></h4>
<p>In Pyrex, one must write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">j</span><span class="p">,</span> <span class="nf">k</span>
<span class="n">i</span> <span class="o">=</span> <span class="mf">2</span>
<span class="n">j</span> <span class="o">=</span> <span class="mf">5</span>
<span class="n">k</span> <span class="o">=</span> <span class="mf">7</span>
</pre></div>
</div>
<p>Now, with cython, one can write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span> <span class="o">=</span> <span class="mf">2</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mf">5</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mf">7</span>
</pre></div>
</div>
<p>The expression on the right hand side can be arbitrarily complicated, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n</span> <span class="o">=</span> <span class="n">python_call</span><span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mf">32</span>
</pre></div>
</div>
</div>
<div class="section" id="by-expression-in-for-loop-e-g-for-i-from-0-i-10-by-2">
<h4>‘by’ expression in for loop (e.g. “for i from 0 &lt;= i &lt; 10 by 2”)<a class="headerlink" href="#by-expression-in-for-loop-e-g-for-i-from-0-i-10-by-2" title="Permalink to this headline">¶</a></h4>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mf">10</span> <span class="k">by</span> <span class="mf">2</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">i</span>
</pre></div>
</div>
<p>yields:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="mf">0</span>
<span class="mf">2</span>
<span class="mf">4</span>
<span class="mf">6</span>
<span class="mf">8</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Usage of this syntax is discouraged as it is redundant with the
normal Python <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#for" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">for</span></code></a> loop.
See <a class="reference internal" href="#automatic-range-conversion"><span class="std std-ref">Automatic range conversion</span></a>.</p>
</div>
</div>
<div class="section" id="boolean-int-type-e-g-it-acts-like-a-c-int-but-coerces-to-from-python-as-a-boolean">
<h4>Boolean int type (e.g. it acts like a c int, but coerces to/from python as a boolean)<a class="headerlink" href="#boolean-int-type-e-g-it-acts-like-a-c-int-but-coerces-to-from-python-as-a-boolean" title="Permalink to this headline">¶</a></h4>
<p>In C, ints are used for truth values. In python, any object can be used as a
truth value (using the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__nonzero__()</span></code> method), but the canonical choices
are the two boolean objects <code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">False</span></code>. The <code class="xref c c-type docutils literal notranslate"><span class="pre">bint</span></code> (for
“boolean int”) type is compiled to a C int, but coerces to and from
Python as booleans. The return type of comparisons and several builtins is a
<code class="xref c c-type docutils literal notranslate"><span class="pre">bint</span></code> as well. This reduces the need for wrapping things in
<code class="xref py py-func docutils literal notranslate"><span class="pre">bool()</span></code>. For example, one can write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span>
</pre></div>
</div>
<p>which would return <code class="docutils literal notranslate"><span class="pre">1</span></code> or <code class="docutils literal notranslate"><span class="pre">0</span></code> in Pyrex, but returns <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> in
Cython. One can declare variables and return values for functions to be of the
<code class="xref c c-type docutils literal notranslate"><span class="pre">bint</span></code> type.  For example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span> <span class="o">=</span> <span class="n">x</span>
<span class="k">cdef</span> <span class="kt">bint</span> <span class="nf">b</span> <span class="o">=</span> <span class="n">x</span>
</pre></div>
</div>
<p>The first conversion would happen via <code class="docutils literal notranslate"><span class="pre">x.__int__()</span></code> whereas the second would
happen via <code class="docutils literal notranslate"><span class="pre">x.__bool__()</span></code> (a.k.a. <code class="docutils literal notranslate"><span class="pre">__nonzero__()</span></code>), with appropriate
optimisations for known builtin types.</p>
</div>
<div class="section" id="executable-class-bodies">
<h4>Executable class bodies<a class="headerlink" href="#executable-class-bodies" title="Permalink to this headline">¶</a></h4>
<p>Including a working <a class="reference external" href="https://docs.python.org/3/library/functions.html#classmethod" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">classmethod()</span></code></a>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">Blah</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="bp">self</span>
    <span class="n">some_method</span> <span class="o">=</span> <span class="nb">classmethod</span><span class="p">(</span><span class="n">some_method</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">2</span><span class="o">*</span><span class="mf">3</span>
    <span class="k">print</span> <span class="s">&quot;hi&quot;</span><span class="p">,</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="section" id="cpdef-functions">
<h4>cpdef functions<a class="headerlink" href="#cpdef-functions" title="Permalink to this headline">¶</a></h4>
<p>Cython adds a third function type on top of the usual <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#def" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">def</span></code></a> and
<a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a>. If a function is declared <a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> it can be called
from and overridden by both extension and normal python subclasses. You can
essentially think of a <a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> method as a <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> method +
some extras. (That’s how it’s implemented at least.) First, it creates a
<a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#def" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">def</span></code></a> method that does nothing but call the underlying
<a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> method (and does argument unpacking/coercion if needed). At
the top of the <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> method a little bit of code is added to see
if it’s overridden, similar to the following pseudocode:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s">&#39;__dict__&#39;</span><span class="p">):</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foo</span>
    <span class="k">if</span> <span class="n">foo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">wrapper_foo</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">foo</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="p">[</span><span class="k">cdef</span> <span class="kt">method</span> <span class="kt">body</span>]
</pre></div>
</div>
<p>To detect whether or not a type has a dictionary, it just checks the
<code class="docutils literal notranslate"><span class="pre">tp_dictoffset</span></code> slot, which is <code class="docutils literal notranslate"><span class="pre">NULL</span></code> (by default) for extension types,
but non- null for instance classes. If the dictionary exists, it does a single
attribute lookup and can tell (by comparing pointers) whether or not the
returned result is actually a new function. If, and only if, it is a new
function, then the arguments packed into a tuple and the method called. This
is all very fast. A flag is set so this lookup does not occur if one calls the
method on the class directly, e.g.:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">x</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>  <span class="c"># will check to see if overridden</span>
<span class="n">A</span><span class="o">.</span><span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c"># will call A&#39;s implementation whether overridden or not</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="index.html#early-binding-for-speed"><span class="std std-ref">Early Binding for Speed</span></a> for explanation and usage tips.</p>
</div>
<div class="section" id="automatic-range-conversion">
<span id="id1"></span><h4>Automatic range conversion<a class="headerlink" href="#automatic-range-conversion" title="Permalink to this headline">¶</a></h4>
<p>This will convert statements of the form <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">range(...)</span></code> to <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span>
<span class="pre">from</span> <span class="pre">...</span></code> when <code class="docutils literal notranslate"><span class="pre">i</span></code> is any cdef’d integer type, and the direction (i.e. sign
of step) can be determined.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This may change the semantics if the range causes
assignment to <code class="docutils literal notranslate"><span class="pre">i</span></code> to overflow. Specifically, if this option is set, an error
will be raised before the loop is entered, whereas without this option the loop
will execute until a overflowing value is encountered. If this affects you,
change <code class="docutils literal notranslate"><span class="pre">Cython/Compiler/Options.py</span></code> (eventually there will be a better
way to set this).</p>
</div>
</div>
<div class="section" id="more-friendly-type-casting">
<h4>More friendly type casting<a class="headerlink" href="#more-friendly-type-casting" title="Permalink to this headline">¶</a></h4>
<p>In Pyrex, if one types <code class="docutils literal notranslate"><span class="pre">&lt;int&gt;x</span></code> where <code class="docutils literal notranslate"><span class="pre">x</span></code> is a Python object, one will get
the memory address of <code class="docutils literal notranslate"><span class="pre">x</span></code>. Likewise, if one types <code class="docutils literal notranslate"><span class="pre">&lt;object&gt;i</span></code> where <code class="docutils literal notranslate"><span class="pre">i</span></code>
is a C int, one will get an “object” at location <code class="docutils literal notranslate"><span class="pre">i</span></code> in memory. This leads
to confusing results and segfaults.</p>
<p>In Cython <code class="docutils literal notranslate"><span class="pre">&lt;type&gt;x</span></code> will try and do a coercion (as would happen on assignment of
<code class="docutils literal notranslate"><span class="pre">x</span></code> to a variable of type type) if exactly one of the types is a python object.
It does not stop one from casting where there is no conversion (though it will
emit a warning). If one really wants the address, cast to a <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code> first.</p>
<p>As in Pyrex <code class="docutils literal notranslate"><span class="pre">&lt;MyExtensionType&gt;x</span></code> will cast <code class="docutils literal notranslate"><span class="pre">x</span></code> to type <code class="xref c c-type docutils literal notranslate"><span class="pre">MyExtensionType</span></code>
without any type checking. Cython supports the syntax <code class="docutils literal notranslate"><span class="pre">&lt;MyExtensionType?&gt;</span></code> to do
the cast with type checking (i.e. it will throw an error if <code class="docutils literal notranslate"><span class="pre">x</span></code> is not a
(subclass of) <code class="xref c c-type docutils literal notranslate"><span class="pre">MyExtensionType</span></code>.</p>
</div>
<div class="section" id="optional-arguments-in-cdef-cpdef-functions">
<h4>Optional arguments in cdef/cpdef functions<a class="headerlink" href="#optional-arguments-in-cdef-cpdef-functions" title="Permalink to this headline">¶</a></h4>
<p>Cython now supports optional arguments for <a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> and
<a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> functions.</p>
<p>The syntax in the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file remains as in Python, but one declares such
functions in the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file by writing <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">foo(x=*)</span></code>. The number of
arguments may increase on subclassing, but the argument types and order must
remain the same. There is a slight performance penalty in some cases when a
cdef/cpdef function without any optional is overridden with one that does have
default argument values.</p>
<p>For example, one can have the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=*</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">C</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=*</span><span class="p">,</span> <span class="nb">int</span> <span class="n">k</span><span class="o">=*</span><span class="p">)</span>
</pre></div>
</div>
<p>with corresponding <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">A</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">C</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="k">cpdef</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">int</span> <span class="n">k</span><span class="o">=</span><span class="mf">3</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">this also demonstrates how <a class="reference internal" href="index.html#cpdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cpdef</span></code></a> functions can override
<a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> functions.</p>
</div>
</div>
<div class="section" id="function-pointers-in-structs">
<h4>Function pointers in structs<a class="headerlink" href="#function-pointers-in-structs" title="Permalink to this headline">¶</a></h4>
<p>Functions declared in <a class="reference internal" href="index.html#struct"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">struct</span></code></a> are automatically converted to
function pointers for convenience.</p>
</div>
<div class="section" id="c-exception-handling">
<h4>C++ Exception handling<a class="headerlink" href="#c-exception-handling" title="Permalink to this headline">¶</a></h4>
<p><a class="reference internal" href="index.html#cdef"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">cdef</span></code></a> functions can now be declared as:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">except</span> <span class="o">+</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">except</span> <span class="o">+</span><span class="ne">TypeError</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">except</span> <span class="o">+</span><span class="n">python_error_raising_function</span>
</pre></div>
</div>
<p>in which case a Python exception will be raised when a C++ error is caught.
See <a class="reference internal" href="index.html#wrapping-cplusplus"><span class="std std-ref">Using C++ in Cython</span></a> for more details.</p>
</div>
<div class="section" id="synonyms">
<h4>Synonyms<a class="headerlink" href="#synonyms" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">import</span> <span class="pre">from</span></code> means the same thing as <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code></p>
</div>
<div class="section" id="source-code-encoding">
<h4>Source code encoding<a class="headerlink" href="#source-code-encoding" title="Permalink to this headline">¶</a></h4>
<p>Cython supports <span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-3120"><strong>PEP 3120</strong></a> and <span class="target" id="index-1"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0263"><strong>PEP 263</strong></a>, i.e. you can start your Cython source
file with an encoding comment and generally write your source code in UTF-8.
This impacts the encoding of byte strings and the conversion of unicode string
literals like <code class="docutils literal notranslate"><span class="pre">u'abcd'</span></code> to unicode objects.</p>
</div>
<div class="section" id="automatic-typecheck">
<h4>Automatic <code class="docutils literal notranslate"><span class="pre">typecheck</span></code><a class="headerlink" href="#automatic-typecheck" title="Permalink to this headline">¶</a></h4>
<p>Rather than introducing a new keyword <code class="docutils literal notranslate"><span class="pre">typecheck</span></code> as explained in the
<a class="reference external" href="https://www.cosc.canterbury.ac.nz/greg.ewing/python/Pyrex/version/Doc/Manual/special_methods.html">Pyrex docs</a>,
Cython emits a (non-spoofable and faster) typecheck whenever
<a class="reference external" href="https://docs.python.org/3/library/functions.html#isinstance" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">isinstance()</span></code></a> is used with an extension type as the second parameter.</p>
</div>
<div class="section" id="from-future-directives">
<h4>From __future__ directives<a class="headerlink" href="#from-future-directives" title="Permalink to this headline">¶</a></h4>
<p>Cython supports several <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">__future__</span> <span class="pre">import</span> <span class="pre">...</span></code> directives, namely
<code class="docutils literal notranslate"><span class="pre">absolute_import</span></code>, <code class="docutils literal notranslate"><span class="pre">unicode_literals</span></code>, <code class="docutils literal notranslate"><span class="pre">print_function</span></code> and <code class="docutils literal notranslate"><span class="pre">division</span></code>.</p>
<p>With statements are always enabled.</p>
</div>
<div class="section" id="pure-python-mode">
<h4>Pure Python mode<a class="headerlink" href="#pure-python-mode" title="Permalink to this headline">¶</a></h4>
<p>Cython has support for compiling <code class="docutils literal notranslate"><span class="pre">.py</span></code> files, and
accepting type annotations using decorators and other
valid Python syntax. This allows the same source to
be interpreted as straight Python, or compiled for
optimized results. See <a class="reference internal" href="index.html#pure-mode"><span class="std std-ref">Pure Python Mode</span></a> for more details.</p>
</div>
</div>
<span id="document-src/userguide/memoryviews"></span><div class="section" id="typed-memoryviews">
<span id="memoryviews"></span><h3>Typed Memoryviews<a class="headerlink" href="#typed-memoryviews" title="Permalink to this headline">¶</a></h3>
<p>Typed memoryviews allow efficient access to memory buffers, such as those
underlying NumPy arrays, without incurring any Python overhead.
Memoryviews are similar to the current NumPy array buffer support
(<code class="docutils literal notranslate"><span class="pre">np.ndarray[np.float64_t,</span> <span class="pre">ndim=2]</span></code>), but
they have more features and cleaner syntax.</p>
<p>Memoryviews are more general than the old NumPy array buffer support, because
they can handle a wider variety of sources of array data.  For example, they can
handle C arrays and the Cython array type (<a class="reference internal" href="#view-cython-arrays"><span class="std std-ref">Cython arrays</span></a>).</p>
<p>A memoryview can be used in any context (function parameters, module-level, cdef
class attribute, etc) and can be obtained from nearly any object that
exposes writable buffer through the <a class="reference external" href="https://www.python.org/dev/peps/pep-3118/">PEP 3118</a> buffer interface.</p>
<div class="section" id="quickstart">
<span id="view-quickstart"></span><h4>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h4>
<p>If you are used to working with NumPy, the following examples should get you
started with Cython memory views.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cython.view</span> <span class="k">cimport</span> <span class="n">array</span> <span class="k">as</span> <span class="n">cvarray</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c"># Memoryview on a NumPy array</span>
<span class="n">narr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">27</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mf">3</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="mf">3</span><span class="p">))</span>
<span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">narr_view</span> <span class="o">=</span> <span class="n">narr</span>

<span class="c"># Memoryview on a C array</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="kt">carr</span>[3][3][3]
<span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">carr_view</span> <span class="o">=</span> <span class="n">carr</span>

<span class="c"># Memoryview on a Cython array</span>
<span class="n">cyarr</span> <span class="o">=</span> <span class="n">cvarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="mf">3</span><span class="p">),</span> <span class="n">itemsize</span><span class="o">=</span><span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">cyarr_view</span> <span class="o">=</span> <span class="n">cyarr</span>

<span class="c"># Show the sum of all the arrays before altering it</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;NumPy sum of the NumPy array before assignments: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">narr</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c"># We can copy the values from one memoryview into another using a single</span>
<span class="c"># statement, by either indexing with ... or (NumPy-style) with a colon.</span>
<span class="n">carr_view</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">narr_view</span>
<span class="n">cyarr_view</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">narr_view</span>
<span class="c"># NumPy-style syntax for assigning a single value to all elements.</span>
<span class="n">narr_view</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">3</span>

<span class="c"># Just to distinguish the arrays</span>
<span class="n">carr_view</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100</span>
<span class="n">cyarr_view</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1000</span>

<span class="c"># Assigning into the memoryview on the NumPy array alters the latter</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;NumPy sum of NumPy array after assignments: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">narr</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c"># A function using a memoryview does not usually need the GIL</span>
<span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">sum3d</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">arr</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">size_t</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">j</span><span class="p">,</span> <span class="nf">k</span><span class="p">,</span> <span class="nf">I</span><span class="p">,</span> <span class="nf">J</span><span class="p">,</span> <span class="nf">K</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">total</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">I</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total</span>

<span class="c"># A function accepting a memoryview knows how to use a NumPy array,</span>
<span class="c"># a C array, a Cython array...</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Memoryview sum of NumPy array is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sum3d</span><span class="p">(</span><span class="n">narr</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Memoryview sum of C array is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sum3d</span><span class="p">(</span><span class="n">carr</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Memoryview sum of Cython array is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sum3d</span><span class="p">(</span><span class="n">cyarr</span><span class="p">))</span>
<span class="c"># ... and of course, a memoryview.</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Memoryview sum of C memoryview is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sum3d</span><span class="p">(</span><span class="n">carr_view</span><span class="p">))</span>
</pre></div>
</div>
<p>This code should give the following output:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">NumPy</span> <span class="nb">sum</span> <span class="n">of</span> <span class="n">the</span> <span class="n">NumPy</span> <span class="n">array</span> <span class="n">before</span> <span class="n">assignments</span><span class="p">:</span> <span class="mf">351</span>
<span class="n">NumPy</span> <span class="nb">sum</span> <span class="n">of</span> <span class="n">NumPy</span> <span class="n">array</span> <span class="n">after</span> <span class="n">assignments</span><span class="p">:</span> <span class="mf">81</span>
<span class="n">Memoryview</span> <span class="nb">sum</span> <span class="n">of</span> <span class="n">NumPy</span> <span class="n">array</span> <span class="ow">is</span> <span class="mf">81</span>
<span class="n">Memoryview</span> <span class="nb">sum</span> <span class="n">of</span> <span class="n">C</span> <span class="n">array</span> <span class="ow">is</span> <span class="mf">451</span>
<span class="n">Memoryview</span> <span class="nb">sum</span> <span class="n">of</span> <span class="n">Cython</span> <span class="n">array</span> <span class="ow">is</span> <span class="mf">1351</span>
<span class="n">Memoryview</span> <span class="nb">sum</span> <span class="n">of</span> <span class="n">C</span> <span class="n">memoryview</span> <span class="ow">is</span> <span class="mf">451</span>
</pre></div>
</div>
</div>
<div class="section" id="using-memoryviews">
<h4>Using memoryviews<a class="headerlink" href="#using-memoryviews" title="Permalink to this headline">¶</a></h4>
<div class="section" id="syntax">
<h5>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h5>
<p>Memory views use Python slicing syntax in a similar way as NumPy.</p>
<p>To create a complete view on a one-dimensional int buffer:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">view1D</span> <span class="o">=</span> <span class="n">exporting_object</span>
</pre></div>
</div>
<p>A complete 3D view:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,:,:]</span> <span class="n">view3D</span> <span class="o">=</span> <span class="n">exporting_object</span>
</pre></div>
</div>
<p>They also work conveniently as function arguments:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_3d_buffer</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,:,:]</span> <span class="n">view</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">None</span></code> declaration for the argument automatically rejects
None values as input, which would otherwise be allowed.  The reason why
None is allowed by default is that it is conveniently used for return
arguments:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">process_buffer</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,:]</span> <span class="n">input_view</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="nb">int</span><span class="p">[:,:]</span> <span class="n">output_view</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

   <span class="k">if</span> <span class="n">output_view</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
       <span class="c"># Creating a default view, e.g.</span>
       <span class="n">output_view</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">input_view</span><span class="p">)</span>

   <span class="c"># process &#39;input_view&#39; into &#39;output_view&#39;</span>
   <span class="k">return</span> <span class="n">output_view</span>
</pre></div>
</div>
<p>Cython will reject incompatible buffers automatically, e.g. passing a
three dimensional buffer into a function that requires a two
dimensional buffer will raise a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
<div class="section" id="indexing">
<h5>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h5>
<p>In Cython, index access on memory views is automatically translated
into memory addresses.  The following code requests a two-dimensional
memory view of C <code class="docutils literal notranslate"><span class="pre">int</span></code> typed items and indexes into it:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,:]</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">exporting_object</span>

<span class="k">print</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="mf">2</span><span class="p">])</span>
</pre></div>
</div>
<p>Negative indices work as well, counting from the end of the respective
dimension:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span>
</pre></div>
</div>
<p>The following function loops over each dimension of a 2D array and
adds 1 to each item:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">add_one</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,:]</span> <span class="n">buf</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]):</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1</span>

<span class="c"># exporting_object must be a Python object</span>
<span class="c"># implementing the buffer interface, e.g. a numpy array.</span>
<span class="n">exporting_object</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mf">10</span><span class="p">,</span> <span class="mf">20</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>

<span class="n">add_one</span><span class="p">(</span><span class="n">exporting_object</span><span class="p">)</span>
</pre></div>
</div>
<p>Indexing and slicing can be done with or without the GIL.  It basically works
like NumPy.  If indices are specified for every dimension you will get an element
of the base type (e.g. <cite>int</cite>).  Otherwise, you will get a new view.  An Ellipsis
means you get consecutive slices for every unspecified dimension:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">exporting_object</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">15</span> <span class="o">*</span> <span class="mf">10</span> <span class="o">*</span> <span class="mf">20</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mf">15</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="mf">20</span><span class="p">))</span>

<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">my_view</span> <span class="o">=</span> <span class="n">exporting_object</span>

<span class="c"># These are all equivalent</span>
<span class="n">my_view</span><span class="p">[</span><span class="mf">10</span><span class="p">]</span>
<span class="n">my_view</span><span class="p">[</span><span class="mf">10</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">my_view</span><span class="p">[</span><span class="mf">10</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="copying">
<h5>Copying<a class="headerlink" href="#copying" title="Permalink to this headline">¶</a></h5>
<p>Memory views can be copied in place:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">to_view</span><span class="p">,</span> <span class="n">from_view</span>
<span class="n">to_view</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">20</span><span class="p">,</span> <span class="mf">15</span><span class="p">,</span> <span class="mf">30</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>
<span class="n">from_view</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mf">20</span><span class="p">,</span> <span class="mf">15</span><span class="p">,</span> <span class="mf">30</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>

<span class="c"># copy the elements in from_view to to_view</span>
<span class="n">to_view</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_view</span>
<span class="c"># or</span>
<span class="n">to_view</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">from_view</span>
<span class="c"># or</span>
<span class="n">to_view</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">from_view</span>
</pre></div>
</div>
<p>They can also be copied with the <code class="docutils literal notranslate"><span class="pre">copy()</span></code> and <code class="docutils literal notranslate"><span class="pre">copy_fortran()</span></code> methods; see
<a class="reference internal" href="#view-copy-c-fortran"><span class="std std-ref">C and Fortran contiguous copies</span></a>.</p>
</div>
<div class="section" id="transposing">
<span id="view-transposing"></span><h5>Transposing<a class="headerlink" href="#transposing" title="Permalink to this headline">¶</a></h5>
<p>In most cases (see below), the memoryview can be transposed in the same way that
NumPy slices can be transposed:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">20</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">))</span>

<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">c_contig</span> <span class="o">=</span> <span class="n">array</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="mf">1</span><span class="p">,</span> <span class="p">:]</span> <span class="n">f_contig</span> <span class="o">=</span> <span class="n">c_contig</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<p>This gives a new, transposed, view on the data.</p>
<p>Transposing requires that all dimensions of the memoryview have a
direct access memory layout (i.e., there are no indirections through pointers).
See <a class="reference internal" href="#view-general-layouts"><span class="std std-ref">Specifying more general memory layouts</span></a> for details.</p>
</div>
<div class="section" id="newaxis">
<h5>Newaxis<a class="headerlink" href="#newaxis" title="Permalink to this headline">¶</a></h5>
<p>As for NumPy, new axes can be introduced by indexing an array with <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">myslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mf">50</span><span class="p">)</span>

<span class="c"># 2D array with shape (1, 50)</span>
<span class="n">myslice</span><span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="c"># or</span>
<span class="n">myslice</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>

<span class="c"># 2D array with shape (50, 1)</span>
<span class="n">myslice</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span>

<span class="c"># 3D array with shape (1, 10, 1)</span>
<span class="n">myslice</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mf">10</span><span class="p">:</span><span class="o">-</span><span class="mf">20</span><span class="p">:</span><span class="mf">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
</pre></div>
</div>
<p>One may mix new axis indexing with all other forms of indexing and slicing.
See also an <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/arrays.indexing.html">example</a>.</p>
</div>
<div class="section" id="read-only-views">
<h5>Read-only views<a class="headerlink" href="#read-only-views" title="Permalink to this headline">¶</a></h5>
<p>Since Cython 0.28, the memoryview item type can be declared as <code class="docutils literal notranslate"><span class="pre">const</span></code> to
support read-only buffers as input:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">cdef</span> <span class="kt">const</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">myslice</span>   <span class="c"># const item type =&gt; read-only view</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mf">50</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">setflags</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">myslice</span> <span class="o">=</span> <span class="n">a</span>
</pre></div>
</div>
<p>Using a non-const memoryview with a binary Python string produces a runtime error.
You can solve this issue with a <code class="docutils literal notranslate"><span class="pre">const</span></code> memoryview:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">bint</span> <span class="nf">is_y_in</span><span class="p">(</span><span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span><span class="p">[:]</span> <span class="n">string_view</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">string_view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">string_view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">print</span><span class="p">(</span><span class="n">is_y_in</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;hello world&#39;</span><span class="p">))</span>   <span class="c"># False</span>
<span class="k">print</span><span class="p">(</span><span class="n">is_y_in</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;hello Cython&#39;</span><span class="p">))</span>  <span class="c"># True</span>
</pre></div>
</div>
<p>Note that this does not <em>require</em> the input buffer to be read-only:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mf">50</span><span class="p">)</span>
<span class="n">myslice</span> <span class="o">=</span> <span class="n">a</span>   <span class="c"># read-only view of a writable buffer</span>
</pre></div>
</div>
<p>Writable buffers are still accepted by <code class="docutils literal notranslate"><span class="pre">const</span></code> views, but read-only
buffers are not accepted for non-const, writable views:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">myslice</span>   <span class="c"># a normal read/write memory view</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mf">50</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">setflags</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">myslice</span> <span class="o">=</span> <span class="n">a</span>   <span class="c"># ERROR: requesting writable memory view from read-only buffer!</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="comparison-to-the-old-buffer-support">
<h4>Comparison to the old buffer support<a class="headerlink" href="#comparison-to-the-old-buffer-support" title="Permalink to this headline">¶</a></h4>
<p>You will probably prefer memoryviews to the older syntax because:</p>
<ul class="simple">
<li>The syntax is cleaner</li>
<li>Memoryviews do not usually need the GIL (see <a class="reference internal" href="#view-needs-gil"><span class="std std-ref">Memoryviews and the GIL</span></a>)</li>
<li>Memoryviews are considerably faster</li>
</ul>
<p>For example, this is the old syntax equivalent of the <code class="docutils literal notranslate"><span class="pre">sum3d</span></code> function above:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">old_sum3d</span><span class="p">(</span><span class="nb">object</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;strided&#39;</span><span class="p">]</span> <span class="n">arr</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">I</span><span class="p">,</span> <span class="nf">J</span><span class="p">,</span> <span class="nf">K</span><span class="p">,</span> <span class="nf">total</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">I</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
<p>Note that we can’t use <code class="docutils literal notranslate"><span class="pre">nogil</span></code> for the buffer version of the function as we
could for the memoryview version of <code class="docutils literal notranslate"><span class="pre">sum3d</span></code> above, because buffer objects
are Python objects.  However, even if we don’t use <code class="docutils literal notranslate"><span class="pre">nogil</span></code> with the
memoryview, it is significantly faster.  This is a output from an IPython
session after importing both versions:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mf">2</span><span class="p">]:</span> <span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">In</span> <span class="p">[</span><span class="mf">3</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mf">40</span><span class="p">,</span> <span class="mf">40</span><span class="p">,</span> <span class="mf">40</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mf">4</span><span class="p">]:</span> <span class="n">timeit</span> <span class="o">-</span><span class="n">r15</span> <span class="n">old_sum3d</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="mf">1000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mf">15</span><span class="p">:</span> <span class="mf">298</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span>

<span class="n">In</span> <span class="p">[</span><span class="mf">5</span><span class="p">]:</span> <span class="n">timeit</span> <span class="o">-</span><span class="n">r15</span> <span class="n">sum3d</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="mf">1000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mf">15</span><span class="p">:</span> <span class="mf">219</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span>
</pre></div>
</div>
</div>
<div class="section" id="python-buffer-support">
<h4>Python buffer support<a class="headerlink" href="#python-buffer-support" title="Permalink to this headline">¶</a></h4>
<p>Cython memoryviews support nearly all objects exporting the interface of Python
<a class="reference external" href="https://docs.python.org/3/c-api/buffer.html">new style buffers</a>.  This is the buffer interface described in <a class="reference external" href="https://www.python.org/dev/peps/pep-3118/">PEP 3118</a>.
NumPy arrays support this interface, as do <a class="reference internal" href="#view-cython-arrays"><span class="std std-ref">Cython arrays</span></a>.  The
“nearly all” is because the Python buffer interface allows the <em>elements</em> in the
data array to themselves be pointers; Cython memoryviews do not yet support
this.</p>
</div>
<div class="section" id="memory-layout">
<span id="view-memory-layout"></span><h4>Memory layout<a class="headerlink" href="#memory-layout" title="Permalink to this headline">¶</a></h4>
<p>The buffer interface allows objects to identify the underlying memory in a
variety of ways.  With the exception of pointers for data elements, Cython
memoryviews support all Python new-type buffer layouts. It can be useful to know
or specify memory layout if the memory has to be in a particular format for an
external routine, or for code optimization.</p>
<div class="section" id="background">
<h5>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h5>
<p>The concepts are as follows: there is data access and data packing. Data access
means either direct (no pointer) or indirect (pointer).  Data packing means your
data may be contiguous or not contiguous in memory, and may use <em>strides</em> to
identify the jumps in memory consecutive indices need to take for each dimension.</p>
<p>NumPy arrays provide a good model of strided direct data access, so we’ll use
them for a refresher on the concepts of C and Fortran contiguous arrays, and
data strides.</p>
</div>
<div class="section" id="brief-recap-on-c-fortran-and-strided-memory-layouts">
<h5>Brief recap on C, Fortran and strided memory layouts<a class="headerlink" href="#brief-recap-on-c-fortran-and-strided-memory-layouts" title="Permalink to this headline">¶</a></h5>
<p>The simplest data layout might be a C contiguous array.  This is the default
layout in NumPy and Cython arrays.  C contiguous means that the array data is
continuous in memory (see below) and that neighboring elements in the first
dimension of the array are furthest apart in memory, whereas neighboring
elements in the last dimension are closest together. For example, in NumPy:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mf">2</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;3&#39;</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">,</span> <span class="s">&#39;5&#39;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;S1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">arr[0,</span> <span class="pre">0]</span></code> and <code class="docutils literal notranslate"><span class="pre">arr[0,</span> <span class="pre">1]</span></code> are one byte apart in memory, whereas
<code class="docutils literal notranslate"><span class="pre">arr[0,</span> <span class="pre">0]</span></code> and <code class="docutils literal notranslate"><span class="pre">arr[1,</span> <span class="pre">0]</span></code> are 3 bytes apart.  This leads us to the idea of
<em>strides</em>.  Each axis of the array has a stride length, which is the number of
bytes needed to go from one element on this axis to the next element.  In the
case above, the strides for axes 0 and 1 will obviously be:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mf">3</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">strides</span>
<span class="n">Out</span><span class="p">[</span><span class="mf">4</span><span class="p">]:</span> <span class="p">(</span><span class="mf">3</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
</pre></div>
</div>
<p>For a 3D C contiguous array:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mf">5</span><span class="p">]:</span> <span class="n">c_contig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">24</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">4</span><span class="p">))</span>
<span class="n">In</span> <span class="p">[</span><span class="mf">6</span><span class="p">]</span> <span class="n">c_contig</span><span class="o">.</span><span class="n">strides</span>
<span class="n">Out</span><span class="p">[</span><span class="mf">6</span><span class="p">]:</span> <span class="p">(</span><span class="mf">12</span><span class="p">,</span> <span class="mf">4</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
</pre></div>
</div>
<p>A Fortran contiguous array has the opposite memory ordering, with the elements
on the first axis closest together in memory:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mf">7</span><span class="p">]:</span> <span class="n">f_contig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c_contig</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mf">8</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">f_contig</span> <span class="o">==</span> <span class="n">c_contig</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mf">8</span><span class="p">]:</span> <span class="bp">True</span>
<span class="n">In</span> <span class="p">[</span><span class="mf">9</span><span class="p">]:</span> <span class="n">f_contig</span><span class="o">.</span><span class="n">strides</span>
<span class="n">Out</span><span class="p">[</span><span class="mf">9</span><span class="p">]:</span> <span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">6</span><span class="p">)</span>
</pre></div>
</div>
<p>A contiguous array is one for which a single continuous block of memory contains
all the data for the elements of the array, and therefore the memory block
length is the product of number of elements in the array and the size of the
elements in bytes. In the example above, the memory block is 2 * 3 * 4 * 1 bytes
long, where 1 is the length of an int8.</p>
<p>An array can be contiguous without being C or Fortran order:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mf">10</span><span class="p">]:</span> <span class="n">c_contig</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mf">1</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">2</span><span class="p">))</span><span class="o">.</span><span class="n">strides</span>
<span class="n">Out</span><span class="p">[</span><span class="mf">10</span><span class="p">]:</span> <span class="p">(</span><span class="mf">4</span><span class="p">,</span> <span class="mf">12</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Slicing an NumPy array can easily make it not contiguous:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mf">11</span><span class="p">]:</span> <span class="n">sliced</span> <span class="o">=</span> <span class="n">c_contig</span><span class="p">[:,</span><span class="mf">1</span><span class="p">,:]</span>
<span class="n">In</span> <span class="p">[</span><span class="mf">12</span><span class="p">]:</span> <span class="n">sliced</span><span class="o">.</span><span class="n">strides</span>
<span class="n">Out</span><span class="p">[</span><span class="mf">12</span><span class="p">]:</span> <span class="p">(</span><span class="mf">12</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mf">13</span><span class="p">]:</span> <span class="n">sliced</span><span class="o">.</span><span class="n">flags</span>
<span class="n">Out</span><span class="p">[</span><span class="mf">13</span><span class="p">]:</span>
<span class="n">C_CONTIGUOUS</span> <span class="p">:</span> <span class="bp">False</span>
<span class="n">F_CONTIGUOUS</span> <span class="p">:</span> <span class="bp">False</span>
<span class="n">OWNDATA</span> <span class="p">:</span> <span class="bp">False</span>
<span class="n">WRITEABLE</span> <span class="p">:</span> <span class="bp">True</span>
<span class="n">ALIGNED</span> <span class="p">:</span> <span class="bp">True</span>
<span class="n">UPDATEIFCOPY</span> <span class="p">:</span> <span class="bp">False</span>
</pre></div>
</div>
</div>
<div class="section" id="default-behavior-for-memoryview-layouts">
<h5>Default behavior for memoryview layouts<a class="headerlink" href="#default-behavior-for-memoryview-layouts" title="Permalink to this headline">¶</a></h5>
<p>As you’ll see in <a class="reference internal" href="#view-general-layouts"><span class="std std-ref">Specifying more general memory layouts</span></a>, you can specify memory layout for
any dimension of an memoryview.  For any dimension for which you don’t specify a
layout, then the data access is assumed to be direct, and the data packing
assumed to be strided.  For example, that will be the assumption for memoryviews
like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">my_memoryview</span> <span class="o">=</span> <span class="n">obj</span>
</pre></div>
</div>
</div>
<div class="section" id="c-and-fortran-contiguous-memoryviews">
<span id="id1"></span><h5>C and Fortran contiguous memoryviews<a class="headerlink" href="#c-and-fortran-contiguous-memoryviews" title="Permalink to this headline">¶</a></h5>
<p>You can specify C and Fortran contiguous layouts for the memoryview by using the
<code class="docutils literal notranslate"><span class="pre">::1</span></code> step syntax at definition.  For example, if you know for sure your
memoryview will be on top of a 3D C contiguous layout, you could write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">c_contiguous</span> <span class="o">=</span> <span class="n">c_contig</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">c_contig</span></code> could be a C contiguous NumPy array.  The <code class="docutils literal notranslate"><span class="pre">::1</span></code> at the 3rd
position means that the elements in this 3rd dimension will be one element apart
in memory.  If you know you will have a 3D Fortran contiguous array:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="mf">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">f_contiguous</span> <span class="o">=</span> <span class="n">f_contig</span>
</pre></div>
</div>
<p>If you pass a non-contiguous buffer, for example</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># This array is C contiguous</span>
<span class="n">c_contig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">24</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">4</span><span class="p">))</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">c_contiguous</span> <span class="o">=</span> <span class="n">c_contig</span>

<span class="c"># But this isn&#39;t</span>
<span class="n">c_contiguous</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c_contig</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>you will get a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> at runtime:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">mb312</span><span class="o">/</span><span class="n">dev_trees</span><span class="o">/</span><span class="n">minimal</span><span class="o">-</span><span class="n">cython</span><span class="o">/</span><span class="n">mincy</span><span class="o">.</span><span class="n">pyx</span> <span class="ow">in</span> <span class="n">init</span> <span class="n">mincy</span> <span class="p">(</span><span class="n">mincy</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mf">17267</span><span class="p">)()</span>
    <span class="mf">69</span>
    <span class="mf">70</span> <span class="c"># But this isn&#39;t</span>
<span class="o">---&gt;</span> <span class="mf">71</span> <span class="n">c_contiguous</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c_contig</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
    <span class="mf">72</span>
    <span class="mf">73</span> <span class="c"># Show the sum of all the arrays before altering it</span>

<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">mb312</span><span class="o">/</span><span class="n">dev_trees</span><span class="o">/</span><span class="n">minimal</span><span class="o">-</span><span class="n">cython</span><span class="o">/</span><span class="n">stringsource</span> <span class="ow">in</span> <span class="n">View</span><span class="o">.</span><span class="n">MemoryView</span><span class="o">.</span><span class="n">memoryview_cwrapper</span> <span class="p">(</span><span class="n">mincy</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mf">9995</span><span class="p">)()</span>

<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">mb312</span><span class="o">/</span><span class="n">dev_trees</span><span class="o">/</span><span class="n">minimal</span><span class="o">-</span><span class="n">cython</span><span class="o">/</span><span class="n">stringsource</span> <span class="ow">in</span> <span class="n">View</span><span class="o">.</span><span class="n">MemoryView</span><span class="o">.</span><span class="n">memoryview</span><span class="o">.</span><span class="n">__cinit__</span> <span class="p">(</span><span class="n">mincy</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mf">6799</span><span class="p">)()</span>

<span class="ne">ValueError</span><span class="p">:</span> <span class="n">ndarray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">C</span><span class="o">-</span><span class="n">contiguous</span>
</pre></div>
</div>
<p>Thus the <cite>::1</cite> in the slice type specification indicates in which dimension the
data is contiguous.  It can only be used to specify full C or Fortran
contiguity.</p>
</div>
<div class="section" id="c-and-fortran-contiguous-copies">
<span id="view-copy-c-fortran"></span><h5>C and Fortran contiguous copies<a class="headerlink" href="#c-and-fortran-contiguous-copies" title="Permalink to this headline">¶</a></h5>
<p>Copies can be made C or Fortran contiguous using the <code class="docutils literal notranslate"><span class="pre">.copy()</span></code> and
<code class="docutils literal notranslate"><span class="pre">.copy_fortran()</span></code> methods:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># This view is C contiguous</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">c_contiguous</span> <span class="o">=</span> <span class="n">myview</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c"># This view is Fortran contiguous</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="mf">1</span><span class="p">,</span> <span class="p">:]</span> <span class="n">f_contiguous_slice</span> <span class="o">=</span> <span class="n">myview</span><span class="o">.</span><span class="n">copy_fortran</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="specifying-more-general-memory-layouts">
<span id="view-general-layouts"></span><h5>Specifying more general memory layouts<a class="headerlink" href="#specifying-more-general-memory-layouts" title="Permalink to this headline">¶</a></h5>
<p>Data layout can be specified using the previously seen <code class="docutils literal notranslate"><span class="pre">::1</span></code> slice syntax, or
by using any of the constants in <code class="docutils literal notranslate"><span class="pre">cython.view</span></code>. If no specifier is given in
any dimension, then the data access is assumed to be direct, and the data
packing assumed to be strided.  If you don’t know whether a dimension will be
direct or indirect (because you’re getting an object with a buffer interface
from some library perhaps), then you can specify the <cite>generic</cite> flag, in which
case it will be determined at runtime.</p>
<p>The flags are as follows:</p>
<ul class="simple">
<li>generic - strided and direct or indirect</li>
<li>strided - strided and direct (this is the default)</li>
<li>indirect - strided and indirect</li>
<li>contiguous - contiguous and direct</li>
<li>indirect_contiguous - the list of pointers is contiguous</li>
</ul>
<p>and they can be used like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cython</span> <span class="k">cimport</span> <span class="n">view</span>

<span class="c"># direct access in both dimensions, strided in the first dimension, contiguous in the last</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">contiguous</span><span class="p">]</span> <span class="n">a</span>

<span class="c"># contiguous list of pointers to contiguous lists of ints</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">indirect_contiguous</span><span class="p">,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">b</span>

<span class="c"># direct or indirect in the first dimension, direct in the second dimension</span>
<span class="c"># strided in both dimensions</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">generic</span><span class="p">,</span> <span class="p">:]</span> <span class="n">c</span>
</pre></div>
</div>
<p>Only the first, last or the dimension following an indirect dimension may be
specified contiguous:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cython</span> <span class="k">cimport</span> <span class="n">view</span>

<span class="c"># VALID</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">indirect</span><span class="p">,</span> <span class="p">::</span><span class="mf">1</span><span class="p">,</span> <span class="p">:]</span> <span class="n">a</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">indirect</span><span class="p">,</span> <span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">b</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">indirect_contiguous</span><span class="p">,</span> <span class="p">::</span><span class="mf">1</span><span class="p">,</span> <span class="p">:]</span> <span class="n">c</span>
</pre></div>
</div>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># INVALID</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">contiguous</span><span class="p">,</span> <span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">indirect</span><span class="p">,</span> <span class="p">:]</span> <span class="n">d</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="mf">1</span><span class="p">,</span> <span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">indirect</span><span class="p">,</span> <span class="p">:]</span> <span class="n">e</span>
</pre></div>
</div>
<p>The difference between the <cite>contiguous</cite> flag and the <cite>::1</cite> specifier is that the
former specifies contiguity for only one dimension, whereas the latter specifies
contiguity for all following (Fortran) or preceding (C) dimensions:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">c_contig</span> <span class="o">=</span> <span class="o">...</span>

<span class="c"># VALID</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">::</span><span class="n">view</span><span class="o">.</span><span class="n">contiguous</span><span class="p">]</span> <span class="n">myslice</span> <span class="o">=</span> <span class="n">c_contig</span><span class="p">[::</span><span class="mf">2</span><span class="p">]</span>

<span class="c"># INVALID</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">myslice</span> <span class="o">=</span> <span class="n">c_contig</span><span class="p">[::</span><span class="mf">2</span><span class="p">]</span>
</pre></div>
</div>
<p>The former case is valid because the last dimension remains contiguous, but the
first dimension does not “follow” the last one anymore (meaning, it was strided
already, but it is not C or Fortran contiguous any longer), since it was sliced.</p>
</div>
</div>
<div class="section" id="memoryviews-and-the-gil">
<span id="view-needs-gil"></span><h4>Memoryviews and the GIL<a class="headerlink" href="#memoryviews-and-the-gil" title="Permalink to this headline">¶</a></h4>
<p>As you will see from the <a class="reference internal" href="#view-quickstart"><span class="std std-ref">Quickstart</span></a> section, memoryviews often do
not need the GIL:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cpdef</span> <span class="kt">int</span> <span class="nf">sum3d</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">arr</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>In particular, you do not need the GIL for memoryview indexing, slicing or
transposing. Memoryviews require the GIL for the copy methods
(<a class="reference internal" href="#view-copy-c-fortran"><span class="std std-ref">C and Fortran contiguous copies</span></a>), or when the dtype is object and an object
element is read or written.</p>
</div>
<div class="section" id="memoryview-objects-and-cython-arrays">
<h4>Memoryview Objects and Cython Arrays<a class="headerlink" href="#memoryview-objects-and-cython-arrays" title="Permalink to this headline">¶</a></h4>
<p>These typed memoryviews can be converted to Python memoryview objects
(<cite>cython.view.memoryview</cite>).  These Python objects are indexable, slicable and
transposable in the same way that the original memoryviews are. They can also be
converted back to Cython-space memoryviews at any time.</p>
<p>They have the following attributes:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">shape</span></code>: size in each dimension, as a tuple.</li>
<li><code class="docutils literal notranslate"><span class="pre">strides</span></code>: stride along each dimension, in bytes.</li>
<li><code class="docutils literal notranslate"><span class="pre">suboffsets</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ndim</span></code>: number of dimensions.</li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code>: total number of items in the view (product of the shape).</li>
<li><code class="docutils literal notranslate"><span class="pre">itemsize</span></code>: size, in bytes, of the items in the view.</li>
<li><code class="docutils literal notranslate"><span class="pre">nbytes</span></code>: equal to <code class="docutils literal notranslate"><span class="pre">size</span></code> times <code class="docutils literal notranslate"><span class="pre">itemsize</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">base</span></code></li>
</ul>
</div></blockquote>
<p>And of course the aforementioned <code class="docutils literal notranslate"><span class="pre">T</span></code> attribute (<a class="reference internal" href="#view-transposing"><span class="std std-ref">Transposing</span></a>).
These attributes have the same semantics as in <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/arrays.ndarray.html#memory-layout">NumPy</a>.  For instance, to
retrieve the original object:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span>
<span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">cnp</span>

<span class="k">cdef</span> <span class="kt">cnp</span>.<span class="kt">int32_t</span>[<span class="p">:]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[::</span><span class="mf">2</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>

<span class="c"># this prints:</span>
<span class="c">#    &lt;MemoryView of &#39;ndarray&#39; object&gt;</span>
<span class="c">#    [0 2 4 6 8]</span>
<span class="c">#    [0 1 2 3 4 5 6 7 8 9]</span>
</pre></div>
</div>
<p>Note that this example returns the original object from which the view was
obtained, and that the view was resliced in the meantime.</p>
</div>
<div class="section" id="cython-arrays">
<span id="view-cython-arrays"></span><h4>Cython arrays<a class="headerlink" href="#cython-arrays" title="Permalink to this headline">¶</a></h4>
<p>Whenever a Cython memoryview is copied (using any of the <cite>copy</cite> or
<cite>copy_fortran</cite> methods), you get a new memoryview slice of a newly created
<code class="docutils literal notranslate"><span class="pre">cython.view.array</span></code> object. This array can also be used manually, and will
automatically allocate a block of data. It can later be assigned to a C or
Fortran contiguous slice (or a strided slice). It can be used like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cython</span> <span class="k">cimport</span> <span class="n">view</span>

<span class="n">my_array</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="mf">2</span><span class="p">),</span> <span class="n">itemsize</span><span class="o">=</span><span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">:]</span> <span class="n">my_slice</span> <span class="o">=</span> <span class="n">my_array</span>
</pre></div>
</div>
<p>It also takes an optional argument <cite>mode</cite> (‘c’ or ‘fortran’) and a boolean
<cite>allocate_buffer</cite>, that indicates whether a buffer should be allocated and freed
when it goes out of scope:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">view</span>.<span class="kt">array</span> <span class="nf">my_array</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;fortran&quot;</span><span class="p">,</span> <span class="n">allocate_buffer</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">my_array</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">char</span> <span class="o">*&gt;</span> <span class="n">my_data_pointer</span>

<span class="c"># define a function that can deallocate the data (if needed)</span>
<span class="n">my_array</span><span class="o">.</span><span class="n">callback_free_data</span> <span class="o">=</span> <span class="n">free</span>
</pre></div>
</div>
<p>You can also cast pointers to array, or C arrays to arrays:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">view</span>.<span class="kt">array</span> <span class="nf">my_array</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">int</span><span class="p">[:</span><span class="mf">10</span><span class="p">,</span> <span class="p">:</span><span class="mf">2</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">my_data_pointer</span>
<span class="k">cdef</span> <span class="kt">view</span>.<span class="kt">array</span> <span class="nf">my_array</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span><span class="o">&gt;</span> <span class="n">my_c_array</span>
</pre></div>
</div>
<p>Of course, you can also immediately assign a cython.view.array to a typed memoryview slice. A C array
may be assigned directly to a memoryview slice:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">myslice</span> <span class="o">=</span> <span class="n">my_2d_c_array</span>
</pre></div>
</div>
<p>The arrays are indexable and slicable from Python space just like memoryview objects, and have the same
attributes as memoryview objects.</p>
</div>
<div class="section" id="cpython-array-module">
<h4>CPython array module<a class="headerlink" href="#cpython-array-module" title="Permalink to this headline">¶</a></h4>
<p>An alternative to <code class="docutils literal notranslate"><span class="pre">cython.view.array</span></code> is the <code class="docutils literal notranslate"><span class="pre">array</span></code> module in the
Python standard library.  In Python 3, the <code class="docutils literal notranslate"><span class="pre">array.array</span></code> type supports
the buffer interface natively, so memoryviews work on top of it without
additional setup.</p>
<p>Starting with Cython 0.17, however, it is possible to use these arrays
as buffer providers also in Python 2.  This is done through explicitly
cimporting the <code class="docutils literal notranslate"><span class="pre">cpython.array</span></code> module as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">cpython.array</span>

<span class="k">def</span> <span class="nf">sum_array</span><span class="p">(</span><span class="nb">int</span><span class="p">[:]</span> <span class="n">view</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; from array import array</span>
<span class="sd">    &gt;&gt;&gt; sum_array( array(&#39;i&#39;, [1,2,3]) )</span>
<span class="sd">    6</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">total</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]):</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
<p>Note that the cimport also enables the old buffer syntax for the array
type.  Therefore, the following also works:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="n">array</span>

<span class="k">def</span> <span class="nf">sum_array</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="n">arr</span><span class="p">):</span>  <span class="c"># using old buffer syntax</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="coercion-to-numpy">
<h4>Coercion to NumPy<a class="headerlink" href="#coercion-to-numpy" title="Permalink to this headline">¶</a></h4>
<p>Memoryview (and array) objects can be coerced to a NumPy ndarray, without having
to copy the data. You can e.g. do:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">numpy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">int32_t</span><span class="p">[:</span><span class="mf">10</span><span class="p">,</span> <span class="p">:</span><span class="mf">10</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">my_pointer</span><span class="p">)</span>
</pre></div>
</div>
<p>Of course, you are not restricted to using NumPy’s type (such as <code class="docutils literal notranslate"><span class="pre">np.int32_t</span></code>
here), you can use any usable type.</p>
</div>
<div class="section" id="none-slices">
<h4>None Slices<a class="headerlink" href="#none-slices" title="Permalink to this headline">¶</a></h4>
<p>Although memoryview slices are not objects they can be set to None and they can
be checked for being None as well:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">myarray</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">myarray</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>If the function requires real memory views as input, it is therefore best to
reject None input straight away in the signature, which is supported in Cython
0.17 and later as follows:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">myarray</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Unlike object attributes of extension classes, memoryview slices are not
initialized to None.</p>
</div>
<div class="section" id="pass-data-from-a-c-function-via-pointer">
<h4>Pass data from a C function via pointer<a class="headerlink" href="#pass-data-from-a-c-function-via-pointer" title="Permalink to this headline">¶</a></h4>
<p>Since use of pointers in C is ubiquitous, here we give a quick example of how
to call C functions whose arguments contain pointers. Let’s suppose you want to
manage an array (allocate and deallocate) with NumPy (it can also be Python arrays, or
anything that supports the buffer interface), but you want to perform computation on this
array with an external C function implemented in <code class="file docutils literal notranslate"><span class="pre">C_func_file.c</span></code>:</p>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">#include &quot;C_func_file.h&quot;</span>

<span class="n">void</span> <span class="n">multiply_by_10_in_C</span><span class="p">(</span><span class="n">double</span> <span class="n">arr</span><span class="p">[],</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">10</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This file comes with a header file called <code class="file docutils literal notranslate"><span class="pre">C_func_file.h</span></code> containing:</p>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">#ifndef C_FUNC_FILE_H</span>
<span class="c">#define C_FUNC_FILE_H</span>

<span class="n">void</span> <span class="n">multiply_by_10_in_C</span><span class="p">(</span><span class="n">double</span> <span class="n">arr</span><span class="p">[],</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">n</span><span class="p">);</span>

<span class="c">#endif</span>
</pre></div>
</td></tr></table></div>
<p>where <code class="docutils literal notranslate"><span class="pre">arr</span></code> points to the array and <code class="docutils literal notranslate"><span class="pre">n</span></code> is its size.</p>
<p>You can call the function in a Cython file in the following way:</p>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;C_func_file.c&quot;</span><span class="p">:</span>
    <span class="c"># C is include here so that it doesn&#39;t need to be compiled externally</span>
    <span class="k">pass</span>

<span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;C_func_file.h&quot;</span><span class="p">:</span>
    <span class="n">void</span> <span class="n">multiply_by_10_in_C</span><span class="p">(</span><span class="n">double</span> <span class="o">*</span><span class="p">,</span> <span class="n">unsigned</span> <span class="nb">int</span><span class="p">)</span>

<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">multiply_by_10</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span> <span class="c"># &#39;arr&#39; is a one-dimensional numpy array</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">arr</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s">&#39;C_CONTIGUOUS&#39;</span><span class="p">]:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="c"># Makes a contiguous copy of the numpy array.</span>

    <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">arr_memview</span> <span class="o">=</span> <span class="n">arr</span>

    <span class="n">multiply_by_10_in_C</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr_memview</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">arr_memview</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">arr</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">multiply_by_10</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[::</span><span class="mf">2</span><span class="p">]</span>  <span class="c"># b is not contiguous.</span>

<span class="k">print</span><span class="p">(</span><span class="n">multiply_by_10</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>  <span class="c"># but our function still works as expected.</span>
</pre></div>
</td></tr></table></div>
<dl class="docutils">
<dt>Several things to note:</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal notranslate"><span class="pre">::1</span></code> requests a C contiguous view, and fails if the buffer is not C contiguous.
See <a class="reference internal" href="#c-and-fortran-contiguous-memoryviews"><span class="std std-ref">C and Fortran contiguous memoryviews</span></a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">&amp;arr_memview[0]</span></code> can be understood as ‘the address of the first element of the
memoryview’. For contiguous arrays, this is equivalent to the
start address of the flat memory buffer.</li>
<li><code class="docutils literal notranslate"><span class="pre">arr_memview.shape[0]</span></code> could have been replaced by <code class="docutils literal notranslate"><span class="pre">arr_memview.size</span></code>,
<code class="docutils literal notranslate"><span class="pre">arr.shape[0]</span></code> or <code class="docutils literal notranslate"><span class="pre">arr.size</span></code>. But <code class="docutils literal notranslate"><span class="pre">arr_memview.shape[0]</span></code> is more efficient
because it doesn’t require any Python interaction.</li>
<li><code class="docutils literal notranslate"><span class="pre">multiply_by_10</span></code> will perform computation in-place if the array passed is contiguous,
and will return a new numpy array if <code class="docutils literal notranslate"><span class="pre">arr</span></code> is not contiguous.</li>
<li>If you are using Python arrays instead of numpy arrays, you don’t need to check
if the data is stored contiguously as this is always the case. See <a class="reference internal" href="index.html#array-array"><span class="std std-ref">Working with Python arrays</span></a>.</li>
</ul>
</dd>
</dl>
<p>This way, you can call the C function similar to a normal Python function,
and leave all the memory management and cleanup to NumPy arrays and Python’s
object handling. For the details of how to compile and
call functions in C files, see <a class="reference internal" href="index.html#using-c-libraries"><span class="std std-ref">Using C libraries</span></a>.</p>
</div>
</div>
<span id="document-src/userguide/buffer"></span><div class="section" id="implementing-the-buffer-protocol">
<span id="buffer"></span><h3>Implementing the buffer protocol<a class="headerlink" href="#implementing-the-buffer-protocol" title="Permalink to this headline">¶</a></h3>
<p>Cython objects can expose memory buffers to Python code
by implementing the “buffer protocol”.
This chapter shows how to implement the protocol
and make use of the memory managed by an extension type from NumPy.</p>
<div class="section" id="a-matrix-class">
<h4>A matrix class<a class="headerlink" href="#a-matrix-class" title="Permalink to this headline">¶</a></h4>
<p>The following Cython/C++ code implements a matrix of floats,
where the number of columns is fixed at construction time
but rows can be added dynamically.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="c"># matrix.pyx</span>

<span class="k">from</span> <span class="nn">libcpp.vector</span> <span class="k">cimport</span> <span class="n">vector</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Matrix</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">unsigned</span> <span class="nf">ncols</span>
    <span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">float</span>] <span class="nf">v</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">ncols</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="n">ncols</span>

    <span class="k">def</span> <span class="nf">add_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a row, initially zero-filled.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">)</span>
</pre></div>
</div>
<p>There are no methods to do anything productive with the matrices’ contents.
We could implement custom <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>, <code class="docutils literal notranslate"><span class="pre">__setitem__</span></code>, etc. for this,
but instead we’ll use the buffer protocol to expose the matrix’s data to Python
so we can use NumPy to do useful work.</p>
<p>Implementing the buffer protocol requires adding two methods,
<code class="docutils literal notranslate"><span class="pre">__getbuffer__</span></code> and <code class="docutils literal notranslate"><span class="pre">__releasebuffer__</span></code>,
which Cython handles specially.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="n">Py_buffer</span>
<span class="k">from</span> <span class="nn">libcpp.vector</span> <span class="k">cimport</span> <span class="n">vector</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Matrix</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ncols</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="kt">shape</span>[2]
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="kt">strides</span>[2]
    <span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">float</span>] <span class="nf">v</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">ncols</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="n">ncols</span>

    <span class="k">def</span> <span class="nf">add_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a row, initially zero-filled.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getbuffer__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Py_buffer</span> <span class="o">*</span><span class="nb">buffer</span><span class="p">,</span> <span class="nb">int</span> <span class="n">flags</span><span class="p">):</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">itemsize</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span>

        <span class="c"># Stride 1 is the distance, in bytes, between two items in a row;</span>
        <span class="c"># this is the distance between two adjacent items in the vector.</span>
        <span class="c"># Stride 0 is the distance between the first elements of adjacent rows.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Py_ssize_t</span><span class="o">&gt;</span><span class="p">(</span>  <span class="o">&lt;</span><span class="n">char</span> <span class="o">*&gt;&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span>
                                       <span class="o">-</span> <span class="o">&lt;</span><span class="n">char</span> <span class="o">*&gt;&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>

        <span class="nb">buffer</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">char</span> <span class="o">*&gt;&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s">&#39;f&#39;</span>                     <span class="c"># float</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">internal</span> <span class="o">=</span> <span class="bp">NULL</span>                  <span class="c"># see References</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">=</span> <span class="n">itemsize</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">*</span> <span class="n">itemsize</span>   <span class="c"># product(shape) * itemsize</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">ndim</span> <span class="o">=</span> <span class="mf">2</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">strides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strides</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">suboffsets</span> <span class="o">=</span> <span class="bp">NULL</span>                <span class="c"># for pointer arrays only</span>

    <span class="k">def</span> <span class="nf">__releasebuffer__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Py_buffer</span> <span class="o">*</span><span class="nb">buffer</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">Matrix.__getbuffer__</span></code> fills a descriptor structure,
called a <code class="docutils literal notranslate"><span class="pre">Py_buffer</span></code>, that is defined by the Python C-API.
It contains a pointer to the actual buffer in memory,
as well as metadata about the shape of the array and the strides
(step sizes to get from one element or row to the next).
Its <code class="docutils literal notranslate"><span class="pre">shape</span></code> and <code class="docutils literal notranslate"><span class="pre">strides</span></code> members are pointers
that must point to arrays of type and size <code class="docutils literal notranslate"><span class="pre">Py_ssize_t[ndim]</span></code>.
These arrays have to stay alive as long as any buffer views the data,
so we store them on the <code class="docutils literal notranslate"><span class="pre">Matrix</span></code> object as members.</p>
<p>The code is not yet complete, but we can already compile it
and test the basic functionality.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">from</span> <span class="nn">matrix</span> <span class="k">import</span> <span class="n">Matrix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">array</span><span class="p">([],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">add_row</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">add_row</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span>
<span class="n">array</span><span class="p">([[</span> <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can view the <code class="docutils literal notranslate"><span class="pre">Matrix</span></code> as a NumPy <code class="docutils literal notranslate"><span class="pre">ndarray</span></code>,
and modify its contents using standard NumPy operations.</p>
</div>
<div class="section" id="memory-safety-and-reference-counting">
<h4>Memory safety and reference counting<a class="headerlink" href="#memory-safety-and-reference-counting" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Matrix</span></code> class as implemented so far is unsafe.
The <code class="docutils literal notranslate"><span class="pre">add_row</span></code> operation can move the underlying buffer,
which invalidates any NumPy (or other) view on the data.
If you try to access values after an <code class="docutils literal notranslate"><span class="pre">add_row</span></code> call,
you’ll get outdated values or a segfault.</p>
<p>This is where <code class="docutils literal notranslate"><span class="pre">__releasebuffer__</span></code> comes in.
We can add a reference count to each matrix,
and lock it for mutation whenever a view exists.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># distutils: language = c++</span>

<span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="n">Py_buffer</span>
<span class="k">from</span> <span class="nn">libcpp.vector</span> <span class="k">cimport</span> <span class="n">vector</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Matrix</span><span class="p">:</span>

    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">view_count</span>

    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ncols</span>
    <span class="k">cdef</span> <span class="kt">vector</span>[<span class="kt">float</span>] <span class="nf">v</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">ncols</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="n">ncols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_count</span> <span class="o">=</span> <span class="mf">0</span>

    <span class="k">def</span> <span class="nf">add_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_count</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;can&#39;t add row while being viewed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getbuffer__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Py_buffer</span> <span class="o">*</span><span class="nb">buffer</span><span class="p">,</span> <span class="nb">int</span> <span class="n">flags</span><span class="p">):</span>
        <span class="c"># ... as before</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">view_count</span> <span class="o">+=</span> <span class="mf">1</span>

    <span class="k">def</span> <span class="nf">__releasebuffer__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Py_buffer</span> <span class="o">*</span><span class="nb">buffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_count</span> <span class="o">-=</span> <span class="mf">1</span>
</pre></div>
</div>
</div>
<div class="section" id="flags">
<h4>Flags<a class="headerlink" href="#flags" title="Permalink to this headline">¶</a></h4>
<p>We skipped some input validation in the code.
The <code class="docutils literal notranslate"><span class="pre">flags</span></code> argument to <code class="docutils literal notranslate"><span class="pre">__getbuffer__</span></code> comes from <code class="docutils literal notranslate"><span class="pre">np.asarray</span></code>
(and other clients) and is an OR of boolean flags
that describe the kind of array that is requested.
Strictly speaking, if the flags contain <code class="docutils literal notranslate"><span class="pre">PyBUF_ND</span></code>, <code class="docutils literal notranslate"><span class="pre">PyBUF_SIMPLE</span></code>,
or <code class="docutils literal notranslate"><span class="pre">PyBUF_F_CONTIGUOUS</span></code>, <code class="docutils literal notranslate"><span class="pre">__getbuffer__</span></code> must raise a <code class="docutils literal notranslate"><span class="pre">BufferError</span></code>.
These macros can be <code class="docutils literal notranslate"><span class="pre">cimport</span></code>’d from <code class="docutils literal notranslate"><span class="pre">cpython.buffer</span></code>.</p>
<p>(The matrix-in-vector structure actually conforms to <code class="docutils literal notranslate"><span class="pre">PyBUF_ND</span></code>,
but that would prohibit <code class="docutils literal notranslate"><span class="pre">__getbuffer__</span></code> from filling in the strides.
A single-row matrix is F-contiguous, but a larger matrix is not.)</p>
</div>
<div class="section" id="references">
<h4>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h4>
<p>The buffer interface used here is set out in
<span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-3118"><strong>PEP 3118</strong></a>, Revising the buffer protocol.</p>
<p>A tutorial for using this API from C is on Jake Vanderplas’s blog,
<a class="reference external" href="https://jakevdp.github.io/blog/2014/05/05/introduction-to-the-python-buffer-protocol/">An Introduction to the Python Buffer Protocol</a>.</p>
<p>Reference documentation is available for
<a class="reference external" href="https://docs.python.org/3/c-api/buffer.html">Python 3</a>
and <a class="reference external" href="https://docs.python.org/2.7/c-api/buffer.html">Python 2</a>.
The Py2 documentation also describes an older buffer protocol
that is no longer in use;
since Python 2.6, the <span class="target" id="index-1"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-3118"><strong>PEP 3118</strong></a> protocol has been implemented,
and the older protocol is only relevant for legacy code.</p>
</div>
</div>
<span id="document-src/userguide/parallelism"></span><span class="target" id="module-cython.parallel"></span><div class="section" id="using-parallelism">
<span id="parallel"></span><h3>Using Parallelism<a class="headerlink" href="#using-parallelism" title="Permalink to this headline">¶</a></h3>
<p>Cython supports native parallelism through the <a class="reference internal" href="#module-cython.parallel" title="cython.parallel"><code class="xref py py-mod docutils literal notranslate"><span class="pre">cython.parallel</span></code></a>
module. To use this kind of parallelism, the GIL must be released
(see <a class="reference internal" href="index.html#nogil"><span class="std std-ref">Releasing the GIL</span></a>).
It currently supports OpenMP, but later on more backends might be supported.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Functionality in this module may only be used from the main thread
or parallel regions due to OpenMP restrictions.</p>
</div>
<dl class="function">
<dt id="cython.parallel.prange">
<code class="descclassname">cython.parallel.</code><code class="descname">prange</code><span class="sig-paren">(</span><em>[start,] stop[, step][, nogil=False][, schedule=None[, chunksize=None]][, num_threads=None]</em><span class="sig-paren">)</span><a class="headerlink" href="#cython.parallel.prange" title="Permalink to this definition">¶</a></dt>
<dd><p>This function can be used for parallel loops. OpenMP automatically
starts a thread pool and distributes the work according to the schedule
used.</p>
<p>Thread-locality and reductions are automatically inferred for variables.</p>
<p>If you assign to a variable in a prange block, it becomes lastprivate, meaning that the
variable will contain the value from the last iteration. If you use an
inplace operator on a variable, it becomes a reduction, meaning that the
values from the thread-local copies of the variable will be reduced with
the operator and assigned to the original variable after the loop. The
index variable is always lastprivate.
Variables assigned to in a parallel with block will be private and unusable
after the block, as there is no concept of a sequentially last value.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>start</strong> – The index indicating the start of the loop (same as the start argument in range).</li>
<li><strong>stop</strong> – The index indicating when to stop the loop (same as the stop argument in range).</li>
<li><strong>step</strong> – An integer giving the step of the sequence (same as the step argument in range).
It must not be 0.</li>
<li><strong>nogil</strong> – This function can only be used with the GIL released.
If <code class="docutils literal notranslate"><span class="pre">nogil</span></code> is true, the loop will be wrapped in a nogil section.</li>
<li><strong>schedule</strong> – <p>The <code class="docutils literal notranslate"><span class="pre">schedule</span></code> is passed to OpenMP and can be one of the following:</p>
<dl class="docutils">
<dt>static:</dt>
<dd>If a chunksize is provided, iterations are distributed to all
threads ahead of time in blocks of the given chunksize.  If no
chunksize is given, the iteration space is divided into chunks that
are approximately equal in size, and at most one chunk is assigned
to each thread in advance.<p class="last">This is most appropriate when the scheduling overhead matters and
the problem can be cut down into equally sized chunks that are
known to have approximately the same runtime.</p>
</dd>
<dt>dynamic:</dt>
<dd>The iterations are distributed to threads as they request them,
with a default chunk size of 1.<p class="last">This is suitable when the runtime of each chunk differs and is not
known in advance and therefore a larger number of smaller chunks
is used in order to keep all threads busy.</p>
</dd>
<dt>guided:</dt>
<dd>As with dynamic scheduling, the iterations are distributed to
threads as they request them, but with decreasing chunk size.  The
size of each chunk is proportional to the number of unassigned
iterations divided by the number of participating threads,
decreasing to 1 (or the chunksize if provided).<p class="last">This has an advantage over pure dynamic scheduling when it turns
out that the last chunks take more time than expected or are
otherwise being badly scheduled, so that most threads start running
idle while the last chunks are being worked on by only a smaller
number of threads.</p>
</dd>
<dt>runtime:</dt>
<dd>The schedule and chunk size are taken from the runtime scheduling
variable, which can be set through the <code class="docutils literal notranslate"><span class="pre">openmp.omp_set_schedule()</span></code>
function call, or the OMP_SCHEDULE environment variable.  Note that
this essentially disables any static compile time optimisations of
the scheduling code itself and may therefore show a slightly worse
performance than when the same scheduling policy is statically
configured at compile time.
The default schedule is implementation defined. For more information consult
the OpenMP specification <a class="footnote-reference" href="#id2" id="id1">[1]</a>.</dd>
</dl>
</li>
<li><strong>num_threads</strong> – The <code class="docutils literal notranslate"><span class="pre">num_threads</span></code> argument indicates how many threads the team should consist of. If not given,
OpenMP will decide how many threads to use. Typically this is the number of cores available on
the machine. However, this may be controlled through the <code class="docutils literal notranslate"><span class="pre">omp_set_num_threads()</span></code> function, or
through the <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environment variable.</li>
<li><strong>chunksize</strong> – The <code class="docutils literal notranslate"><span class="pre">chunksize</span></code> argument indicates the chunksize to be used for dividing the iterations among threads.
This is only valid for <code class="docutils literal notranslate"><span class="pre">static</span></code>, <code class="docutils literal notranslate"><span class="pre">dynamic</span></code> and <code class="docutils literal notranslate"><span class="pre">guided</span></code> scheduling, and is optional. Different chunksizes
may give substantially different performance results, depending on the schedule, the load balance it provides,
the scheduling overhead and the amount of false sharing (if any).</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Example with a reduction:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cython.parallel</span> <span class="k">import</span> <span class="n">prange</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n</span> <span class="o">=</span> <span class="mf">30</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">sum</span> <span class="o">=</span> <span class="mf">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">nogil</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="nb">sum</span> <span class="o">+=</span> <span class="n">i</span>

<span class="k">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
</pre></div>
</div>
<p>Example with a typed memoryview (e.g. a NumPy array):</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cython.parallel</span> <span class="k">import</span> <span class="n">prange</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">x</span><span class="p">,</span> <span class="n">double</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">i</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
<dl class="function">
<dt id="cython.parallel.parallel">
<code class="descclassname">cython.parallel.</code><code class="descname">parallel</code><span class="sig-paren">(</span><em>num_threads=None</em><span class="sig-paren">)</span><a class="headerlink" href="#cython.parallel.parallel" title="Permalink to this definition">¶</a></dt>
<dd><p>This directive can be used as part of a <code class="docutils literal notranslate"><span class="pre">with</span></code> statement to execute code
sequences in parallel. This is currently useful to setup thread-local
buffers used by a prange. A contained prange will be a worksharing loop
that is not parallel, so any variable assigned to in the parallel section
is also private to the prange. Variables that are private in the parallel
block are unavailable after the parallel block.</p>
<p>Example with thread-local buffers:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cython.parallel</span> <span class="k">import</span> <span class="n">parallel</span><span class="p">,</span> <span class="n">prange</span>
<span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">abort</span><span class="p">,</span> <span class="n">malloc</span><span class="p">,</span> <span class="n">free</span>

<span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">idx</span><span class="p">,</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">n</span> <span class="o">=</span> <span class="mf">100</span>
<span class="k">cdef</span> <span class="kt">int</span> * <span class="nf">local_buf</span>
<span class="k">cdef</span> <span class="kt">size_t</span> <span class="nf">size</span> <span class="o">=</span> <span class="mf">10</span>

<span class="k">with</span> <span class="k">nogil</span><span class="p">,</span> <span class="n">parallel</span><span class="p">():</span>
    <span class="n">local_buf</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">int</span> <span class="o">*&gt;</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">local_buf</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">()</span>

    <span class="c"># populate our local buffer in a sequential loop</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">local_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">2</span>

    <span class="c"># share the work using the thread-local buffer(s)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="s">&#39;guided&#39;</span><span class="p">):</span>
        <span class="n">func</span><span class="p">(</span><span class="n">local_buf</span><span class="p">)</span>

    <span class="n">free</span><span class="p">(</span><span class="n">local_buf</span><span class="p">)</span>
</pre></div>
</div>
<p>Later on sections might be supported in parallel blocks, to distribute
code sections of work among threads.</p>
</dd></dl>

<dl class="function">
<dt id="cython.parallel.threadid">
<code class="descclassname">cython.parallel.</code><code class="descname">threadid</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cython.parallel.threadid" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the id of the thread. For n threads, the ids will range from 0 to
n-1.</p>
</dd></dl>

<div class="section" id="compiling">
<h4>Compiling<a class="headerlink" href="#compiling" title="Permalink to this headline">¶</a></h4>
<p>To actually use the OpenMP support, you need to tell the C or C++ compiler to
enable OpenMP.  For gcc this can be done as follows in a setup.py:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">distutils.extension</span> <span class="k">import</span> <span class="n">Extension</span>
<span class="k">from</span> <span class="nn">Cython.Build</span> <span class="k">import</span> <span class="n">cythonize</span>

<span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Extension</span><span class="p">(</span>
        <span class="s">&quot;hello&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s">&quot;hello.pyx&quot;</span><span class="p">],</span>
        <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-fopenmp&#39;</span><span class="p">],</span>
        <span class="n">extra_link_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-fopenmp&#39;</span><span class="p">],</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&#39;hello-parallel-world&#39;</span><span class="p">,</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">ext_modules</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>For Microsoft Visual C++ compiler, use <code class="docutils literal notranslate"><span class="pre">'/openmp'</span></code> instead of <code class="docutils literal notranslate"><span class="pre">'-fopenmp'</span></code>.</p>
</div>
<div class="section" id="breaking-out-of-loops">
<h4>Breaking out of loops<a class="headerlink" href="#breaking-out-of-loops" title="Permalink to this headline">¶</a></h4>
<p>The parallel with and prange blocks support the statements break, continue and
return in nogil mode. Additionally, it is valid to use a <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil</span></code> block
inside these blocks, and have exceptions propagate from them.
However, because the blocks use OpenMP, they can not just be left, so the
exiting procedure is best-effort. For prange() this means that the loop
body is skipped after the first break, return or exception for any subsequent
iteration in any thread. It is undefined which value shall be returned if
multiple different values may be returned, as the iterations are in no
particular order:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">cython.parallel</span> <span class="k">import</span> <span class="n">prange</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">func</span><span class="p">(</span><span class="n">Py_ssize_t</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">i</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">nogil</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">8</span><span class="p">:</span>
            <span class="k">with</span> <span class="k">gil</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">4</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span>
</pre></div>
</div>
<p>In the example above it is undefined whether an exception shall be raised,
whether it will simply break or whether it will return 2.</p>
</div>
<div class="section" id="using-openmp-functions">
<h4>Using OpenMP Functions<a class="headerlink" href="#using-openmp-functions" title="Permalink to this headline">¶</a></h4>
<p>OpenMP functions can be used by cimporting <code class="docutils literal notranslate"><span class="pre">openmp</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># tag: openmp</span>
<span class="c"># You can ignore the previous line.</span>
<span class="c"># It&#39;s for internal testing of the Cython documentation.</span>

<span class="k">from</span> <span class="nn">cython.parallel</span> <span class="k">cimport</span> <span class="n">parallel</span>
<span class="k">cimport</span> <span class="nn">openmp</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">num_threads</span>

<span class="n">openmp</span><span class="o">.</span><span class="n">omp_set_dynamic</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="k">with</span> <span class="k">nogil</span><span class="p">,</span> <span class="n">parallel</span><span class="p">():</span>
    <span class="n">num_threads</span> <span class="o">=</span> <span class="n">openmp</span><span class="o">.</span><span class="n">omp_get_num_threads</span><span class="p">()</span>
    <span class="c"># ...</span>
</pre></div>
</div>
<p class="rubric">References</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://www.openmp.org/mp-documents/spec30.pdf">https://www.openmp.org/mp-documents/spec30.pdf</a></td></tr>
</tbody>
</table>
</div>
</div>
<span id="document-src/userguide/debugging"></span><div class="section" id="debugging-your-cython-program">
<span id="debugging"></span><h3>Debugging your Cython program<a class="headerlink" href="#debugging-your-cython-program" title="Permalink to this headline">¶</a></h3>
<p>Cython comes with an extension for the GNU Debugger that helps users debug
Cython code. To use this functionality, you will need to install gdb 7.2 or
higher, built with Python support (linked to Python 2.6 or higher).
The debugger supports debuggees with versions 2.6 and higher. For Python 3,
code should be built with Python 3 and the debugger should be run with
Python 2 (or at least it should be able to find the Python 2 Cython
installation). Note that in recent versions of Ubuntu, for instance, <code class="docutils literal notranslate"><span class="pre">gdb</span></code>
installed with <code class="docutils literal notranslate"><span class="pre">apt-get</span></code> is configured with Python 3. On such systems, the
proper configuration of <code class="docutils literal notranslate"><span class="pre">gdb</span></code> can be obtained by downloading the <code class="docutils literal notranslate"><span class="pre">gdb</span></code>
source, and then running:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">python</span><span class="o">=</span><span class="n">python2</span>
<span class="n">make</span>
<span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
</pre></div>
</div>
<p>The debugger will need debug information that the Cython compiler can export.
This can be achieved from within the setup script by passing <code class="docutils literal notranslate"><span class="pre">gdb_debug=True</span></code>
to <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span>
<span class="k">from</span> <span class="nn">distutils.extension</span> <span class="k">import</span> <span class="n">Extension</span>

<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;source.pyx&#39;</span><span class="p">])]</span>

<span class="n">setup</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">,</span> <span class="n">gdb_debug</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>For development it’s often helpful to pass the <code class="docutils literal notranslate"><span class="pre">--inplace</span></code> flag to
the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script, which makes distutils build your project
“in place”, i.e., not in a separate <cite>build</cite> directory.</p>
<p>When invoking Cython from the command line directly you can have it write
debug information using the <code class="docutils literal notranslate"><span class="pre">--gdb</span></code> flag:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">cython</span> <span class="o">--</span><span class="n">gdb</span> <span class="n">myfile</span><span class="o">.</span><span class="n">pyx</span>
</pre></div>
</div>
<div class="section" id="running-the-debugger">
<h4>Running the Debugger<a class="headerlink" href="#running-the-debugger" title="Permalink to this headline">¶</a></h4>
<p>To run the Cython debugger and have it import the debug information exported
by Cython, run <code class="docutils literal notranslate"><span class="pre">cygdb</span></code> in the build directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py build_ext --inplace
$ cygdb
GNU gdb <span class="o">(</span>GDB<span class="o">)</span> <span class="m">7</span>.2
...
<span class="o">(</span>gdb<span class="o">)</span>
</pre></div>
</div>
<p>When using the Cython debugger, it’s preferable that you build and run your code
with an interpreter that is compiled with debugging symbols (i.e. configured
with <code class="docutils literal notranslate"><span class="pre">--with-pydebug</span></code> or compiled with the <code class="docutils literal notranslate"><span class="pre">-g</span></code> CFLAG). If your Python is
installed and managed by your package manager you probably need to install debug
support separately. If using NumPy then you also need to install numpy debugging, or you’ll
see an <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1030830">import error for multiarray</a>.
E.G. for ubuntu:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get install python-dbg python-numpy-dbg
$ python-dbg setup.py build_ext --inplace
</pre></div>
</div>
<p>Then you need to run your script with <code class="docutils literal notranslate"><span class="pre">python-dbg</span></code> also. Ensure that when
building your package with debug symbols that cython extensions are re-compiled
if they had been previously compiled. If your package is version controlled, you
might want to perform <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clean</span> <span class="pre">-fxd</span></code> or <code class="docutils literal notranslate"><span class="pre">hg</span> <span class="pre">purge</span> <span class="pre">--all</span></code> before building.</p>
<p>You can also pass additional arguments to gdb:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cygdb /path/to/build/directory/ GDBARGS
</pre></div>
</div>
<p>i.e.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cygdb . -- --args python-dbg mainscript.py
</pre></div>
</div>
<p>To tell cygdb not to import any debug information, supply <code class="docutils literal notranslate"><span class="pre">--</span></code> as the first
argument:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cygdb --
</pre></div>
</div>
</div>
<div class="section" id="using-the-debugger">
<h4>Using the Debugger<a class="headerlink" href="#using-the-debugger" title="Permalink to this headline">¶</a></h4>
<p>The Cython debugger comes with a set of commands that support breakpoints,
stack inspection, source code listing, stepping, stepping over, etc. Most
of these commands are analogous to their respective gdb command.</p>
<dl class="function">
<dt>
<code class="descname">cy break breakpoints...</code></dt>
<dd><p>Break in a Python, Cython or C function. First it will look for a Cython
function with that name, if cygdb doesn’t know about a function (or method)
with that name, it will set a (pending) C breakpoint. The <code class="docutils literal notranslate"><span class="pre">-p</span></code> option can
be used to specify a Python breakpoint.</p>
<p>Breakpoints can be set for either the function or method name, or they can
be fully “qualified”, which means that the entire “path” to a function is
given:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> cython_function_or_method
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> packagename.cython_module.cython_function
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> packagename.cython_module.ClassName.cython_method
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> c_function
</pre></div>
</div>
<p>You can also break on Cython line numbers:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> :14
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> cython_module:14
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> packagename.cython_module:14
</pre></div>
</div>
<p>Python breakpoints currently support names of the module (not the entire
package path) and the function or method:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> -p python_module.python_function_or_method
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">break</span> -p python_function_or_method
</pre></div>
</div>
</dd></dl>

<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Python breakpoints only work in Python builds where the Python frame
information can be read from the debugger. To ensure this, use a
Python debug build or a non-stripped build compiled with debug
support.</p>
</div>
<dl class="function">
<dt>
<code class="descname">cy step</code></dt>
<dd><p>Step through Python, Cython or C code. Python, Cython and C functions
called directly from Cython code are considered relevant and will be
stepped into.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy next</code></dt>
<dd><p>Step over Python, Cython or C code.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy run</code></dt>
<dd><p>Run the program. The default interpreter is the interpreter that was used
to build your extensions with, or the interpreter <code class="docutils literal notranslate"><span class="pre">cygdb</span></code> is run with
in case the “don’t import debug information” option was in effect.
The interpreter can be overridden using gdb’s <code class="docutils literal notranslate"><span class="pre">file</span></code> command.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy cont</code></dt>
<dd><p>Continue the program.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy up</code></dt>
<dt>
<code class="descname">cy down</code></dt>
<dd><p>Go up and down the stack to what is considered a relevant frame.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy finish</code></dt>
<dd><p>Execute until an upward relevant frame is met or something halts
execution.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy bt</code></dt>
<dt>
<code class="descname">cy backtrace</code></dt>
<dd><p>Print a traceback of all frames considered relevant. The <code class="docutils literal notranslate"><span class="pre">-a</span></code> option
makes it print the full traceback (all C frames).</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy select</code></dt>
<dd><p>Select a stack frame by number as listed by <code class="docutils literal notranslate"><span class="pre">cy</span> <span class="pre">backtrace</span></code>. This
command is introduced because <code class="docutils literal notranslate"><span class="pre">cy</span> <span class="pre">backtrace</span></code> prints a reversed stack
trace, so frame numbers differ from gdb’s <code class="docutils literal notranslate"><span class="pre">bt</span></code>.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy print varname</code></dt>
<dd><p>Print a local or global Cython, Python or C variable (depending on the
context). Variables may also be dereferenced:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span> cy print x
<span class="nv">x</span> <span class="o">=</span> <span class="m">1</span>
<span class="o">(</span>gdb<span class="o">)</span> cy print *x
*x <span class="o">=</span> <span class="o">(</span>PyObject<span class="o">)</span> <span class="o">{</span>
    <span class="nv">_ob_next</span> <span class="o">=</span> 0x93efd8,
    <span class="nv">_ob_prev</span> <span class="o">=</span> 0x93ef88,
    <span class="nv">ob_refcnt</span> <span class="o">=</span> <span class="m">65</span>,
    <span class="nv">ob_type</span> <span class="o">=</span> 0x83a3e0
<span class="o">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy set cython_variable = value</code></dt>
<dd><p>Set a Cython variable on the Cython stack to value.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy list</code></dt>
<dd><p>List the source code surrounding the current line.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy locals</code></dt>
<dt>
<code class="descname">cy globals</code></dt>
<dd><p>Print all the local and global variables and their values.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy import FILE...</code></dt>
<dd><p>Import debug information from files given as arguments. The easiest way to
import debug information is to use the cygdb command line tool.</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">cy exec code</code></dt>
<dd><p>Execute code in the current Python or Cython frame. This works like
Python’s interactive interpreter.</p>
<p>For Python frames it uses the globals and locals from the Python frame,
for Cython frames it uses the dict of globals used on the Cython module
and a new dict filled with the local Cython variables.</p>
</dd></dl>

<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">cy</span> <span class="pre">exec</span></code> modifies state and executes code in the debuggee and is
therefore potentially dangerous.</p>
</div>
<p>Example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">exec</span> x + <span class="m">1</span>
<span class="m">2</span>
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">exec</span> import sys<span class="p">;</span> print sys.version_info
<span class="o">(</span><span class="m">2</span>, <span class="m">6</span>, <span class="m">5</span>, <span class="s1">&#39;final&#39;</span>, <span class="m">0</span><span class="o">)</span>
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">exec</span>
&gt;global foo
&gt;
&gt;foo <span class="o">=</span> <span class="s1">&#39;something&#39;</span>
&gt;end
</pre></div>
</div>
</div>
<div class="section" id="convenience-functions">
<h4>Convenience functions<a class="headerlink" href="#convenience-functions" title="Permalink to this headline">¶</a></h4>
<p>The following functions are gdb functions, which means they can be used in a
gdb expression.</p>
<dl class="function">
<dt id="cy_cname">
<code class="descname">cy_cname</code><span class="sig-paren">(</span><em>varname</em><span class="sig-paren">)</span><a class="headerlink" href="#cy_cname" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the C variable name of a Cython variable. For global
variables this may not be actually valid.</p>
</dd></dl>

<dl class="function">
<dt id="cy_cvalue">
<code class="descname">cy_cvalue</code><span class="sig-paren">(</span><em>varname</em><span class="sig-paren">)</span><a class="headerlink" href="#cy_cvalue" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the value of a Cython variable.</p>
</dd></dl>

<dl class="function">
<dt id="cy_eval">
<code class="descname">cy_eval</code><span class="sig-paren">(</span><em>expression</em><span class="sig-paren">)</span><a class="headerlink" href="#cy_eval" title="Permalink to this definition">¶</a></dt>
<dd><p>Evaluates Python code in the nearest Python or Cython frame and returns
the result of the expression as a gdb value. This gives a new reference
if successful, NULL on error.</p>
</dd></dl>

<dl class="function">
<dt id="cy_lineno">
<code class="descname">cy_lineno</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cy_lineno" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the current line number in the selected Cython frame.</p>
</dd></dl>

<p>Example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span> print <span class="nv">$cy_cname</span><span class="o">(</span><span class="s2">&quot;x&quot;</span><span class="o">)</span>
<span class="nv">$1</span> <span class="o">=</span> <span class="s2">&quot;__pyx_v_x&quot;</span>
<span class="o">(</span>gdb<span class="o">)</span> watch <span class="nv">$cy_cvalue</span><span class="o">(</span><span class="s2">&quot;x&quot;</span><span class="o">)</span>
Hardware watchpoint <span class="m">13</span>: <span class="nv">$cy_cvalue</span><span class="o">(</span><span class="s2">&quot;x&quot;</span><span class="o">)</span>
<span class="o">(</span>gdb<span class="o">)</span> cy <span class="nb">set</span> <span class="nv">my_cython_variable</span> <span class="o">=</span> <span class="nv">$cy_eval</span><span class="o">(</span><span class="s2">&quot;{&#39;spam&#39;: &#39;ham&#39;}&quot;</span><span class="o">)</span>
<span class="o">(</span>gdb<span class="o">)</span> print <span class="nv">$cy_lineno</span><span class="o">()</span>
<span class="nv">$2</span> <span class="o">=</span> <span class="m">12</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-the-debugger">
<h4>Configuring the Debugger<a class="headerlink" href="#configuring-the-debugger" title="Permalink to this headline">¶</a></h4>
<p>A few aspects of the debugger are configurable with gdb parameters. For
instance, colors can be disabled, the terminal background color
and breakpoint autocompletion can be configured.</p>
<dl class="macro">
<dt id="c.cy_complete_unqualified">
<code class="descname">cy_complete_unqualified</code><a class="headerlink" href="#c.cy_complete_unqualified" title="Permalink to this definition">¶</a></dt>
<dd><p>Tells the Cython debugger whether <code class="docutils literal notranslate"><span class="pre">cy</span> <span class="pre">break</span></code> should also complete
plain function names, i.e. not prefixed by their module name.
E.g. if you have a function named <code class="docutils literal notranslate"><span class="pre">spam</span></code>,
in module <code class="docutils literal notranslate"><span class="pre">M</span></code>, it tells whether to only complete <code class="docutils literal notranslate"><span class="pre">M.spam</span></code> or also just
<code class="docutils literal notranslate"><span class="pre">spam</span></code>.</p>
<p>The default is true.</p>
</dd></dl>

<dl class="macro">
<dt id="c.cy_colorize_code">
<code class="descname">cy_colorize_code</code><a class="headerlink" href="#c.cy_colorize_code" title="Permalink to this definition">¶</a></dt>
<dd><p>Tells the debugger whether to colorize source code. The default is true.</p>
</dd></dl>

<dl class="macro">
<dt id="c.cy_terminal_background_color">
<code class="descname">cy_terminal_background_color</code><a class="headerlink" href="#c.cy_terminal_background_color" title="Permalink to this definition">¶</a></dt>
<dd><p>Tells the debugger about the terminal background color, which affects
source code coloring. The default is “dark”, another valid option is
“light”.</p>
</dd></dl>

<p>This is how these parameters can be used:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set</span> cy_complete_unqualified off
<span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set</span> cy_terminal_background_color light
<span class="o">(</span>gdb<span class="o">)</span> show cy_colorize_code
</pre></div>
</div>
</div>
</div>
<span id="document-src/userguide/numpy_tutorial"></span><div class="section" id="cython-for-numpy-users">
<span id="numpy-tutorial"></span><h3>Cython for NumPy users<a class="headerlink" href="#cython-for-numpy-users" title="Permalink to this headline">¶</a></h3>
<p>This tutorial is aimed at NumPy users who have no experience with Cython at
all. If you have some knowledge of Cython you may want to skip to the
‘’Efficient indexing’’ section.</p>
<p>The main scenario considered is NumPy end-use rather than NumPy/SciPy
development. The reason is that Cython is not (yet) able to support functions
that are generic with respect to the number of dimensions in a
high-level fashion. This restriction is much more severe for SciPy development
than more specific, “end-user” functions. See the last section for more
information on this.</p>
<p>The style of this tutorial will not fit everybody, so you can also consider:</p>
<ul class="simple">
<li>Kurt Smith’s <a class="reference external" href="https://www.youtube.com/watch?v=gMvkiQ-gOW8&amp;t=4730s&amp;ab_channel=Enthought">video tutorial of Cython at SciPy 2015</a>.
The slides and notebooks of this talk are <a class="reference external" href="https://github.com/kwmsmith/scipy-2015-cython-tutorial">on github</a>.</li>
<li>Basic Cython documentation (see <a class="reference external" href="https://cython.readthedocs.io/en/latest/index.html">Cython front page</a>).</li>
</ul>
<div class="section" id="cython-at-a-glance">
<h4>Cython at a glance<a class="headerlink" href="#cython-at-a-glance" title="Permalink to this headline">¶</a></h4>
<p>Cython is a compiler which compiles Python-like code files to C code. Still,
‘’Cython is not a Python to C translator’‘. That is, it doesn’t take your full
program and “turns it into C” – rather, the result makes full use of the
Python runtime environment. A way of looking at it may be that your code is
still Python in that it runs within the Python runtime environment, but rather
than compiling to interpreted Python bytecode one compiles to native machine
code (but with the addition of extra syntax for easy embedding of faster
C-like code).</p>
<p>This has two important consequences:</p>
<ul class="simple">
<li>Speed. How much depends very much on the program involved though. Typical Python numerical programs would tend to gain very little as most time is spent in lower-level C that is used in a high-level fashion. However for-loop-style programs can gain many orders of magnitude, when typing information is added (and is so made possible as a realistic alternative).</li>
<li>Easy calling into C code. One of Cython’s purposes is to allow easy wrapping
of C libraries. When writing code in Cython you can call into C code as
easily as into Python code.</li>
</ul>
<p>Very few Python constructs are not yet supported, though making Cython compile all
Python code is a stated goal, you can see the differences with Python in
<a class="reference internal" href="index.html#cython-limitations"><span class="std std-ref">limitations</span></a>.</p>
</div>
<div class="section" id="your-cython-environment">
<h4>Your Cython environment<a class="headerlink" href="#your-cython-environment" title="Permalink to this headline">¶</a></h4>
<p>Using Cython consists of these steps:</p>
<ol class="arabic simple">
<li>Write a <code class="file docutils literal notranslate"><span class="pre">.pyx</span></code> source file</li>
<li>Run the Cython compiler to generate a C file</li>
<li>Run a C compiler to generate a compiled library</li>
<li>Run the Python interpreter and ask it to import the module</li>
</ol>
<p>However there are several options to automate these steps:</p>
<ol class="arabic simple">
<li>The <a class="reference external" href="http://sagemath.org">SAGE</a> mathematics software system provides
excellent support for using Cython and NumPy from an interactive command
line or through a notebook interface (like
Maple/Mathematica). See <a class="reference external" href="https://doc.sagemath.org/html/en/developer/coding_in_cython.html">this documentation</a>.</li>
<li>Cython can be used as an extension within a Jupyter notebook,
making it easy to compile and use Cython code with just a <code class="docutils literal notranslate"><span class="pre">%%cython</span></code>
at the top of a cell. For more information see
<a class="reference internal" href="index.html#jupyter-notebook"><span class="std std-ref">Using the Jupyter Notebook</span></a>.</li>
<li>A version of pyximport is shipped with Cython,
so that you can import pyx-files dynamically into Python and
have them compiled automatically (See <a class="reference internal" href="index.html#pyximport"><span class="std std-ref">Compiling with pyximport</span></a>).</li>
<li>Cython supports distutils so that you can very easily create build scripts
which automate the process, this is the preferred method for
Cython implemented libraries and packages.
See <a class="reference internal" href="index.html#basic-setup-py"><span class="std std-ref">Basic setup.py</span></a>.</li>
<li>Manual compilation (see below)</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If using another interactive command line environment than SAGE, like
IPython or Python itself, it is important that you restart the process
when you recompile the module. It is not enough to issue an “import”
statement again.</p>
</div>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>If you already have a C compiler, just do:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">Cython</span>
</pre></div>
</div>
<p>otherwise, see <a class="reference internal" href="index.html#install"><span class="std std-ref">the installation page</span></a>.</p>
<p>As of this writing SAGE comes with an older release of Cython than required
for this tutorial. So if using SAGE you should download the newest Cython and
then execute</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cd</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">cython</span><span class="o">-</span><span class="n">distro</span>
<span class="err">$</span> <span class="n">path</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">sage</span><span class="o">/</span><span class="n">sage</span> <span class="o">-</span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
<p>This will install the newest Cython into SAGE.</p>
</div>
<div class="section" id="manual-compilation">
<h4>Manual compilation<a class="headerlink" href="#manual-compilation" title="Permalink to this headline">¶</a></h4>
<p>As it is always important to know what is going on, I’ll describe the manual
method here. First Cython is run:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cython</span> <span class="n">yourmod</span><span class="o">.</span><span class="n">pyx</span>
</pre></div>
</div>
<p>This creates <code class="file docutils literal notranslate"><span class="pre">yourmod.c</span></code> which is the C source for a Python extension
module. A useful additional switch is <code class="docutils literal notranslate"><span class="pre">-a</span></code> which will generate a document
<code class="file docutils literal notranslate"><span class="pre">yourmod.html</span></code>) that shows which Cython code translates to which C code
line by line.</p>
<p>Then we compile the C file. This may vary according to your system, but the C
file should be built like Python was built. Python documentation for writing
extensions should have some details. On Linux this often means something
like:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">shared</span> <span class="o">-</span><span class="n">pthread</span> <span class="o">-</span><span class="n">fPIC</span> <span class="o">-</span><span class="n">fwrapv</span> <span class="o">-</span><span class="n">O2</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">strict</span><span class="o">-</span><span class="n">aliasing</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">include</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mf">7</span> <span class="o">-</span><span class="n">o</span> <span class="n">yourmod</span><span class="o">.</span><span class="n">so</span> <span class="n">yourmod</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">gcc</span></code> should have access to the NumPy C header files so if they are not
installed at <code class="file docutils literal notranslate"><span class="pre">/usr/include/numpy</span></code> or similar you may need to pass another
option for those. You only need to provide the NumPy headers if you write:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cimport</span> <span class="nn">numpy</span>
</pre></div>
</div>
<p>in your Cython code.</p>
<p>This creates <code class="file docutils literal notranslate"><span class="pre">yourmod.so</span></code> in the same directory, which is importable by
Python by using a normal <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">yourmod</span></code> statement.</p>
</div>
<div class="section" id="the-first-cython-program">
<h4>The first Cython program<a class="headerlink" href="#the-first-cython-program" title="Permalink to this headline">¶</a></h4>
<p>You can easily execute the code of this tutorial by
downloading <a class="reference external" href="https://github.com/cython/cython/blob/master/docs/examples/userguide/numpy_tutorial/numpy_and_cython.ipynb">the Jupyter notebook</a>.</p>
<p>The code below does the equivalent of this function in numpy:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_np</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>
</div>
<p>We’ll say that <code class="docutils literal notranslate"><span class="pre">array_1</span></code> and <code class="docutils literal notranslate"><span class="pre">array_2</span></code> are 2D NumPy arrays of integer type and
<code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code> and <code class="docutils literal notranslate"><span class="pre">c</span></code> are three Python integers.</p>
<p>This function uses NumPy and is already really fast, so it might be a bit overkill
to do it again with Cython. This is for demonstration purposes. Nonetheless, we
will show that we achieve a better speed and memory efficiency than NumPy at the cost of more verbosity.</p>
<p>This code computes the function with the loops over the two dimensions being unrolled.
It is both valid Python and valid Cython code. I’ll refer to it as both
<code class="file docutils literal notranslate"><span class="pre">compute_py.py</span></code> for the Python version and <code class="file docutils literal notranslate"><span class="pre">compute_cy.pyx</span></code> for the
Cython version – Cython uses <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> as its file suffix (but it can also compile
<code class="docutils literal notranslate"><span class="pre">.py</span></code> files).</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">),</span> <span class="n">max_value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function must implement the formula</span>
<span class="sd">    np.clip(array_1, 2, 10) * a + array_2 * b + c</span>

<span class="sd">    array_1 and array_2 are 2D.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">array_2</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">array_1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_max</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_max</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
            <span class="n">result</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>This should be compiled to produce <code class="file docutils literal notranslate"><span class="pre">compute_cy.so</span></code> for Linux systems
(on Windows systems, this will be a <code class="docutils literal notranslate"><span class="pre">.pyd</span></code> file). We
run a Python session to test both the Python version (imported from
<code class="docutils literal notranslate"><span class="pre">.py</span></code>-file) and the compiled Cython module.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="gp">In [2]: </span><span class="n">array_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>
<span class="gp">In [3]: </span><span class="n">array_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>
<span class="gp">In [4]: </span><span class="n">a</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">In [5]: </span><span class="n">b</span> <span class="o">=</span> <span class="mi">3</span>
<span class="gp">In [6]: </span><span class="n">c</span> <span class="o">=</span> <span class="mi">9</span>
<span class="gp">In [7]: </span><span class="k">def</span> <span class="nf">compute_np</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="gp">   ...:</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
<span class="gp">In [8]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">compute_np</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">103 ms ± 4.16 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>

<span class="gp">In [9]: </span><span class="kn">import</span> <span class="nn">compute_py</span>
<span class="gp">In [10]: </span><span class="n">compute_py</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">1min 10s ± 844 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>

<span class="gp">In [11]: </span><span class="kn">import</span> <span class="nn">compute_cy</span>
<span class="gp">In [12]: </span><span class="n">compute_cy</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">56.5 s ± 587 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<p>There’s not such a huge difference yet; because the C code still does exactly
what the Python interpreter does (meaning, for instance, that a new object is
allocated for each number used).</p>
<p>You can look at the Python interaction and the generated C
code by using <code class="docutils literal notranslate"><span class="pre">-a</span></code> when calling Cython from the command
line, <code class="docutils literal notranslate"><span class="pre">%%cython</span> <span class="pre">-a</span></code> when using a Jupyter Notebook, or by using
<code class="docutils literal notranslate"><span class="pre">cythonize('compute_cy.pyx',</span> <span class="pre">annotate=True)</span></code> when using a <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>.
Look at the generated html file and see what
is needed for even the simplest statements. You get the point quickly. We need
to give Cython more information; we need to add types.</p>
</div>
<div class="section" id="adding-types">
<h4>Adding types<a class="headerlink" href="#adding-types" title="Permalink to this headline">¶</a></h4>
<p>To add types we use custom Cython syntax, so we are now breaking Python source
compatibility. Here’s <code class="file docutils literal notranslate"><span class="pre">compute_typed.pyx</span></code>. <em>Read the comments!</em></p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c"># We now need to fix a datatype for our arrays. I&#39;ve used the variable</span>
<span class="c"># DTYPE for this, which is assigned to the usual NumPy runtime</span>
<span class="c"># type info object.</span>
<span class="n">DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intc</span>

<span class="c"># cdef means here that this function is a plain C function (so faster).</span>
<span class="c"># To get all the benefits, we type the arguments and the return value.</span>
<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">clip</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">min_value</span><span class="p">,</span> <span class="nb">int</span> <span class="n">max_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">),</span> <span class="n">max_value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">c</span><span class="p">):</span>

    <span class="c"># The &quot;cdef&quot; keyword is also used within functions to type variables. It</span>
    <span class="c"># can only be used at the top indentation level (there are non-trivial</span>
    <span class="c"># problems with allowing them in other places, though we&#39;d love to see</span>
    <span class="c"># good and thought out proposals for it).</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">x_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">y_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">array_2</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">array_1</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DTYPE</span>
    <span class="k">assert</span> <span class="n">array_2</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">DTYPE</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>

    <span class="c"># It is very important to type ALL your variables. You do not get any</span>
    <span class="c"># warnings if not, only much slower code (they are implicitly typed as</span>
    <span class="c"># Python objects).</span>
    <span class="c"># For the &quot;tmp&quot; variable, we want to use the same data type as is</span>
    <span class="c"># stored in the array, so we use int because it correspond to np.intc.</span>
    <span class="c"># NB! An important side-effect of this is that if &quot;tmp&quot; overflows its</span>
    <span class="c"># datatype size, it will simply wrap around like in C, rather than raise</span>
    <span class="c"># an error like in Python.</span>

    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">tmp</span>

    <span class="c"># Py_ssize_t is the proper C type for Python array indices.</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">x</span><span class="p">,</span> <span class="nf">y</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_max</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_max</span><span class="p">):</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
            <span class="n">result</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<div class="figure">
<img alt="_images/compute_typed_html.jpg" src="_images/compute_typed_html.jpg" />
</div>
<p>At this point, have a look at the generated C code for <code class="file docutils literal notranslate"><span class="pre">compute_cy.pyx</span></code> and
<code class="file docutils literal notranslate"><span class="pre">compute_typed.pyx</span></code>. Click on the lines to expand them and see corresponding C.</p>
<p>Especially have a look at the <code class="docutils literal notranslate"><span class="pre">for-loops</span></code>: In <code class="file docutils literal notranslate"><span class="pre">compute_cy.c</span></code>, these are ~20 lines
of C code to set up while in <code class="file docutils literal notranslate"><span class="pre">compute_typed.c</span></code> a normal C for loop is used.</p>
<p>After building this and continuing my (very informal) benchmarks, I get:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [13]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">compute_typed</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">26.5 s ± 422 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<p>So adding types does make the code faster, but nowhere
near the speed of NumPy?</p>
<p>What happened is that most of the time spend in this code is spent in the following lines,
and those lines are slower to execute than in pure Python:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
<span class="n">result</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>
</div>
<p>So what made those line so much slower than in the pure Python version?</p>
<p><code class="docutils literal notranslate"><span class="pre">array_1</span></code> and <code class="docutils literal notranslate"><span class="pre">array_2</span></code> are still NumPy arrays, so Python objects, and expect
Python integers as indexes. Here we pass C int values. So every time
Cython reaches this line, it has to convert all the C integers to Python
int objects. Since this line is called very often, it outweighs the speed
benefits of the pure C loops that were created from the <code class="docutils literal notranslate"><span class="pre">range()</span></code> earlier.</p>
<p>Furthermore, <code class="docutils literal notranslate"><span class="pre">tmp</span> <span class="pre">*</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">array_2[x,</span> <span class="pre">y]</span> <span class="pre">*</span> <span class="pre">b</span></code> returns a Python integer
and <code class="docutils literal notranslate"><span class="pre">tmp</span></code> is a C integer, so Cython has to do type conversions again.
In the end those types conversions add up. And made our computation really
slow. But this problem can be solved easily by using memoryviews.</p>
</div>
<div class="section" id="efficient-indexing-with-memoryviews">
<h4>Efficient indexing with memoryviews<a class="headerlink" href="#efficient-indexing-with-memoryviews" title="Permalink to this headline">¶</a></h4>
<p>There are still two bottlenecks that degrade the performance, and that is the array lookups
and assignments, as well as C/Python types conversion.
The <code class="docutils literal notranslate"><span class="pre">[]</span></code>-operator still uses full Python operations –
what we would like to do instead is to access the data buffer directly at C
speed.</p>
<p>What we need to do then is to type the contents of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">ndarray</span></code> objects.
We do this with a memoryview. There is <a class="reference internal" href="index.html#memoryviews"><span class="std std-ref">a page in the Cython documentation</span></a> dedicated to it.</p>
<p>In short, memoryviews are C structures that can hold a pointer to the data
of a NumPy array and all the necessary buffer metadata to provide efficient
and safe access: dimensions, strides, item size, item type information, etc…
They also support slices, so they work even if
the NumPy array isn’t contiguous in memory.
They can be indexed by C integers, thus allowing fast access to the
NumPy array data.</p>
<p>Here is how to declare a memoryview of integers:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:]</span> <span class="n">foo</span>         <span class="c"># 1D memoryview</span>
<span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:,</span> <span class="p">:]</span> <span class="n">foo</span>      <span class="c"># 2D memoryview</span>
<span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">foo</span>   <span class="c"># 3D memoryview</span>
<span class="o">...</span>                      <span class="c"># You get the idea.</span>
</pre></div>
</div>
<p>No data is copied from the NumPy array to the memoryview in our example.
As the name implies, it is only a “view” of the memory. So we can use the
view <code class="docutils literal notranslate"><span class="pre">result_view</span></code> for efficient indexing and at the end return the real NumPy
array <code class="docutils literal notranslate"><span class="pre">result</span></code> that holds the data that we operated on.</p>
<p>Here is how to use them in our code:</p>
<p><code class="file docutils literal notranslate"><span class="pre">compute_memview.pyx</span></code></p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intc</span>


<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">clip</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">min_value</span><span class="p">,</span> <span class="nb">int</span> <span class="n">max_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">),</span> <span class="n">max_value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">array_1</span><span class="p">,</span> <span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">array_2</span><span class="p">,</span> <span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">c</span><span class="p">):</span>

    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">x_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">y_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>

    <span class="c"># array_1.shape is now a C array, no it&#39;s not possible</span>
    <span class="c"># to compare it simply by using == without a for-loop.</span>
    <span class="c"># To be able to compare it to array_2.shape easily,</span>
    <span class="c"># we convert them both to Python tuples.</span>
    <span class="k">assert</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">:]</span> <span class="n">result_view</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">tmp</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">x</span><span class="p">,</span> <span class="nf">y</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_max</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_max</span><span class="p">):</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
            <span class="n">result_view</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Let’s see how much faster accessing is now.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [22]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">compute_memview</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">22.9 ms ± 197 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</pre></div>
</div>
<p>Note the importance of this change.
We’re now 3081 times faster than an interpreted version of Python and 4.5 times
faster than NumPy.</p>
<p>Memoryviews can be used with slices too, or even
with Python arrays. Check out the <a class="reference internal" href="index.html#memoryviews"><span class="std std-ref">memoryview page</span></a> to
see what they can do for you.</p>
</div>
<div class="section" id="tuning-indexing-further">
<h4>Tuning indexing further<a class="headerlink" href="#tuning-indexing-further" title="Permalink to this headline">¶</a></h4>
<p>The array lookups are still slowed down by two factors:</p>
<ol class="arabic simple">
<li>Bounds checking is performed.</li>
<li>Negative indices are checked for and handled correctly.  The code above is
explicitly coded so that it doesn’t use negative indices, and it
(hopefully) always access within bounds.</li>
</ol>
<p>With decorators, we can deactivate those checks:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">cimport</span> <span class="nn">cython</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># Deactivate bounds checking</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>   <span class="c"># Deactivate negative indexing.</span>
<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">array_1</span><span class="p">,</span> <span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">array_2</span><span class="p">,</span> <span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">c</span><span class="p">):</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Now bounds checking is not performed (and, as a side-effect, if you ‘’do’’
happen to access out of bounds you will in the best case crash your program
and in the worst case corrupt data). It is possible to switch bounds-checking
mode in many ways, see <a class="reference internal" href="index.html#compiler-directives"><span class="std std-ref">Compiler directives</span></a> for more
information.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [23]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">compute_index</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">16.8 ms ± 25.4 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</pre></div>
</div>
<p>We’re faster than the NumPy version (6.2x). NumPy is really well written,
but does not performs operation lazily, resulting in a lot
of intermediate copy operations in memory. Our version is
very memory efficient and cache friendly because we
can execute the operations in a single run over the data.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Speed comes with some cost. Especially it can be dangerous to set typed
objects (like <code class="docutils literal notranslate"><span class="pre">array_1</span></code>, <code class="docutils literal notranslate"><span class="pre">array_2</span></code> and <code class="docutils literal notranslate"><span class="pre">result_view</span></code> in our sample code) to <code class="docutils literal notranslate"><span class="pre">None</span></code>.
Setting such objects to <code class="docutils literal notranslate"><span class="pre">None</span></code> is entirely legal, but all you can do with them
is check whether they are None. All other use (attribute lookup or indexing)
can potentially segfault or corrupt data (rather than raising exceptions as
they would in Python).</p>
<p class="last">The actual rules are a bit more complicated but the main message is clear: Do
not use typed objects without knowing that they are not set to <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</div>
<div class="section" id="declaring-the-numpy-arrays-as-contiguous">
<h4>Declaring the NumPy arrays as contiguous<a class="headerlink" href="#declaring-the-numpy-arrays-as-contiguous" title="Permalink to this headline">¶</a></h4>
<p>For extra speed gains, if you know that the NumPy arrays you are
providing are contiguous in memory, you can declare the
memoryview as contiguous.</p>
<p>We give an example on an array that has 3 dimensions.
If you want to give Cython the information that the data is C-contiguous
you have to declare the memoryview like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a</span>
</pre></div>
</div>
<p>If you want to give Cython the information that the data is Fortran-contiguous
you have to declare the memoryview like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">int</span> [<span class="p">::</span><span class="mf">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">a</span>
</pre></div>
</div>
<p>If all this makes no sense to you, you can skip this part, declaring
arrays as contiguous constrains the usage of your functions as it rejects array slices as input.
If you still want to understand what contiguous arrays are
all about, you can see <a class="reference external" href="https://stackoverflow.com/questions/26998223/what-is-the-difference-between-contiguous-and-non-contiguous-arrays">this answer on StackOverflow</a>.</p>
<p>For the sake of giving numbers, here are the speed gains that you should
get by declaring the memoryviews as contiguous:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [23]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">compute_contiguous</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">11.1 ms ± 30.2 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</pre></div>
</div>
<p>We’re now around nine times faster than the NumPy version, and 6300 times
faster than the pure Python version!</p>
</div>
<div class="section" id="making-the-function-cleaner">
<h4>Making the function cleaner<a class="headerlink" href="#making-the-function-cleaner" title="Permalink to this headline">¶</a></h4>
<p>Declaring types can make your code quite verbose. If you don’t mind
Cython inferring the C types of your variables, you can use
the <code class="docutils literal notranslate"><span class="pre">infer_types=True</span></code> compiler directive at the top of the file.
It will save you quite a bit of typing.</p>
<p>Note that since type declarations must happen at the top indentation level,
Cython won’t infer the type of variables declared for the first time
in other indentation levels. It would change too much the meaning of
our code. This is why, we must still declare manually the type of the
<code class="docutils literal notranslate"><span class="pre">tmp</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> variable.</p>
<p>And actually, manually giving the type of the <code class="docutils literal notranslate"><span class="pre">tmp</span></code> variable will
be useful when using fused types.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: infer_types=True</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">cimport</span> <span class="nn">cython</span>

<span class="n">DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intc</span>


<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">clip</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">min_value</span><span class="p">,</span> <span class="nb">int</span> <span class="n">max_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">),</span> <span class="n">max_value</span><span class="p">)</span>


<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">array_1</span><span class="p">,</span> <span class="nb">int</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">array_2</span><span class="p">,</span> <span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">c</span><span class="p">):</span>

    <span class="n">x_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">result_view</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">tmp</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">x</span><span class="p">,</span> <span class="nf">y</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_max</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_max</span><span class="p">):</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
            <span class="n">result_view</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>We now do a speed test:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [24]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">compute_infer_types</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">11.5 ms ± 261 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</pre></div>
</div>
<p>Lo and behold, the speed has not changed.</p>
</div>
<div class="section" id="more-generic-code">
<h4>More generic code<a class="headerlink" href="#more-generic-code" title="Permalink to this headline">¶</a></h4>
<p>All those speed gains are nice, but adding types constrains our code.
At the moment, it would mean that our function can only work with
NumPy arrays with the <code class="docutils literal notranslate"><span class="pre">np.intc</span></code> type. Is it possible to make our
code work for multiple NumPy data types?</p>
<p>Yes, with the help of a new feature called fused types.
You can learn more about it at <a class="reference internal" href="index.html#fusedtypes"><span class="std std-ref">this section of the documentation</span></a>.
It is similar to C++ ‘s templates. It generates multiple function declarations
at compile time, and then chooses the right one at run-time based on the
types of the arguments provided. By comparing types in if-conditions, it
is also possible to execute entirely different code paths depending
on the specific data type.</p>
<p>In our example, since we don’t have access anymore to the NumPy’s dtype
of our input arrays, we use those <code class="docutils literal notranslate"><span class="pre">if-else</span></code> statements to
know what NumPy data type we should use for our output array.</p>
<p>In this case, our function now works for ints, doubles and floats.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: infer_types=True</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">cimport</span> <span class="nn">cython</span>

<span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">my_type</span><span class="p">:</span>
    <span class="nb">int</span>
    <span class="n">double</span>
    <span class="nb">long</span> <span class="nb">long</span>


<span class="k">cdef</span> <span class="kt">my_type</span> <span class="nf">clip</span><span class="p">(</span><span class="n">my_type</span> <span class="n">a</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">max_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">),</span> <span class="n">max_value</span><span class="p">)</span>


<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">my_type</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">array_1</span><span class="p">,</span> <span class="n">my_type</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">a</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">b</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">c</span><span class="p">):</span>

    <span class="n">x_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">my_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intc</span>
    <span class="k">elif</span> <span class="n">my_type</span> <span class="ow">is</span> <span class="n">double</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span>
    <span class="k">elif</span> <span class="n">my_type</span> <span class="ow">is</span> <span class="n">cython</span><span class="o">.</span><span class="n">longlong</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longlong</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">my_type</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">result_view</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">cdef</span> <span class="kt">my_type</span> <span class="nf">tmp</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">x</span><span class="p">,</span> <span class="nf">y</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_max</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_max</span><span class="p">):</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
            <span class="n">result_view</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>We can check that the output type is the right one:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
<span class="n">dtype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span> <span class="n">array_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
<span class="n">dtype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We now do a speed test:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [25]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">compute_fused_types</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">11.5 ms ± 258 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</pre></div>
</div>
<p>More versions of the function are created at compile time. So it makes
sense that the speed doesn’t change for executing this function with
integers as before.</p>
</div>
<div class="section" id="using-multiple-threads">
<h4>Using multiple threads<a class="headerlink" href="#using-multiple-threads" title="Permalink to this headline">¶</a></h4>
<p>Cython has support for OpenMP.  It also has some nice wrappers around it,
like the function <code class="xref py py-func docutils literal notranslate"><span class="pre">prange()</span></code>. You can see more information about Cython and
parallelism in <a class="reference internal" href="index.html#parallel"><span class="std std-ref">Using Parallelism</span></a>. Since we do elementwise operations, we can easily
distribute the work among multiple threads. It’s important not to forget to pass the
correct arguments to the compiler to enable OpenMP. When using the Jupyter notebook,
you should use the cell magic like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">cython</span> <span class="o">--</span><span class="n">force</span>
<span class="c"># distutils: extra_compile_args=-fopenmp</span>
<span class="c"># distutils: extra_link_args=-fopenmp</span>
</pre></div>
</div>
<p>The GIL must be released (see <a class="reference internal" href="index.html#nogil"><span class="std std-ref">Releasing the GIL</span></a>), so this is why we
declare our <code class="xref py py-func docutils literal notranslate"><span class="pre">clip()</span></code> function <code class="docutils literal notranslate"><span class="pre">nogil</span></code>.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># tag: openmp</span>
<span class="c"># You can ignore the previous line.</span>
<span class="c"># It&#39;s for internal testing of the cython documentation.</span>

<span class="c"># distutils: extra_compile_args=-fopenmp</span>
<span class="c"># distutils: extra_link_args=-fopenmp</span>

<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">cimport</span> <span class="nn">cython</span>
<span class="k">from</span> <span class="nn">cython.parallel</span> <span class="k">import</span> <span class="n">prange</span>

<span class="k">ctypedef</span> <span class="n">fused</span> <span class="n">my_type</span><span class="p">:</span>
    <span class="nb">int</span>
    <span class="n">double</span>
    <span class="nb">long</span> <span class="nb">long</span>


<span class="c"># We declare our plain c function nogil</span>
<span class="k">cdef</span> <span class="kt">my_type</span> <span class="nf">clip</span><span class="p">(</span><span class="n">my_type</span> <span class="n">a</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">max_value</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">),</span> <span class="n">max_value</span><span class="p">)</span>


<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">my_type</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">array_1</span><span class="p">,</span> <span class="n">my_type</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">a</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">b</span><span class="p">,</span> <span class="n">my_type</span> <span class="n">c</span><span class="p">):</span>

    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">x_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">y_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">my_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intc</span>
    <span class="k">elif</span> <span class="n">my_type</span> <span class="ow">is</span> <span class="n">double</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span>
    <span class="k">elif</span> <span class="n">my_type</span> <span class="ow">is</span> <span class="n">cython</span><span class="o">.</span><span class="n">longlong</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longlong</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">my_type</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">result_view</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">cdef</span> <span class="kt">my_type</span> <span class="nf">tmp</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">x</span><span class="p">,</span> <span class="nf">y</span>

    <span class="c"># We use prange here.</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="k">nogil</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_max</span><span class="p">):</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
            <span class="n">result_view</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>We can have substantial speed gains for minimal effort:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [25]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">compute_prange</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="go">9.33 ms ± 412 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</pre></div>
</div>
<p>We’re now 7558 times faster than the pure Python version and 11.1 times faster
than NumPy!</p>
</div>
<div class="section" id="where-to-go-from-here">
<h4>Where to go from here?<a class="headerlink" href="#where-to-go-from-here" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>If you want to learn how to make use of <a class="reference external" href="https://www.netlib.org/blas/">BLAS</a>
or <a class="reference external" href="https://www.netlib.org/lapack/">LAPACK</a> with Cython, you can watch
<a class="reference external" href="https://www.youtube.com/watch?v=R4yB-8tB0J0&amp;t=693s&amp;ab_channel=Enthought">the presentation of Ian Henriksen at SciPy 2015</a>.</li>
<li>If you want to learn how to use Pythran as backend in Cython, you
can see how in <a class="reference internal" href="index.html#numpy-pythran"><span class="std std-ref">Pythran as a NumPy backend</span></a>.
Note that using Pythran only works with the
<a class="reference internal" href="index.html#working-numpy"><span class="std std-ref">old buffer syntax</span></a> and not yet with memoryviews.</li>
</ul>
</div>
</div>
<span id="document-src/userguide/numpy_pythran"></span><div class="section" id="pythran-as-a-numpy-backend">
<span id="numpy-pythran"></span><h3>Pythran as a Numpy backend<a class="headerlink" href="#pythran-as-a-numpy-backend" title="Permalink to this headline">¶</a></h3>
<p>Using the flag <code class="docutils literal notranslate"><span class="pre">--np-pythran</span></code>, it is possible to use the <a class="reference external" href="https://github.com/serge-sans-paille/pythran">Pythran</a> numpy
implementation for numpy related operations. One advantage to use this backend
is that the Pythran implementation uses C++ expression templates to save memory
transfers and can benefit from SIMD instructions of modern CPU.</p>
<p>This can lead to really interesting speedup in some cases, going from 2 up to
16, depending on the targeted CPU architecture and the original algorithm.</p>
<p>Please note that this feature is experimental.</p>
<div class="section" id="usage-example-with-distutils">
<h4>Usage example with distutils<a class="headerlink" href="#usage-example-with-distutils" title="Permalink to this headline">¶</a></h4>
<p>You first need to install Pythran. See its <a class="reference external" href="https://pythran.readthedocs.io/">documentation</a> for more information.</p>
<p>Then, simply add a <code class="docutils literal notranslate"><span class="pre">cython:</span> <span class="pre">np_pythran=True</span></code> directive at the top of the
Python files that needs to be compiled using Pythran numpy support.</p>
<p>Here is an example of a simple <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file using distutils:</p>
<div class="code highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;My hello app&quot;</span><span class="p">,</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="s1">&#39;hello_pythran.pyx&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Then, with the following header in <code class="docutils literal notranslate"><span class="pre">hello_pythran.pyx</span></code>:</p>
<div class="code highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># cython: np_pythran=True</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">hello_pythran.pyx</span></code> will be compiled using Pythran numpy support.</p>
<p>Please note that Pythran can further be tweaked by adding settings in the
<code class="docutils literal notranslate"><span class="pre">$HOME/.pythranrc</span></code> file. For instance, this can be used to enable <a class="reference external" href="https://github.com/NumScale/boost.simd">Boost.SIMD</a> support.
See the <a class="reference external" href="https://pythran.readthedocs.io/en/latest/MANUAL.html#customizing-your-pythranrc">Pythran user manual</a> for
more information.</p>
</div>
</div>
</div>
<div class="section" id="indices-and-tables">
<h3>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></li>
<li><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
<div class="toctree-wrapper compound">
</div>
</div>
</div>
<span id="document-src/changes"></span><div class="section" id="cython-changelog">
<h2>Cython Changelog<a class="headerlink" href="#cython-changelog" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>3.0.0 (2019-??-??)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="section" id="features-added">
<h4>Features added<a class="headerlink" href="#features-added" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil/nogil</span></code> statements can be conditional based on compile-time
constants, e.g. fused type checks.
Patch by Noam Hershtig.  (Github issue #2579)</li>
<li>Reimports of already imported modules are substantially faster.
(Github issue #2854)</li>
<li>Positional-only arguments are supported in Python functions.
Patch by Josh Tobin.  (Github issue #2915)</li>
<li>The <code class="docutils literal notranslate"><span class="pre">volatile</span></code> C modifier is supported in Cython code.
Patch by Jeroen Demeyer.  (Github issue #1667)</li>
<li><code class="docutils literal notranslate"><span class="pre">&#64;cython.trashcan(True)</span></code> can be used on an extension type to enable the
CPython trashcan. This allows deallocating deeply recursive objects without
overflowing the stack.  Patch by Jeroen Demeyer.  (Github issue #2842)</li>
<li><code class="docutils literal notranslate"><span class="pre">?</span></code> is supported as NumPy dtype for <code class="docutils literal notranslate"><span class="pre">bool</span></code>.
Patch by Max Klein.  (Github issue #2675)</li>
<li>Properties can be defined for external extension types.
Patch by Matti Picus.  (Github issue #2640)</li>
<li>Multiplication of Python numbers with small constant integers is faster.
(Github issue #2808)</li>
<li>Extension types that do not need their own <code class="docutils literal notranslate"><span class="pre">tp_new</span></code> implementation (because
they have no object attributes etc.) directly inherit the implementation of
their parent type if possible.
(Github issue #1555)</li>
<li>The attributes <code class="docutils literal notranslate"><span class="pre">gen.gi_frame</span></code> and <code class="docutils literal notranslate"><span class="pre">coro.cr_frame</span></code> of Cython compiled
generators and coroutines now return an actual frame object for introspection.
(Github issue #2306)</li>
<li>Several missing declarations in <code class="docutils literal notranslate"><span class="pre">cpython.*</span></code> were added.
Patches by Jeroen Demeyer and Zackery Spytz.  (Github issues #2826, #2713)</li>
<li>The builtin <code class="docutils literal notranslate"><span class="pre">abs()</span></code> function can now be used on C numbers in nogil code.
Patch by Elliott Sales de Andrade.  (Github issue #2748)</li>
<li>PEP-479 (<code class="docutils literal notranslate"><span class="pre">generator_stop</span></code>) is now enabled by default with language level 3.
(Github issue #2580)</li>
<li>Code annotation accepts a new debugging argument <code class="docutils literal notranslate"><span class="pre">--annotate-fullc</span></code> that
will include the complete syntax highlighted C file in the HTML output.
(Github issue #2855)</li>
<li><code class="docutils literal notranslate"><span class="pre">--no-capture</span></code> added to <code class="docutils literal notranslate"><span class="pre">runtests.py</span></code> to prevent stdout/stderr capturing
during srctree tests.  Patch by Matti Picus.</li>
<li><code class="docutils literal notranslate"><span class="pre">--no-docstrings</span></code> option added to <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> script.
Original patch by mo-han.  (Github issue #2889)</li>
<li>The <code class="docutils literal notranslate"><span class="pre">&#64;cython.binding</span></code> decorator is available in Python code.</li>
</ul>
</div>
<div class="section" id="bugs-fixed">
<h4>Bugs fixed<a class="headerlink" href="#bugs-fixed" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The unicode methods <code class="docutils literal notranslate"><span class="pre">.upper()</span></code>, <code class="docutils literal notranslate"><span class="pre">.lower()</span></code> and <code class="docutils literal notranslate"><span class="pre">.title()</span></code> were
incorrectly optimised for single character input values and only returned
the first character if multiple characters should have been returned.
They now use the original Python methods again.</li>
<li>Nested dict literals in function call kwargs could incorrectly raise an
error about duplicate keyword arguments, which are allowed when passing
them from dict literals.
(Github issue #2963)</li>
<li>Item access (subscripting) with integer indices/keys always tried the
Sequence protocol before the Mapping protocol, which diverged from Python
semantics.  It now passes through the Mapping protocol first when supported.
(Github issue #1807)</li>
<li>Broadcast assignments to a multi-dimensional memory view slice could end
up in the wrong places when the underlying memory view is known to be
contiguous but the slice is not.
(Github issue #2941)</li>
<li>Pickling unbound methods of Python classes failed.
Patch by Pierre Glaser.  (Github issue #2972)</li>
<li>The <code class="docutils literal notranslate"><span class="pre">Py_hash_t</span></code> type failed to accept arbitrary “index” values.
(Github issue #2752)</li>
<li>The first function line number of functions with decorators pointed to the
signature line and not the first decorator line, as in Python.
Patch by Felix Kohlgrüber.  (Github issue #2536)</li>
<li>Constant integer expressions that used a negative exponent were evaluated
as integer 0 instead of the expected float value.
Patch by Kryštof Pilnáček.  (Github issue #2133)</li>
<li><code class="docutils literal notranslate"><span class="pre">__doc__</span></code> was not available inside of the class body during class creation.
(Github issue #1635)</li>
<li>Setting <code class="docutils literal notranslate"><span class="pre">language_level=2</span></code> in a file did not work if <code class="docutils literal notranslate"><span class="pre">language_level=3</span></code>
was enabled globally before.
Patch by Jeroen Demeyer.  (Github issue #2791)</li>
<li><code class="docutils literal notranslate"><span class="pre">__init__.pyx</span></code> files were not always considered as package indicators.
(Github issue #2665)</li>
<li>Compiling package <code class="docutils literal notranslate"><span class="pre">__init__</span></code> files could fail under Windows due to an
undefined export symbol.  (Github issue #2968)</li>
<li>A C compiler cast warning was resolved.
Patch by Michael Buesch.  (Github issue #2775)</li>
</ul>
</div>
<div class="section" id="other-changes">
<h4>Other changes<a class="headerlink" href="#other-changes" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The default language level was changed to <code class="docutils literal notranslate"><span class="pre">3str</span></code>, i.e. Python 3 semantics,
but with <code class="docutils literal notranslate"><span class="pre">str</span></code> literals (also in Python 2.7).  This is a backwards incompatible
change from the previous default of Python 2 semantics.  The previous behaviour
is available through the directive <code class="docutils literal notranslate"><span class="pre">language_level=2</span></code>.</li>
<li>Cython no longer generates <code class="docutils literal notranslate"><span class="pre">__qualname__</span></code> attributes for classes in Python
2.x since they are problematic there and not correctly maintained for subclasses.
Patch by Jeroen Demeyer.  (Github issue #2772)</li>
<li>Source file fingerprinting now uses SHA-1 instead of MD5 since the latter
tends to be slower and less widely supported these days.
(Github issue #2790)</li>
<li>The long deprecated include files <code class="docutils literal notranslate"><span class="pre">python_*</span></code>, <code class="docutils literal notranslate"><span class="pre">stdio</span></code>, <code class="docutils literal notranslate"><span class="pre">stdlib</span></code> and
<code class="docutils literal notranslate"><span class="pre">stl</span></code> in <code class="docutils literal notranslate"><span class="pre">Cython/Includes/Deprecated/</span></code> were removed.  Use the <code class="docutils literal notranslate"><span class="pre">libc.*</span></code>
and <code class="docutils literal notranslate"><span class="pre">cpython.*</span></code> pxd modules instead.
Patch by Jeroen Demeyer.  (Github issue #2904)</li>
<li>The search order for include files was changed. Previously it was
<code class="docutils literal notranslate"><span class="pre">include_directories</span></code>, <code class="docutils literal notranslate"><span class="pre">Cython/Includes</span></code>, <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>. Now it is
<code class="docutils literal notranslate"><span class="pre">include_directories</span></code>, <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>, <code class="docutils literal notranslate"><span class="pre">Cython/Includes</span></code>. This was done to
allow third-party <code class="docutils literal notranslate"><span class="pre">*.pxd</span></code> files to override the ones in Cython.
Patch by Matti Picus.  (Github issue #2905)</li>
<li>The command line parser was rewritten and modernised using <code class="docutils literal notranslate"><span class="pre">argparse</span></code>.
Patch by Egor Dranischnikow.  (Github issue #2952)</li>
<li>Support for Python 2.6 was removed.</li>
</ul>
</div>
</div>
<div class="section" id="id2">
<h3>0.29.10 (2019-06-02)<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id3">
<h4>Bugs fixed<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Fix compile errors in CPython 3.8b1 due to the new “tp_vectorcall” slots.
(Github issue #2976)</li>
</ul>
</div>
</div>
<div class="section" id="id4">
<h3>0.29.9 (2019-05-29)<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id5">
<h4>Bugs fixed<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Fix a crash regression in 0.29.8 when creating code objects fails.</li>
<li>Remove an incorrect cast when using true-division in C++ operations.
(Github issue #1950)</li>
</ul>
</div>
</div>
<div class="section" id="id6">
<h3>0.29.8 (2019-05-28)<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id7">
<h4>Bugs fixed<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>C compile errors with CPython 3.8 were resolved.
Patch by Marcel Plch.  (Github issue #2938)</li>
<li>Python tuple constants that compare equal but have different item
types could incorrectly be merged into a single constant.
(Github issue #2919)</li>
<li>Non-ASCII characters in unprefixed strings could crash the compiler when
used with language level <code class="docutils literal notranslate"><span class="pre">3str</span></code>.</li>
<li>Starred expressions in %-formatting tuples could fail to compile for
unicode strings.  (Github issue #2939)</li>
<li>Passing Python class references through <code class="docutils literal notranslate"><span class="pre">cython.inline()</span></code> was broken.
(Github issue #2936)</li>
</ul>
</div>
</div>
<div class="section" id="id8">
<h3>0.29.7 (2019-04-14)<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id9">
<h4>Bugs fixed<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Crash when the shared Cython config module gets unloaded and another Cython
module reports an exceptions.  Cython now makes sure it keeps an owned reference
to the module.
(Github issue #2885)</li>
<li>Resolved a C89 compilation problem when enabling the fast-gil sharing feature.</li>
<li>Coverage reporting did not include the signature line of <code class="docutils literal notranslate"><span class="pre">cdef</span></code> functions.
(Github issue #1461)</li>
<li>Casting a GIL-requiring function into a nogil function now issues a warning.
(Github issue #2879)</li>
<li>Generators and coroutines were missing their return type annotation.
(Github issue #2884)</li>
</ul>
</div>
</div>
<div class="section" id="id10">
<h3>0.29.6 (2019-02-27)<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id11">
<h4>Bugs fixed<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Fix a crash when accessing the <code class="docutils literal notranslate"><span class="pre">__kwdefaults__</span></code> special attribute of
fused functions.  (Github issue #1470)</li>
<li>Fix the parsing of buffer format strings that contain numeric sizes, which
could lead to incorrect input rejections.  (Github issue #2845)</li>
<li>Avoid a C #pragma in old gcc versions that was only added in GCC 4.6.
Patch by Michael Anselmi.  (Github issue #2838)</li>
<li>Auto-encoding of Unicode strings to UTF-8 C/C++ strings failed in Python 3,
even though the default encoding there is UTF-8.
(Github issue #2819)</li>
</ul>
</div>
</div>
<div class="section" id="id12">
<h3>0.29.5 (2019-02-09)<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id13">
<h4>Bugs fixed<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Crash when defining a Python subclass of an extension type and repeatedly calling
a cpdef method on it.  (Github issue #2823)</li>
<li>Compiler crash when <code class="docutils literal notranslate"><span class="pre">prange()</span></code> loops appear inside of with-statements.
(Github issue #2780)</li>
<li>Some C compiler warnings were resolved.
Patches by Christoph Gohlke.  (Github issues #2815, #2816, #2817, #2822)</li>
<li>Python conversion of C++ enums failed in 0.29.
Patch by Orivej Desh.  (Github issue #2767)</li>
</ul>
</div>
</div>
<div class="section" id="id14">
<h3>0.29.4 (2019-02-01)<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Division of numeric constants by a runtime value of 0 could fail to raise a
<code class="docutils literal notranslate"><span class="pre">ZeroDivisionError</span></code>.  (Github issue #2820)</li>
</ul>
</div>
<div class="section" id="id15">
<h3>0.29.3 (2019-01-19)<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id16">
<h4>Bugs fixed<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Some C code for memoryviews was generated in a non-deterministic order.
Patch by Martijn van Steenbergen.  (Github issue #2779)</li>
<li>C89 compatibility was accidentally lost since 0.28.
Patches by gastineau and true-pasky.  (Github issues #2778, #2801)</li>
<li>A C compiler cast warning was resolved.
Patch by Michael Buesch.  (Github issue #2774)</li>
<li>An compilation failure with complex numbers under MSVC++ was resolved.
(Github issue #2797)</li>
<li>Coverage reporting could fail when modules were moved around after the build.
Patch by Wenjun Si.  (Github issue #2776)</li>
</ul>
</div>
</div>
<div class="section" id="id17">
<h3>0.29.2 (2018-12-14)<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id18">
<h4>Bugs fixed<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The code generated for deduplicated constants leaked some references.
(Github issue #2750)</li>
<li>The declaration of <code class="docutils literal notranslate"><span class="pre">sigismember()</span></code> in <code class="docutils literal notranslate"><span class="pre">libc.signal</span></code> was corrected.
(Github issue #2756)</li>
<li>Crashes in compiler and test runner were fixed.
(Github issue #2736, #2755)</li>
<li>A C compiler warning about an invalid safety check was resolved.
(Github issue #2731)</li>
</ul>
</div>
</div>
<div class="section" id="id19">
<h3>0.29.1 (2018-11-24)<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id20">
<h4>Bugs fixed<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Extensions compiled with MinGW-64 under Windows could misinterpret integer
objects larger than 15 bit and return incorrect results.
(Github issue #2670)</li>
<li>Cython no longer requires the source to be writable when copying its data
into a memory view slice.
Patch by Andrey Paramonov.  (Github issue #2644)</li>
<li>Line tracing of <code class="docutils literal notranslate"><span class="pre">try</span></code>-statements generated invalid C code.
(Github issue #2274)</li>
<li>When using the <code class="docutils literal notranslate"><span class="pre">warn.undeclared</span></code> directive, Cython’s own code generated
warnings that are now fixed.
Patch by Nicolas Pauss.  (Github issue #2685)</li>
<li>Cython’s memoryviews no longer require strides for setting the shape field
but only the <code class="docutils literal notranslate"><span class="pre">PyBUF_ND</span></code> flag to be set.
Patch by John Kirkham.  (Github issue #2716)</li>
<li>Some C compiler warnings about unused memoryview code were fixed.
Patch by Ho Cheuk Ting.  (Github issue #2588)</li>
<li>A C compiler warning about implicit signed/unsigned conversion was fixed.
(Github issue #2729)</li>
<li>Assignments to C++ references returned by <code class="docutils literal notranslate"><span class="pre">operator[]</span></code> could fail to compile.
(Github issue #2671)</li>
<li>The power operator and the support for NumPy math functions were fixed
in Pythran expressions.
Patch by Serge Guelton.  (Github issues #2702, #2709)</li>
<li>Signatures with memory view arguments now show the expected type
when embedded in docstrings.
Patch by Matthew Chan and Benjamin Weigel.  (Github issue #2634)</li>
<li>Some <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">...</span> <span class="pre">cimport</span> <span class="pre">...</span></code> constructs were not correctly considered
when searching modified dependencies in <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code> to decide
whether to recompile a module.
Patch by Kryštof Pilnáček.  (Github issue #2638)</li>
<li>A struct field type in the <code class="docutils literal notranslate"><span class="pre">cpython.array</span></code> declarations was corrected.
Patch by John Kirkham.  (Github issue #2712)</li>
</ul>
</div>
</div>
<div class="section" id="id21">
<h3>0.29 (2018-10-14)<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id22">
<h4>Features added<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>PEP-489 multi-phase module initialisation has been enabled again.  Module
reloads in other subinterpreters raise an exception to prevent corruption
of the static module state.</li>
<li>A set of <code class="docutils literal notranslate"><span class="pre">mypy</span></code> compatible PEP-484 declarations were added for Cython’s C data
types to integrate with static analysers in typed Python code.  They are available
in the <code class="docutils literal notranslate"><span class="pre">Cython/Shadow.pyi</span></code> module and describe the types in the special <code class="docutils literal notranslate"><span class="pre">cython</span></code>
module that can be used for typing in Python code.
Original patch by Julian Gethmann. (Github issue #1965)</li>
<li>Memoryviews are supported in PEP-484/526 style type declarations.
(Github issue #2529)</li>
<li><code class="docutils literal notranslate"><span class="pre">&#64;cython.nogil</span></code> is supported as a C-function decorator in Python code.
(Github issue #2557)</li>
<li>Raising exceptions from nogil code will automatically acquire the GIL, instead
of requiring an explicit <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil</span></code> block.</li>
<li>C++ functions can now be declared as potentially raising both C++ and Python
exceptions, so that Cython can handle both correctly.
(Github issue #2615)</li>
<li><code class="docutils literal notranslate"><span class="pre">cython.inline()</span></code> supports a direct <code class="docutils literal notranslate"><span class="pre">language_level</span></code> keyword argument that
was previously only available via a directive.</li>
<li>A new language level name <code class="docutils literal notranslate"><span class="pre">3str</span></code> was added that mostly corresponds to language
level 3, but keeps unprefixed string literals as type ‘str’ in both Py2 and Py3,
and the builtin ‘str’ type unchanged.  This will become the default in the next
Cython release and is meant to help user code a) transition more easily to this
new default and b) migrate to Python 3 source code semantics without making support
for Python 2.x difficult.</li>
<li>In CPython 3.6 and later, looking up globals in the module dict is almost
as fast as looking up C globals.
(Github issue #2313)</li>
<li>For a Python subclass of an extension type, repeated method calls to non-overridden
cpdef methods can avoid the attribute lookup in Py3.6+, which makes them 4x faster.
(Github issue #2313)</li>
<li>(In-)equality comparisons of objects to integer literals are faster.
(Github issue #2188)</li>
<li>Some internal and 1-argument method calls are faster.</li>
<li>Modules that cimport many external extension types from other Cython modules
execute less import requests during module initialisation.</li>
<li>Constant tuples and slices are deduplicated and only created once per module.
(Github issue #2292)</li>
<li>The coverage plugin considers more C file extensions such as <code class="docutils literal notranslate"><span class="pre">.cc</span></code> and <code class="docutils literal notranslate"><span class="pre">.cxx</span></code>.
(Github issue #2266)</li>
<li>The <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> command accepts compile time variable values (as set by <code class="docutils literal notranslate"><span class="pre">DEF</span></code>)
through the new <code class="docutils literal notranslate"><span class="pre">-E</span></code> option.
Patch by Jerome Kieffer.  (Github issue #2315)</li>
<li><code class="docutils literal notranslate"><span class="pre">pyximport</span></code> can import from namespace packages.
Patch by Prakhar Goel.  (Github issue #2294)</li>
<li>Some missing numpy and CPython C-API declarations were added.
Patch by John Kirkham. (Github issues #2523, #2520, #2537)</li>
<li>Declarations for the <code class="docutils literal notranslate"><span class="pre">pylifecycle</span></code> C-API functions were added in a new .pxd file
<code class="docutils literal notranslate"><span class="pre">cpython.pylifecycle</span></code>.</li>
<li>The Pythran support was updated to work with the latest Pythran 0.8.7.
Original patch by Adrien Guinet.  (Github issue #2600)</li>
<li><code class="docutils literal notranslate"><span class="pre">%a</span></code> is included in the string formatting types that are optimised into f-strings.
In this case, it is also automatically mapped to <code class="docutils literal notranslate"><span class="pre">%r</span></code> in Python 2.x.</li>
<li>New C macro <code class="docutils literal notranslate"><span class="pre">CYTHON_HEX_VERSION</span></code> to access Cython’s version in the same style as
<code class="docutils literal notranslate"><span class="pre">PY_HEX_VERSION</span></code>.</li>
<li>Constants in <code class="docutils literal notranslate"><span class="pre">libc.math</span></code> are now declared as <code class="docutils literal notranslate"><span class="pre">const</span></code> to simplify their handling.</li>
<li>An additional <code class="docutils literal notranslate"><span class="pre">check_size</span></code> clause was added to the <code class="docutils literal notranslate"><span class="pre">ctypedef</span> <span class="pre">class</span></code> name
specification to allow suppressing warnings when importing modules with
backwards-compatible <code class="docutils literal notranslate"><span class="pre">PyTypeObject</span></code> size changes.
Patch by Matti Picus.  (Github issue #2627)</li>
</ul>
</div>
<div class="section" id="id23">
<h4>Bugs fixed<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The exception handling in generators and coroutines under CPython 3.7 was adapted
to the newly introduced exception stack.  Users of Cython 0.28 who want to support
Python 3.7 are encouraged to upgrade to 0.29 to avoid potentially incorrect error
reporting and tracebacks.  (Github issue #1958)</li>
<li>Crash when importing a module under Stackless Python that was built for CPython.
Patch by Anselm Kruis.  (Github issue #2534)</li>
<li>2-value slicing of typed sequences failed if the start or stop index was None.
Patch by Christian Gibson.  (Github issue #2508)</li>
<li>Multiplied string literals lost their factor when they are part of another
constant expression (e.g. ‘x’ * 10 + ‘y’ =&gt; ‘xy’).</li>
<li>String formatting with the ‘%’ operator didn’t call the special <code class="docutils literal notranslate"><span class="pre">__rmod__()</span></code>
method if the right side is a string subclass that implements it.
(Python issue 28598)</li>
<li>The directive <code class="docutils literal notranslate"><span class="pre">language_level=3</span></code> did not apply to the first token in the
source file.  (Github issue #2230)</li>
<li>Overriding cpdef methods did not work in Python subclasses with slots.
Note that this can have a performance impact on calls from Cython code.
(Github issue #1771)</li>
<li>Fix declarations of builtin or C types using strings in pure python mode.
(Github issue #2046)</li>
<li>Generator expressions and lambdas failed to compile in <code class="docutils literal notranslate"><span class="pre">&#64;cfunc</span></code> functions.
(Github issue #459)</li>
<li>Global names with <code class="docutils literal notranslate"><span class="pre">const</span></code> types were not excluded from star-import assignments
which could lead to invalid C code.
(Github issue #2621)</li>
<li>Several internal function signatures were fixed that lead to warnings in gcc-8.
(Github issue #2363)</li>
<li>The numpy helper functions <code class="docutils literal notranslate"><span class="pre">set_array_base()</span></code> and <code class="docutils literal notranslate"><span class="pre">get_array_base()</span></code>
were adapted to the current numpy C-API recommendations.
Patch by Matti Picus. (Github issue #2528)</li>
<li>Some NumPy related code was updated to avoid deprecated API usage.
Original patch by jbrockmendel.  (Github issue #2559)</li>
<li>Several C++ STL declarations were extended and corrected.
Patch by Valentin Valls. (Github issue #2207)</li>
<li>C lines of the module init function were unconditionally not reported in
exception stack traces.
Patch by Jeroen Demeyer.  (Github issue #2492)</li>
<li>When PEP-489 support is enabled, reloading the module overwrote any static
module state. It now raises an exception instead, given that reloading is
not actually supported.</li>
<li>Object-returning, C++ exception throwing functions were not checking that
the return value was non-null.
Original patch by Matt Wozniski (Github Issue #2603)</li>
<li>The source file encoding detection could get confused if the
<code class="docutils literal notranslate"><span class="pre">c_string_encoding</span></code> directive appeared within the first two lines.
(Github issue #2632)</li>
<li>Cython generated modules no longer emit a warning during import when the
size of the NumPy array type is larger than what was found at compile time.
Instead, this is assumed to be a backwards compatible change on NumPy side.</li>
</ul>
</div>
<div class="section" id="id24">
<h4>Other changes<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Cython now emits a warning when no <code class="docutils literal notranslate"><span class="pre">language_level</span></code> (2, 3 or ‘3str’) is set
explicitly, neither as a <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code> option nor as a compiler directive.
This is meant to prepare the transition of the default language level from
currently Py2 to Py3, since that is what most new users will expect these days.
The future default will, however, not enforce unicode literals, because this
has proven a major obstacle in the support for both Python 2.x and 3.x.  The
next major release is intended to make this change, so that it will parse all
code that does not request a specific language level as Python 3 code, but with
<code class="docutils literal notranslate"><span class="pre">str</span></code> literals.  The language level 2 will continue to be supported for an
indefinite time.</li>
<li>The documentation was restructured, cleaned up and examples are now tested.
The NumPy tutorial was also rewritten to simplify the running example.
Contributed by Gabriel de Marmiesse.  (Github issue #2245)</li>
<li>Cython compiles less of its own modules at build time to reduce the installed
package size to about half of its previous size.  This makes the compiler
slightly slower, by about 5-7%.</li>
</ul>
</div>
</div>
<div class="section" id="id25">
<h3>0.28.6 (2018-11-01)<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id26">
<h4>Bugs fixed<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Extensions compiled with MinGW-64 under Windows could misinterpret integer
objects larger than 15 bit and return incorrect results.
(Github issue #2670)</li>
<li>Multiplied string literals lost their factor when they are part of another
constant expression (e.g. ‘x’ * 10 + ‘y’ =&gt; ‘xy’).</li>
</ul>
</div>
</div>
<div class="section" id="id27">
<h3>0.28.5 (2018-08-03)<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id28">
<h4>Bugs fixed<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The discouraged usage of GCC’s attribute <code class="docutils literal notranslate"><span class="pre">optimize(&quot;Os&quot;)</span></code> was replaced by the
similar attribute <code class="docutils literal notranslate"><span class="pre">cold</span></code> to reduce the code impact of the module init functions.
(Github issue #2494)</li>
<li>A reference leak in Py2.x was fixed when comparing str to unicode for equality.</li>
</ul>
</div>
</div>
<div class="section" id="id29">
<h3>0.28.4 (2018-07-08)<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id30">
<h4>Bugs fixed<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Reallowing <code class="docutils literal notranslate"><span class="pre">tp_clear()</span></code> in a subtype of an <code class="docutils literal notranslate"><span class="pre">&#64;no_gc_clear</span></code> extension type
generated an invalid C function call to the (non-existent) base type implementation.
(Github issue #2309)</li>
<li>Exception catching based on a non-literal (runtime) tuple could fail to match the
exception.  (Github issue #2425)</li>
<li>Compile fix for CPython 3.7.0a2.  (Github issue #2477)</li>
</ul>
</div>
</div>
<div class="section" id="id31">
<h3>0.28.3 (2018-05-27)<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id32">
<h4>Bugs fixed<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Set iteration was broken in non-CPython since 0.28.</li>
<li><code class="docutils literal notranslate"><span class="pre">UnicodeEncodeError</span></code> in Py2 when <code class="docutils literal notranslate"><span class="pre">%s</span></code> formatting is optimised for
unicode strings.  (Github issue #2276)</li>
<li>Work around a crash bug in g++ 4.4.x by disabling the size reduction setting
of the module init function in this version.  (Github issue #2235)</li>
<li>Crash when exceptions occur early during module initialisation.
(Github issue #2199)</li>
</ul>
</div>
</div>
<div class="section" id="id33">
<h3>0.28.2 (2018-04-13)<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id34">
<h4>Features added<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">abs()</span></code> is faster for Python long objects.</li>
<li>The C++11 methods <code class="docutils literal notranslate"><span class="pre">front()</span></code> and <code class="docutils literal notranslate"><span class="pre">end()</span></code> were added to the declaration of
<code class="docutils literal notranslate"><span class="pre">libcpp.string</span></code>.  Patch by Alex Huszagh.  (Github issue #2123)</li>
<li>The C++11 methods <code class="docutils literal notranslate"><span class="pre">reserve()</span></code> and <code class="docutils literal notranslate"><span class="pre">bucket_count()</span></code> are declared for
<code class="docutils literal notranslate"><span class="pre">libcpp.unordered_map</span></code>.  Patch by Valentin Valls.  (Github issue #2168)</li>
</ul>
</div>
<div class="section" id="id35">
<h4>Bugs fixed<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The copy of a read-only memoryview was considered read-only as well, whereas
a common reason to copy a read-only view is to make it writable.  The result
of the copying is now a writable buffer by default.
(Github issue #2134)</li>
<li>The <code class="docutils literal notranslate"><span class="pre">switch</span></code> statement generation failed to apply recursively to the body of
converted if-statements.</li>
<li><code class="docutils literal notranslate"><span class="pre">NULL</span></code> was sometimes rejected as exception return value when the returned
type is a fused pointer type.
Patch by Callie LeFave.  (Github issue #2177)</li>
<li>Fixed compatibility with PyPy 5.11.
Patch by Matti Picus.  (Github issue #2165)</li>
</ul>
</div>
<div class="section" id="id36">
<h4>Other changes<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The NumPy tutorial was rewritten to use memoryviews instead of the older
buffer declaration syntax.
Contributed by Gabriel de Marmiesse.  (Github issue #2162)</li>
</ul>
</div>
</div>
<div class="section" id="id37">
<h3>0.28.1 (2018-03-18)<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id38">
<h4>Bugs fixed<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">PyFrozenSet_New()</span></code> was accidentally used in PyPy where it is missing
from the C-API.</li>
<li>Assignment between some C++ templated types were incorrectly rejected
when the templates mix <code class="docutils literal notranslate"><span class="pre">const</span></code> with <code class="docutils literal notranslate"><span class="pre">ctypedef</span></code>.
(Github issue #2148)</li>
<li>Undeclared C++ no-args constructors in subclasses could make the compilation
fail if the base class constructor was declared without <code class="docutils literal notranslate"><span class="pre">nogil</span></code>.
(Github issue #2157)</li>
<li>Bytes %-formatting inferred <code class="docutils literal notranslate"><span class="pre">basestring</span></code> (bytes or unicode) as result type
in some cases where <code class="docutils literal notranslate"><span class="pre">bytes</span></code> would have been safe to infer.
(Github issue #2153)</li>
<li><code class="docutils literal notranslate"><span class="pre">None</span></code> was accidentally disallowed as typed return value of <code class="docutils literal notranslate"><span class="pre">dict.pop()</span></code>.
(Github issue #2152)</li>
</ul>
</div>
</div>
<div class="section" id="id39">
<h3>0.28 (2018-03-13)<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id40">
<h4>Features added<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Cdef classes can now multiply inherit from ordinary Python classes.
(The primary base must still be a c class, possibly <code class="docutils literal notranslate"><span class="pre">object</span></code>, and
the other bases must <em>not</em> be cdef classes.)</li>
<li>Type inference is now supported for Pythran compiled NumPy expressions.
Patch by Nils Braun.  (Github issue #1954)</li>
<li>The <code class="docutils literal notranslate"><span class="pre">const</span></code> modifier can be applied to memoryview declarations to allow
read-only buffers as input.  (Github issues #1605, #1869)</li>
<li>C code in the docstring of a <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span></code> block is copied verbatimly
into the generated file.
Patch by Jeroen Demeyer.  (Github issue #1915)</li>
<li>When compiling with gcc, the module init function is now tuned for small
code size instead of whatever compile flags were provided externally.
Cython now also disables some code intensive optimisations in that function
to further reduce the code size.  (Github issue #2102)</li>
<li>Decorating an async coroutine with <code class="docutils literal notranslate"><span class="pre">&#64;cython.iterable_coroutine</span></code> changes its
type at compile time to make it iterable.  While this is not strictly in line
with PEP-492, it improves the interoperability with old-style coroutines that
use <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> instead of <code class="docutils literal notranslate"><span class="pre">await</span></code>.</li>
<li>The IPython magic has preliminary support for JupyterLab.
(Github issue #1775)</li>
<li>The new TSS C-API in CPython 3.7 is supported and has been backported.
Patch by Naotoshi Seo.  (Github issue #1932)</li>
<li>Cython knows the new <code class="docutils literal notranslate"><span class="pre">Py_tss_t</span></code> type defined in PEP-539 and automatically
initialises variables declared with that type to <code class="docutils literal notranslate"><span class="pre">Py_tss_NEEDS_INIT</span></code>,
a value which cannot be used outside of static assignments.</li>
<li>The set methods <code class="docutils literal notranslate"><span class="pre">.remove()</span></code> and <code class="docutils literal notranslate"><span class="pre">.discard()</span></code> are optimised.
Patch by Antoine Pitrou.  (Github issue #2042)</li>
<li><code class="docutils literal notranslate"><span class="pre">dict.pop()</span></code> is optimised.
Original patch by Antoine Pitrou.  (Github issue #2047)</li>
<li>Iteration over sets and frozensets is optimised.
(Github issue #2048)</li>
<li>Safe integer loops (&lt; range(2^30)) are automatically optimised into C loops.</li>
<li><code class="docutils literal notranslate"><span class="pre">alist.extend([a,b,c])</span></code> is optimised into sequential <code class="docutils literal notranslate"><span class="pre">list.append()</span></code> calls
for short literal sequences.</li>
<li>Calls to builtin methods that are not specifically optimised into C-API calls
now use a cache that avoids repeated lookups of the underlying C function.
(Github issue #2054)</li>
<li>Single argument function calls can avoid the argument tuple creation in some cases.</li>
<li>Some redundant extension type checks are avoided.</li>
<li>Formatting C enum values in f-strings is faster, as well as some other special cases.</li>
<li>String formatting with the ‘%’ operator is optimised into f-strings in simple cases.</li>
<li>Subscripting (item access) is faster in some cases.</li>
<li>Some <code class="docutils literal notranslate"><span class="pre">bytearray</span></code> operations have been optimised similar to <code class="docutils literal notranslate"><span class="pre">bytes</span></code>.</li>
<li>Some PEP-484/526 container type declarations are now considered for
loop optimisations.</li>
<li>Indexing into memoryview slices with <code class="docutils literal notranslate"><span class="pre">view[i][j]</span></code> is now optimised into
<code class="docutils literal notranslate"><span class="pre">view[i,</span> <span class="pre">j]</span></code>.</li>
<li>Python compatible <code class="docutils literal notranslate"><span class="pre">cython.*</span></code> types can now be mixed with type declarations
in Cython syntax.</li>
<li>Name lookups in the module and in classes are faster.</li>
<li>Python attribute lookups on extension types without instance dict are faster.</li>
<li>Some missing signals were added to <code class="docutils literal notranslate"><span class="pre">libc/signal.pxd</span></code>.
Patch by Jeroen Demeyer.  (Github issue #1914)</li>
<li>The warning about repeated extern declarations is now visible by default.
(Github issue #1874)</li>
<li>The exception handling of the function types used by CPython’s type slot
functions was corrected to match the de-facto standard behaviour, so that
code that uses them directly benefits from automatic and correct exception
propagation.  Patch by Jeroen Demeyer.  (Github issue #1980)</li>
<li>Defining the macro <code class="docutils literal notranslate"><span class="pre">CYTHON_NO_PYINIT_EXPORT</span></code> will prevent the module init
function from being exported as symbol, e.g. when linking modules statically
in an embedding setup.  Patch by AraHaan.  (Github issue #1944)</li>
</ul>
</div>
<div class="section" id="id41">
<h4>Bugs fixed<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>If a module name is explicitly provided for an <code class="docutils literal notranslate"><span class="pre">Extension()</span></code> that is compiled
via <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code>, it was previously ignored and replaced by the source file
name.  It can now be used to override the target module name, e.g. for compiling
prefixed accelerator modules from Python files.  (Github issue #2038)</li>
<li>The arguments of the <code class="docutils literal notranslate"><span class="pre">num_threads</span></code> parameter of parallel sections
were not sufficiently validated and could lead to invalid C code.
(Github issue #1957)</li>
<li>Catching exceptions with a non-trivial exception pattern could call into
CPython with a live exception set.  This triggered incorrect behaviour
and crashes, especially in CPython 3.7.</li>
<li>The signature of the special <code class="docutils literal notranslate"><span class="pre">__richcmp__()</span></code> method was corrected to recognise
the type of the first argument as <code class="docutils literal notranslate"><span class="pre">self</span></code>.  It was previously treated as plain
object, but CPython actually guarantees that it always has the correct type.
Note: this can change the semantics of user code that previously relied on
<code class="docutils literal notranslate"><span class="pre">self</span></code> being untyped.</li>
<li>Some Python 3 exceptions were not recognised as builtins when running Cython
under Python 2.</li>
<li>Some async helper functions were not defined in the generated C code when
compiling simple async code.  (Github issue #2075)</li>
<li>Line tracing did not include generators and coroutines.
(Github issue #1949)</li>
<li>C++ declarations for <code class="docutils literal notranslate"><span class="pre">unordered_map</span></code> were corrected.
Patch by Michael Schatzow.  (Github issue #1484)</li>
<li>Iterator declarations in C++ <code class="docutils literal notranslate"><span class="pre">deque</span></code> and <code class="docutils literal notranslate"><span class="pre">vector</span></code> were corrected.
Patch by Alex Huszagh.  (Github issue #1870)</li>
<li>The const modifiers in the C++ <code class="docutils literal notranslate"><span class="pre">string</span></code> declarations were corrected, together
with the coercion behaviour of string literals into C++ strings.
(Github issue #2132)</li>
<li>Some declaration types in <code class="docutils literal notranslate"><span class="pre">libc.limits</span></code> were corrected.
Patch by Jeroen Demeyer.  (Github issue #2016)</li>
<li><code class="docutils literal notranslate"><span class="pre">&#64;cython.final</span></code> was not accepted on Python classes with an <code class="docutils literal notranslate"><span class="pre">&#64;cython.cclass</span></code>
decorator.  (Github issue #2040)</li>
<li>Cython no longer creates useless and incorrect <code class="docutils literal notranslate"><span class="pre">PyInstanceMethod</span></code> wrappers for
methods in Python 3.  Patch by Jeroen Demeyer.  (Github issue #2105)</li>
<li>The builtin <code class="docutils literal notranslate"><span class="pre">bytearray</span></code> type could not be used as base type of cdef classes.
(Github issue #2106)</li>
</ul>
</div>
<div class="section" id="id42">
<h4>Other changes<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id43">
<h3>0.27.3 (2017-11-03)<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id44">
<h4>Bugs fixed<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>String forward references to extension types like <code class="docutils literal notranslate"><span class="pre">&#64;cython.locals(x=&quot;ExtType&quot;)</span></code>
failed to find the named type.  (Github issue #1962)</li>
<li>NumPy slicing generated incorrect results when compiled with Pythran.
Original patch by Serge Guelton (Github issue #1946).</li>
<li>Fix “undefined reference” linker error for generators on Windows in Py3.3-3.5.
(Github issue #1968)</li>
<li>Adapt to recent C-API change of <code class="docutils literal notranslate"><span class="pre">PyThreadState</span></code> in CPython 3.7.</li>
<li>Fix signature of <code class="docutils literal notranslate"><span class="pre">PyWeakref_GetObject()</span></code> API declaration.
Patch by Jeroen Demeyer (Github issue #1975).</li>
</ul>
</div>
</div>
<div class="section" id="id45">
<h3>0.27.2 (2017-10-22)<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id46">
<h4>Bugs fixed<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Comprehensions could incorrectly be optimised away when they appeared in boolean
test contexts.  (Github issue #1920)</li>
<li>The special methods <code class="docutils literal notranslate"><span class="pre">__eq__</span></code>, <code class="docutils literal notranslate"><span class="pre">__lt__</span></code> etc. in extension types did not type
their first argument as the type of the class but <code class="docutils literal notranslate"><span class="pre">object</span></code>.  (Github issue #1935)</li>
<li>Crash on first lookup of “cline_in_traceback” option during exception handling.
(Github issue #1907)</li>
<li>Some nested module level comprehensions failed to compile.
(Github issue #1906)</li>
<li>Compiler crash on some complex type declarations in pure mode.
(Github issue #1908)</li>
<li><code class="docutils literal notranslate"><span class="pre">std::unordered_map.erase()</span></code> was declared with an incorrect <code class="docutils literal notranslate"><span class="pre">void</span></code> return
type in <code class="docutils literal notranslate"><span class="pre">libcpp.unordered_map</span></code>.  (Github issue #1484)</li>
<li>Invalid use of C++ <code class="docutils literal notranslate"><span class="pre">fallthrough</span></code> attribute before C++11 and similar issue in clang.
(Github issue #1930)</li>
<li>Compiler crash on misnamed properties. (Github issue #1905)</li>
</ul>
</div>
</div>
<div class="section" id="id47">
<h3>0.27.1 (2017-10-01)<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id48">
<h4>Features added<a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The Jupyter magic has a new debug option <code class="docutils literal notranslate"><span class="pre">--verbose</span></code> that shows details about
the distutils invocation.  Patch by Boris Filippov (Github issue #1881).</li>
</ul>
</div>
<div class="section" id="id49">
<h4>Bugs fixed<a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Py3 list comprehensions in class bodies resulted in invalid C code.
(Github issue #1889)</li>
<li>Modules built for later CPython 3.5.x versions failed to import in 3.5.0/3.5.1.
(Github issue #1880)</li>
<li>Deallocating fused types functions and methods kept their GC tracking enabled,
which could potentially lead to recursive deallocation attempts.</li>
<li>Crash when compiling in C++ mode with old setuptools versions.
(Github issue #1879)</li>
<li>C++ object arguments for the constructor of Cython implemented C++ are now
passed by reference and not by value to allow for non-copyable arguments, such
as <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code>.</li>
<li>API-exported C++ classes with Python object members failed to compile.
(Github issue #1866)</li>
<li>Some issues with the new relaxed exception value handling were resolved.</li>
<li>Python classes as annotation types could prevent compilation.
(Github issue #1887)</li>
<li>Cython annotation types in Python files could lead to import failures
with a “cython undefined” error.  Recognised types are now turned into strings.</li>
<li>Coverage analysis could fail to report on extension modules on some platforms.</li>
<li>Annotations could be parsed (and rejected) as types even with
<code class="docutils literal notranslate"><span class="pre">annotation_typing=False</span></code>.</li>
</ul>
</div>
<div class="section" id="id50">
<h4>Other changes<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>PEP 489 support has been disabled by default to counter incompatibilities with
import setups that try to reload or reinitialise modules.</li>
</ul>
</div>
</div>
<div class="section" id="id51">
<h3>0.27 (2017-09-23)<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id52">
<h4>Features added<a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Extension module initialisation follows
<a class="reference external" href="https://www.python.org/dev/peps/pep-0489/">PEP 489</a> in CPython 3.5+, which
resolves several differences with regard to normal Python modules.  This makes
the global names <code class="docutils literal notranslate"><span class="pre">__file__</span></code> and <code class="docutils literal notranslate"><span class="pre">__path__</span></code> correctly available to module
level code and improves the support for module-level relative imports.
(Github issues #1715, #1753, #1035)</li>
<li>Asynchronous generators (<a class="reference external" href="https://www.python.org/dev/peps/pep-0525/">PEP 525</a>)
and asynchronous comprehensions (<a class="reference external" href="https://www.python.org/dev/peps/pep-0530/">PEP 530</a>)
have been implemented.  Note that async generators require finalisation support
in order to allow for asynchronous operations during cleanup, which is only
available in CPython 3.6+.  All other functionality has been backported as usual.</li>
<li>Variable annotations are now parsed according to
<a class="reference external" href="https://www.python.org/dev/peps/pep-0526/">PEP 526</a>.  Cython types (e.g.
<code class="docutils literal notranslate"><span class="pre">cython.int</span></code>) are evaluated as C type declarations and everything else as Python
types.  This can be disabled with the directive <code class="docutils literal notranslate"><span class="pre">annotation_typing=False</span></code>.
Note that most complex PEP-484 style annotations are currently ignored.  This will
change in future releases. (Github issue #1850)</li>
<li>Extension types (also in pure Python mode) can implement the normal special methods
<code class="docutils literal notranslate"><span class="pre">__eq__</span></code>, <code class="docutils literal notranslate"><span class="pre">__lt__</span></code> etc. for comparisons instead of the low-level <code class="docutils literal notranslate"><span class="pre">__richcmp__</span></code>
method.  (Github issue #690)</li>
<li>New decorator <code class="docutils literal notranslate"><span class="pre">&#64;cython.exceptval(x=None,</span> <span class="pre">check=False)</span></code> that makes the signature
declarations <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">except?</span> <span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">*</span></code> available to pure Python
code.  Original patch by Antonio Cuni.  (Github issue #1653)</li>
<li>Signature annotations are now included in the signature docstring generated by
the <code class="docutils literal notranslate"><span class="pre">embedsignature</span></code> directive.  Patch by Lisandro Dalcin (Github issue #1781).</li>
<li>The gdb support for Python code (<code class="docutils literal notranslate"><span class="pre">libpython.py</span></code>) was updated to the latest
version in CPython 3.7 (git rev 5fe59f8).</li>
<li>The compiler tries to find a usable exception return value for cdef functions
with <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">*</span></code> if the returned type allows it.  Note that this feature is subject
to safety limitations, so it is still better to provide an explicit declaration.</li>
<li>C functions can be assigned to function pointers with a compatible exception
declaration, not only with exact matches.  A side-effect is that certain compatible
signature overrides are now allowed and some more mismatches of exception signatures
are now detected and rejected as errors that were not detected before.</li>
<li>The IPython/Jupyter magic integration has a new option <code class="docutils literal notranslate"><span class="pre">%%cython</span> <span class="pre">--pgo</span></code> for profile
guided optimisation. It compiles the cell with PGO settings for the C compiler,
executes it to generate a runtime profile, and then compiles it again using that
profile for C compiler optimisation.  Currently only tested with gcc.</li>
<li><code class="docutils literal notranslate"><span class="pre">len(memoryview)</span></code> can be used in nogil sections to get the size of the
first dimension of a memory view (<code class="docutils literal notranslate"><span class="pre">shape[0]</span></code>). (Github issue #1733)</li>
<li>C++ classes can now contain (properly refcounted) Python objects.</li>
<li>NumPy dtype subarrays are now accessible through the C-API.
Patch by Gerald Dalley (Github issue #245).</li>
<li>Resolves several issues with PyPy and uses faster async slots in PyPy3.
Patch by Ronan Lamy (Github issues #1871, #1878).</li>
</ul>
</div>
<div class="section" id="id53">
<h4>Bugs fixed<a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Extension types that were cimported from other Cython modules could disagree
about the order of fused cdef methods in their call table.  This could lead
to wrong methods being called and potentially also crashes.  The fix required
changes to the ordering of fused methods in the call table, which may break
existing compiled modules that call fused cdef methods across module boundaries,
if these methods were implemented in a different order than they were declared
in the corresponding .pxd file. (Github issue #1873)</li>
<li>The exception state handling in generators and coroutines could lead to
exceptions in the caller being lost if an exception was raised and handled
inside of the coroutine when yielding. (Github issue #1731)</li>
<li>Loops over <code class="docutils literal notranslate"><span class="pre">range(enum)</span></code> were not converted into C for-loops.  Note that it
is still recommended to use an explicit cast to a C integer type in this case.</li>
<li>Error positions of names (e.g. variables) were incorrectly reported after the
name and not at the beginning of the name.</li>
<li>Compile time <code class="docutils literal notranslate"><span class="pre">DEF</span></code> assignments were evaluated even when they occur inside of
falsy <code class="docutils literal notranslate"><span class="pre">IF</span></code> blocks. (Github issue #1796)</li>
<li>Disabling the line tracing from a trace function could fail.
Original patch by Dmitry Trofimov. (Github issue #1769)</li>
<li>Several issues with the Pythran integration were resolved.</li>
<li>abs(signed int) now returns a signed rather than unsigned int.
(Github issue #1837)</li>
<li>Reading <code class="docutils literal notranslate"><span class="pre">frame.f_locals</span></code> of a Cython function (e.g. from a debugger or profiler
could modify the module globals. (Github issue #1836)</li>
<li>Buffer type mismatches in the NumPy buffer support could leak a reference to the
buffer owner.</li>
<li>Using the “is_f_contig” and “is_c_contig” memoryview methods together could leave
one of them undeclared. (Github issue #1872)</li>
<li>Compilation failed if the for-in-range loop target was not a variable but a more
complex expression, e.g. an item assignment. (Github issue #1831)</li>
<li>Compile time evaluations of (partially) constant f-strings could show incorrect
results.</li>
<li>Escape sequences in raw f-strings (<code class="docutils literal notranslate"><span class="pre">fr'...'</span></code>) were resolved instead of passing
them through as expected.</li>
<li>Some ref-counting issues in buffer error handling have been resolved.</li>
</ul>
</div>
<div class="section" id="id54">
<h4>Other changes<a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Type declarations in signature annotations are now parsed according to
<a class="reference external" href="https://www.python.org/dev/peps/pep-0484/">PEP 484</a>
typing.  Only Cython types (e.g. <code class="docutils literal notranslate"><span class="pre">cython.int</span></code>) and Python builtin types are
currently considered as type declarations.  Everything else is ignored, but this
will change in a future Cython release.
(Github issue #1672)</li>
<li>The directive <code class="docutils literal notranslate"><span class="pre">annotation_typing</span></code> is now <code class="docutils literal notranslate"><span class="pre">True</span></code> by default, which enables
parsing type declarations from annotations.</li>
<li>This release no longer supports Python 3.2.</li>
</ul>
</div>
</div>
<div class="section" id="id55">
<h3>0.26.1 (2017-08-29)<a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id56">
<h4>Features added<a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id57">
<h4>Bugs fixed<a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">cython.view.array</span></code> was missing <code class="docutils literal notranslate"><span class="pre">.__len__()</span></code>.</li>
<li>Extension types with a <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> override for their <code class="docutils literal notranslate"><span class="pre">__releasebuffer__</span></code> slot
(e.g. as provided by Cython for the Python <code class="docutils literal notranslate"><span class="pre">array.array</span></code> type) could leak
a reference to the buffer owner on release, thus not freeing the memory.
(Github issue #1638)</li>
<li>Auto-decoding failed in 0.26 for strings inside of C++ containers.
(Github issue #1790)</li>
<li>Compile error when inheriting from C++ container types.
(Github issue #1788)</li>
<li>Invalid C code in generators (declaration after code).
(Github issue #1801)</li>
<li>Arithmetic operations on <code class="docutils literal notranslate"><span class="pre">const</span></code> integer variables could generate invalid code.
(Github issue #1798)</li>
<li>Local variables with names of special Python methods failed to compile inside of
closures. (Github issue #1797)</li>
<li>Problem with indirect Emacs buffers in cython-mode.
Patch by Martin Albrecht (Github issue #1743).</li>
<li>Extension types named <code class="docutils literal notranslate"><span class="pre">result</span></code> or <code class="docutils literal notranslate"><span class="pre">PickleError</span></code> generated invalid unpickling code.
Patch by Jason Madden (Github issue #1786).</li>
<li>Bazel integration failed to compile <code class="docutils literal notranslate"><span class="pre">.py</span></code> files.
Patch by Guro Bokum (Github issue #1784).</li>
<li>Some include directories and dependencies were referenced with their absolute paths
in the generated files despite lying within the project directory.</li>
<li>Failure to compile in Py3.7 due to a modified signature of <code class="docutils literal notranslate"><span class="pre">_PyCFunctionFast()</span></code></li>
</ul>
</div>
</div>
<div class="section" id="id58">
<h3>0.26 (2017-07-19)<a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id59">
<h4>Features added<a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Pythran can be used as a backend for evaluating NumPy array expressions.
Patch by Adrien Guinet (Github issue #1607).</li>
<li>cdef classes now support pickling by default when possible.
This can be disabled with the <code class="docutils literal notranslate"><span class="pre">auto_pickle</span></code> directive.</li>
<li>Speed up comparisons of strings if their hash value is available.
Patch by Claudio Freire (Github issue #1571).</li>
<li>Support pyximport from zip files.
Patch by Sergei Lebedev (Github issue #1485).</li>
<li>IPython magic now respects the <code class="docutils literal notranslate"><span class="pre">__all__</span></code> variable and ignores
names with leading-underscore (like <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">*</span></code> does).
Patch by Syrtis Major (Github issue #1625).</li>
<li><code class="docutils literal notranslate"><span class="pre">abs()</span></code> is optimised for C complex numbers.
Patch by da-woods (Github issue #1648).</li>
<li>The display of C lines in Cython tracebacks can now be enabled at runtime
via <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">cython_runtime;</span> <span class="pre">cython_runtime.cline_in_traceback=True</span></code>.
The default has been changed to False.</li>
<li>The overhead of calling fused types generic functions was reduced.</li>
<li>“cdef extern” include files are now also searched relative to the current file.
Patch by Jeroen Demeyer (Github issue #1654).</li>
<li>Optional optimization for re-aquiring the GIL, controlled by the
<cite>fast_gil</cite> directive.</li>
</ul>
</div>
<div class="section" id="id60">
<h4>Bugs fixed<a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Item lookup/assignment with a unicode character as index that is typed
(explicitly or implicitly) as <code class="docutils literal notranslate"><span class="pre">Py_UCS4</span></code> or <code class="docutils literal notranslate"><span class="pre">Py_UNICODE</span></code> used the
integer value instead of the Unicode string value. Code that relied on
the previous behaviour now triggers a warning that can be disabled by
applying an explicit cast. (Github issue #1602)</li>
<li>f-string processing was adapted to changes in PEP 498 and CPython 3.6.</li>
<li>Invalid C code when decoding from UTF-16(LE/BE) byte strings.
(Github issue #1696)</li>
<li>Unicode escapes in ‘ur’ raw-unicode strings were not resolved in Py2 code.
Original patch by Aaron Gallagher (Github issue #1594).</li>
<li>File paths of code objects are now relative.
Original patch by Jelmer Vernooij (Github issue #1565).</li>
<li>Decorators of cdef class methods could be executed twice.
Patch by Jeroen Demeyer (Github issue #1724).</li>
<li>Dict iteration using the Py2 <code class="docutils literal notranslate"><span class="pre">iter*</span></code> methods failed in PyPy3.
Patch by Armin Rigo (Github issue #1631).</li>
<li>Several warnings in the generated code are now suppressed.</li>
</ul>
</div>
<div class="section" id="id61">
<h4>Other changes<a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">unraisable_tracebacks</span></code> option now defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</li>
<li>Coercion of C++ containers to Python is no longer automatic on attribute
access (Github issue #1521).</li>
<li>Access to Python attributes of cimported modules without the corresponding
import is now a compile-time (rather than runtime) error.</li>
<li>Do not use special dll linkage for “cdef public” functions.
Patch by Jeroen Demeyer (Github issue #1687).</li>
<li>cdef/cpdef methods must match their declarations.  See Github Issue #1732.
This is now a warning and will be an error in future releases.</li>
</ul>
</div>
</div>
<div class="section" id="id62">
<h3>0.25.2 (2016-12-08)<a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id63">
<h4>Bugs fixed<a class="headerlink" href="#id63" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Fixes several issues with C++ template deduction.</li>
<li>Fixes a issue with bound method type inference (Github issue #551).</li>
<li>Fixes a bug with cascaded tuple assignment (Github issue #1523).</li>
<li>Fixed or silenced many Clang warnings.</li>
<li>Fixes bug with powers of pure real complex numbers (Github issue #1538).</li>
</ul>
</div>
</div>
<div class="section" id="id64">
<h3>0.25.1 (2016-10-26)<a class="headerlink" href="#id64" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id65">
<h4>Bugs fixed<a class="headerlink" href="#id65" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Fixes a bug with <code class="docutils literal notranslate"><span class="pre">isinstance(o,</span> <span class="pre">Exception)</span></code> (Github issue #1496).</li>
<li>Fixes bug with <code class="docutils literal notranslate"><span class="pre">cython.view.array</span></code> missing utility code in some cases
(Github issue #1502).</li>
</ul>
</div>
<div class="section" id="id66">
<h4>Other changes<a class="headerlink" href="#id66" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The distutils extension <code class="docutils literal notranslate"><span class="pre">Cython.Distutils.build_ext</span></code> has been reverted,
temporarily, to be <code class="docutils literal notranslate"><span class="pre">old_build_ext</span></code> to give projects time to migrate.
The new build_ext is available as <code class="docutils literal notranslate"><span class="pre">new_build_ext</span></code>.</li>
</ul>
</div>
</div>
<div class="section" id="id67">
<h3>0.25 (2016-10-25)<a class="headerlink" href="#id67" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id68">
<h4>Features added<a class="headerlink" href="#id68" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>def/cpdef methods of cdef classes benefit from Cython’s internal function
implementation, which enables introspection and line profiling for them.
Implementation sponsored by Turbostream (www.turbostream-cfd.com).</li>
<li>Calls to Python functions are faster, following the recent “FastCall”
optimisations that Victor Stinner implemented for CPython 3.6.
See <a class="reference external" href="https://bugs.python.org/issue27128">https://bugs.python.org/issue27128</a> and related issues.</li>
<li>The new METH_FASTCALL calling convention for PyCFunctions is supported
in CPython 3.6.  See <a class="reference external" href="https://bugs.python.org/issue27810">https://bugs.python.org/issue27810</a></li>
<li>Initial support for using Cython modules in Pyston.
Patch by Boxiang Sun.</li>
<li>Dynamic Python attributes are allowed on cdef classes if an attribute
<code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">dict</span> <span class="pre">__dict__</span></code> is declared in the class.  Patch by empyrical.</li>
<li>Cython implemented C++ classes can make direct calls to base class methods.
Patch by empyrical.</li>
<li>C++ classes can now have typedef members. STL containers updated with
value_type.</li>
<li>New directive <code class="docutils literal notranslate"><span class="pre">cython.no_gc</span></code> to fully disable GC for a cdef class.
Patch by Claudio Freire.</li>
<li>Buffer variables are no longer excluded from <code class="docutils literal notranslate"><span class="pre">locals()</span></code>.
Patch by da-woods.</li>
<li>Building f-strings is faster, especially when formatting C integers.</li>
<li>for-loop iteration over “std::string”.</li>
<li><code class="docutils literal notranslate"><span class="pre">libc/math.pxd</span></code> provides <code class="docutils literal notranslate"><span class="pre">e</span></code> and <code class="docutils literal notranslate"><span class="pre">pi</span></code> as alias constants to simplify
usage as a drop-in replacement for Python’s math module.</li>
<li>Speed up cython.inline().</li>
<li>Binary lshift operations with small constant Python integers are faster.</li>
<li>Some integer operations on Python long objects are faster in Python 2.7.</li>
<li>Support for the C++ <code class="docutils literal notranslate"><span class="pre">typeid</span></code> operator.</li>
<li>Support for bazel using a the pyx_library rule in //Tools:rules.bzl.</li>
</ul>
</div>
<div class="section" id="significant-bugs-fixed">
<h4>Significant Bugs fixed<a class="headerlink" href="#significant-bugs-fixed" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Division of complex numbers avoids overflow by using Smith’s method.</li>
<li>Some function signatures in <code class="docutils literal notranslate"><span class="pre">libc.math</span></code> and <code class="docutils literal notranslate"><span class="pre">numpy.pxd</span></code> were incorrect.
Patch by Michael Seifert.</li>
</ul>
</div>
<div class="section" id="id69">
<h4>Other changes<a class="headerlink" href="#id69" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The “%%cython” IPython/jupyter magic now defaults to the language level of
the current jupyter kernel.  The language level can be set explicitly with
“%%cython -2” or “%%cython -3”.</li>
<li>The distutils extension <code class="docutils literal notranslate"><span class="pre">Cython.Distutils.build_ext</span></code> has now been updated
to use cythonize which properly handles dependencies.  The old extension can
still be found in <code class="docutils literal notranslate"><span class="pre">Cython.Distutils.old_build_ext</span></code> and is now deprecated.</li>
<li><code class="docutils literal notranslate"><span class="pre">directive_defaults</span></code> is no longer available in <code class="docutils literal notranslate"><span class="pre">Cython.Compiler.Options</span></code>,
use <code class="docutils literal notranslate"><span class="pre">get_directive_defaults()</span></code> instead.</li>
</ul>
</div>
</div>
<div class="section" id="id70">
<h3>0.24.1 (2016-07-15)<a class="headerlink" href="#id70" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id71">
<h4>Bugs fixed<a class="headerlink" href="#id71" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>IPython cell magic was lacking a good way to enable Python 3 code semantics.
It can now be used as “%%cython -3”.</li>
<li>Follow a recent change in <a class="reference external" href="https://www.python.org/dev/peps/pep-0492/">PEP 492</a>
and CPython 3.5.2 that now requires the <code class="docutils literal notranslate"><span class="pre">__aiter__()</span></code> method of asynchronous
iterators to be a simple <code class="docutils literal notranslate"><span class="pre">def</span></code> method instead of an <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code> method.</li>
<li>Coroutines and generators were lacking the <code class="docutils literal notranslate"><span class="pre">__module__</span></code> special attribute.</li>
<li>C++ <code class="docutils literal notranslate"><span class="pre">std::complex</span></code> values failed to auto-convert from and to Python complex
objects.</li>
<li>Namespaced C++ types could not be used as memory view types due to lack of
name mangling.  Patch by Ivan Smirnov.</li>
<li>Assignments between identical C++ types that were declared with differently
typedefed template types could fail.</li>
<li>Rebuilds could fail to evaluate dependency timestamps in C++ mode.
Patch by Ian Henriksen.</li>
<li>Macros defined in the <code class="docutils literal notranslate"><span class="pre">distutils</span></code> compiler option do not require values
anymore.  Patch by Ian Henriksen.</li>
<li>Minor fixes for MSVC, Cygwin and PyPy.</li>
</ul>
</div>
</div>
<div class="section" id="id72">
<h3>0.24 (2016-04-04)<a class="headerlink" href="#id72" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id73">
<h4>Features added<a class="headerlink" href="#id73" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0498/">PEP 498</a>:
Literal String Formatting (f-strings).
Original patch by Jelle Zijlstra.</li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0515/">PEP 515</a>:
Underscores as visual separators in number literals.</li>
<li>Parser was adapted to some minor syntax changes in Py3.6, e.g.
<a class="reference external" href="https://bugs.python.org/issue9232">https://bugs.python.org/issue9232</a></li>
<li>The embedded C code comments that show the original source code
can be discarded with the new directive <code class="docutils literal notranslate"><span class="pre">emit_code_comments=False</span></code>.</li>
<li>Cpdef enums are now first-class iterable, callable types in Python.</li>
<li>Ctuples can now be declared in pure Python code.</li>
<li>Posix declarations for DLL loading and stdio extensions were added.
Patch by Lars Buitinck.</li>
<li>The Py2-only builtins <code class="docutils literal notranslate"><span class="pre">unicode()</span></code>, <code class="docutils literal notranslate"><span class="pre">xrange()</span></code>, <code class="docutils literal notranslate"><span class="pre">reduce()</span></code> and
<code class="docutils literal notranslate"><span class="pre">long</span></code> are now also available in compile time <code class="docutils literal notranslate"><span class="pre">DEF</span></code> expressions
when compiling with Py3.</li>
<li>Exception type tests have slightly lower overhead.
This fixes ticket 868.</li>
<li>&#64;property syntax fully supported in cdef classes, old syntax deprecated.</li>
<li>C++ classes can now be declared with default template parameters.</li>
</ul>
</div>
<div class="section" id="id74">
<h4>Bugs fixed<a class="headerlink" href="#id74" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>C++ exceptions raised by overloaded C++ operators were not always
handled.  Patch by Ian Henriksen.</li>
<li>C string literals were previously always stored as non-const global
variables in the module.  They are now stored as global constants
when possible, and otherwise as non-const C string literals in the
generated code that uses them.  This improves compatibility with
strict C compiler options and prevents non-const strings literals
with the same content from being incorrectly merged.</li>
<li>Compile time evaluated <code class="docutils literal notranslate"><span class="pre">str</span></code> expressions (<code class="docutils literal notranslate"><span class="pre">DEF</span></code>) now behave in a
more useful way by turning into Unicode strings when compiling under
Python 3.  This allows using them as intermediate values in expressions.
Previously, they always evaluated to bytes objects.</li>
<li><code class="docutils literal notranslate"><span class="pre">isinf()</span></code> declarations in <code class="docutils literal notranslate"><span class="pre">libc/math.pxd</span></code> and <code class="docutils literal notranslate"><span class="pre">numpy/math.pxd</span></code> now
reflect the actual tristate <code class="docutils literal notranslate"><span class="pre">int</span></code> return value instead of using <code class="docutils literal notranslate"><span class="pre">bint</span></code>.</li>
<li>Literal assignments to ctuples avoid Python tuple round-trips in some
more corner cases.</li>
<li>Iteration over <code class="docutils literal notranslate"><span class="pre">dict(...).items()</span></code> failed to get optimised when dict
arguments included keyword arguments.</li>
<li>cProfile now correctly profiles cpdef functions and methods.</li>
</ul>
</div>
</div>
<div class="section" id="id75">
<h3>0.23.5 (2016-03-26)<a class="headerlink" href="#id75" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Compile errors and warnings in integer type conversion code.  This fixes
ticket 877.  Patches by Christian Neukirchen, Nikolaus Rath, Ian Henriksen.</li>
<li>Reference leak when <code class="docutils literal notranslate"><span class="pre">*args</span></code> argument was reassigned in closures.</li>
<li>Truth-testing Unicode strings could waste time and memory in Py3.3+.</li>
<li>Return values of async functions could be ignored and replaced by <code class="docutils literal notranslate"><span class="pre">None</span></code>.</li>
<li>Compiler crash in CPython 3.6.</li>
<li>Fix prange() to behave identically to range().  The end condition was
miscalculated when the range was not exactly divisible by the step.</li>
<li>Optimised <code class="docutils literal notranslate"><span class="pre">all(genexpr)</span></code>/<code class="docutils literal notranslate"><span class="pre">any(genexpr)</span></code> calls could warn about unused
code.  This fixes ticket 876.</li>
</ul>
</div>
<div class="section" id="id76">
<h3>0.23.4 (2015-10-10)<a class="headerlink" href="#id76" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id77">
<h4>Bugs fixed<a class="headerlink" href="#id77" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Memory leak when calling Python functions in PyPy.</li>
<li>Compilation problem with MSVC in C99-ish mode.</li>
<li>Warning about unused values in a helper macro.</li>
</ul>
</div>
</div>
<div class="section" id="id78">
<h3>0.23.3 (2015-09-29)<a class="headerlink" href="#id78" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id79">
<h4>Bugs fixed<a class="headerlink" href="#id79" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Invalid C code for some builtin methods.  This fixes ticket 856 again.</li>
<li>Incorrect C code in helper functions for PyLong conversion and string
decoding.  This fixes ticket 863, ticket 864 and ticket 865.
Original patch by Nikolaus Rath.</li>
<li>Large folded or inserted integer constants could use too small C
integer types and thus trigger a value wrap-around.</li>
</ul>
</div>
<div class="section" id="id80">
<h4>Other changes<a class="headerlink" href="#id80" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The coroutine and generator types of Cython now also register directly
with the <code class="docutils literal notranslate"><span class="pre">Coroutine</span></code> and <code class="docutils literal notranslate"><span class="pre">Generator</span></code> ABCs in the <code class="docutils literal notranslate"><span class="pre">backports_abc</span></code>
module if it can be imported.  This fixes ticket 870.</li>
</ul>
</div>
</div>
<div class="section" id="id81">
<h3>0.23.2 (2015-09-11)<a class="headerlink" href="#id81" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id82">
<h4>Bugs fixed<a class="headerlink" href="#id82" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Compiler crash when analysing some optimised expressions.</li>
<li>Coverage plugin was adapted to coverage.py 4.0 beta 2.</li>
<li>C++ destructor calls could fail when ‘&amp;’ operator is overwritten.</li>
<li>Incorrect C literal generation for large integers in compile-time
evaluated DEF expressions and constant folded expressions.</li>
<li>Byte string constants could end up as Unicode strings when originating
from compile-time evaluated DEF expressions.</li>
<li>Invalid C code when caching known builtin methods.
This fixes ticket 860.</li>
<li><code class="docutils literal notranslate"><span class="pre">ino_t</span></code> in <code class="docutils literal notranslate"><span class="pre">posix.types</span></code> was not declared as <code class="docutils literal notranslate"><span class="pre">unsigned</span></code>.</li>
<li>Declarations in <code class="docutils literal notranslate"><span class="pre">libcpp/memory.pxd</span></code> were missing <code class="docutils literal notranslate"><span class="pre">operator!()</span></code>.
Patch by Leo Razoumov.</li>
<li>Static cdef methods can now be declared in .pxd files.</li>
</ul>
</div>
</div>
<div class="section" id="id83">
<h3>0.23.1 (2015-08-22)<a class="headerlink" href="#id83" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id84">
<h4>Bugs fixed<a class="headerlink" href="#id84" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Invalid C code for generators.  This fixes ticket 858.</li>
<li>Invalid C code for some builtin methods.  This fixes ticket 856.</li>
<li>Invalid C code for unused local buffer variables.
This fixes ticket 154.</li>
<li>Test failures on 32bit systems.  This fixes ticket 857.</li>
<li>Code that uses <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">xyz</span> <span class="pre">import</span> <span class="pre">*</span></code> and global C struct/union/array
variables could fail to compile due to missing helper functions.
This fixes ticket 851.</li>
<li>Misnamed PEP 492 coroutine property <code class="docutils literal notranslate"><span class="pre">cr_yieldfrom</span></code> renamed to
<code class="docutils literal notranslate"><span class="pre">cr_await</span></code> to match CPython.</li>
<li>Missing deallocation code for C++ object attributes in certain
extension class hierarchies.</li>
<li>Crash when async coroutine was not awaited.</li>
<li>Compiler crash on <code class="docutils literal notranslate"><span class="pre">yield</span></code> in signature annotations and default
argument values.  Both are forbidden now.</li>
<li>Compiler crash on certain constructs in <code class="docutils literal notranslate"><span class="pre">finally</span></code> clauses.</li>
<li>Cython failed to build when CPython’s pgen is installed.</li>
</ul>
</div>
</div>
<div class="section" id="id85">
<h3>0.23 (2015-08-08)<a class="headerlink" href="#id85" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id86">
<h4>Features added<a class="headerlink" href="#id86" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0492/">PEP 492</a>
(async/await) was implemented.</li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0448/">PEP 448</a>
(Additional Unpacking Generalizations) was implemented.</li>
<li>Support for coverage.py 4.0+ can be enabled by adding the plugin
“Cython.Coverage” to the “.coveragerc” config file.</li>
<li>Annotated HTML source pages can integrate (XML) coverage reports.</li>
<li>Tracing is supported in <code class="docutils literal notranslate"><span class="pre">nogil</span></code> functions/sections and module init code.</li>
<li>When generators are used in a Cython module and the module imports the
modules “inspect” and/or “asyncio”, Cython enables interoperability by
patching these modules during the import to recognise Cython’s internal
generator and coroutine types. This can be disabled by C compiling the
module with “-D CYTHON_PATCH_ASYNCIO=0” or “-D CYTHON_PATCH_INSPECT=0”</li>
<li>When generators or coroutines are used in a Cython module, their types
are registered with the <code class="docutils literal notranslate"><span class="pre">Generator</span></code> and <code class="docutils literal notranslate"><span class="pre">Coroutine</span></code> ABCs in the
<code class="docutils literal notranslate"><span class="pre">collections</span></code> or <code class="docutils literal notranslate"><span class="pre">collections.abc</span></code> stdlib module at import time to
enable interoperability with code that needs to detect and process Python
generators/coroutines.  These ABCs were added in CPython 3.5 and are
available for older Python versions through the <code class="docutils literal notranslate"><span class="pre">backports_abc</span></code> module
on PyPI.  See <a class="reference external" href="https://bugs.python.org/issue24018">https://bugs.python.org/issue24018</a></li>
<li>Adding/subtracting/dividing/modulus and equality comparisons with
constant Python floats and small integers are faster.</li>
<li>Binary and/or/xor/rshift operations with small constant Python integers
are faster.</li>
<li>When called on generator expressions, the builtins <code class="docutils literal notranslate"><span class="pre">all()</span></code>, <code class="docutils literal notranslate"><span class="pre">any()</span></code>,
<code class="docutils literal notranslate"><span class="pre">dict()</span></code>, <code class="docutils literal notranslate"><span class="pre">list()</span></code>, <code class="docutils literal notranslate"><span class="pre">set()</span></code>, <code class="docutils literal notranslate"><span class="pre">sorted()</span></code> and <code class="docutils literal notranslate"><span class="pre">unicode.join()</span></code>
avoid the generator iteration overhead by inlining a part of their
functionality into the for-loop.</li>
<li>Keyword argument dicts are no longer copied on function entry when they
are not being used or only passed through to other function calls (e.g.
in wrapper functions).</li>
<li>The <code class="docutils literal notranslate"><span class="pre">PyTypeObject</span></code> declaration in <code class="docutils literal notranslate"><span class="pre">cpython.object</span></code> was extended.</li>
<li>The builtin <code class="docutils literal notranslate"><span class="pre">type</span></code> type is now declared as PyTypeObject in source,
allowing for extern functions taking type parameters to have the correct
C signatures.  Note that this might break code that uses <code class="docutils literal notranslate"><span class="pre">type</span></code> just
for passing around Python types in typed variables.  Removing the type
declaration provides a backwards compatible fix.</li>
<li><code class="docutils literal notranslate"><span class="pre">wraparound()</span></code> and <code class="docutils literal notranslate"><span class="pre">boundscheck()</span></code> are available as no-ops in pure
Python mode.</li>
<li>Const iterators were added to the provided C++ STL declarations.</li>
<li>Smart pointers were added to the provided C++ STL declarations.
Patch by Daniel Filonik.</li>
<li><code class="docutils literal notranslate"><span class="pre">NULL</span></code> is allowed as default argument when embedding signatures.
This fixes ticket 843.</li>
<li>When compiling with <code class="docutils literal notranslate"><span class="pre">--embed</span></code>, the internal module name is changed to
<code class="docutils literal notranslate"><span class="pre">__main__</span></code> to allow arbitrary program names, including those that would
be invalid for modules.  Note that this prevents reuse of the generated
C code as an importable module.</li>
<li>External C++ classes that overload the assignment operator can be used.
Patch by Ian Henriksen.</li>
<li>Support operator bool() for C++ classes so they can be used in if statements.</li>
</ul>
</div>
<div class="section" id="id88">
<h4>Bugs fixed<a class="headerlink" href="#id88" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Calling “yield from” from Python on a Cython generator that returned a
value triggered a crash in CPython.  This is now being worked around.
See <a class="reference external" href="https://bugs.python.org/issue23996">https://bugs.python.org/issue23996</a></li>
<li>Language level 3 did not enable true division (a.k.a. float division)
for integer operands.</li>
<li>Functions with fused argument types that included a generic ‘object’
fallback could end up using that fallback also for other explicitly
listed object types.</li>
<li>Relative cimports could accidentally fall back to trying an absolute
cimport on failure.</li>
<li>The result of calling a C struct constructor no longer requires an
intermediate assignment when coercing to a Python dict.</li>
<li>C++ exception declarations with mapping functions could fail to compile
when pre-declared in .pxd files.</li>
<li><code class="docutils literal notranslate"><span class="pre">cpdef</span> <span class="pre">void</span></code> methods are now permitted.</li>
<li><code class="docutils literal notranslate"><span class="pre">abs(cint)</span></code> could fail to compile in MSVC and used sub-optimal code
in C++.  Patch by David Vierra, original patch by Michael Enßlin.</li>
<li>Buffer index calculations using index variables with small C integer
types could overflow for large buffer sizes.
Original patch by David Vierra.</li>
<li>C unions use a saner way to coerce from and to Python dicts.</li>
<li>When compiling a module <code class="docutils literal notranslate"><span class="pre">foo.pyx</span></code>, the directories in <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>
are no longer searched when looking for <code class="docutils literal notranslate"><span class="pre">foo.pxd</span></code>.
Patch by Jeroen Demeyer.</li>
<li>Memory leaks in the embedding main function were fixed.
Original patch by Michael Enßlin.</li>
<li>Some complex Python expressions could fail to compile inside of finally
clauses.</li>
<li>Unprefixed ‘str’ literals were not supported as C varargs arguments.</li>
<li>Fixed type errors in conversion enum types to/from Python.  Note that
this imposes stricter correctness requirements on enum declarations.</li>
</ul>
</div>
<div class="section" id="id89">
<h4>Other changes<a class="headerlink" href="#id89" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Changed mangling scheme in header files generated by <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">api</span></code>
declarations.</li>
<li>Installation under CPython 3.3+ no longer requires a pass of the
2to3 tool.  This also makes it possible to run Cython in Python
3.3+ from a source checkout without installing it first.
Patch by Petr Viktorin.</li>
<li><code class="docutils literal notranslate"><span class="pre">jedi-typer.py</span></code> (in <code class="docutils literal notranslate"><span class="pre">Tools/</span></code>) was extended and renamed to
<code class="docutils literal notranslate"><span class="pre">jedityper.py</span></code> (to make it importable) and now works with and
requires Jedi 0.9.  Patch by Tzer-jen Wei.</li>
</ul>
</div>
</div>
<div class="section" id="id90">
<h3>0.22.1 (2015-06-20)<a class="headerlink" href="#id90" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id91">
<h4>Bugs fixed<a class="headerlink" href="#id91" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Crash when returning values on generator termination.</li>
<li>In some cases, exceptions raised during internal isinstance() checks were
not propagated.</li>
<li>Runtime reported file paths of source files (e.g for profiling and tracing)
are now relative to the build root directory instead of the main source file.</li>
<li>Tracing exception handling code could enter the trace function with an active
exception set.</li>
<li>The internal generator function type was not shared across modules.</li>
<li>Comparisons of (inferred) ctuples failed to compile.</li>
<li>Closures inside of cdef functions returning <code class="docutils literal notranslate"><span class="pre">void</span></code> failed to compile.</li>
<li>Using <code class="docutils literal notranslate"><span class="pre">const</span></code> C++ references in intermediate parts of longer expressions
could fail to compile.</li>
<li>C++ exception declarations with mapping functions could fail to compile when
pre-declared in .pxd files.</li>
<li>C++ compilation could fail with an ambiguity error in recent MacOS-X Xcode
versions.</li>
<li>C compilation could fail in pypy3.</li>
<li>Fixed a memory leak in the compiler when compiling multiple modules.</li>
<li>When compiling multiple modules, external library dependencies could leak
into later compiler runs.  Fix by Jeroen Demeyer.  This fixes ticket 845.</li>
</ul>
</div>
</div>
<div class="section" id="id92">
<h3>0.22 (2015-02-11)<a class="headerlink" href="#id92" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id93">
<h4>Features added<a class="headerlink" href="#id93" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>C functions can coerce to Python functions, which allows passing them
around as callable objects.</li>
<li>C arrays can be assigned by value and auto-coerce from Python iterables
and to Python lists (and tuples).</li>
<li>Extern C functions can now be declared as cpdef to export them to
the module’s Python namespace.  Extern C functions in pxd files export
their values to their own module, iff it exists.</li>
<li>Anonymous C tuple types can be declared as (ctype1, ctype2, …).</li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0479/">PEP 479</a>:
turn accidental StopIteration exceptions that exit generators
into a RuntimeError, activated with future import “generator_stop”.</li>
<li>Looping over <code class="docutils literal notranslate"><span class="pre">reversed(range())</span></code> is optimised in the same way as
<code class="docutils literal notranslate"><span class="pre">range()</span></code>.  Patch by Favian Contreras.</li>
</ul>
</div>
<div class="section" id="id94">
<h4>Bugs fixed<a class="headerlink" href="#id94" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Mismatching ‘except’ declarations on signatures in .pxd and .pyx files failed
to produce a compile error.</li>
<li>Failure to find any files for the path pattern(s) passed into <code class="docutils literal notranslate"><span class="pre">cythonize()</span></code>
is now an error to more easily detect accidental typos.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">logaddexp</span></code> family of functions in <code class="docutils literal notranslate"><span class="pre">numpy.math</span></code> now has correct
declarations.</li>
<li>In Py2.6/7 and Py3.2, simple Cython memory views could accidentally be
interpreted as non-contiguous by CPython, which could trigger a CPython
bug when copying data from them, thus leading to data corruption.
See CPython issues 12834 and 23349.</li>
</ul>
</div>
<div class="section" id="id95">
<h4>Other changes<a class="headerlink" href="#id95" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Preliminary support for defining the Cython language with a formal grammar.
To try parsing your files against this grammar, use the –formal_grammar directive.
Experimental.</li>
<li><code class="docutils literal notranslate"><span class="pre">_</span></code> is no longer considered a cacheable builtin as it could interfere with
gettext.</li>
<li>Cythonize-computed metadata now cached in the generated C files.</li>
<li>Several corrections and extensions in numpy, cpython, and libcpp pxd files.</li>
</ul>
</div>
</div>
<div class="section" id="id96">
<h3>0.21.2 (2014-12-27)<a class="headerlink" href="#id96" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id97">
<h4>Bugs fixed<a class="headerlink" href="#id97" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Crash when assigning a C value to both a Python and C target at the same time.</li>
<li>Automatic coercion from C++ strings to <code class="docutils literal notranslate"><span class="pre">str</span></code> generated incomplete code that
failed to compile.</li>
<li>Declaring a constructor in a C++ child class erroneously required a default
constructor declaration in the super class.</li>
<li><code class="docutils literal notranslate"><span class="pre">resize_smart()</span></code> in <code class="docutils literal notranslate"><span class="pre">cpython.array</span></code> was broken.</li>
<li>Functions in <code class="docutils literal notranslate"><span class="pre">libcpp.cast</span></code> are now declared as <code class="docutils literal notranslate"><span class="pre">nogil</span></code>.</li>
<li>Some missing C-API declarations were added.</li>
<li>Py3 main code in embedding program code was lacking casts.</li>
<li>Exception related to distutils “Distribution” class type in pyximport under
latest CPython 2.7 and 3.4 releases when setuptools is being imported later.</li>
</ul>
</div>
</div>
<div class="section" id="id98">
<h3>0.21.1 (2014-10-18)<a class="headerlink" href="#id98" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id99">
<h4>Features added<a class="headerlink" href="#id99" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>New <code class="docutils literal notranslate"><span class="pre">cythonize</span></code> option <code class="docutils literal notranslate"><span class="pre">-a</span></code> to generate the annotated HTML source view.</li>
<li>Missing C-API declarations in <code class="docutils literal notranslate"><span class="pre">cpython.unicode</span></code> were added.</li>
<li>Passing <code class="docutils literal notranslate"><span class="pre">language='c++'</span></code> into cythonize() globally enables C++ mode for
all modules that were not passed as Extension objects (i.e. only source
files and file patterns).</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_hash_t</span></code> is a known type (used in CPython for hash values).</li>
<li><code class="docutils literal notranslate"><span class="pre">PySlice_*()</span></code> C-API functions are available from the <code class="docutils literal notranslate"><span class="pre">cpython.slice</span></code>
module.</li>
<li>Allow arrays of C++ classes.</li>
</ul>
</div>
<div class="section" id="id100">
<h4>Bugs fixed<a class="headerlink" href="#id100" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Reference leak for non-simple Python expressions in boolean and/or expressions.</li>
<li>To fix a name collision and to reflect availability on host platforms,
standard C declarations [ clock(), time(), struct tm and tm* functions ]
were moved from posix/time.pxd to a new libc/time.pxd.  Patch by Charles
Blake.</li>
<li>Rerunning unmodified modules in IPython’s cython support failed.
Patch by Matthias Bussonier.</li>
<li>Casting C++ <code class="docutils literal notranslate"><span class="pre">std::string</span></code> to Python byte strings failed when
auto-decoding was enabled.</li>
<li>Fatal exceptions in global module init code could lead to crashes
if the already created module was used later on (e.g. through a
stale reference in sys.modules or elsewhere).</li>
<li><code class="docutils literal notranslate"><span class="pre">cythonize.py</span></code> script was not installed on MS-Windows.</li>
</ul>
</div>
<div class="section" id="id101">
<h4>Other changes<a class="headerlink" href="#id101" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Compilation no longer fails hard when unknown compilation options are
passed.  Instead, it raises a warning and ignores them (as it did silently
before 0.21).  This will be changed back to an error in a future release.</li>
</ul>
</div>
</div>
<div class="section" id="id102">
<h3>0.21 (2014-09-10)<a class="headerlink" href="#id102" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id103">
<h4>Features added<a class="headerlink" href="#id103" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>C (cdef) functions allow inner Python functions.</li>
<li>Enums can now be declared as cpdef to export their values to
the module’s Python namespace.  Cpdef enums in pxd files export
their values to their own module, iff it exists.</li>
<li>Allow &#64;staticmethod decorator to declare static cdef methods.
This is especially useful for declaring “constructors” for
cdef classes that can take non-Python arguments.</li>
<li>Taking a <code class="docutils literal notranslate"><span class="pre">char*</span></code> from a temporary Python string object is safer
in more cases and can be done inside of non-trivial expressions,
including arguments of a function call.  A compile time error
is raised only when such a pointer is assigned to a variable and
would thus exceed the lifetime of the string itself.</li>
<li>Generators have new properties <code class="docutils literal notranslate"><span class="pre">__name__</span></code> and <code class="docutils literal notranslate"><span class="pre">__qualname__</span></code>
that provide the plain/qualified name of the generator function
(following CPython 3.5).  See <a class="reference external" href="https://bugs.python.org/issue21205">https://bugs.python.org/issue21205</a></li>
<li>The <code class="docutils literal notranslate"><span class="pre">inline</span></code> function modifier is available as a decorator
<code class="docutils literal notranslate"><span class="pre">&#64;cython.inline</span></code> in pure mode.</li>
<li>When cygdb is run in a virtualenv, it enables the same virtualenv
inside of the debugger. Patch by Marc Abramowitz.</li>
<li>PEP 465: dedicated infix operator for matrix multiplication (A &#64; B).</li>
<li>HTML output of annotated code uses Pygments for code highlighting
and generally received a major overhaul by Matthias Bussonier.</li>
<li>IPython magic support is now available directly from Cython with
the command “%load_ext cython”.  Cython code can directly be
executed in a cell when marked with “%%cython”.  Code analysis
is available with “%%cython -a”.  Patch by Martín Gaitán.</li>
<li>Simple support for declaring Python object types in Python signature
annotations.  Currently requires setting the compiler directive
<code class="docutils literal notranslate"><span class="pre">annotation_typing=True</span></code>.</li>
<li>New directive <code class="docutils literal notranslate"><span class="pre">use_switch</span></code> (defaults to True) to optionally disable
the optimization of chained if statement to C switch statements.</li>
<li>Defines dynamic_cast et al. in <code class="docutils literal notranslate"><span class="pre">libcpp.cast</span></code> and C++ heap data
structure operations in <code class="docutils literal notranslate"><span class="pre">libcpp.algorithm</span></code>.</li>
<li>Shipped header declarations in <code class="docutils literal notranslate"><span class="pre">posix.*</span></code> were extended to cover
more of the POSIX API.  Patches by Lars Buitinck and Mark Peek.</li>
</ul>
</div>
<div class="section" id="optimizations">
<h4>Optimizations<a class="headerlink" href="#optimizations" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Simple calls to C implemented Python functions/methods are faster.
This also speeds up many operations on builtins that Cython cannot
otherwise optimise.</li>
<li>The “and”/”or” operators try to avoid unnecessary coercions of their
arguments.  They now evaluate the truth value of each argument
independently and only coerce the final result of the whole expression
to the target type (e.g. the type on the left side of an assignment).
This also avoids reference counting overhead for Python values during
evaluation and generally improves the code flow in the generated C code.</li>
<li>The Python expression “2 ** N” is optimised into bit shifting.
See <a class="reference external" href="https://bugs.python.org/issue21420">https://bugs.python.org/issue21420</a></li>
<li>Cascaded assignments (a = b = …) try to minimise the number of
type coercions.</li>
<li>Calls to <code class="docutils literal notranslate"><span class="pre">slice()</span></code> are translated to a straight C-API call.</li>
</ul>
</div>
<div class="section" id="id104">
<h4>Bugs fixed<a class="headerlink" href="#id104" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Crash when assigning memory views from ternary conditional expressions.</li>
<li>Nested C++ templates could lead to unseparated “&gt;&gt;” characters being
generated into the C++ declarations, which older C++ compilers could
not parse.</li>
<li>Sending SIGINT (Ctrl-C) during parallel cythonize() builds could
hang the child processes.</li>
<li>No longer ignore local setup.cfg files for distutils in pyximport.
Patch by Martin Teichmann.</li>
<li>Taking a <code class="docutils literal notranslate"><span class="pre">char*</span></code> from an indexed Python string generated unsafe
reference counting code.</li>
<li>Set literals now create all of their items before trying to add them
to the set, following the behaviour in CPython.  This makes a
difference in the rare case that the item creation has side effects
and some items are not hashable (or if hashing them has side effects,
too).</li>
<li>Cython no longer generates the cross product of C functions for code
that uses memory views of fused types in function signatures (e.g.
<code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">func(floating[:]</span> <span class="pre">a,</span> <span class="pre">floating[:]</span> <span class="pre">b)</span></code>).  This is considered the
expected behaviour by most users and was previously inconsistent with
other structured types like C arrays.  Code that really wants all type
combinations can create the same fused memoryview type under different
names and use those in the signature to make it clear which types are
independent.</li>
<li>Names that were unknown at compile time were looked up as builtins at
runtime but not as global module names.  Trying both lookups helps with
globals() manipulation.</li>
<li>Fixed stl container conversion for typedef element types.</li>
<li><code class="docutils literal notranslate"><span class="pre">obj.pop(x)</span></code> truncated large C integer values of x to <code class="docutils literal notranslate"><span class="pre">Py_ssize_t</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">__init__.pyc</span></code> is recognised as marking a package directory
(in addition to .py, .pyx and .pxd).</li>
<li>Syntax highlighting in <code class="docutils literal notranslate"><span class="pre">cython-mode.el</span></code> for Emacs no longer
incorrectly highlights keywords found as part of longer names.</li>
<li>Correctly handle <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">cython.submodule</span> <span class="pre">cimport</span> <span class="pre">name</span></code>.</li>
<li>Fix infinite recursion when using super with cpdef methods.</li>
<li>No-args <code class="docutils literal notranslate"><span class="pre">dir()</span></code> was not guaranteed to return a sorted list.</li>
</ul>
</div>
<div class="section" id="id105">
<h4>Other changes<a class="headerlink" href="#id105" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The header line in the generated C files no longer contains the
timestamp but only the Cython version that wrote it.  This was
changed to make builds more reproducible.</li>
<li>Removed support for CPython 2.4, 2.5 and 3.1.</li>
<li>The licensing implications on the generated code were clarified
to avoid legal constraints for users.</li>
</ul>
</div>
</div>
<div class="section" id="id106">
<h3>0.20.2 (2014-06-16)<a class="headerlink" href="#id106" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id107">
<h4>Features added<a class="headerlink" href="#id107" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Some optimisations for set/frozenset instantiation.</li>
<li>Support for C++ unordered_set and unordered_map.</li>
</ul>
</div>
<div class="section" id="id108">
<h4>Bugs fixed<a class="headerlink" href="#id108" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Access to attributes of optimised builtin methods (e.g.
<code class="docutils literal notranslate"><span class="pre">[].append.__name__</span></code>) could fail to compile.</li>
<li>Memory leak when extension subtypes add a memory view as attribute
to those of the parent type without having Python object attributes
or a user provided dealloc method.</li>
<li>Compiler crash on readonly properties in “binding” mode.</li>
<li>Auto-encoding with <code class="docutils literal notranslate"><span class="pre">c_string_encoding=ascii</span></code> failed in Py3.3.</li>
<li>Crash when subtyping freelist enabled Cython extension types with
Python classes that use <code class="docutils literal notranslate"><span class="pre">__slots__</span></code>.</li>
<li>Freelist usage is restricted to CPython to avoid problems with other
Python implementations.</li>
<li>Memory leak in memory views when copying overlapping, contiguous slices.</li>
<li>Format checking when requesting non-contiguous buffers from
<code class="docutils literal notranslate"><span class="pre">cython.array</span></code> objects was accidentally omitted in Py3.</li>
<li>C++ destructor calls in extension types could fail to compile in clang.</li>
<li>Buffer format validation failed for sequences of strings in structs.</li>
<li>Docstrings on extension type attributes in .pxd files were rejected.</li>
</ul>
</div>
</div>
<div class="section" id="id109">
<h3>0.20.1 (2014-02-11)<a class="headerlink" href="#id109" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id110">
<h4>Bugs fixed<a class="headerlink" href="#id110" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Build error under recent MacOS-X versions where <code class="docutils literal notranslate"><span class="pre">isspace()</span></code> could not be
resolved by clang.</li>
<li>List/Tuple literals multiplied by more than one factor were only multiplied
by the last factor instead of all.</li>
<li>Lookups of special methods (specifically for context managers) could fail
in Python &lt;= 2.6/3.1.</li>
<li>Local variables were erroneously appended to the signature introspection
of Cython implemented functions with keyword-only arguments under Python 3.</li>
<li>In-place assignments to variables with inferred Python builtin/extension
types could fail with type errors if the result value type was incompatible
with the type of the previous value.</li>
<li>The C code generation order of cdef classes, closures, helper code,
etc. was not deterministic, thus leading to high code churn.</li>
<li>Type inference could fail to deduce C enum types.</li>
<li>Type inference could deduce unsafe or inefficient types from integer
assignments within a mix of inferred Python variables and integer
variables.</li>
</ul>
</div>
</div>
<div class="section" id="id111">
<h3>0.20 (2014-01-18)<a class="headerlink" href="#id111" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id112">
<h4>Features added<a class="headerlink" href="#id112" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Support for CPython 3.4.</li>
<li>Support for calling C++ template functions.</li>
<li><code class="docutils literal notranslate"><span class="pre">yield</span></code> is supported in <code class="docutils literal notranslate"><span class="pre">finally</span></code> clauses.</li>
<li>The C code generated for finally blocks is duplicated for each exit
case to allow for better optimisations by the C compiler.</li>
<li>Cython tries to undo the Python optimisationism of assigning a bound
method to a local variable when it can generate better code for the
direct call.</li>
<li>Constant Python float values are cached.</li>
<li>String equality comparisons can use faster type specific code in
more cases than before.</li>
<li>String/Unicode formatting using the ‘%’ operator uses a faster
C-API call.</li>
<li><code class="docutils literal notranslate"><span class="pre">bytearray</span></code> has become a known type and supports coercion from and
to C strings.  Indexing, slicing and decoding is optimised. Note that
this may have an impact on existing code due to type inference.</li>
<li>Using <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">basestring</span> <span class="pre">stringvar</span></code> and function arguments typed as
<code class="docutils literal notranslate"><span class="pre">basestring</span></code> is now meaningful and allows assigning exactly
<code class="docutils literal notranslate"><span class="pre">str</span></code> and <code class="docutils literal notranslate"><span class="pre">unicode</span></code> objects, but no subtypes of these types.</li>
<li>Support for the <code class="docutils literal notranslate"><span class="pre">__debug__</span></code> builtin.</li>
<li>Assertions in Cython compiled modules are disabled if the running
Python interpreter was started with the “-O” option.</li>
<li>Some types that Cython provides internally, such as functions and
generators, are now shared across modules if more than one Cython
implemented module is imported.</li>
<li>The type inference algorithm works more fine granular by taking the
results of the control flow analysis into account.</li>
<li>A new script in <code class="docutils literal notranslate"><span class="pre">bin/cythonize</span></code> provides a command line frontend
to the cythonize() compilation function (including distutils build).</li>
<li>The new extension type decorator <code class="docutils literal notranslate"><span class="pre">&#64;cython.no_gc_clear</span></code> prevents
objects from being cleared during cyclic garbage collection, thus
making sure that object attributes are kept alive until deallocation.</li>
<li>During cyclic garbage collection, attributes of extension types that
cannot create reference cycles due to their type (e.g. strings) are
no longer considered for traversal or clearing.  This can reduce the
processing overhead when searching for or cleaning up reference cycles.</li>
<li>Package compilation (i.e. <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> files) now works, starting
with Python 3.3.</li>
<li>The cython-mode.el script for Emacs was updated.  Patch by Ivan Andrus.</li>
<li>An option common_utility_include_dir was added to cythonize() to save
oft-used utility code once in a separate directory rather than as
part of each generated file.</li>
<li><code class="docutils literal notranslate"><span class="pre">unraisable_tracebacks</span></code> directive added to control printing of
tracebacks of unraisable exceptions.</li>
</ul>
</div>
<div class="section" id="id113">
<h4>Bugs fixed<a class="headerlink" href="#id113" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Abstract Python classes that subtyped a Cython extension type
failed to raise an exception on instantiation, and thus ended
up being instantiated.</li>
<li><code class="docutils literal notranslate"><span class="pre">set.add(a_tuple)</span></code> and <code class="docutils literal notranslate"><span class="pre">set.discard(a_tuple)</span></code> failed with a
TypeError in Py2.4.</li>
<li>The PEP 3155 <code class="docutils literal notranslate"><span class="pre">__qualname__</span></code> was incorrect for nested classes and
inner classes/functions declared as <code class="docutils literal notranslate"><span class="pre">global</span></code>.</li>
<li>Several corner cases in the try-finally statement were fixed.</li>
<li>The metaclass of a Python class was not inherited from its parent
class(es).  It is now extracted from the list of base classes if not
provided explicitly using the Py3 <code class="docutils literal notranslate"><span class="pre">metaclass</span></code> keyword argument.
In Py2 compilation mode, a <code class="docutils literal notranslate"><span class="pre">__metaclass__</span></code> entry in the class
dict will still take precedence if not using Py3 metaclass syntax,
but only <em>after</em> creating the class dict (which may have been done
by a metaclass of a base class, see PEP 3115).  It is generally
recommended to use the explicit Py3 syntax to define metaclasses
for Python types at compile time.</li>
<li>The automatic C switch statement generation behaves more safely for
heterogeneous value types (e.g. mixing enum and char), allowing for
a slightly wider application and reducing corner cases.  It now always
generates a ‘default’ clause to avoid C compiler warnings about
unmatched enum values.</li>
<li>Fixed a bug where class hierarchies declared out-of-order could result
in broken generated code.</li>
<li>Fixed a bug which prevented overriding const methods of C++ classes.</li>
<li>Fixed a crash when converting Python objects to C++ strings fails.</li>
</ul>
</div>
<div class="section" id="id114">
<h4>Other changes<a class="headerlink" href="#id114" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>In Py3 compilation mode, Python2-style metaclasses declared by a
<code class="docutils literal notranslate"><span class="pre">__metaclass__</span></code> class dict entry are ignored.</li>
<li>In Py3.4+, the Cython generator type uses <code class="docutils literal notranslate"><span class="pre">tp_finalize()</span></code> for safer
cleanup instead of <code class="docutils literal notranslate"><span class="pre">tp_del()</span></code>.</li>
</ul>
</div>
</div>
<div class="section" id="id115">
<h3>0.19.2 (2013-10-13)<a class="headerlink" href="#id115" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id116">
<h4>Features added<a class="headerlink" href="#id116" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id117">
<h4>Bugs fixed<a class="headerlink" href="#id117" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Some standard declarations were fixed or updated, including the previously
incorrect declaration of <code class="docutils literal notranslate"><span class="pre">PyBuffer_FillInfo()</span></code> and some missing bits in
<code class="docutils literal notranslate"><span class="pre">libc.math</span></code>.</li>
<li>Heap allocated subtypes of <code class="docutils literal notranslate"><span class="pre">type</span></code> used the wrong base type struct at the
C level.</li>
<li>Calling the unbound method dict.keys/value/items() in dict subtypes could
call the bound object method instead of the unbound supertype method.</li>
<li>“yield” wasn’t supported in “return” value expressions.</li>
<li>Using the “bint” type in memory views lead to unexpected results.
It is now an error.</li>
<li>Assignments to global/closure variables could catch them in an illegal state
while deallocating the old value.</li>
</ul>
</div>
<div class="section" id="id118">
<h4>Other changes<a class="headerlink" href="#id118" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id119">
<h3>0.19.1 (2013-05-11)<a class="headerlink" href="#id119" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id120">
<h4>Features added<a class="headerlink" href="#id120" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Completely empty C-API structs for extension type slots (protocols like
number/mapping/sequence) are no longer generated into the C code.</li>
<li>Docstrings that directly follow a public/readonly attribute declaration
in a cdef class will be used as docstring of the auto-generated property.
This fixes ticket 206.</li>
<li>The automatic signature documentation tries to preserve more semantics
of default arguments and argument types.  Specifically, <code class="docutils literal notranslate"><span class="pre">bint</span></code> arguments
now appear as type <code class="docutils literal notranslate"><span class="pre">bool</span></code>.</li>
<li>A warning is emitted when negative literal indices are found inside of
a code section that disables <code class="docutils literal notranslate"><span class="pre">wraparound</span></code> handling.  This helps with
fixing invalid code that might fail in the face of future compiler
optimisations.</li>
<li>Constant folding for boolean expressions (and/or) was improved.</li>
<li>Added a build_dir option to cythonize() which allows one to place
the generated .c files outside the source tree.</li>
</ul>
</div>
<div class="section" id="id121">
<h4>Bugs fixed<a class="headerlink" href="#id121" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">isinstance(X,</span> <span class="pre">type)</span></code> failed to get optimised into a call to
<code class="docutils literal notranslate"><span class="pre">PyType_Check()</span></code>, as done for other builtin types.</li>
<li>A spurious <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">datetime</span> <span class="pre">cimport</span> <span class="pre">*</span></code> was removed from the “cpython”
declaration package. This means that the “datetime” declarations
(added in 0.19) are no longer available directly from the “cpython”
namespace, but only from “cpython.datetime”. This is the correct
way of doing it because the declarations refer to a standard library
module, not the core CPython C-API itself.</li>
<li>The C code for extension types is now generated in topological order
instead of source code order to avoid C compiler errors about missing
declarations for subtypes that are defined before their parent.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">memoryview</span></code> type name no longer shows up in the module dict of
modules that use memory views.  This fixes trac ticket 775.</li>
<li>Regression in 0.19 that rejected valid C expressions from being used
in C array size declarations.</li>
<li>In C++ mode, the C99-only keyword <code class="docutils literal notranslate"><span class="pre">restrict</span></code> could accidentally be
seen by the GNU C++ compiler. It is now specially handled for both
GCC and MSVC.</li>
<li>Testing large (&gt; int) C integer values for their truth value could fail
due to integer wrap-around.</li>
</ul>
</div>
<div class="section" id="id122">
<h4>Other changes<a class="headerlink" href="#id122" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id123">
<h3>0.19 (2013-04-19)<a class="headerlink" href="#id123" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id124">
<h4>Features added<a class="headerlink" href="#id124" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>New directives <code class="docutils literal notranslate"><span class="pre">c_string_type</span></code> and <code class="docutils literal notranslate"><span class="pre">c_string_encoding</span></code> to more easily
and automatically convert between C strings and the different Python string
types.</li>
<li>The extension type flag <code class="docutils literal notranslate"><span class="pre">Py_TPFLAGS_HAVE_VERSION_TAG</span></code> is enabled by default
on extension types and can be disabled using the <code class="docutils literal notranslate"><span class="pre">type_version_tag</span></code> compiler
directive.</li>
<li>EXPERIMENTAL support for simple Cython code level line tracing.  Enabled by
the “linetrace” compiler directive.</li>
<li>Cython implemented functions make their argument and return type annotations
available through the <code class="docutils literal notranslate"><span class="pre">__annotations__</span></code> attribute (PEP 3107).</li>
<li>Access to non-cdef module globals and Python object attributes is faster.</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_UNICODE*</span></code> coerces from and to Python unicode strings.  This is
helpful when talking to Windows APIs, which use compatible wchar_t
arrays for strings.  Note that the <code class="docutils literal notranslate"><span class="pre">Py_UNICODE</span></code> type is otherwise
deprecated as of CPython 3.3.</li>
<li><code class="docutils literal notranslate"><span class="pre">isinstance(obj,</span> <span class="pre">basestring)</span></code> is optimised.  In Python 3 it only tests
for instances of <code class="docutils literal notranslate"><span class="pre">str</span></code> (i.e. Py2 <code class="docutils literal notranslate"><span class="pre">unicode</span></code>).</li>
<li>The <code class="docutils literal notranslate"><span class="pre">basestring</span></code> builtin is mapped to <code class="docutils literal notranslate"><span class="pre">str</span></code> (i.e. Py2 <code class="docutils literal notranslate"><span class="pre">unicode</span></code>) when
compiling the generated C code under Python 3.</li>
<li>Closures use freelists, which can speed up their creation quite substantially.
This is also visible for short running generator expressions, for example.</li>
<li>A new class decorator <code class="docutils literal notranslate"><span class="pre">&#64;cython.freelist(N)</span></code> creates a static freelist of N
instances for an extension type, thus avoiding the costly allocation step if
possible. This can speed up object instantiation by 20-30% in suitable
scenarios. Note that freelists are currently only supported for base types,
not for types that inherit from others.</li>
<li>Fast extension type instantiation using the <code class="docutils literal notranslate"><span class="pre">Type.__new__(Type)</span></code> idiom has
gained support for passing arguments.  It is also a bit faster for types defined
inside of the module.</li>
<li>The Python2-only dict methods <code class="docutils literal notranslate"><span class="pre">.iter*()</span></code> and <code class="docutils literal notranslate"><span class="pre">.view*()</span></code> (requires Python 2.7)
are automatically mapped to the equivalent keys/values/items methods in Python 3
for typed dictionaries.</li>
<li>Slicing unicode strings, lists and tuples is faster.</li>
<li>list.append() is faster on average.</li>
<li><code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">Exception()</span> <span class="pre">from</span> <span class="pre">None</span></code> suppresses the exception context in Py3.3.</li>
<li>Py3 compatible <code class="docutils literal notranslate"><span class="pre">exec(tuple)</span></code> syntax is supported in Py2 code.</li>
<li>Keyword arguments are supported for cdef functions.</li>
<li>External C++ classes can be declared nogil.  Patch by John Stumpo.  This fixes
trac ticket 805.</li>
</ul>
</div>
<div class="section" id="id125">
<h4>Bugs fixed<a class="headerlink" href="#id125" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>2-value slicing of unknown objects passes the correct slice when the <code class="docutils literal notranslate"><span class="pre">getitem</span></code>
protocol is used instead of the <code class="docutils literal notranslate"><span class="pre">getslice</span></code> protocol (especially in Python 3),
i.e. <code class="docutils literal notranslate"><span class="pre">None</span></code> values for missing bounds instead of <code class="docutils literal notranslate"><span class="pre">[0,maxsize]</span></code>.  It is also
a bit faster in some cases, e.g. for constant bounds.  This fixes trac ticket 636.</li>
<li>Cascaded assignments of None values to extension type variables failed with
a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> at runtime.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">__defaults__</span></code> attribute was not writable for Cython implemented
functions.</li>
<li>Default values of keyword-only arguments showed up in <code class="docutils literal notranslate"><span class="pre">__defaults__</span></code> instead
of <code class="docutils literal notranslate"><span class="pre">__kwdefaults__</span></code> (which was not implemented).  Both are available for
Cython implemented functions now, as specified in Python 3.x.</li>
<li><code class="docutils literal notranslate"><span class="pre">yield</span></code> works inside of <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">gil</span></code> sections.  It previously lead to a crash.
This fixes trac ticket 803.</li>
<li>Static methods without explicitly named positional arguments (e.g. having only
<code class="docutils literal notranslate"><span class="pre">*args</span></code>) crashed when being called.  This fixes trac ticket 804.</li>
<li><code class="docutils literal notranslate"><span class="pre">dir()</span></code> without arguments previously returned an unsorted list, which now
gets sorted as expected.</li>
<li><code class="docutils literal notranslate"><span class="pre">dict.items()</span></code>, <code class="docutils literal notranslate"><span class="pre">dict.keys()</span></code> and <code class="docutils literal notranslate"><span class="pre">dict.values()</span></code> no longer return lists
in Python 3.</li>
<li>Exiting from an <code class="docutils literal notranslate"><span class="pre">except-as</span></code> clause now deletes the exception in Python 3 mode.</li>
<li>The declarations of <code class="docutils literal notranslate"><span class="pre">frexp()</span></code> and <code class="docutils literal notranslate"><span class="pre">ldexp()</span></code> in <code class="docutils literal notranslate"><span class="pre">math.pxd</span></code> were incorrect.</li>
</ul>
</div>
<div class="section" id="id126">
<h4>Other changes<a class="headerlink" href="#id126" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id127">
<h3>0.18 (2013-01-28)<a class="headerlink" href="#id127" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id128">
<h4>Features added<a class="headerlink" href="#id128" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Named Unicode escapes (“N{…}”) are supported.</li>
<li>Python functions/classes provide the special attribute “__qualname__”
as defined by PEP 3155.</li>
<li>Added a directive <code class="docutils literal notranslate"><span class="pre">overflowcheck</span></code> which raises an OverflowException when
arithmetic with C ints overflow.  This has a modest performance penalty, but
is much faster than using Python ints.</li>
<li>Calls to nested Python functions are resolved at compile time.</li>
<li>Type inference works across nested functions.</li>
<li><code class="docutils literal notranslate"><span class="pre">py_bytes_string.decode(...)</span></code> is optimised.</li>
<li>C <code class="docutils literal notranslate"><span class="pre">const</span></code> declarations are supported in the language.</li>
</ul>
</div>
<div class="section" id="id129">
<h4>Bugs fixed<a class="headerlink" href="#id129" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Automatic C++ exception mapping didn’t work in nogil functions (only in
“with nogil” blocks).</li>
</ul>
</div>
<div class="section" id="id130">
<h4>Other changes<a class="headerlink" href="#id130" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id131">
<h3>0.17.4 (2013-01-03)<a class="headerlink" href="#id131" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id132">
<h4>Bugs fixed<a class="headerlink" href="#id132" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Garbage collection triggered during deallocation of container classes could lead to a double-deallocation.</li>
</ul>
</div>
</div>
<div class="section" id="id133">
<h3>0.17.3 (2012-12-14)<a class="headerlink" href="#id133" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id134">
<h4>Features added<a class="headerlink" href="#id134" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id135">
<h4>Bugs fixed<a class="headerlink" href="#id135" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>During final interpreter cleanup (with types cleanup enabled at compile time), extension types that inherit from base types over more than one level that were cimported from other modules could lead to a crash.</li>
<li>Weak-reference support in extension types (with a <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">__weakref__</span></code> attribute) generated incorrect deallocation code.</li>
<li>In CPython 3.3, converting a Unicode character to the Py_UNICODE type could fail to raise an overflow for non-BMP characters that do not fit into a wchar_t on the current platform.</li>
<li>Negative C integer constants lost their longness suffix in the generated C code.</li>
</ul>
</div>
<div class="section" id="id136">
<h4>Other changes<a class="headerlink" href="#id136" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id137">
<h3>0.17.2 (2012-11-20)<a class="headerlink" href="#id137" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id138">
<h4>Features added<a class="headerlink" href="#id138" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">cythonize()</span></code> gained a best effort compile mode that can be used to simply ignore .py files that fail to compile.</li>
</ul>
</div>
<div class="section" id="id139">
<h4>Bugs fixed<a class="headerlink" href="#id139" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Replacing an object reference with the value of one of its cdef attributes could generate incorrect C code that accessed the object after deleting its last reference.</li>
<li>C-to-Python type coercions during cascaded comparisons could generate invalid C code, specifically when using the ‘in’ operator.</li>
<li>“obj[1,]” passed a single integer into the item getter instead of a tuple.</li>
<li>Cyclic imports at module init time did not work in Py3.</li>
<li>The names of C++ destructors for template classes were built incorrectly.</li>
<li>In pure mode, type casts in Cython syntax and the C ampersand operator are now rejected. Use the pure mode replacements instead.</li>
<li>In pure mode, C type names and the sizeof() function are no longer recognised as such and can be used as normal Python names.</li>
<li>The extended C level support for the CPython array type was declared too late to be used by user defined classes.</li>
<li>C++ class nesting was broken.</li>
<li>Better checking for required nullary constructors for stack-allocated C++ instances.</li>
<li>Remove module docstring in no-docstring mode.</li>
<li>Fix specialization for varargs function signatures.</li>
<li>Fix several compiler crashes.</li>
</ul>
</div>
<div class="section" id="id140">
<h4>Other changes<a class="headerlink" href="#id140" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>An experimental distutils script for compiling the CPython standard library was added as Tools/cystdlib.py.</li>
</ul>
</div>
</div>
<div class="section" id="id141">
<h3>0.17.1 (2012-09-26)<a class="headerlink" href="#id141" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id142">
<h4>Features added<a class="headerlink" href="#id142" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id143">
<h4>Bugs fixed<a class="headerlink" href="#id143" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>A reference leak was fixed in the new dict iteration code when the loop target was not a plain variable but an unpacked tuple.</li>
<li>Memory views did not handle the special case of a NULL buffer strides value, as allowed by PEP3118.</li>
</ul>
</div>
<div class="section" id="id144">
<h4>Other changes<a class="headerlink" href="#id144" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id145">
<h3>0.17 (2012-09-01)<a class="headerlink" href="#id145" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id146">
<h4>Features added<a class="headerlink" href="#id146" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Alpha quality support for compiling and running Cython generated extension modules in PyPy (through cpyext). Note that this requires at least PyPy 1.9 and in many cases also adaptations in user code, especially to avoid borrowed references when no owned reference is being held directly in C space (a reference in a Python list or dict is not enough, for example). See the documentation on porting Cython code to PyPy.</li>
<li>“yield from” is supported (PEP 380) and a couple of minor problems with generators were fixed.</li>
<li>C++ STL container classes automatically coerce from and to the equivalent Python container types on typed assignments and casts. Note that the data in the containers is copied during this conversion.</li>
<li>C++ iterators can now be iterated over using “for x in cpp_container” whenever cpp_container has begin() and end() methods returning objects satisfying the iterator pattern (that is, it can be incremented, dereferenced, and compared (for non-equality)).</li>
<li>cdef classes can now have C++ class members (provided a zero-argument constructor exists)</li>
<li>A new cpython.array standard cimport file allows to efficiently talk to the stdlib array.array data type in Python 2. Since CPython does not export an official C-API for this module, it receives special casing by the compiler in order to avoid setup overhead on user side. In Python 3, both buffers and memory views on the array type already worked out of the box with earlier versions of Cython due to the native support for the buffer interface in the Py3 array module.</li>
<li>Fast dict iteration is now enabled optimistically also for untyped variables when the common iteration methods are used.</li>
<li>The unicode string processing code was adapted for the upcoming CPython 3.3 (PEP 393, new Unicode buffer layout).</li>
<li>Buffer arguments and memory view arguments in Python functions can be declared “not None” to raise a TypeError on None input.</li>
<li>c(p)def functions in pure mode can specify their return type with “&#64;cython.returns()”.</li>
<li>Automatic dispatch for fused functions with memoryview arguments</li>
<li>Support newaxis indexing for memoryviews</li>
<li>Support decorators for fused functions</li>
</ul>
</div>
<div class="section" id="id147">
<h4>Bugs fixed<a class="headerlink" href="#id147" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Old-style Py2 imports did not work reliably in Python 3.x and were broken in Python 3.3. Regardless of this fix, it’s generally best to be explicit about relative and global imports in Cython code because old-style imports have a higher overhead. To this end, “from __future__ import absolute_import” is supported in Python/Cython 2.x code now (previous versions of Cython already used it when compiling Python 3 code).</li>
<li>Stricter constraints on the “inline” and “final” modifiers. If your code does not compile due to this change, chances are these modifiers were previously being ignored by the compiler and can be removed without any performance regression.</li>
<li>Exceptions are always instantiated while raising them (as in Python), instead of risking to instantiate them in potentially unsafe situations when they need to be handled or otherwise processed.</li>
<li>locals() properly ignores names that do not have Python compatible types (including automatically inferred types).</li>
<li>Some garbage collection issues of memory views were fixed.</li>
<li>numpy.pxd compiles in Python 3 mode.</li>
<li>Several C compiler warnings were fixed.</li>
<li>Several bugs related to memoryviews and fused types were fixed.</li>
<li>Several bug-fixes and improvements related to cythonize(), including ccache-style caching.</li>
</ul>
</div>
<div class="section" id="id148">
<h4>Other changes<a class="headerlink" href="#id148" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>libc.string provides a convenience declaration for const uchar in addition to const char.</li>
<li>User declared char* types are now recognised as such and auto-coerce to and from Python bytes strings.</li>
<li>callable() and next() compile to more efficient C code.</li>
<li>list.append() is faster on average.</li>
<li>Modules generated by &#64;cython.inline() are written into the directory pointed to by the environment variable CYTHON_CACHE_DIR if set.</li>
</ul>
</div>
</div>
<div class="section" id="id149">
<h3>0.16 (2012-04-21)<a class="headerlink" href="#id149" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id150">
<h4>Features added<a class="headerlink" href="#id150" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Enhancements to Cython’s function type (support for weak references, default arguments, code objects, dynamic attributes, classmethods, staticmethods, and more)</li>
<li>Fused Types - Template-like support for functions and methods CEP 522 (docs)</li>
<li>Typed views on memory - Support for efficient direct and indirect buffers (indexing, slicing, transposing, …) CEP 517 (docs)</li>
<li>super() without arguments</li>
<li>Final cdef methods (which translate into direct calls on known instances)</li>
</ul>
</div>
<div class="section" id="id151">
<h4>Bugs fixed<a class="headerlink" href="#id151" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>fix alignment handling for record types in buffer support</li>
</ul>
</div>
<div class="section" id="id152">
<h4>Other changes<a class="headerlink" href="#id152" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>support default arguments for closures</li>
<li>search sys.path for pxd files</li>
<li>support C++ template casting</li>
<li>faster traceback building and faster generator termination</li>
<li>support inplace operators on indexed buffers</li>
<li>allow nested prange sections</li>
</ul>
</div>
</div>
<div class="section" id="id153">
<h3>0.15.1 (2011-09-19)<a class="headerlink" href="#id153" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id154">
<h4>Features added<a class="headerlink" href="#id154" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id155">
<h4>Bugs fixed<a class="headerlink" href="#id155" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id156">
<h4>Other changes<a class="headerlink" href="#id156" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id157">
<h3>0.15 (2011-08-05)<a class="headerlink" href="#id157" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id158">
<h4>Features added<a class="headerlink" href="#id158" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Generators (yield) - Cython has full support for generators, generator expressions and PEP 342 coroutines.</li>
<li>The nonlocal keyword is supported.</li>
<li>Re-acquiring the gil: with gil - works as expected within a nogil context.</li>
<li>OpenMP support: prange.</li>
<li>Control flow analysis prunes dead code and emits warnings and errors about uninitialised variables.</li>
<li>Debugger command cy set to assign values of expressions to Cython variables and cy exec counterpart $cy_eval().</li>
<li>Exception chaining PEP 3134.</li>
<li>Relative imports PEP 328.</li>
<li>Improved pure syntax including cython.cclass, cython.cfunc, and cython.ccall.</li>
<li>The with statement has its own dedicated and faster C implementation.</li>
<li>Support for del.</li>
<li>Boundschecking directives implemented for builtin Python sequence types.</li>
<li>Several updates and additions to the shipped standard library .pxd files.</li>
<li>Forward declaration of types is no longer required for circular references.</li>
</ul>
</div>
<div class="section" id="id159">
<h4>Bugs fixed<a class="headerlink" href="#id159" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id160">
<h4>Other changes<a class="headerlink" href="#id160" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Uninitialized variables are no longer initialized to None and accessing them has the same semantics as standard Python.</li>
<li>globals() now returns a read-only dict of the Cython module’s globals, rather than the globals of the first non-Cython module in the stack</li>
<li>Many C++ exceptions are now special cased to give closer Python counterparts. This means that except+ functions that formerly raised generic RuntimeErrors may raise something else such as ArithmeticError.</li>
<li>The inlined generator expressions (introduced in Cython 0.13) were disabled in favour of full generator expression support. This breaks code that previously used them inside of cdef functions (usage in def functions continues to work) and induces a performance regression for cases that continue to work but that were previously inlined. We hope to reinstate this feature in the near future.</li>
</ul>
</div>
</div>
<div class="section" id="id161">
<h3>0.14.1 (2011-02-04)<a class="headerlink" href="#id161" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id162">
<h4>Features added<a class="headerlink" href="#id162" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The gdb debugging support was extended to include all major Cython features, including closures.</li>
<li>raise MemoryError() is now safe to use as Cython replaces it with the correct C-API call.</li>
</ul>
</div>
<div class="section" id="id163">
<h4>Bugs fixed<a class="headerlink" href="#id163" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id164">
<h4>Other changes<a class="headerlink" href="#id164" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Decorators on special methods of cdef classes now raise a compile time error rather than being ignored.</li>
<li>In Python 3 language level mode (-3 option), the ‘str’ type is now mapped to ‘unicode’, so that cdef str s declares a Unicode string even when running in Python 2.</li>
</ul>
</div>
</div>
<div class="section" id="id165">
<h3>0.14 (2010-12-14)<a class="headerlink" href="#id165" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id166">
<h4>Features added<a class="headerlink" href="#id166" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Python classes can now be nested and receive a proper closure at definition time.</li>
<li>Redefinition is supported for Python functions, even within the same scope.</li>
<li>Lambda expressions are supported in class bodies and at the module level.</li>
<li>Metaclasses are supported for Python classes, both in Python 2 and Python 3 syntax. The Python 3 syntax (using a keyword argument in the type declaration) is preferred and optimised at compile time.</li>
<li>“final” extension classes prevent inheritance in Python space. This feature is available through the new “cython.final” decorator. In the future, these classes may receive further optimisations.</li>
<li>“internal” extension classes do not show up in the module dictionary. This feature is available through the new “cython.internal” decorator.</li>
<li>Extension type inheritance from builtin types, such as “cdef class MyUnicode(unicode)”, now works without further external type redeclarations (which are also strongly discouraged now and continue to issue a warning).</li>
<li>GDB support. <a class="reference external" href="http://docs.cython.org/src/userguide/debugging.html">http://docs.cython.org/src/userguide/debugging.html</a></li>
<li>A new build system with support for inline distutils directives, correct dependency tracking, and parallel compilation. <a class="reference external" href="https://github.com/cython/cython/wiki/enhancements-distutils_preprocessing">https://github.com/cython/cython/wiki/enhancements-distutils_preprocessing</a></li>
<li>Support for dynamic compilation at runtime via the new cython.inline function and cython.compile decorator. <a class="reference external" href="https://github.com/cython/cython/wiki/enhancements-inline">https://github.com/cython/cython/wiki/enhancements-inline</a></li>
<li>“nogil” blocks are supported when compiling pure Python code by writing “with cython.nogil”.</li>
<li>Iterating over arbitrary pointer types is now supported, as is an optimized version of the in operator, e.g. x in ptr[a:b].</li>
</ul>
</div>
<div class="section" id="id167">
<h4>Bugs fixed<a class="headerlink" href="#id167" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>In parallel assignments, the right side was evaluated in reverse order in 0.13. This could result in errors if it had side effects (e.g. function calls).</li>
<li>In some cases, methods of builtin types would raise a SystemError instead of an AttributeError when called on None.</li>
</ul>
</div>
<div class="section" id="id168">
<h4>Other changes<a class="headerlink" href="#id168" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Constant tuples are now cached over the lifetime of an extension module, just like CPython does. Constant argument tuples of Python function calls are also cached.</li>
<li>Closures have tightened to include exactly the names used in the inner functions and classes. Previously, they held the complete locals of the defining function.</li>
<li>The builtin “next()” function in Python 2.6 and later is now implemented internally and therefore available in all Python versions. This makes it the preferred and portable way of manually advancing an iterator.</li>
<li>In addition to the previously supported inlined generator expressions in 0.13, “sorted(genexpr)” can now be used as well. Typing issues were fixed in “sum(genexpr)” that could lead to invalid C code being generated. Other known issues with inlined generator expressions were also fixed that make upgrading to 0.14 a strong recommendation for code that uses them. Note that general generators and generator expressions continue to be not supported.</li>
<li>Inplace arithmetic operators now respect the cdivision directive and are supported for complex types.</li>
<li>Typing a variable as type “complex” previously gave it the Python object type. It now uses the appropriate C/C++ double complex type. A side-effect is that assignments and typed function parameters now accept anything that Python can coerce to a complex, including integers and floats, and not only complex instances.</li>
<li>Large integer literals pass through the compiler in a safer way. To prevent truncation in C code, non 32-bit literals are turned into Python objects if not used in a C context. This context can either be given by a clear C literal suffix such as “UL” or “LL” (or “L” in Python 3 code), or it can be an assignment to a typed variable or a typed function argument, in which case it is up to the user to take care of a sufficiently large value space of the target.</li>
<li>Python functions are declared in the order they appear in the file, rather than all being created at module creation time. This is consistent with Python and needed to support, for example, conditional or repeated declarations of functions. In the face of circular imports this may cause code to break, so a new –disable-function-redefinition flag was added to revert to the old behavior. This flag will be removed in a future release, so should only be used as a stopgap until old code can be fixed.</li>
</ul>
</div>
</div>
<div class="section" id="id169">
<h3>0.13 (2010-08-25)<a class="headerlink" href="#id169" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id170">
<h4>Features added<a class="headerlink" href="#id170" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Closures are fully supported for Python functions. Cython supports inner functions and lambda expressions. Generators and generator expressions are not supported in this release.</li>
<li>Proper C++ support. Cython knows about C++ classes, templates and overloaded function signatures, so that Cython code can interact with them in a straight forward way.</li>
<li>Type inference is enabled by default for safe C types (e.g. double, bint, C++ classes) and known extension types. This reduces the need for explicit type declarations and can improve the performance of untyped code in some cases. There is also a verbose compile mode for testing the impact on user code.</li>
<li>Cython’s for-in-loop can iterate over C arrays and sliced pointers. The type of the loop variable will be inferred automatically in this case.</li>
<li>The Py_UNICODE integer type for Unicode code points is fully supported, including for-loops and ‘in’ tests on unicode strings. It coerces from and to single character unicode strings. Note that untyped for-loop variables will automatically be inferred as Py_UNICODE when iterating over a unicode string. In most cases, this will be much more efficient than yielding sliced string objects, but can also have a negative performance impact when the variable is used in a Python context multiple times, so that it needs to coerce to a unicode string object more than once. If this happens, typing the loop variable as unicode or object will help.</li>
<li>The built-in functions any(), all(), sum(), list(), set() and dict() are inlined as plain for loops when called on generator expressions. Note that generator expressions are not generally supported apart from this feature. Also, tuple(genexpr) is not currently supported - use tuple([listcomp]) instead.</li>
<li>More shipped standard library declarations. The python_* and stdlib/stdio .pxd files have been deprecated in favor of clib.* and cpython[.*] and may get removed in a future release.</li>
<li>Pure Python mode no longer disallows non-Python keywords like ‘cdef’, ‘include’ or ‘cimport’. It also no longer recognises syntax extensions like the for-from loop.</li>
<li>Parsing has improved for Python 3 syntax in Python code, although not all features are correctly supported. The missing Python 3 features are being worked on for the next release.</li>
<li>from __future__ import print_function is supported in Python 2.6 and later. Note that there is currently no emulation for earlier Python versions, so code that uses print() with this future import will require at least Python 2.6.</li>
<li>New compiler directive language_level (valid values: 2 or 3) with corresponding command line options -2 and -3 requests source code compatibility with Python 2.x or Python 3.x respectively. Language level 3 currently enforces unicode literals for unprefixed string literals, enables the print function (requires Python 2.6 or later) and keeps loop variables in list comprehensions from leaking.</li>
<li>Loop variables in set/dict comprehensions no longer leak into the surrounding scope (following Python 2.7). List comprehensions are unchanged in language level 2.</li>
<li>print &gt;&gt; stream</li>
</ul>
</div>
<div class="section" id="id171">
<h4>Bugs fixed<a class="headerlink" href="#id171" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id172">
<h4>Other changes<a class="headerlink" href="#id172" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">The availability of type inference by default means that Cython will also infer the type of pointers on assignments. Previously, code like this:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">s</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">untyped_variable</span> <span class="o">=</span> <span class="n">s</span>
</pre></div>
</div>
<p>would convert the char* to a Python bytes string and assign that. This is no longer the case and no coercion will happen in the example above. The correct way of doing this is through an explicit cast or by typing the target variable, i.e.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">char</span>* <span class="nf">s</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">untyped_variable1</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">bytes</span><span class="p">&gt;</span><span class="n">s</span>
<span class="n">untyped_variable2</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span><span class="n">s</span>

<span class="k">cdef</span> <span class="kt">object</span> <span class="nf">py_object</span> <span class="o">=</span> <span class="n">s</span>
<span class="k">cdef</span> <span class="kt">bytes</span>  <span class="nf">bytes_string</span> <span class="o">=</span> <span class="n">s</span>
</pre></div>
</div>
</li>
<li><p class="first">bool is no longer a valid type name by default. The problem is that it’s not clear whether bool should refer to the Python type or the C++ type, and expecting one and finding the other has already led to several hard-to-find bugs. Both types are available for importing: you can use from cpython cimport bool for the Python bool type, and from libcpp cimport bool for the C++ type. bool is still a valid object by default, so one can still write bool(x).</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">__getsegcount__</span></code> is now correctly typed to take a <code class="docutils literal notranslate"><span class="pre">Py_size_t*</span></code> rather than an <code class="docutils literal notranslate"><span class="pre">int*</span></code>.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="id173">
<h3>0.12.1 (2010-02-02)<a class="headerlink" href="#id173" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id174">
<h4>Features added<a class="headerlink" href="#id174" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Type inference improvements.<ul>
<li>There have been several bug fixes and improvements to the type inferencer.</li>
<li>Notably, there is now a “safe” mode enabled by setting the infer_types directive to None. (The None here refers to the “default” mode, which will be the default in 0.13.) This safe mode limits inference to Python object types and C doubles, which should speed up execution without affecting any semantics such as integer overflow behavior like infer_types=True might. There is also an infer_types.verbose option which allows one to see what types are inferred.</li>
</ul>
</li>
<li>The boundscheck directive works for lists and tuples as well as buffers.</li>
<li>len(s) and s.decode(“encoding”) are efficiently supported for char* s.</li>
<li>Cython’s INLINE macro has been renamed to CYTHON_INLINE to reduce conflict and has better support for the MSVC compiler on Windows. It is no longer clobbered if externally defined.</li>
<li>Revision history is now omitted from the source package, resulting in a 85% size reduction. Running make repo will download the history and turn the directory into a complete Mercurial working repository.</li>
<li>Cython modules don’t need to be recompiled when the size of an external type grows. (A warning, rather than an error, is produced.) This should be helpful for binary distributions relying on NumPy.</li>
</ul>
</div>
<div class="section" id="id175">
<h4>Bugs fixed<a class="headerlink" href="#id175" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Several other bugs and minor improvements have been made. This release should be fully backwards compatible with 0.12.</li>
</ul>
</div>
<div class="section" id="id176">
<h4>Other changes<a class="headerlink" href="#id176" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="id177">
<h3>0.12 (2009-11-23)<a class="headerlink" href="#id177" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id178">
<h4>Features added<a class="headerlink" href="#id178" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Type inference with the infer_types directive</li>
<li>Seamless C++ complex support</li>
<li>Fast extension type instantiation using the normal Python meme obj = MyType.__new__(MyType)</li>
<li>Improved support for Py3.1</li>
<li>Cython now runs under Python 3.x using the 2to3 tool</li>
<li>unittest support for doctests in Cython modules</li>
<li>Optimised handling of C strings (char*): for c in cstring[2:50] and cstring.decode()</li>
<li>Looping over c pointers: for i in intptr[:50].</li>
<li>pyximport improvements</li>
<li>cython_freeze improvements</li>
</ul>
</div>
<div class="section" id="id179">
<h4>Bugs fixed<a class="headerlink" href="#id179" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Many bug fixes</li>
</ul>
</div>
<div class="section" id="id180">
<h4>Other changes<a class="headerlink" href="#id180" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Many other optimisation, e.g. enumerate() loops, parallel swap assignments (a,b = b,a), and unicode.encode()</li>
<li>More complete numpy.pxd</li>
</ul>
</div>
</div>
<div class="section" id="id181">
<h3>0.11.2 (2009-05-20)<a class="headerlink" href="#id181" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id182">
<h4>Features added<a class="headerlink" href="#id182" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">There’s now native complex floating point support! C99 complex will be used if complex.h is included, otherwise explicit complex arithmetic working on all C compilers is used. [Robert Bradshaw]</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span> <span class="kt">complex</span> <span class="nf">a</span> <span class="o">=</span> <span class="mf">1</span> <span class="o">+</span> <span class="mf">0.3</span><span class="n">j</span>
<span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span>[<span class="kt">np</span>.<span class="nf">complex128_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">arr</span> <span class="o">=</span> \
   <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Cython can now generate a main()-method for embedding of the Python interpreter into an executable (see #289) [Robert Bradshaw]</p>
</li>
<li><p class="first">&#64;wraparound directive (another way to disable arr[idx] for negative idx) [Dag Sverre Seljebotn]</p>
</li>
<li><p class="first">Correct support for NumPy record dtypes with different alignments, and “cdef packed struct” support [Dag Sverre Seljebotn]</p>
</li>
<li><p class="first">&#64;callspec directive, allowing custom calling convention macros [Lisandro Dalcin]</p>
</li>
</ul>
</div>
<div class="section" id="id183">
<h4>Bugs fixed<a class="headerlink" href="#id183" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id184">
<h4>Other changes<a class="headerlink" href="#id184" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Bug fixes and smaller improvements. For the full list, see [1].</li>
</ul>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html#document-index">
              <img class="logo" src="_static/cythonlogo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html#document-index">Table of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-src/quickstart/index">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/quickstart/overview">Cython - an overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/quickstart/install">Installing Cython</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/quickstart/build">Building Cython code</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/quickstart/cythonize">Faster code via static typing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-src/tutorial/index">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/cython_tutorial">Basic Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/external">Calling C functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/clibraries">Using C libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/cdef_classes">Extension types (aka. cdef classes)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/pxd_files">pxd files</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/caveats">Caveats</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/profiling_tutorial">Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/strings">Unicode and passing strings</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/memory_allocation">Memory Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/pure">Pure Python Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/numpy">Working with NumPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/array">Working with Python arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/readings">Further reading</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/related_work">Related work</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/tutorial/appendix">Appendix: Installing MinGW on Windows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-src/userguide/index">Users Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/language_basics">Language Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/extension_types">Extension Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/special_methods">Special Methods of Extension Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/sharing_declarations">Sharing Declarations Between Cython Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/external_C_code">Interfacing with External C Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/source_files_and_compilation">Source Files and Compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/early_binding_for_speed">Early Binding for Speed</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/wrapping_CPlusPlus">Using C++ in Cython</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/fusedtypes">Fused Types (Templates)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/pypy">Porting Cython code to PyPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/limitations">Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/pyrex_differences">Differences between Cython and Pyrex</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/memoryviews">Typed Memoryviews</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/buffer">Implementing the buffer protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/parallelism">Using Parallelism</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/debugging">Debugging your Cython program</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/numpy_tutorial">Cython for NumPy users</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-src/userguide/numpy_pythran">Pythran as a Numpy backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-src/changes">Cython Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">3.0.0 (2019-??-??)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">0.29.10 (2019-06-02)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">0.29.9 (2019-05-29)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">0.29.8 (2019-05-28)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">0.29.7 (2019-04-14)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">0.29.6 (2019-02-27)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id12">0.29.5 (2019-02-09)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id14">0.29.4 (2019-02-01)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id15">0.29.3 (2019-01-19)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id17">0.29.2 (2018-12-14)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id19">0.29.1 (2018-11-24)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id21">0.29 (2018-10-14)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id25">0.28.6 (2018-11-01)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id27">0.28.5 (2018-08-03)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id29">0.28.4 (2018-07-08)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id31">0.28.3 (2018-05-27)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id33">0.28.2 (2018-04-13)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id37">0.28.1 (2018-03-18)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id39">0.28 (2018-03-13)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id43">0.27.3 (2017-11-03)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id45">0.27.2 (2017-10-22)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id47">0.27.1 (2017-10-01)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id51">0.27 (2017-09-23)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id55">0.26.1 (2017-08-29)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id58">0.26 (2017-07-19)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id62">0.25.2 (2016-12-08)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id64">0.25.1 (2016-10-26)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id67">0.25 (2016-10-25)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id70">0.24.1 (2016-07-15)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id72">0.24 (2016-04-04)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id75">0.23.5 (2016-03-26)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id76">0.23.4 (2015-10-10)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id78">0.23.3 (2015-09-29)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id81">0.23.2 (2015-09-11)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id83">0.23.1 (2015-08-22)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id85">0.23 (2015-08-08)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id90">0.22.1 (2015-06-20)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id92">0.22 (2015-02-11)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id96">0.21.2 (2014-12-27)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id98">0.21.1 (2014-10-18)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id102">0.21 (2014-09-10)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id106">0.20.2 (2014-06-16)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id109">0.20.1 (2014-02-11)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id111">0.20 (2014-01-18)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id115">0.19.2 (2013-10-13)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id119">0.19.1 (2013-05-11)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id123">0.19 (2013-04-19)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id127">0.18 (2013-01-28)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id131">0.17.4 (2013-01-03)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id133">0.17.3 (2012-12-14)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id137">0.17.2 (2012-11-20)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id141">0.17.1 (2012-09-26)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id145">0.17 (2012-09-01)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id149">0.16 (2012-04-21)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id153">0.15.1 (2011-09-19)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id157">0.15 (2011-08-05)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id161">0.14.1 (2011-02-04)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id165">0.14 (2010-12-14)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id169">0.13 (2010-08-25)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id173">0.12.1 (2010-02-02)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id177">0.12 (2009-11-23)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id181">0.11.2 (2009-05-20)</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index.html#document-index">Cython 3.0a0 documentation</a> &#187;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Stefan Behnel, Robert Bradshaw, Dag Sverre Seljebotn, Greg Ewing, William Stein, Gabriel Gellner, et al..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-6139100-3");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>